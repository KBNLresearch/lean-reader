import"./style-DyeAjxw-.js";const ce=class Ae{constructor(e){if(typeof e=="string"){if(!Ae.VALID_MODES.has(e.toLowerCase()))return;this.value=e.toLowerCase()}else{const t=e.filter(i=>Ae.VALID_MODES.has(i.toLowerCase()));if(t.length===0)return;this.value=Array.from(new Set(t))}}static deserialize(e){if(!e)return;if(typeof e=="string")return new Ae(e);if(!Array.isArray(e))return;const t=e.filter(i=>i?Ae.VALID_MODES.has(i.toLowerCase()):!1);if(t.length!==0)return new Ae(t)}serialize(){return this.value}};ce.VALID_MODES=new Set(["auditory","tactile","textual","visual"]),ce.AUDITORY=new ce("auditory"),ce.TACTILE=new ce("tactile"),ce.TEXTUAL=new ce("textual"),ce.VISUAL=new ce("visual");class Ei{constructor(e){this.algorithm=e.algorithm,this.compression=e.compression,this.originalLength=e.originalLength,this.profile=e.profile,this.scheme=e.scheme}static deserialize(e){if(e&&e.algorithm)return new Ei({algorithm:e.algorithm,compression:e.compression,originalLength:e.originalLength,profile:e.profile,scheme:e.scheme})}serialize(){const e={algorithm:this.algorithm};return this.compression!==void 0&&(e.compression=this.compression),this.originalLength!==void 0&&(e.originalLength=this.originalLength),this.profile!==void 0&&(e.profile=this.profile),this.scheme!==void 0&&(e.scheme=this.scheme),e}}let ne=class Jt{constructor(e){this.otherProperties=e}get page(){return this.otherProperties.page}static deserialize(e){if(e)return new Jt(e)}serialize(){return this.otherProperties}add(e){const t=Object.assign({},this.otherProperties);for(const i in e)t[i]=e[i];return new Jt(t)}};Object.defineProperty(ne.prototype,"encryption",{get:function(){return Ei.deserialize(this.otherProperties.encrypted)}});function Gn(r){return r&&Array.isArray(r)?r:void 0}function ir(r){return r&&typeof r=="string"?[r]:Gn(r)}function ts(r){return typeof r=="string"?new Date(r):void 0}function dt(r){return isNaN(r)?void 0:r}function $(r){return dt(r)!==void 0&&Math.sign(r)>=0?r:void 0}function Xn(r){const e=new Array;return r.forEach(t=>e.push(t)),e}class v{constructor(e){let t,i,s=e.mediaType.replace(/\s/g,"").split(";");const n=s[0].split("/");if(n.length===2){if(t=n[0].toLowerCase().trim(),i=n[1].toLowerCase().trim(),t.length===0||i.length===0)throw new Error("Invalid media type")}else throw new Error("Invalid media type");const o={};for(let p=1;p<s.length;p++){const g=s[p].split("=");if(g.length===2){const c=g[0].toLocaleLowerCase(),m=c==="charset"?g[1].toUpperCase():g[1];o[c]=m}}const a={},l=Object.keys(o);l.sort((p,g)=>p.localeCompare(g)),l.forEach(p=>a[p]=o[p]);let h="";for(const p in a){const g=a[p];h+=`;${p}=${g}`}const u=`${t}/${i}${h}`,d=a.encoding;this.string=u,this.type=t,this.subtype=i,this.parameters=a,this.encoding=d,this.name=e.name,this.fileExtension=e.fileExtension}static parse(e){return new v(e)}get structuredSyntaxSuffix(){const e=this.subtype.split("+");return e.length>1?`+${e[e.length-1]}`:void 0}get charset(){return this.parameters.charset}contains(e){const t=typeof e=="string"?v.parse({mediaType:e}):e;if(!((this.type==="*"||this.type===t.type)&&(this.subtype==="*"||this.subtype===t.subtype)))return!1;const i=new Set(Object.entries(this.parameters).map(([n,o])=>`${n}=${o}`)),s=new Set(Object.entries(t.parameters).map(([n,o])=>`${n}=${o}`));for(const n of Array.from(i.values()))if(!s.has(n))return!1;return!0}matches(e){const t=typeof e=="string"?v.parse({mediaType:e}):e;return this.contains(t)||t.contains(this)}matchesAny(...e){for(const t of e)if(this.matches(t))return!0;return!1}equals(e){return this.string===e.string}get isZIP(){return this.matchesAny(v.ZIP,v.LCP_PROTECTED_AUDIOBOOK,v.LCP_PROTECTED_PDF)||this.structuredSyntaxSuffix==="+zip"}get isJSON(){return this.matchesAny(v.JSON)||this.structuredSyntaxSuffix==="+json"}get isOPDS(){return this.matchesAny(v.OPDS1,v.OPDS1_ENTRY,v.OPDS2,v.OPDS2_PUBLICATION,v.OPDS_AUTHENTICATION)||this.structuredSyntaxSuffix==="+json"}get isHTML(){return this.matchesAny(v.HTML,v.XHTML)}get isBitmap(){return this.matchesAny(v.BMP,v.GIF,v.JPEG,v.PNG,v.TIFF,v.WEBP)}get isAudio(){return this.type==="audio"}get isVideo(){return this.type==="video"}get isRWPM(){return this.matchesAny(v.READIUM_AUDIOBOOK_MANIFEST,v.DIVINA_MANIFEST,v.READIUM_WEBPUB_MANIFEST)}get isPublication(){return this.matchesAny(v.READIUM_AUDIOBOOK,v.READIUM_AUDIOBOOK_MANIFEST,v.CBZ,v.DIVINA,v.DIVINA_MANIFEST,v.EPUB,v.LCP_PROTECTED_AUDIOBOOK,v.LCP_PROTECTED_PDF,v.LPF,v.PDF,v.W3C_WPUB_MANIFEST,v.READIUM_WEBPUB,v.READIUM_WEBPUB_MANIFEST,v.ZAB)}static get AAC(){return v.parse({mediaType:"audio/aac",fileExtension:"aac"})}static get ACSM(){return v.parse({mediaType:"application/vnd.adobe.adept+xml",name:"Adobe Content Server Message",fileExtension:"acsm"})}static get AIFF(){return v.parse({mediaType:"audio/aiff",fileExtension:"aiff"})}static get AVI(){return v.parse({mediaType:"video/x-msvideo",fileExtension:"avi"})}static get BINARY(){return v.parse({mediaType:"application/octet-stream"})}static get BMP(){return v.parse({mediaType:"image/bmp",fileExtension:"bmp"})}static get CBZ(){return v.parse({mediaType:"application/vnd.comicbook+zip",name:"Comic Book Archive",fileExtension:"cbz"})}static get CSS(){return v.parse({mediaType:"text/css",fileExtension:"css"})}static get DIVINA(){return v.parse({mediaType:"application/divina+zip",name:"Digital Visual Narratives",fileExtension:"divina"})}static get DIVINA_MANIFEST(){return v.parse({mediaType:"application/divina+json",name:"Digital Visual Narratives",fileExtension:"json"})}static get EPUB(){return v.parse({mediaType:"application/epub+zip",name:"EPUB",fileExtension:"epub"})}static get GIF(){return v.parse({mediaType:"image/gif",fileExtension:"gif"})}static get GZ(){return v.parse({mediaType:"application/gzip",fileExtension:"gz"})}static get HTML(){return v.parse({mediaType:"text/html",fileExtension:"html"})}static get JAVASCRIPT(){return v.parse({mediaType:"text/javascript",fileExtension:"js"})}static get JPEG(){return v.parse({mediaType:"image/jpeg",fileExtension:"jpeg"})}static get JSON(){return v.parse({mediaType:"application/json"})}static get LCP_LICENSE_DOCUMENT(){return v.parse({mediaType:"application/vnd.readium.lcp.license.v1.0+json",name:"LCP License",fileExtension:"lcpl"})}static get LCP_PROTECTED_AUDIOBOOK(){return v.parse({mediaType:"application/audiobook+lcp",name:"LCP Protected Audiobook",fileExtension:"lcpa"})}static get LCP_PROTECTED_PDF(){return v.parse({mediaType:"application/pdf+lcp",name:"LCP Protected PDF",fileExtension:"lcpdf"})}static get LCP_STATUS_DOCUMENT(){return v.parse({mediaType:"application/vnd.readium.license.status.v1.0+json"})}static get LPF(){return v.parse({mediaType:"application/lpf+zip",fileExtension:"lpf"})}static get MP3(){return v.parse({mediaType:"audio/mpeg",fileExtension:"mp3"})}static get MPEG(){return v.parse({mediaType:"video/mpeg",fileExtension:"mpeg"})}static get NCX(){return v.parse({mediaType:"application/x-dtbncx+xml",fileExtension:"ncx"})}static get OGG(){return v.parse({mediaType:"audio/ogg",fileExtension:"oga"})}static get OGV(){return v.parse({mediaType:"video/ogg",fileExtension:"ogv"})}static get OPDS1(){return v.parse({mediaType:"application/atom+xml;profile=opds-catalog"})}static get OPDS1_ENTRY(){return v.parse({mediaType:"application/atom+xml;type=entry;profile=opds-catalog"})}static get OPDS2(){return v.parse({mediaType:"application/opds+json"})}static get OPDS2_PUBLICATION(){return v.parse({mediaType:"application/opds-publication+json"})}static get OPDS_AUTHENTICATION(){return v.parse({mediaType:"application/opds-authentication+json"})}static get OPUS(){return v.parse({mediaType:"audio/opus",fileExtension:"opus"})}static get OTF(){return v.parse({mediaType:"font/otf",fileExtension:"otf"})}static get PDF(){return v.parse({mediaType:"application/pdf",name:"PDF",fileExtension:"pdf"})}static get PNG(){return v.parse({mediaType:"image/png",fileExtension:"png"})}static get READIUM_AUDIOBOOK(){return v.parse({mediaType:"application/audiobook+zip",name:"Readium Audiobook",fileExtension:"audiobook"})}static get READIUM_AUDIOBOOK_MANIFEST(){return v.parse({mediaType:"application/audiobook+json",name:"Readium Audiobook",fileExtension:"json"})}static get READIUM_CONTENT_DOCUMENT(){return v.parse({mediaType:"application/vnd.readium.content+json",name:"Readium Content Document",fileExtension:"json"})}static get READIUM_GUIDED_NAVIGATION_DOCUMENT(){return v.parse({mediaType:"application/guided-navigation+json",name:"Readium Guided Navigation Document",fileExtension:"json"})}static get READIUM_POSITION_LIST(){return v.parse({mediaType:"application/vnd.readium.position-list+json",name:"Readium Position List",fileExtension:"json"})}static get READIUM_WEBPUB(){return v.parse({mediaType:"application/webpub+zip",name:"Readium Web Publication",fileExtension:"webpub"})}static get READIUM_WEBPUB_MANIFEST(){return v.parse({mediaType:"application/webpub+json",name:"Readium Web Publication",fileExtension:"json"})}static get SMIL(){return v.parse({mediaType:"application/smil+xml",fileExtension:"smil"})}static get SVG(){return v.parse({mediaType:"image/svg+xml",fileExtension:"svg"})}static get TEXT(){return v.parse({mediaType:"text/plain",fileExtension:"txt"})}static get TIFF(){return v.parse({mediaType:"image/tiff",fileExtension:"tiff"})}static get TTF(){return v.parse({mediaType:"font/ttf",fileExtension:"ttf"})}static get W3C_WPUB_MANIFEST(){return v.parse({mediaType:"application/x.readium.w3c.wpub+json",name:"Web Publication",fileExtension:"json"})}static get WAV(){return v.parse({mediaType:"audio/wav",fileExtension:"wav"})}static get WEBM_AUDIO(){return v.parse({mediaType:"audio/webm",fileExtension:"webm"})}static get WEBM_VIDEO(){return v.parse({mediaType:"video/webm",fileExtension:"webm"})}static get WEBP(){return v.parse({mediaType:"image/webp",fileExtension:"webp"})}static get WOFF(){return v.parse({mediaType:"font/woff",fileExtension:"woff"})}static get WOFF2(){return v.parse({mediaType:"font/woff2",fileExtension:"woff2"})}static get XHTML(){return v.parse({mediaType:"application/xhtml+xml",fileExtension:"xhtml"})}static get XML(){return v.parse({mediaType:"application/xml",fileExtension:"xml"})}static get ZAB(){return v.parse({mediaType:"application/x.readium.zab+zip",name:"Zipped Audio Book",fileExtension:"zab"})}static get ZIP(){return v.parse({mediaType:"application/zip",fileExtension:"zip"})}}let is=class{constructor(e){this.uri=e,this.parameters=this.getParameters(e)}getParameters(e){const t=/\{\??([^}]+)\}/g,i=e.match(t);return i?new Set(i.join(",").replace(t,"$1").split(",").map(s=>s.trim())):new Set}expand(e){const t=s=>s.split(",").map(n=>{const o=e[n];return o?encodeURIComponent(o):""}).join(","),i=s=>"?"+s.split(",").map(n=>{const o=n.split("=")[0],a=e[o];return a?`${o}=${encodeURIComponent(a)}`:""}).join("&");return this.uri.replace(/\{(\??)([^}]+)\}/g,(...s)=>s[1]?i(s[2]):t(s[2]))}},N=class sr{constructor(e){this.fragments=e.fragments?e.fragments:new Array,this.progression=e.progression,this.totalProgression=e.totalProgression,this.position=e.position,this.otherLocations=e.otherLocations}static deserialize(e){if(!e)return;const t=dt(e.progression),i=dt(e.totalProgression),s=dt(e.position),n=new Map,o=new Set(["fragment","fragments","progression","totalProgression","position"]);return Object.entries(e).forEach(([a,l])=>{o.has(a)||n.set(a,l)}),new sr({fragments:ir(e.fragments||e.fragment),progression:t!==void 0&&t>=0&&t<=1?t:void 0,totalProgression:i!==void 0&&i>=0&&i<=1?i:void 0,position:s!==void 0&&s>0?s:void 0,otherLocations:n.size===0?void 0:n})}serialize(){const e={};return this.fragments&&(e.fragments=this.fragments),this.progression!==void 0&&(e.progression=this.progression),this.totalProgression!==void 0&&(e.totalProgression=this.totalProgression),this.position!==void 0&&(e.position=this.position),this.otherLocations&&this.otherLocations.forEach((t,i)=>e[i]=t),e}},et=class rr{constructor(e){this.after=e.after,this.before=e.before,this.highlight=e.highlight}static deserialize(e){if(e)return new rr({after:e.after,before:e.before,highlight:e.highlight})}serialize(){const e={};return this.after!==void 0&&(e.after=this.after),this.before!==void 0&&(e.before=this.before),this.highlight!==void 0&&(e.highlight=this.highlight),e}},Be=class Kt{constructor(e){this.href=e.href,this.type=e.type,this.title=e.title,this.locations=e.locations?e.locations:new N({}),this.text=e.text}static deserialize(e){if(e&&e.href&&e.type)return new Kt({href:e.href,type:e.type,title:e.title,locations:N.deserialize(e.locations),text:et.deserialize(e.text)})}serialize(){const e={href:this.href,type:this.type};return this.title!==void 0&&(e.title=this.title),this.locations&&(e.locations=this.locations.serialize()),this.text&&(e.text=this.text.serialize()),e}copyWithLocations(e){return new Kt({href:this.href,type:this.type,title:this.title,text:this.text,locations:new N({...this.locations,...e})})}},nr=class ut{constructor(e){this.href=e.href,this.templated=e.templated,this.type=e.type,this.title=e.title,this.rels=e.rels,this.properties=e.properties,this.height=e.height,this.width=e.width,this.size=e.size,this.duration=e.duration,this.bitrate=e.bitrate,this.languages=e.languages,this.alternates=e.alternates,this.children=e.children}static deserialize(e){if(!(!e||typeof e.href!="string"))return new ut({href:e.href,templated:e.templated,type:e.type,title:e.title,rels:e.rel?Array.isArray(e.rel)?new Set(e.rel):new Set([e.rel]):void 0,properties:ne.deserialize(e.properties),height:$(e.height),width:$(e.width),size:$(e.size),duration:$(e.duration),bitrate:$(e.bitrate),languages:ir(e.language),alternates:ss.deserialize(e.alternate),children:ss.deserialize(e.children)})}serialize(){const e={href:this.href};return this.templated!==void 0&&(e.templated=this.templated),this.type!==void 0&&(e.type=this.type),this.title!==void 0&&(e.title=this.title),this.rels&&(e.rel=Xn(this.rels)),this.properties&&(e.properties=this.properties.serialize()),this.height!==void 0&&(e.height=this.height),this.width!==void 0&&(e.width=this.width),this.size!==void 0&&(e.size=this.size),this.duration!==void 0&&(e.duration=this.duration),this.bitrate!==void 0&&(e.bitrate=this.bitrate),this.languages&&(e.language=this.languages),this.alternates&&(e.alternate=this.alternates.serialize()),this.children&&(e.children=this.children.serialize()),e}get mediaType(){return this.type!==void 0?v.parse({mediaType:this.type}):v.BINARY}toURL(e){const t=this.href.replace(/^(\/)/,"");if(t.length===0)return;let i=e||"/";return i.startsWith("/")&&(i="file://"+i),new URL(t,i).href.replace(/^(file:\/\/)/,"")}get templateParameters(){return this.templated?new is(this.href).parameters:new Set}expandTemplate(e){return new ut({href:new is(this.href).expand(e),templated:!1})}addProperties(e){const t=ut.deserialize(this.serialize());return t.properties=t.properties?t.properties?.add(e):new ne(e),t}get locator(){let e=this.href.split("#");return new Be({href:e.length>0&&e[0]!==void 0?e[0]:this.href,type:this.type??"",title:this.title,locations:new N({fragments:e.length>1&&e[1]!==void 0?[e[1]]:[]})})}},ss=class or{constructor(e){this.items=e}static deserialize(e){if(e&&Array.isArray(e))return new or(e.map(t=>nr.deserialize(t)).filter(t=>t!==void 0))}serialize(){return this.items.map(e=>e.serialize())}findWithRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.find(t)}filterByRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.filter(t)}findWithHref(e){const t=i=>i.href===e;return this.items.find(t)}findIndexWithHref(e){const t=i=>i.href===e;return this.items.findIndex(t)}findWithMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.find(t)}filterByMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.filter(t)}filterByMediaTypes(e){const t=i=>{for(const s of e)if(i.mediaType.matches(s))return!0;return!1};return this.items.filter(t)}everyIsAudio(){const e=t=>t.mediaType.isAudio;return this.items.length>0&&this.items.every(e)}everyIsBitmap(){const e=t=>t.mediaType.isBitmap;return this.items.length>0&&this.items.every(e)}everyIsHTML(){const e=t=>t.mediaType.isHTML;return this.items.length>0&&this.items.every(e)}everyIsVideo(){const e=t=>t.mediaType.isVideo;return this.items.length>0&&this.items.every(e)}everyMatchesMediaType(e){return Array.isArray(e)?this.items.length>0&&this.items.every(t=>{for(const i of e)return t.mediaType.matches(i);return!1}):this.items.length>0&&this.items.every(t=>t.mediaType.matches(e))}filterLinksHasType(){return this.items.filter(e=>e.type)}};ne.prototype.getContains=function(){return new Set(this.otherProperties.contains||[])};let rs=class ar{constructor(e){this.cssSelector=e.cssSelector,this.textNodeIndex=e.textNodeIndex,this.charOffset=e.charOffset}static deserialize(e){if(!(e&&e.cssSelector))return;let t=$(e.textNodeIndex);if(t===void 0)return;let i=$(e.charOffset);return i===void 0&&(i=$(e.offset)),new ar({cssSelector:e.cssSelector,textNodeIndex:t,charOffset:i})}serialize(){const e={cssSelector:this.cssSelector,textNodeIndex:this.textNodeIndex};return this.charOffset!==void 0&&(e.charOffset=this.charOffset),e}},Yn=class lr{constructor(e){this.start=e.start,this.end=e.end}static deserialize(e){if(!e)return;let t=rs.deserialize(e.start);if(t)return new lr({start:t,end:rs.deserialize(e.end)})}serialize(){const e={start:this.start.serialize()};return this.end&&(e.end=this.end.serialize()),e}};N.prototype.getCssSelector=function(){return this.otherLocations?.get("cssSelector")};N.prototype.getPartialCfi=function(){return this.otherLocations?.get("partialCfi")};N.prototype.getDomRange=function(){return Yn.deserialize(this.otherLocations?.get("domRange"))};N.prototype.fragmentParameters=function(){return new Map(this.fragments.map(r=>r.startsWith("#")?r.slice(1):r).join("&").split("&").filter(r=>!r.startsWith("#")).map(r=>r.split("=")).filter(r=>r.length===2).map(r=>[r[0].trim().toLowerCase(),r[1].trim()]))};N.prototype.htmlId=function(){if(!this.fragments.length)return;let r=this.fragments.find(e=>e.length&&!e.includes("="));if(!r){const e=this.fragmentParameters();e.has("id")?r=e.get("id"):e.has("name")&&(r=e.get("name"))}return r?.startsWith("#")?r.slice(1):r};N.prototype.page=function(){const r=parseInt(this.fragmentParameters().get("page"));if(!isNaN(r)&&r>=0)return r};N.prototype.time=function(){const r=parseInt(this.fragmentParameters().get("t"));if(!isNaN(r))return r};N.prototype.space=function(){const r=this.fragmentParameters();if(!r.has("xywh"))return;const e=r.get("xywh").split(",").map(t=>parseInt(t));if(e.length===4&&!e.some(isNaN))return e};let qn=class hr{constructor(e){this.currency=e.currency,this.value=e.value}static deserialize(e){if(!e)return;let t=e.currency;if(!(t&&typeof t=="string"&&t.length>0))return;let i=$(e.value);if(i!==void 0)return new hr({currency:t,value:i})}serialize(){return{currency:this.currency,value:this.value}}};class Xe{constructor(e){this.type=e.type,this.children=e.children}static deserialize(e){if(e&&e.type)return new Xe({type:e.type,children:Xe.deserializeArray(e.children)})}static deserializeArray(e){if(Array.isArray(e))return e.map(t=>Xe.deserialize(t)).filter(t=>t!==void 0)}serialize(){const e={type:this.type};return this.children&&(e.children=this.children.map(t=>t.serialize())),e}}let Jn=class cr{constructor(e){this.total=e.total,this.position=e.position}static deserialize(e){if(e)return new cr({total:$(e.total),position:$(e.position)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.position!==void 0&&(e.position=this.position),e}};class xi{constructor(e){this.total=e.total,this.available=e.available}static deserialize(e){if(e)return new xi({total:$(e.total),available:$(e.available)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.available!==void 0&&(e.available=this.available),e}}let Kn=class dr{constructor(e){this.state=e.state,this.since=e.since,this.until=e.until}static deserialize(e){if(e&&e.state)return new dr({state:e.state,since:ts(e.since),until:ts(e.until)})}serialize(){const e={state:this.state};return this.since!==void 0&&(e.since=this.since.toISOString()),this.until!==void 0&&(e.until=this.until.toISOString()),e}};ne.prototype.getNumberOfItems=function(){return $(this.otherProperties.numberOfItems)};ne.prototype.getPrice=function(){return qn.deserialize(this.otherProperties.price)};ne.prototype.getIndirectAcquisitions=function(){const r=this.otherProperties.indirectAcquisition;if(r&&Array.isArray(r))return r.map(e=>Xe.deserialize(e)).filter(e=>e!==void 0)};ne.prototype.getHolds=function(){return Jn.deserialize(this.otherProperties.holds)};ne.prototype.getCopies=function(){return xi.deserialize(this.otherProperties.copies)};ne.prototype.getAvailability=function(){return Kn.deserialize(this.otherProperties.availability)};ne.prototype.getAuthenticate=function(){return nr.deserialize(this.otherProperties.authenticate)};const Zn="CssSelectorGenerator";function ns(r="unknown problem",...e){console.warn(`${Zn}: ${r}`,...e)}function Qn(r){return r instanceof RegExp}function eo(r){return r.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".+")}function to(r){const e=r.map(t=>{if(Qn(t))return i=>t.test(i);if(typeof t=="function")return i=>{const s=t(i);return typeof s!="boolean"?(ns("pattern matcher function invalid","Provided pattern matching function does not return boolean. It's result will be ignored.",t),!1):s};if(typeof t=="string"){const i=new RegExp("^"+eo(t)+"$");return s=>i.test(s)}return ns("pattern matcher invalid","Pattern matching only accepts strings, regular expressions and/or functions. This item is invalid and will be ignored.",t),()=>!1});return t=>e.some(i=>i(t))}to(["class","id","ng-*"]);let tt=class{};function os(r){return r.split("").reverse().join("")}function io(r,e,t){const i=os(e);return t.map(s=>{const n=Math.max(0,s.end-e.length-s.errors),o=os(r.slice(n,s.end));return{start:ur(o,i,s.errors).reduce((a,l)=>s.end-l.end<a?s.end-l.end:a,s.end),end:s.end,errors:s.errors}})}function $t(r){return(r|-r)>>31&1}function as(r,e,t,i){let s=r.P[t],n=r.M[t];const o=i>>>31,a=e[t]|o,l=a|n,h=(a&s)+s^s|a;let u=n|~(h|s),d=s&h;const p=$t(u&r.lastRowMask[t])-$t(d&r.lastRowMask[t]);return u<<=1,d<<=1,d|=o,u|=$t(i)-o,s=d|~(l|u),n=u&l,r.P[t]=s,r.M[t]=n,p}function ur(r,e,t){if(e.length===0)return[];t=Math.min(t,e.length);const i=[],s=32,n=Math.ceil(e.length/s)-1,o={P:new Uint32Array(n+1),M:new Uint32Array(n+1),lastRowMask:new Uint32Array(n+1)};o.lastRowMask.fill(1<<31),o.lastRowMask[n]=1<<(e.length-1)%s;const a=new Uint32Array(n+1),l=new Map,h=[];for(let p=0;p<256;p++)h.push(a);for(let p=0;p<e.length;p+=1){const g=e.charCodeAt(p);if(l.has(g))continue;const c=new Uint32Array(n+1);l.set(g,c),g<h.length&&(h[g]=c);for(let m=0;m<=n;m+=1){c[m]=0;for(let b=0;b<s;b+=1){const x=m*s+b;x>=e.length||e.charCodeAt(x)===g&&(c[m]|=1<<b)}}}let u=Math.max(0,Math.ceil(t/s)-1);const d=new Uint32Array(n+1);for(let p=0;p<=u;p+=1)d[p]=(p+1)*s;d[n]=e.length;for(let p=0;p<=u;p+=1)o.P[p]=-1,o.M[p]=0;for(let p=0;p<r.length;p+=1){const g=r.charCodeAt(p);let c;g<h.length?c=h[g]:(c=l.get(g),typeof c>"u"&&(c=a));let m=0;for(let b=0;b<=u;b+=1)m=as(o,c,b,m),d[b]+=m;if(d[u]-m<=t&&u<n&&(c[u+1]&1||m<0)){u+=1,o.P[u]=-1,o.M[u]=0;let b;if(u===n){const x=e.length%s;b=x===0?s:x}else b=s;d[u]=d[u-1]+b-m+as(o,c,u,m)}else for(;u>0&&d[u]>=t+s;)u-=1;u===n&&d[u]<=t&&(d[u]<t&&i.splice(0,i.length),i.push({start:-1,end:p+1,errors:d[u]}),t=d[u])}return i}function so(r,e,t){const i=ur(r,e,t);return io(r,e,i)}function pr(r,e,t){let i=0;const s=[];for(;i!==-1;)i=r.indexOf(e,i),i!==-1&&(s.push({start:i,end:i+e.length,errors:0}),i+=1);return s.length>0?s:so(r,e,t)}function ls(r,e){return e.length===0||r.length===0?0:1-pr(r,e,e.length)[0].errors/e.length}function ro(r,e,t={}){if(e.length===0)return null;const i=Math.min(256,e.length/2),s=pr(r,e,i);if(s.length===0)return null;const n=a=>{const l=1-a.errors/e.length,h=t.prefix?ls(r.slice(Math.max(0,a.start-t.prefix.length),a.start),t.prefix):1,u=t.suffix?ls(r.slice(a.end,a.end+t.suffix.length),t.suffix):1;let d=1;return typeof t.hint=="number"&&(d=1-Math.abs(a.start-t.hint)/r.length),(50*l+20*h+20*u+2*d)/92},o=s.map(a=>({start:a.start,end:a.end,score:n(a)}));return o.sort((a,l)=>l.score-a.score),o[0]}function Zt(r,e,t){const i=t===1?e:e-1;if(r.charAt(i).trim()!=="")return e;let s,n;if(t===2?(s=r.substring(0,e),n=s.trimEnd()):(s=r.substring(e),n=s.trimStart()),!n.length)return-1;const o=s.length-n.length;return t===2?e-o:e+o}function hs(r,e){const t=r.commonAncestorContainer.ownerDocument.createNodeIterator(r.commonAncestorContainer,NodeFilter.SHOW_TEXT),i=e===1?r.startContainer:r.endContainer,s=e===1?r.endContainer:r.startContainer;let n=t.nextNode();for(;n&&n!==i;)n=t.nextNode();e===2&&(n=t.previousNode());let o=-1;const a=()=>{if(n=e===1?t.nextNode():t.previousNode(),n){const l=n.textContent,h=e===1?0:l.length;o=Zt(l,h,e)}};for(;n&&o===-1&&n!==s;)a();if(n&&o>=0)return{node:n,offset:o};throw new RangeError("No text nodes with non-whitespace text found in range")}function no(r){if(!r.toString().trim().length)throw new RangeError("Range contains no non-whitespace text");if(r.startContainer.nodeType!==Node.TEXT_NODE)throw new RangeError("Range startContainer is not a text node");if(r.endContainer.nodeType!==Node.TEXT_NODE)throw new RangeError("Range endContainer is not a text node");const e=r.cloneRange();let t=!1,i=!1;const s={start:Zt(r.startContainer.textContent,r.startOffset,1),end:Zt(r.endContainer.textContent,r.endOffset,2)};if(s.start>=0&&(e.setStart(r.startContainer,s.start),t=!0),s.end>0&&(e.setEnd(r.endContainer,s.end),i=!0),t&&i)return e;if(!t){const{node:n,offset:o}=hs(e,1);n&&o>=0&&e.setStart(n,o)}if(!i){const{node:n,offset:o}=hs(e,2);n&&o>0&&e.setEnd(n,o)}return e}function mr(r){switch(r.nodeType){case Node.ELEMENT_NODE:case Node.TEXT_NODE:return r.textContent?.length??0;default:return 0}}function cs(r){let e=r.previousSibling,t=0;for(;e;)t+=mr(e),e=e.previousSibling;return t}function gr(r,...e){let t=e.shift();const i=r.ownerDocument.createNodeIterator(r,NodeFilter.SHOW_TEXT),s=[];let n=i.nextNode(),o,a=0;for(;t!==void 0&&n;)o=n,a+o.data.length>t?(s.push({node:o,offset:t-a}),t=e.shift()):(n=i.nextNode(),a+=o.data.length);for(;t!==void 0&&o&&a===t;)s.push({node:o,offset:o.data.length}),t=e.shift();if(t!==void 0)throw new RangeError("Offset exceeds text length");return s}let at=class _e{constructor(e,t){if(t<0)throw new Error("Offset is invalid");this.element=e,this.offset=t}relativeTo(e){if(!e.contains(this.element))throw new Error("Parent is not an ancestor of current element");let t=this.element,i=this.offset;for(;t!==e;)i+=cs(t),t=t.parentElement;return new _e(t,i)}resolve(e={}){try{return gr(this.element,this.offset)[0]}catch(t){if(this.offset===0&&e.direction!==void 0){const i=document.createTreeWalker(this.element.getRootNode(),NodeFilter.SHOW_TEXT);i.currentNode=this.element;const s=e.direction===1,n=s?i.nextNode():i.previousNode();if(!n)throw t;return{node:n,offset:s?0:n.data.length}}else throw t}}static fromCharOffset(e,t){switch(e.nodeType){case Node.TEXT_NODE:return _e.fromPoint(e,t);case Node.ELEMENT_NODE:return new _e(e,t);default:throw new Error("Node is not an element or text node")}}static fromPoint(e,t){switch(e.nodeType){case Node.TEXT_NODE:{if(t<0||t>e.data.length)throw new Error("Text node offset is out of range");if(!e.parentElement)throw new Error("Text node has no parent");const i=cs(e)+t;return new _e(e.parentElement,i)}case Node.ELEMENT_NODE:{if(t<0||t>e.childNodes.length)throw new Error("Child node offset is out of range");let i=0;for(let s=0;s<t;s++)i+=mr(e.childNodes[s]);return new _e(e,i)}default:throw new Error("Point is not in an element or text node")}}},Qt=class He{constructor(e,t){this.start=e,this.end=t}relativeTo(e){return new He(this.start.relativeTo(e),this.end.relativeTo(e))}toRange(){let e,t;this.start.element===this.end.element&&this.start.offset<=this.end.offset?[e,t]=gr(this.start.element,this.start.offset,this.end.offset):(e=this.start.resolve({direction:1}),t=this.end.resolve({direction:2}));const i=new Range;return i.setStart(e.node,e.offset),i.setEnd(t.node,t.offset),i}static fromRange(e){const t=at.fromPoint(e.startContainer,e.startOffset),i=at.fromPoint(e.endContainer,e.endOffset);return new He(t,i)}static fromOffsets(e,t,i){return new He(new at(e,t),new at(e,i))}static trimmedRange(e){return no(He.fromRange(e).toRange())}},oo=class ei{constructor(e,t,i){this.root=e,this.start=t,this.end=i}static fromRange(e,t){const i=Qt.fromRange(t).relativeTo(e);return new ei(e,i.start.offset,i.end.offset)}static fromSelector(e,t){return new ei(e,t.start,t.end)}toSelector(){return{type:"TextPositionSelector",start:this.start,end:this.end}}toRange(){return Qt.fromOffsets(this.root,this.start,this.end).toRange()}},ao=class ti{constructor(e,t,i={}){this.root=e,this.exact=t,this.context=i}static fromRange(e,t){const i=e.textContent,s=Qt.fromRange(t).relativeTo(e),n=s.start.offset,o=s.end.offset,a=32;return new ti(e,i.slice(n,o),{prefix:i.slice(Math.max(0,n-a),n),suffix:i.slice(o,Math.min(i.length,o+a))})}static fromSelector(e,t){const{prefix:i,suffix:s}=t;return new ti(e,t.exact,{prefix:i,suffix:s})}toSelector(){return{type:"TextQuoteSelector",exact:this.exact,prefix:this.context.prefix,suffix:this.context.suffix}}toRange(e={}){return this.toPositionAnchor(e).toRange()}toPositionAnchor(e={}){const t=this.root.textContent,i=ro(t,this.exact,{...this.context,hint:e.hint});if(!i)throw new Error("Quote not found");return new oo(this.root,i.start,i.end)}};function lo(r){const e=r.tagName.toUpperCase();return e==="IMG"||e==="VIDEO"||e==="AUDIO"||e==="IFRAME"||e==="OBJECT"||e==="EMBED"||e==="CANVAS"}function Ft(r,e){try{const t=e.locations,i=e.text;if(i&&i.highlight){let s;t&&t.getCssSelector()&&(s=r.querySelector(t.getCssSelector())),s||(s=r.body);const n=new ao(s,i.highlight,{prefix:i.before,suffix:i.after});try{return n.toRange()}catch{return console.warn("Quote not found:",n),null}}if(t){let s=null;if(!s&&t.getCssSelector()&&(s=r.querySelector(t.getCssSelector())),!s&&t.fragments){for(const n of t.fragments)if(s=r.getElementById(n),s)break}if(s){const n=r.createRange();return s.childNodes.length===0||lo(s)?(n.selectNode(s),n):(n.setStartBefore(s),n.setEndAfter(s),n)}}}catch(t){console.error(t)}return null}function ho(r,e){let t=r.getClientRects();t.length||r.commonAncestorContainer.nodeType===Node.ELEMENT_NODE&&(t=r.commonAncestorContainer.getClientRects());const i=1,s=[];for(const h of t)s.push({bottom:h.bottom,height:h.height,left:h.left,right:h.right,top:h.top,width:h.width});const n=fr(s,i),o=uo(n,i),a=yr(o),l=4;for(let h=a.length-1;h>=0;h--){const u=a[h];if(!(u.width*u.height>l))if(a.length>1)a.splice(h,1);else break}return a}function fr(r,e,t){for(let i=0;i<r.length;i++)for(let s=i+1;s<r.length;s++){const n=r[i],o=r[s];if(n===o)continue;const a=te(n.top,o.top,e)&&te(n.bottom,o.bottom,e),l=te(n.left,o.left,e)&&te(n.right,o.right,e);if(a&&!l&&vr(n,o,e)){const h=r.filter(d=>d!==n&&d!==o),u=co(n,o);return h.push(u),fr(h,e)}}return r}function co(r,e){const t=Math.min(r.left,e.left),i=Math.max(r.right,e.right),s=Math.min(r.top,e.top),n=Math.max(r.bottom,e.bottom);return{bottom:n,height:n-s,left:t,right:i,top:s,width:i-t}}function uo(r,e){const t=new Set(r);for(const i of r){if(!(i.width>1&&i.height>1)){t.delete(i);continue}for(const s of r)if(i!==s&&t.has(s)&&po(s,i,e)){t.delete(i);break}}return Array.from(t)}function po(r,e,t){return lt(r,e.left,e.top,t)&&lt(r,e.right,e.top,t)&&lt(r,e.left,e.bottom,t)&&lt(r,e.right,e.bottom,t)}function lt(r,e,t,i){return(r.left<e||te(r.left,e,i))&&(r.right>e||te(r.right,e,i))&&(r.top<t||te(r.top,t,i))&&(r.bottom>t||te(r.bottom,t,i))}function yr(r){for(let e=0;e<r.length;e++)for(let t=e+1;t<r.length;t++){const i=r[e],s=r[t];if(i!==s&&vr(i,s,-1)){let n=[],o;const a=ds(i,s);if(a.length===1)n=a,o=i;else{const h=ds(s,i);a.length<h.length?(n=a,o=i):(n=h,o=s)}const l=r.filter(h=>h!==o);return Array.prototype.push.apply(l,n),yr(l)}}return r}function ds(r,e){const t=mo(e,r);if(t.height===0||t.width===0)return[r];const i=[];{const s={bottom:r.bottom,height:0,left:r.left,right:t.left,top:r.top,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}{const s={bottom:t.top,height:0,left:t.left,right:t.right,top:r.top,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}{const s={bottom:r.bottom,height:0,left:t.left,right:t.right,top:t.bottom,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}{const s={bottom:r.bottom,height:0,left:t.right,right:r.right,top:r.top,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}return i}function mo(r,e){const t=Math.max(r.left,e.left),i=Math.min(r.right,e.right),s=Math.max(r.top,e.top),n=Math.min(r.bottom,e.bottom);return{bottom:n,height:Math.max(0,n-s),left:t,right:i,top:s,width:Math.max(0,i-t)}}function vr(r,e,t){return(r.left<e.right||t>=0&&te(r.left,e.right,t))&&(e.left<r.right||t>=0&&te(e.left,r.right,t))&&(r.top<e.bottom||t>=0&&te(r.top,e.bottom,t))&&(e.top<r.bottom||t>=0&&te(e.top,r.bottom,t))}function te(r,e,t){return Math.abs(r-e)<=t}function wr(r){const e={},t=r.document.documentElement.style;for(const i in r.document.documentElement.style)Object.hasOwn(t,i)&&!Number.isNaN(Number.parseInt(i))&&(e[t[i]]=t.getPropertyValue(t[i]));return e}function go(r,e){const t=wr(r);Object.keys(t).forEach(i=>{e.hasOwnProperty(i)||Ti(r,i)}),Object.entries(e).forEach(([i,s])=>{t[i]!==s&&Et(r,i,s)})}function us(r,e){return r.document.documentElement.style.getPropertyValue(e)}function Et(r,e,t){r.document.documentElement.style.setProperty(e,t)}function Ti(r,e){r.document.documentElement.style.removeProperty(e)}const fo=r=>{if(r.startsWith("rgb")){const e=r.match(/rgb\((\d+),\s(\d+),\s(\d+)(?:,\s(\d+))?\)/);if(e)return{r:parseInt(e[1],10),g:parseInt(e[2],10),b:parseInt(e[3],10),a:e[4]?parseInt(e[4],10)/255:1}}else if(r.startsWith("#")){const e=r.slice(1);if(e.length===3||e.length===4)return{r:parseInt(e[0]+e[0],16)/255,g:parseInt(e[1]+e[1],16)/255,b:parseInt(e[2]+e[2],16)/255,a:e.length===4?parseInt(e[3]+e[3],16)/255:1};if(e.length===6||e.length===8)return{r:parseInt(e[0]+e[1],16)/255,g:parseInt(e[2]+e[3],16)/255,b:parseInt(e[4]+e[5],16)/255,a:e.length===8?parseInt(e[6]+e[7],16)/255:1}}return{r:0,g:0,b:0,a:1}},yo=r=>.2126*r.r*r.a+.7152*r.g*r.a+.0722*r.b*r.a,vo=r=>{const e=fo(r);return yo(e)<128},wo=()=>"Highlight"in window,ps=["IMG","IMAGE","AUDIO","VIDEO","SVG"];let So=class{constructor(e,t,i,s){this.wnd=e,this.comms=t,this.id=i,this.name=s,this.items=[],this.lastItemId=0,this.container=void 0,this.activateable=!1,this.experimentalHighlights=!1,this.currentRender=0,wo()&&(this.experimentalHighlights=!0,this.notTextFlag=new Map)}get activeable(){return this.activateable}set activeable(e){this.activateable=e}add(e){const t=`${this.id}-${this.lastItemId++}`,i=Ft(this.wnd.document,e.locator);if(!i){this.comms.log("Can't locate DOM range for decoration",e);return}const s=i.commonAncestorContainer;s.nodeType!==Node.TEXT_NODE&&this.experimentalHighlights&&(ps.includes(s.nodeName.toUpperCase())&&this.notTextFlag?.set(t,!0),s.querySelector(ps.join(", ").toLowerCase())&&this.notTextFlag?.set(t,!0),(s.textContent?.trim()||"").length===0&&this.notTextFlag?.set(t,!0));const n={decoration:e,id:t,range:i};this.items.push(n),this.layout(n),this.renderLayout([n])}remove(e){const t=this.items.findIndex(s=>s.decoration.id===e);if(t<0)return;const i=this.items[t];this.items.splice(t,1),i.clickableElements=void 0,i.container&&(i.container.remove(),i.container=void 0),this.experimentalHighlights&&!this.notTextFlag?.has(i.id)&&this.wnd.CSS.highlights.get(this.id)?.delete(i.range),this.notTextFlag?.delete(i.id)}update(e){this.remove(e.id),this.add(e)}clear(){this.clearContainer(),this.items.length=0,this.notTextFlag?.clear()}requestLayout(){this.wnd.cancelAnimationFrame(this.currentRender),this.clearContainer(),this.items.forEach(e=>this.layout(e)),this.renderLayout(this.items)}experimentalLayout(e){const[t,i]=this.requireContainer(!0);i.add(e.range),t.innerHTML=`
        ::highlight(${this.id}) {
            color: black;
            background-color: ${e.decoration?.style?.tint??"yellow"};
        }`}layout(e){if(this.experimentalHighlights&&!this.notTextFlag?.has(e.id))return this.experimentalLayout(e);const t=this.wnd.document.createElement("div");t.setAttribute("id",e.id),t.style.setProperty("pointer-events","none");const i=this.wnd.innerWidth,s=parseInt(getComputedStyle(this.wnd.document.documentElement).getPropertyValue("column-count")),n=i/(s||1),o=this.wnd.document.scrollingElement,a=o.scrollLeft,l=o.scrollTop,h=(c,m,b)=>{if(c.style.position="absolute",e.decoration?.style?.width==="viewport"){c.style.width=`${i}px`,c.style.height=`${m.height}px`;let x=Math.floor(m.left/i)*i;c.style.left=`${x+a}px`,c.style.top=`${m.top+l}px`}else if(e.decoration?.style?.width==="bounds")c.style.width=`${b.width}px`,c.style.height=`${m.height}px`,c.style.left=`${b.left+a}px`,c.style.top=`${m.top+l}px`;else if(e.decoration?.style?.width==="page"){c.style.width=`${n}px`,c.style.height=`${m.height}px`;let x=Math.floor(m.left/n)*n;c.style.left=`${x+a}px`,c.style.top=`${m.top+l}px`}else c.style.width=`${m.width}px`,c.style.height=`${m.height}px`,c.style.left=`${m.left+a}px`,c.style.top=`${m.top+l}px`},u=e.range.getBoundingClientRect();let d=this.wnd.document.createElement("template");const p=us(this.wnd,"--USER__appearance")==="readium-night-on"||vo(us(this.wnd,"--USER__backgroundColor"));d.innerHTML=`
        <div
            class="r2-highlight-0"
            style="${[`background-color: ${e.decoration?.style?.tint??"yellow"} !important`,`mix-blend-mode: ${p?"exclusion":"multiply"} !important`,"opacity: 1 !important","box-sizing: border-box !important"].join("; ")}"
        >
        </div>
        `.trim();const g=d.content.firstElementChild;if(e.decoration?.style?.layout==="bounds"){const c=g.cloneNode(!0);c.style.setProperty("pointer-events","none"),h(c,u,u),t.append(c)}else{let c=ho(e.range);c=c.sort((m,b)=>m.top<b.top?-1:m.top>b.top?1:0);for(let m of c){const b=g.cloneNode(!0);b.style.setProperty("pointer-events","none"),h(b,m,u),t.append(b)}}e.container=t,e.clickableElements=Array.from(t.querySelectorAll("[data-activable='1']")),e.clickableElements.length||(e.clickableElements=Array.from(t.children))}renderLayout(e){this.wnd.cancelAnimationFrame(this.currentRender),this.currentRender=this.wnd.requestAnimationFrame(()=>{e=e.filter(t=>!this.experimentalHighlights||!!this.notTextFlag?.has(t.id)),!(!e||e.length===0)&&this.requireContainer().append(...e.map(t=>t.container).filter(t=>!!t))})}requireContainer(e=!1){if(e){let t;this.wnd.document.getElementById(`${this.id}-style`)?t=this.wnd.document.getElementById(`${this.id}-style`):(t=this.wnd.document.createElement("style"),t.dataset.readium="true",t.id=`${this.id}-style`,this.wnd.document.head.appendChild(t));let i;return this.wnd.CSS.highlights.has(this.id)?i=this.wnd.CSS.highlights.get(this.id):(i=new this.wnd.Highlight,this.wnd.CSS.highlights.set(this.id,i)),[t,i]}return this.container||(this.container=this.wnd.document.createElement("div"),this.container.setAttribute("id",this.id),this.container.dataset.group=this.name,this.container.dataset.readium="true",this.container.style.setProperty("pointer-events","none"),this.container.style.display="contents",this.wnd.document.body.append(this.container)),this.container}clearContainer(){this.experimentalHighlights&&this.wnd.CSS.highlights.delete(this.id),this.container&&(this.container.remove(),this.container=void 0)}};const Sr=class ii extends tt{constructor(){super(...arguments),this.resizeFrame=0,this.lastGroupId=0,this.groups=new Map,this.handleResizer=this.handleResize.bind(this)}cleanup(){this.groups.forEach(e=>e.clear()),this.groups.clear()}handleResize(){this.wnd.clearTimeout(this.resizeFrame),this.resizeFrame=this.wnd.setTimeout(()=>{this.groups.forEach(e=>{e.experimentalHighlights||e.requestLayout()})},50)}mount(e,t){return this.wnd=e,t.register("decorate",ii.moduleName,(i,s)=>{const n=i;n.decoration&&n.decoration.locator&&(n.decoration.locator=Be.deserialize(n.decoration.locator)),this.groups.has(n.group)||this.groups.set(n.group,new So(e,t,`readium-decoration-${this.lastGroupId++}`,n.group));const o=this.groups.get(n.group);switch(n.action){case"add":o?.add(n.decoration);break;case"remove":o?.remove(n.decoration.id);break;case"clear":o?.clear();break;case"update":o?.update(n.decoration);break}s(!0)}),this.resizeObserver=new ResizeObserver(()=>e.requestAnimationFrame(()=>this.handleResize())),this.resizeObserver.observe(e.document.body),e.addEventListener("orientationchange",this.handleResizer),e.addEventListener("resize",this.handleResizer),t.log("Decorator Mounted"),!0}unmount(e,t){return e.removeEventListener("orientationchange",this.handleResizer),e.removeEventListener("resize",this.handleResizer),t.unregisterAll(ii.moduleName),this.resizeObserver.disconnect(),this.cleanup(),t.log("Decorator Unmounted"),!0}};Sr.moduleName="decorator";let bo=Sr;const ms="readium-snapper-style",br=class si extends tt{constructor(){super(...arguments),this.protected=!1}buildStyles(){return`
        html, body {
            touch-action: manipulation;
            user-select: ${this.protected?"none":"auto"};
        }`}mount(e,t){const i=e.document.createElement("style");return i.dataset.readium="true",i.id=ms,i.textContent=this.buildStyles(),e.document.head.appendChild(i),t.register("protect",si.moduleName,(s,n)=>{this.protected=!0,i.textContent=this.buildStyles(),n(!0)}),t.register("unprotect",si.moduleName,(s,n)=>{this.protected=!1,i.textContent=this.buildStyles(),n(!0)}),t.log("Snapper Mounted"),!0}unmount(e,t){return e.document.getElementById(ms)?.remove(),t.log("Snapper Unmounted"),!0}};br.moduleName="snapper";let Pi=br;function we(r){return r.document.body.dir.toLowerCase()==="rtl"}function Er(r){return parseInt(r.getComputedStyle(r.document.documentElement).getPropertyValue("column-count"))}function Eo(r){const e=getComputedStyle(r),t=parseFloat(e.paddingTop||"0"),i=parseFloat(e.paddingBottom||"0");return r.clientHeight-t-i}function gs(r){const e=Er(r);if(!e)return!1;const t=r.document.querySelectorAll("div[id^='readium-virtual-page']");for(const l of t)l.remove();const i=t.length,s=r.document.scrollingElement.scrollWidth,n=r.visualViewport.width,o=Math.round(s/n*e)%e,a=e===1||o===0?0:e-o;if(a>0)for(let l=0;l<a;l++){const h=r.document.createElement("div");h.setAttribute("id",`readium-virtual-page-${l}`),h.dataset.readium="true",CSS.supports("break-before","column")?h.style.breakBefore="column":(CSS.supports("break-inside","avoid-column")&&(h.style.breakInside="avoid-column"),h.style.height=Eo(r.document.documentElement)+"px"),h.innerHTML="&#8203;",r.document.body.appendChild(h)}return i!==a}function xr(r){const e=r.document.createElement("style");e.appendChild(r.document.createTextNode("*{}")),r.document.body.appendChild(e),r.document.body.removeChild(e)}function xo(r){return r<.5?2*r*r:-1+(4-2*r)*r}function R(r){const e=r.getSelection();e&&e.removeAllRanges()}const To=["a","audio","button","canvas","details","input","label","option","select","submit","textarea","video"];function Tr(r){return To.indexOf(r.nodeName.toLowerCase())!==-1||r.hasAttribute("contenteditable")&&r.getAttribute("contenteditable")?.toLowerCase()!=="false"?r:r.parentElement?Tr(r.parentElement):null}function Ci(r,e){const t=Pr(r,r.document.body,e),i=r._readium_cssSelectorGenerator.getCssSelector(t,{selectors:["tag","id","class","nthchild","nthoftype","attribute"]});return new Be({href:"#",type:"application/xhtml+xml",locations:new N({otherLocations:new Map([["cssSelector",i]])}),text:new et({highlight:t.textContent||void 0})})}function Pr(r,e,t){for(var i=0;i<e.children.length;i++){const s=e.children[i];if(!Ao(s)&&Po(r,s,t))return Co(r,s)?s:Pr(r,s,t)}return e}function Po(r,e,t){if(e===document.body||e===document.documentElement)return!0;if(!document||!document.documentElement||!document.body)return!1;const i=e.getBoundingClientRect();return t?i.bottom>0&&i.top<r.innerHeight:i.right>0&&i.left<r.innerWidth}function Co(r,e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=r.innerHeight&&t.right<=r.innerWidth}function Ao(r){const e=getComputedStyle(r);if(e){const t=e.getPropertyValue("display");if(t!="block"&&t!="list-item"||e.getPropertyValue("opacity")==="0")return!0}return!1}const fs="readium-column-snapper-style",_o=200,Cr=class Y extends Pi{constructor(){super(...arguments),this.shakeTimeout=0,this.snappingCancelled=!1,this.alreadyScrollLeft=0,this.overscroll=0,this.cachedScrollWidth=0,this.touchState=0,this.startingX=void 0,this.endingX=void 0,this.onTouchStarter=this.onTouchStart.bind(this),this.onTouchEnder=this.onTouchEnd.bind(this),this.onWidthChanger=this.onWidthChange.bind(this),this.onTouchMover=this.onTouchMove.bind(this)}doc(){return this.wnd.document.scrollingElement}scrollOffset(){return this.doc().scrollLeft>0?this.doc().scrollLeft:this.alreadyScrollLeft}snapOffset(e){const t=e+(we(this.wnd)?-1:1);return t-t%this.wnd.innerWidth}reportProgress(){const e=this.wnd.scrollX,t=this.cachedScrollWidth,i=Math.max(0,Math.min(1,e/t)),s=Math.max(0,Math.min(1,(e+this.wnd.innerWidth)/t));this.comms.send("progress",{start:i,end:s})}shake(){if(this.overscroll!==0||this.shakeTimeout!==0)return;const e=this.doc();e.classList.add(we(this.wnd)?"readium-bounce-l":"readium-bounce-r");const t=this.scrollOffset();this.shakeTimeout=this.wnd.setTimeout(()=>{e.classList.remove("readium-bounce-l"),e.classList.remove("readium-bounce-r"),this.shakeTimeout=0,this.doc().scrollLeft=t},150)}takeOverSnap(){this.snappingCancelled=!0,this.clearTouches();const e=this.doc();this.overscroll=e.style.transform?.length>12?parseFloat(e.style.transform.slice(12).split("px")[0]):0}snapCurrentOffset(e=!1,t=!1){const i=this.wnd.scrollX>0?this.wnd.scrollX:this.alreadyScrollLeft,s=this.doc(),n=this.dragOffset(),o=Er(this.wnd),a=Math.min(Math.max(0,i),this.cachedScrollWidth),l=we(this.wnd)?-1:1,h=l*(this.wnd.innerWidth/3)*(l*n>0?2:1),u=this.snapOffset(a+h);if(e&&u!==this.scrollOffset()){this.snappingCancelled=!1;const d=(m,b,x,X)=>x>X?b:m+(b-m)*xo(x/X),p=_o*o;let g;const c=m=>{if(this.snappingCancelled)return;g||(g=m);const b=m-g,x=d(this.overscroll,0,b,p),X=d(i,u,b,p);s.scrollLeft=X,this.overscroll!==0&&(s.style.transform=`translate3d(${-x}px, 0px, 0px)`),b<p?this.wnd.requestAnimationFrame(c):(this.clearTouches(),s.style.removeProperty("transform"),s.scrollLeft=u,t||this.reportProgress())};this.wnd.requestAnimationFrame(c)}else s.style.removeProperty("transform"),this.wnd.requestAnimationFrame(()=>{s.scrollLeft=u,this.clearTouches(),t||this.reportProgress()})}dragOffset(){return(this.startingX??0)-(this.endingX??0)}clearTouches(){this.startingX=void 0,this.endingX=void 0,this.overscroll=0}onTouchStart(e){switch(e.stopPropagation(),this.takeOverSnap(),e.touches.length){case 1:break;case 2:this.onTouchEnd(e);return;default:{this.onTouchEnd(e),this.comms.send("tap_more",e.touches.length);return}}this.startingX=e.touches[0].clientX,this.alreadyScrollLeft=this.doc().scrollLeft,this.touchState=1}onTouchEnd(e){if(this.touchState===2){const t=this.dragOffset(),i=this.scrollOffset();this.cachedScrollWidth<=this.wnd.innerWidth?(this.reportProgress(),t>5&&this.comms.send("no_more",void 0),t<-5&&this.comms.send("no_less",void 0)):i<5&&t<5?(this.alreadyScrollLeft=0,this.comms.send("no_less",void 0)):this.cachedScrollWidth-i-this.wnd.innerWidth<5&&t>5&&(this.alreadyScrollLeft=this.cachedScrollWidth,this.comms.send("no_more",void 0)),this.snapCurrentOffset(!0),this.comms.send("swipe",t)}this.touchState=0}onWidthChange(){this.cachedScrollWidth=this.doc().scrollWidth,this.comms.ready&&this.snapCurrentOffset()}onTouchMove(e){if(this.touchState===0)return;this.touchState===1&&(this.touchState=2,R(this.wnd)),this.endingX=e.touches[0].clientX;const t=this.dragOffset(),i=this.alreadyScrollLeft+t;i<0?(this.overscroll=i,this.doc().style.transform=`translate3d(${-this.overscroll}px, 0px, 0px)`):i+this.wnd.innerWidth>this.cachedScrollWidth?(this.overscroll=i,this.doc().style.transform=`translate3d(${-i}px, 0px, 0px)`):(this.overscroll=0,this.doc().style.removeProperty("transform"),this.doc().scrollLeft=this.alreadyScrollLeft+t)}mount(e,t){if(this.wnd=e,this.comms=t,!super.mount(e,t))return!1;e.navigator.epubReadingSystem&&(e.navigator.epubReadingSystem.layoutStyle="paginated");const i=e.document.createElement("style");i.dataset.readium="true",i.id=fs,i.textContent=`
        @keyframes readium-bounce-l-animation {
            0%, 100% {transform: translate3d(0, 0, 0);}
            50% {transform: translate3d(-50px, 0, 0);}
        }

        @keyframes readium-bounce-r-animation {
            0%, 100% {transform: translate3d(0, 0, 0);}
            50% {transform: translate3d(50px, 0, 0);}
        }

        .readium-bounce-l {
            animation: readium-bounce-l-animation 150ms ease-out 1;
        }

        .readium-bounce-r {
            animation: readium-bounce-r-animation 150ms ease-out 1;
        }

        html {
            overflow: hidden;
        }

        body {
            -ms-overflow-style: none; /* for Internet Explorer, Edge */
        }

        * {
            scrollbar-width: none; /* for Firefox */
        }
        
        body::-webkit-scrollbar {
            display: none; /* for Chrome, Safari, and Opera */
        }
        `,e.document.head.appendChild(i),this.resizeObserver=new ResizeObserver(()=>{e.requestAnimationFrame(()=>{e&&gs(e)}),this.onWidthChange()}),this.resizeObserver.observe(e.document.body),this.mutationObserver=new MutationObserver(n=>{for(const o of n)if(o.target===this.wnd.document.documentElement){const a=o.oldValue,l=o.target.getAttribute("style"),h=/transform\s*:\s*([^;]+)/,u=a?.match(h),d=l?.match(h);(!u&&!d||u&&!d||u&&d&&u[1]!==d[1])&&(e.requestAnimationFrame(()=>{e&&gs(e)}),this.onWidthChange())}else e.requestAnimationFrame(()=>this.cachedScrollWidth=this.doc().scrollWidth)}),e.frameElement&&this.mutationObserver.observe(e.frameElement,{attributes:!0,attributeFilter:["style"]}),this.mutationObserver.observe(e.document,{attributes:!0,attributeFilter:["style"]}),this.mutationObserver.observe(e.document.documentElement,{attributes:!0,attributeFilter:["style"]});const s=n=>{const o=this.doc().scrollLeft;return this.doc().scrollLeft=this.snapOffset(n),o!==this.doc().scrollLeft};return e.addEventListener("orientationchange",this.onWidthChanger),e.addEventListener("resize",this.onWidthChanger),e.requestAnimationFrame(()=>this.cachedScrollWidth=this.doc().scrollWidth),t.register("go_progression",Y.moduleName,(n,o)=>{const a=n;if(a<0||a>1){t.send("error",{message:"go_progression must be given a position from 0.0 to 1.0"}),o(!1);return}this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const l=this.cachedScrollWidth,h=we(e)?-1:1,u=l*a*h;this.doc().scrollLeft=this.snapOffset(u),this.reportProgress(),R(this.wnd),o(!0)})}),t.register("go_id",Y.moduleName,(n,o)=>{const a=e.document.getElementById(n);if(!a){o(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollLeft=this.snapOffset(a.getBoundingClientRect().left+e.scrollX),this.reportProgress(),R(this.wnd),o(!0)})}),t.register("go_text",Y.moduleName,(n,o)=>{let a;Array.isArray(n)&&(n.length>1&&(a=n[1]),n=n[0]);const l=et.deserialize(n),h=Ft(this.wnd.document,new Be({href:e.location.href,type:"text/html",text:l,locations:a?new N({otherLocations:new Map([["cssSelector",a]])}):void 0}));if(!h){o(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollLeft=this.snapOffset(h.getBoundingClientRect().left+e.scrollX),this.reportProgress(),R(this.wnd),o(!0)})}),t.register("go_end",Y.moduleName,(n,o)=>{const a=we(e)?-1:1;this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const l=this.cachedScrollWidth*a;if(this.doc().scrollLeft===l)return o(!1);this.doc().scrollLeft=this.snapOffset(l),this.reportProgress(),R(this.wnd),o(!0)})}),t.register("go_start",Y.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{if(this.doc().scrollLeft===0)return o(!1);this.doc().scrollLeft=0,this.reportProgress(),R(this.wnd),o(!0)})}),t.register("go_prev",Y.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const a=e.scrollX-e.innerWidth,l=we(e)?-(this.cachedScrollWidth-e.innerWidth):0,h=s(Math.max(a,l));h&&(this.reportProgress(),R(this.wnd)),o(h)})}),t.register("go_next",Y.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const a=e.scrollX+e.innerWidth,l=we(e)?0:this.cachedScrollWidth-e.innerWidth,h=s(Math.min(a,l));h&&(this.reportProgress(),R(this.wnd)),o(h)})}),t.register("unfocus",Y.moduleName,(n,o)=>{this.snappingCancelled=!0,R(this.wnd),o(!0)}),t.register("shake",Y.moduleName,(n,o)=>{this.shake(),o(!0)}),t.register("focus",Y.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth,this.snapCurrentOffset(!1,!0),this.reportProgress(),o(!0)})}),t.register("first_visible_locator",Y.moduleName,(n,o)=>{const a=Ci(e,!1);this.comms.send("first_visible_locator",a.serialize()),o(!0)}),e.addEventListener("touchstart",this.onTouchStarter,{passive:!0}),e.addEventListener("touchend",this.onTouchEnder,{passive:!0}),e.addEventListener("touchmove",this.onTouchMover,{passive:!0}),e.document.addEventListener("touchstart",()=>{}),t.log("ColumnSnapper Mounted"),!0}unmount(e,t){return this.snappingCancelled=!0,t.unregisterAll(Y.moduleName),this.resizeObserver.disconnect(),this.mutationObserver.disconnect(),e.removeEventListener("touchstart",this.onTouchStarter),e.removeEventListener("touchend",this.onTouchEnder),e.removeEventListener("touchmove",this.onTouchMover),e.removeEventListener("orientationchange",this.onWidthChanger),e.removeEventListener("resize",this.onWidthChanger),e.document.getElementById(fs)?.remove(),t.log("ColumnSnapper Unmounted"),super.unmount(e,t)}};Cr.moduleName="column_snapper";let Oo=Cr;const ys="readium-scroll-snapper-style",Ar=class K extends Pi{constructor(){super(...arguments),this.initialScrollHandled=!1,this.isScrolling=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce=null,this.handleScroll=()=>{if(this.comms.ready&&!this.isResizing){if(!this.initialScrollHandled){this.lastScrollTop=this.doc().scrollTop,this.initialScrollHandled=!0,this.reportProgress();return}this.isScrolling||(this.isScrolling=!0,this.wnd.requestAnimationFrame(()=>{this.reportProgress();const e=this.doc().scrollTop,t=e-this.lastScrollTop;this.lastScrollTop=e,this.comms.send("scroll",t),this.isScrolling=!1}))}}}doc(){return this.wnd.document.scrollingElement}reportProgress(){if(!this.comms.ready)return;const e=Math.ceil(this.doc().scrollTop),t=this.doc().scrollHeight,i=this.wnd.innerHeight,s=Math.max(0,Math.min(1,e/t)),n=Math.max(0,Math.min(1,(e+i)/t));this.comms.send("progress",{start:s,end:n})}mount(e,t){this.wnd=e,this.comms=t,this.initialScrollHandled=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce&&(this.wnd.clearTimeout(this.resizeDebounce),this.resizeDebounce=null),e.navigator.epubReadingSystem&&(e.navigator.epubReadingSystem.layoutStyle="scrolling");const i=e.document.createElement("style");return i.dataset.readium="true",i.id=ys,i.textContent=`
        * {
            scrollbar-width: none; /* for Firefox */
        }
        
        body::-webkit-scrollbar {
            display: none; /* for Chrome, Safari, and Opera */
        }
        `,e.document.head.appendChild(i),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounce&&this.wnd.clearTimeout(this.resizeDebounce),this.isResizing=!0,this.resizeDebounce=this.wnd.setTimeout(()=>{this.isResizing=!1,this.resizeDebounce=null,this.reportProgress()},50)}),this.resizeObserver.observe(e.document.body),e.addEventListener("scroll",this.handleScroll,{passive:!0}),t.register("force_webkit_recalc",K.moduleName,()=>{xr(this.wnd);const s=this.doc().scrollTop;s>1?this.doc().scrollTop=s-1:this.doc().scrollTop=s+1,this.doc().scrollTop=s}),t.register("go_progression",K.moduleName,(s,n)=>{const o=s;if(o<0||o>1){t.send("error",{message:"go_progression must be given a position from 0.0 to 1.0"}),n(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=this.doc().offsetHeight*o,this.reportProgress(),R(this.wnd),n(!0)})}),t.register("go_id",K.moduleName,(s,n)=>{const o=e.document.getElementById(s);if(!o){n(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=o.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),R(this.wnd),n(!0)})}),t.register("go_text",K.moduleName,(s,n)=>{let o;Array.isArray(s)&&(s.length>1&&(o=s[1]),s=s[0]);const a=et.deserialize(s),l=Ft(this.wnd.document,new Be({href:e.location.href,type:"text/html",text:a,locations:o?new N({otherLocations:new Map([["cssSelector",o]])}):void 0}));if(!l){n(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=l.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),R(this.wnd),n(!0)})}),t.register("go_start",K.moduleName,(s,n)=>{if(this.doc().scrollTop===0)return n(!1);this.doc().scrollTop=0,this.reportProgress(),n(!0)}),t.register("go_end",K.moduleName,(s,n)=>{if(this.doc().scrollTop===this.doc().scrollHeight-this.doc().offsetHeight)return n(!1);this.doc().scrollTop=this.doc().scrollHeight-this.doc().offsetHeight,this.reportProgress(),n(!0)}),t.register("unfocus",K.moduleName,(s,n)=>{R(this.wnd),n(!0)}),t.register(["go_next","go_prev"],K.moduleName,(s,n)=>n(!1)),t.register("focus",K.moduleName,(s,n)=>{this.reportProgress(),n(!0)}),t.register("first_visible_locator",K.moduleName,(s,n)=>{const o=Ci(e,!0);this.comms.send("first_visible_locator",o.serialize()),n(!0)}),t.log("ScrollSnapper Mounted"),!0}unmount(e,t){return t.unregisterAll(K.moduleName),this.resizeObserver.disconnect(),this.handleScroll&&e.removeEventListener("scroll",this.handleScroll),e.document.getElementById(ys)?.remove(),t.log("ScrollSnapper Unmounted"),!0}};Ar.moduleName="scroll_snapper";let Ro=Ar;const _r=class Z extends Pi{constructor(){super(...arguments),this.initialScrollHandled=!1,this.isScrolling=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce=null,this.handleScroll=()=>{if(this.comms.ready&&!this.isResizing){if(!this.initialScrollHandled){this.lastScrollTop=this.doc().scrollTop,this.initialScrollHandled=!0,this.reportProgress();return}this.isScrolling||(this.isScrolling=!0,this.wnd.requestAnimationFrame(()=>{this.reportProgress();const e=this.doc().scrollTop,t=e-this.lastScrollTop;this.lastScrollTop=e,this.comms.send("scroll",t),this.isScrolling=!1}))}}}doc(){return this.wnd.document.scrollingElement}reportProgress(){if(!this.comms.ready)return;const e=Math.ceil(this.doc().scrollTop),t=this.doc().scrollHeight,i=this.wnd.innerHeight,s=Math.max(0,Math.min(1,e/t)),n=Math.max(0,Math.min(1,(e+i)/t));this.comms.send("progress",{start:s,end:n})}mount(e,t){return this.wnd=e,this.comms=t,this.initialScrollHandled=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce&&(this.wnd.clearTimeout(this.resizeDebounce),this.resizeDebounce=null),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounce&&this.wnd.clearTimeout(this.resizeDebounce),this.isResizing=!0,this.resizeDebounce=this.wnd.setTimeout(()=>{this.isResizing=!1,this.resizeDebounce=null,this.reportProgress()},50)}),this.resizeObserver.observe(e.document.body),e.addEventListener("scroll",this.handleScroll,{passive:!0}),t.register("force_webkit_recalc",Z.moduleName,()=>{xr(this.wnd);const i=this.doc().scrollTop;i>1?this.doc().scrollTop=i-1:this.doc().scrollTop=i+1,this.doc().scrollTop=i}),t.register("go_progression",Z.moduleName,(i,s)=>{const n=i;if(n<0||n>1){t.send("error",{message:"go_progression must be given a position from 0.0 to 1.0"}),s(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=this.doc().offsetHeight*n,this.reportProgress(),R(this.wnd),s(!0)})}),this.comms.register("go_id",Z.moduleName,(i,s)=>{const n=e.document.getElementById(i);if(!n){s(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=n.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),R(this.wnd),s(!0)})}),t.register("go_text",Z.moduleName,(i,s)=>{let n;Array.isArray(i)&&(i.length>1&&(n=i[1]),i=i[0]);const o=et.deserialize(i),a=Ft(this.wnd.document,new Be({href:e.location.href,type:"text/html",text:o,locations:n?new N({otherLocations:new Map([["cssSelector",n]])}):void 0}));if(!a){s(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=a.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),R(this.wnd),s(!0)})}),t.register("go_start",Z.moduleName,(i,s)=>{if(this.doc().scrollTop===0)return s(!1);this.doc().scrollTop=0,this.reportProgress(),s(!0)}),t.register("go_end",Z.moduleName,(i,s)=>{if(this.doc().scrollTop===this.doc().scrollHeight-this.doc().offsetHeight)return s(!1);this.doc().scrollTop=this.doc().scrollHeight-this.doc().offsetHeight,this.reportProgress(),s(!0)}),t.register("unfocus",Z.moduleName,(i,s)=>{R(this.wnd),s(!0)}),t.register(["go_next","go_prev"],Z.moduleName,(i,s)=>s(!1)),t.register("focus",Z.moduleName,(i,s)=>{this.reportProgress(),s(!0)}),t.register("first_visible_locator",Z.moduleName,(i,s)=>{const n=Ci(e,!0);t.send("first_visible_locator",n.serialize()),s(!0)}),t.log("WebPubSnapper Mounted"),!0}unmount(e,t){return t.unregisterAll(Z.moduleName),this.resizeObserver.disconnect(),this.handleScroll&&e.removeEventListener("scroll",this.handleScroll),t.log("WebPubSnapper Unmounted"),!0}};_r.moduleName="webpub_snapper";let Lo=_r;const Or=class extends tt{constructor(){super(...arguments),this.pointerMoved=!1,this.onPointerUp=this.onPointUp.bind(this),this.onPointerMove=this.onPointMove.bind(this),this.onPointerDown=this.onPointDown.bind(this),this.onContextMenu=this.onContext.bind(this),this.onClicker=this.onClick.bind(this)}onPointUp(e){const t=this.wnd.getSelection();if(t&&t.toString()?.length>0){const s=t.getRangeAt(0)?.getClientRects();if(!s||s.length===0)return;const n=s[0],o={text:t.toString(),x:n.x,y:n.y,width:n.width,height:n.height,targetFrameSrc:this.wnd?.location?.href};this.comms.send("text_selected",o)}if(this.pointerMoved){this.pointerMoved=!1;return}if(!t?.isCollapsed||!e.isPrimary)return;const i=this.wnd.devicePixelRatio;e.preventDefault(),this.comms.send(e.pointerType==="touch"?"tap":"click",{defaultPrevented:e.defaultPrevented,x:e.clientX*i,y:e.clientY*i,targetFrameSrc:this.wnd.location.href,targetElement:e.target.outerHTML,interactiveElement:Tr(e.target)?.outerHTML,cssSelector:this.wnd._readium_cssSelectorGenerator.getCssSelector(e.target)}),this.pointerMoved=!1}onPointMove(e){if(e.movementY!==void 0&&e.movementX!==void 0){(Math.abs(e.movementX)>1||Math.abs(e.movementY)>1)&&(this.pointerMoved=!0);return}this.pointerMoved=!0}onPointDown(){this.pointerMoved=!1}onContext(e){this.onPointUp(e),this.pointerMoved=!1}onClick(e){if(e.preventDefault(),!e.isTrusted){const t=new PointerEvent("pointerup",{isPrimary:!0,pointerType:"mouse",clientX:e.clientX,clientY:e.clientY});Object.defineProperty(t,"target",{writable:!1,value:e.target}),Object.defineProperty(t,"defaultPrevented",{writable:!1,value:e.defaultPrevented}),this.onPointUp(t)}}mount(e,t){return this.wnd=e,this.comms=t,e.document.addEventListener("pointerdown",this.onPointerDown),e.document.addEventListener("pointerup",this.onPointerUp),e.document.addEventListener("contextmenu",this.onContextMenu),e.document.addEventListener("pointermove",this.onPointerMove),e.document.addEventListener("click",this.onClicker),t.log("Peripherals Mounted"),!0}unmount(e,t){return e.document.removeEventListener("pointerdown",this.onPointerDown),e.document.removeEventListener("pointerup",this.onPointerUp),e.document.removeEventListener("contextmenu",this.onContextMenu),e.document.removeEventListener("pointermove",this.onPointerMove),e.document.removeEventListener("click",this.onClicker),t.log("Peripherals Unmounted"),!0}};Or.moduleName="peripherals";let zo=Or;const Rr=class ri extends tt{constructor(){super(...arguments),this.mediaPlayingCount=0,this.allAnimations=new Set}wndOnErr(e){this.comms?.send("error",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}unblock(e){for(e._readium_blockEvents=!1;e._readium_blockedEvents?.length>0;){const t=e._readium_blockedEvents.shift();switch(t[0]){case 0:Reflect.apply(t[1],t[2],t[3]);break;case 1:const i=t[1],s=t[2];e.removeEventListener(i.type,e._readium_eventBlocker,!0);const n=new Event(i.type,{bubbles:i.bubbles,cancelable:i.cancelable});s?s.dispatchEvent(n):e.dispatchEvent(n);break}}}onMediaPlayEvent(){this.mediaPlayingCount++,this.comms?.send("media_play",this.mediaPlayingCount)}onMediaPauseEvent(){this.mediaPlayingCount>0&&this.mediaPlayingCount--,this.comms?.send("media_pause",this.mediaPlayingCount)}pauseAllMedia(e){const t=e.document.querySelectorAll("audio,video");for(let i=0;i<t.length;i++)t[i].pause()}mount(e,t){this.comms=t,e.addEventListener("error",this.wndOnErr,!1),Reflect.defineProperty(e.navigator,"epubReadingSystem",{value:{name:"readium-ts-toolkit",version:"2.2.0",hasFeature:(s,n="")=>{switch(s){case"dom-manipulation":return!0;case"layout-changes":return!0;case"touch-events":return!0;case"mouse-events":return!0;case"keyboard-events":return!0;case"spine-scripting":return!0;case"embedded-web-content":return!0;default:return!1}}},writable:!1}),"getAnimations"in e.document&&e.document.getAnimations().forEach(s=>{s.cancel(),this.allAnimations.add(s)}),t.register("activate",ri.moduleName,(s,n)=>{this.allAnimations.forEach(o=>{o.cancel(),o.play()}),n(!0)}),t.register("unfocus",ri.moduleName,(s,n)=>{this.pauseAllMedia(e),this.allAnimations.forEach(o=>o.pause()),n(!0)});const i=e.document.querySelectorAll("audio,video");for(let s=0;s<i.length;s++){const n=i[s];n.addEventListener("play",this.onMediaPlayEvent,{passive:!0}),n.addEventListener("pause",this.onMediaPauseEvent,{passive:!0})}return t.log("Setup Mounted"),!0}unmount(e,t){return e.removeEventListener("error",this.wndOnErr),e.removeEventListener("play",this.onMediaPlayEvent),e.removeEventListener("pause",this.onMediaPauseEvent),this.allAnimations.forEach(i=>i.cancel()),this.allAnimations.clear(),t.log("Setup Unmounted"),!0}};Rr.moduleName="setup";let Lr=Rr;const vs="readium-viewport",zr=class be extends Lr{onViewportWidthChanged(e){const t=e.target;Et(t,"--RS__viewportWidth",`${t.innerWidth}px`)}mount(e,t){if(!super.mount(e,t))return!1;const i=e.document.createElement("meta");return i.dataset.readium="true",i.setAttribute("name","viewport"),i.setAttribute("id",vs),i.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no"),e.document.head.appendChild(i),e.addEventListener("orientationchange",this.onViewportWidthChanged),e.addEventListener("resize",this.onViewportWidthChanged),this.onViewportWidthChanged({target:e}),t.register("get_properties",be.moduleName,(s,n)=>{wr(e),n(!0)}),t.register("update_properties",be.moduleName,(s,n)=>{s["--RS__viewportWidth"]=`${e.innerWidth}px`,go(e,s),n(!0)}),t.register("set_property",be.moduleName,(s,n)=>{const o=s;Et(e,o[0],o[1]),n(!0)}),t.register("remove_property",be.moduleName,(s,n)=>{Ti(e,s),n(!0)}),t.register("activate",be.moduleName,(s,n)=>{this.unblock(e),n(!0)}),t.log("ReflowableSetup Mounted"),!0}unmount(e,t){return t.unregisterAll(be.moduleName),e.document.head.querySelector(`#${vs}`)?.remove(),e.removeEventListener("orientationchange",this.onViewportWidthChanged),t.log("ReflowableSetup Unmounted"),super.unmount(e,t)}};zr.moduleName="reflowable_setup";let Mo=zr;const ws="readium-fixed-style",Mr=class me extends Lr{mount(e,t){if(!super.mount(e,t))return!1;e.navigator.epubReadingSystem&&(e.navigator.epubReadingSystem.layoutStyle="paginated");const i=e.document.createElement("style");return i.id=ws,i.dataset.readium="true",i.textContent=`
        html, body {
            text-size-adjust: none;
            -ms-text-size-adjust: none;
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;

            /* Fight Safari pinches */
            touch-action: none !important;
            min-height: 100%;

            /*cursor: var() TODO*/
        }`,e.document.head.appendChild(i),t.register("set_property",me.moduleName,(s,n)=>{const o=s;Et(e,o[0],o[1]),n(!0)}),t.register("remove_property",me.moduleName,(s,n)=>{Ti(e,s),n(!0)}),t.register("first_visible_locator",me.moduleName,(s,n)=>n(!1)),t.register("unfocus",me.moduleName,(s,n)=>{R(e),n(!0)}),t.register(["focus","go_next","go_prev","go_id","go_end","go_start","go_text","go_progression"],me.moduleName,(s,n)=>n(!0)),t.register("activate",me.moduleName,(s,n)=>{this.unblock(e),n(!0)}),t.log("FixedSetup Mounted"),!0}unmount(e,t){return t.unregisterAll(me.moduleName),e.document.getElementById(ws)?.remove(),t.log("FixedSetup Unmounted"),super.unmount(e,t)}};Mr.moduleName="fixed_setup";let Io=Mr;const Ir=class Nr extends tt{wndOnErr(e){this.comms?.send("error",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}mount(e,t){return this.comms=t,e.addEventListener("error",this.wndOnErr,!1),t.register("activate",Nr.moduleName,(i,s)=>{s(!0)}),t.log("WebPubSetup Mounted"),!0}unmount(e,t){return e.removeEventListener("error",this.wndOnErr),t.log("WebPubSetup Unmounted"),!0}};Ir.moduleName="webpub_setup";let No=Ir;new Map([Io,Mo,No,Lo,zo,bo,Oo,Ro].map(r=>[r.moduleName,r]));const de=class Oe{constructor(e){if(typeof e=="string"){if(!Oe.VALID_MODES.has(e.toLowerCase()))return;this.value=e.toLowerCase()}else{const t=e.filter(i=>Oe.VALID_MODES.has(i.toLowerCase()));if(t.length===0)return;this.value=Array.from(new Set(t))}}static deserialize(e){if(!e)return;if(typeof e=="string")return new Oe(e);if(!Array.isArray(e))return;const t=e.filter(i=>i?Oe.VALID_MODES.has(i.toLowerCase()):!1);if(t.length!==0)return new Oe(t)}serialize(){return this.value}};de.VALID_MODES=new Set(["auditory","tactile","textual","visual"]),de.AUDITORY=new de("auditory"),de.TACTILE=new de("tactile"),de.TEXTUAL=new de("textual"),de.VISUAL=new de("visual");var E=(r=>(r.reflowable="reflowable",r.fixed="fixed",r.scrolled="scrolled",r))(E||{});let ko=class kr{constructor(e){this.algorithm=e.algorithm,this.compression=e.compression,this.originalLength=e.originalLength,this.profile=e.profile,this.scheme=e.scheme}static deserialize(e){if(e&&e.algorithm)return new kr({algorithm:e.algorithm,compression:e.compression,originalLength:e.originalLength,profile:e.profile,scheme:e.scheme})}serialize(){const e={algorithm:this.algorithm};return this.compression!==void 0&&(e.compression=this.compression),this.originalLength!==void 0&&(e.originalLength=this.originalLength),this.profile!==void 0&&(e.profile=this.profile),this.scheme!==void 0&&(e.scheme=this.scheme),e}};var le=(r=>(r.left="left",r.right="right",r.center="center",r))(le||{});let oe=class ni{constructor(e){this.otherProperties=e}get page(){return this.otherProperties.page}static deserialize(e){if(e)return new ni(e)}serialize(){return this.otherProperties}add(e){const t=Object.assign({},this.otherProperties);for(const i in e)t[i]=e[i];return new ni(t)}};Object.defineProperty(oe.prototype,"encryption",{get:function(){return ko.deserialize(this.otherProperties.encrypted)}});function Fo(r){return r&&Array.isArray(r)?r:void 0}function Fr(r){return r&&typeof r=="string"?[r]:Fo(r)}function Ss(r){return typeof r=="string"?new Date(r):void 0}function pt(r){return isNaN(r)?void 0:r}function H(r){return pt(r)!==void 0&&Math.sign(r)>=0?r:void 0}function Do(r){const e=new Array;return r.forEach(t=>e.push(t)),e}class f{constructor(e){let t,i,s=e.mediaType.replace(/\s/g,"").split(";");const n=s[0].split("/");if(n.length===2){if(t=n[0].toLowerCase().trim(),i=n[1].toLowerCase().trim(),t.length===0||i.length===0)throw new Error("Invalid media type")}else throw new Error("Invalid media type");const o={};for(let p=1;p<s.length;p++){const g=s[p].split("=");if(g.length===2){const c=g[0].toLocaleLowerCase(),m=c==="charset"?g[1].toUpperCase():g[1];o[c]=m}}const a={},l=Object.keys(o);l.sort((p,g)=>p.localeCompare(g)),l.forEach(p=>a[p]=o[p]);let h="";for(const p in a){const g=a[p];h+=`;${p}=${g}`}const u=`${t}/${i}${h}`,d=a.encoding;this.string=u,this.type=t,this.subtype=i,this.parameters=a,this.encoding=d,this.name=e.name,this.fileExtension=e.fileExtension}static parse(e){return new f(e)}get structuredSyntaxSuffix(){const e=this.subtype.split("+");return e.length>1?`+${e[e.length-1]}`:void 0}get charset(){return this.parameters.charset}contains(e){const t=typeof e=="string"?f.parse({mediaType:e}):e;if(!((this.type==="*"||this.type===t.type)&&(this.subtype==="*"||this.subtype===t.subtype)))return!1;const i=new Set(Object.entries(this.parameters).map(([n,o])=>`${n}=${o}`)),s=new Set(Object.entries(t.parameters).map(([n,o])=>`${n}=${o}`));for(const n of Array.from(i.values()))if(!s.has(n))return!1;return!0}matches(e){const t=typeof e=="string"?f.parse({mediaType:e}):e;return this.contains(t)||t.contains(this)}matchesAny(...e){for(const t of e)if(this.matches(t))return!0;return!1}equals(e){return this.string===e.string}get isZIP(){return this.matchesAny(f.ZIP,f.LCP_PROTECTED_AUDIOBOOK,f.LCP_PROTECTED_PDF)||this.structuredSyntaxSuffix==="+zip"}get isJSON(){return this.matchesAny(f.JSON)||this.structuredSyntaxSuffix==="+json"}get isOPDS(){return this.matchesAny(f.OPDS1,f.OPDS1_ENTRY,f.OPDS2,f.OPDS2_PUBLICATION,f.OPDS_AUTHENTICATION)||this.structuredSyntaxSuffix==="+json"}get isHTML(){return this.matchesAny(f.HTML,f.XHTML)}get isBitmap(){return this.matchesAny(f.BMP,f.GIF,f.JPEG,f.PNG,f.TIFF,f.WEBP)}get isAudio(){return this.type==="audio"}get isVideo(){return this.type==="video"}get isRWPM(){return this.matchesAny(f.READIUM_AUDIOBOOK_MANIFEST,f.DIVINA_MANIFEST,f.READIUM_WEBPUB_MANIFEST)}get isPublication(){return this.matchesAny(f.READIUM_AUDIOBOOK,f.READIUM_AUDIOBOOK_MANIFEST,f.CBZ,f.DIVINA,f.DIVINA_MANIFEST,f.EPUB,f.LCP_PROTECTED_AUDIOBOOK,f.LCP_PROTECTED_PDF,f.LPF,f.PDF,f.W3C_WPUB_MANIFEST,f.READIUM_WEBPUB,f.READIUM_WEBPUB_MANIFEST,f.ZAB)}static get AAC(){return f.parse({mediaType:"audio/aac",fileExtension:"aac"})}static get ACSM(){return f.parse({mediaType:"application/vnd.adobe.adept+xml",name:"Adobe Content Server Message",fileExtension:"acsm"})}static get AIFF(){return f.parse({mediaType:"audio/aiff",fileExtension:"aiff"})}static get AVI(){return f.parse({mediaType:"video/x-msvideo",fileExtension:"avi"})}static get BINARY(){return f.parse({mediaType:"application/octet-stream"})}static get BMP(){return f.parse({mediaType:"image/bmp",fileExtension:"bmp"})}static get CBZ(){return f.parse({mediaType:"application/vnd.comicbook+zip",name:"Comic Book Archive",fileExtension:"cbz"})}static get CSS(){return f.parse({mediaType:"text/css",fileExtension:"css"})}static get DIVINA(){return f.parse({mediaType:"application/divina+zip",name:"Digital Visual Narratives",fileExtension:"divina"})}static get DIVINA_MANIFEST(){return f.parse({mediaType:"application/divina+json",name:"Digital Visual Narratives",fileExtension:"json"})}static get EPUB(){return f.parse({mediaType:"application/epub+zip",name:"EPUB",fileExtension:"epub"})}static get GIF(){return f.parse({mediaType:"image/gif",fileExtension:"gif"})}static get GZ(){return f.parse({mediaType:"application/gzip",fileExtension:"gz"})}static get HTML(){return f.parse({mediaType:"text/html",fileExtension:"html"})}static get JAVASCRIPT(){return f.parse({mediaType:"text/javascript",fileExtension:"js"})}static get JPEG(){return f.parse({mediaType:"image/jpeg",fileExtension:"jpeg"})}static get JSON(){return f.parse({mediaType:"application/json"})}static get LCP_LICENSE_DOCUMENT(){return f.parse({mediaType:"application/vnd.readium.lcp.license.v1.0+json",name:"LCP License",fileExtension:"lcpl"})}static get LCP_PROTECTED_AUDIOBOOK(){return f.parse({mediaType:"application/audiobook+lcp",name:"LCP Protected Audiobook",fileExtension:"lcpa"})}static get LCP_PROTECTED_PDF(){return f.parse({mediaType:"application/pdf+lcp",name:"LCP Protected PDF",fileExtension:"lcpdf"})}static get LCP_STATUS_DOCUMENT(){return f.parse({mediaType:"application/vnd.readium.license.status.v1.0+json"})}static get LPF(){return f.parse({mediaType:"application/lpf+zip",fileExtension:"lpf"})}static get MP3(){return f.parse({mediaType:"audio/mpeg",fileExtension:"mp3"})}static get MPEG(){return f.parse({mediaType:"video/mpeg",fileExtension:"mpeg"})}static get NCX(){return f.parse({mediaType:"application/x-dtbncx+xml",fileExtension:"ncx"})}static get OGG(){return f.parse({mediaType:"audio/ogg",fileExtension:"oga"})}static get OGV(){return f.parse({mediaType:"video/ogg",fileExtension:"ogv"})}static get OPDS1(){return f.parse({mediaType:"application/atom+xml;profile=opds-catalog"})}static get OPDS1_ENTRY(){return f.parse({mediaType:"application/atom+xml;type=entry;profile=opds-catalog"})}static get OPDS2(){return f.parse({mediaType:"application/opds+json"})}static get OPDS2_PUBLICATION(){return f.parse({mediaType:"application/opds-publication+json"})}static get OPDS_AUTHENTICATION(){return f.parse({mediaType:"application/opds-authentication+json"})}static get OPUS(){return f.parse({mediaType:"audio/opus",fileExtension:"opus"})}static get OTF(){return f.parse({mediaType:"font/otf",fileExtension:"otf"})}static get PDF(){return f.parse({mediaType:"application/pdf",name:"PDF",fileExtension:"pdf"})}static get PNG(){return f.parse({mediaType:"image/png",fileExtension:"png"})}static get READIUM_AUDIOBOOK(){return f.parse({mediaType:"application/audiobook+zip",name:"Readium Audiobook",fileExtension:"audiobook"})}static get READIUM_AUDIOBOOK_MANIFEST(){return f.parse({mediaType:"application/audiobook+json",name:"Readium Audiobook",fileExtension:"json"})}static get READIUM_CONTENT_DOCUMENT(){return f.parse({mediaType:"application/vnd.readium.content+json",name:"Readium Content Document",fileExtension:"json"})}static get READIUM_GUIDED_NAVIGATION_DOCUMENT(){return f.parse({mediaType:"application/guided-navigation+json",name:"Readium Guided Navigation Document",fileExtension:"json"})}static get READIUM_POSITION_LIST(){return f.parse({mediaType:"application/vnd.readium.position-list+json",name:"Readium Position List",fileExtension:"json"})}static get READIUM_WEBPUB(){return f.parse({mediaType:"application/webpub+zip",name:"Readium Web Publication",fileExtension:"webpub"})}static get READIUM_WEBPUB_MANIFEST(){return f.parse({mediaType:"application/webpub+json",name:"Readium Web Publication",fileExtension:"json"})}static get SMIL(){return f.parse({mediaType:"application/smil+xml",fileExtension:"smil"})}static get SVG(){return f.parse({mediaType:"image/svg+xml",fileExtension:"svg"})}static get TEXT(){return f.parse({mediaType:"text/plain",fileExtension:"txt"})}static get TIFF(){return f.parse({mediaType:"image/tiff",fileExtension:"tiff"})}static get TTF(){return f.parse({mediaType:"font/ttf",fileExtension:"ttf"})}static get W3C_WPUB_MANIFEST(){return f.parse({mediaType:"application/x.readium.w3c.wpub+json",name:"Web Publication",fileExtension:"json"})}static get WAV(){return f.parse({mediaType:"audio/wav",fileExtension:"wav"})}static get WEBM_AUDIO(){return f.parse({mediaType:"audio/webm",fileExtension:"webm"})}static get WEBM_VIDEO(){return f.parse({mediaType:"video/webm",fileExtension:"webm"})}static get WEBP(){return f.parse({mediaType:"image/webp",fileExtension:"webp"})}static get WOFF(){return f.parse({mediaType:"font/woff",fileExtension:"woff"})}static get WOFF2(){return f.parse({mediaType:"font/woff2",fileExtension:"woff2"})}static get XHTML(){return f.parse({mediaType:"application/xhtml+xml",fileExtension:"xhtml"})}static get XML(){return f.parse({mediaType:"application/xml",fileExtension:"xml"})}static get ZAB(){return f.parse({mediaType:"application/x.readium.zab+zip",name:"Zipped Audio Book",fileExtension:"zab"})}static get ZIP(){return f.parse({mediaType:"application/zip",fileExtension:"zip"})}}let bs=class{constructor(r){this.uri=r,this.parameters=this.getParameters(r)}getParameters(r){const e=/\{\??([^}]+)\}/g,t=r.match(e);return t?new Set(t.join(",").replace(e,"$1").split(",").map(i=>i.trim())):new Set}expand(r){const e=i=>i.split(",").map(s=>{const n=r[s];return n?encodeURIComponent(n):""}).join(","),t=i=>"?"+i.split(",").map(s=>{const n=s.split("=")[0],o=r[n];return o?`${n}=${encodeURIComponent(o)}`:""}).join("&");return this.uri.replace(/\{(\??)([^}]+)\}/g,(...i)=>i[1]?t(i[2]):e(i[2]))}},se=class Dr{constructor(e){this.fragments=e.fragments?e.fragments:new Array,this.progression=e.progression,this.totalProgression=e.totalProgression,this.position=e.position,this.otherLocations=e.otherLocations}static deserialize(e){if(!e)return;const t=pt(e.progression),i=pt(e.totalProgression),s=pt(e.position),n=new Map,o=new Set(["fragment","fragments","progression","totalProgression","position"]);return Object.entries(e).forEach(([a,l])=>{o.has(a)||n.set(a,l)}),new Dr({fragments:Fr(e.fragments||e.fragment),progression:t!==void 0&&t>=0&&t<=1?t:void 0,totalProgression:i!==void 0&&i>=0&&i<=1?i:void 0,position:s!==void 0&&s>0?s:void 0,otherLocations:n.size===0?void 0:n})}serialize(){const e={};return this.fragments&&(e.fragments=this.fragments),this.progression!==void 0&&(e.progression=this.progression),this.totalProgression!==void 0&&(e.totalProgression=this.totalProgression),this.position!==void 0&&(e.position=this.position),this.otherLocations&&this.otherLocations.forEach((t,i)=>e[i]=t),e}},Uo=class Ur{constructor(e){this.after=e.after,this.before=e.before,this.highlight=e.highlight}static deserialize(e){if(e)return new Ur({after:e.after,before:e.before,highlight:e.highlight})}serialize(){const e={};return this.after!==void 0&&(e.after=this.after),this.before!==void 0&&(e.before=this.before),this.highlight!==void 0&&(e.highlight=this.highlight),e}},oi=class ai{constructor(e){this.href=e.href,this.type=e.type,this.title=e.title,this.locations=e.locations?e.locations:new se({}),this.text=e.text}static deserialize(e){if(e&&e.href&&e.type)return new ai({href:e.href,type:e.type,title:e.title,locations:se.deserialize(e.locations),text:Uo.deserialize(e.text)})}serialize(){const e={href:this.href,type:this.type};return this.title!==void 0&&(e.title=this.title),this.locations&&(e.locations=this.locations.serialize()),this.text&&(e.text=this.text.serialize()),e}copyWithLocations(e){return new ai({href:this.href,type:this.type,title:this.title,text:this.text,locations:new se({...this.locations,...e})})}},Ye=class mt{constructor(e){this.href=e.href,this.templated=e.templated,this.type=e.type,this.title=e.title,this.rels=e.rels,this.properties=e.properties,this.height=e.height,this.width=e.width,this.size=e.size,this.duration=e.duration,this.bitrate=e.bitrate,this.languages=e.languages,this.alternates=e.alternates,this.children=e.children}static deserialize(e){if(!(!e||typeof e.href!="string"))return new mt({href:e.href,templated:e.templated,type:e.type,title:e.title,rels:e.rel?Array.isArray(e.rel)?new Set(e.rel):new Set([e.rel]):void 0,properties:oe.deserialize(e.properties),height:H(e.height),width:H(e.width),size:H(e.size),duration:H(e.duration),bitrate:H(e.bitrate),languages:Fr(e.language),alternates:Es.deserialize(e.alternate),children:Es.deserialize(e.children)})}serialize(){const e={href:this.href};return this.templated!==void 0&&(e.templated=this.templated),this.type!==void 0&&(e.type=this.type),this.title!==void 0&&(e.title=this.title),this.rels&&(e.rel=Do(this.rels)),this.properties&&(e.properties=this.properties.serialize()),this.height!==void 0&&(e.height=this.height),this.width!==void 0&&(e.width=this.width),this.size!==void 0&&(e.size=this.size),this.duration!==void 0&&(e.duration=this.duration),this.bitrate!==void 0&&(e.bitrate=this.bitrate),this.languages&&(e.language=this.languages),this.alternates&&(e.alternate=this.alternates.serialize()),this.children&&(e.children=this.children.serialize()),e}get mediaType(){return this.type!==void 0?f.parse({mediaType:this.type}):f.BINARY}toURL(e){const t=this.href.replace(/^(\/)/,"");if(t.length===0)return;let i=e||"/";return i.startsWith("/")&&(i="file://"+i),new URL(t,i).href.replace(/^(file:\/\/)/,"")}get templateParameters(){return this.templated?new bs(this.href).parameters:new Set}expandTemplate(e){return new mt({href:new bs(this.href).expand(e),templated:!1})}addProperties(e){const t=mt.deserialize(this.serialize());return t.properties=t.properties?t.properties?.add(e):new oe(e),t}get locator(){let e=this.href.split("#");return new oi({href:e.length>0&&e[0]!==void 0?e[0]:this.href,type:this.type??"",title:this.title,locations:new se({fragments:e.length>1&&e[1]!==void 0?[e[1]]:[]})})}},Es=class Wr{constructor(e){this.items=e}static deserialize(e){if(e&&Array.isArray(e))return new Wr(e.map(t=>Ye.deserialize(t)).filter(t=>t!==void 0))}serialize(){return this.items.map(e=>e.serialize())}findWithRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.find(t)}filterByRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.filter(t)}findWithHref(e){const t=i=>i.href===e;return this.items.find(t)}findIndexWithHref(e){const t=i=>i.href===e;return this.items.findIndex(t)}findWithMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.find(t)}filterByMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.filter(t)}filterByMediaTypes(e){const t=i=>{for(const s of e)if(i.mediaType.matches(s))return!0;return!1};return this.items.filter(t)}everyIsAudio(){const e=t=>t.mediaType.isAudio;return this.items.length>0&&this.items.every(e)}everyIsBitmap(){const e=t=>t.mediaType.isBitmap;return this.items.length>0&&this.items.every(e)}everyIsHTML(){const e=t=>t.mediaType.isHTML;return this.items.length>0&&this.items.every(e)}everyIsVideo(){const e=t=>t.mediaType.isVideo;return this.items.length>0&&this.items.every(e)}everyMatchesMediaType(e){return Array.isArray(e)?this.items.length>0&&this.items.every(t=>{for(const i of e)return t.mediaType.matches(i);return!1}):this.items.length>0&&this.items.every(t=>t.mediaType.matches(e))}filterLinksHasType(){return this.items.filter(e=>e.type)}};var Br=(r=>(r.EPUB="https://readium.org/webpub-manifest/profiles/epub",r.AUDIOBOOK="https://readium.org/webpub-manifest/profiles/audiobook",r.DIVINA="https://readium.org/webpub-manifest/profiles/divina",r.PDF="https://readium.org/webpub-manifest/profiles/pdf",r))(Br||{}),I=(r=>(r.ltr="ltr",r.rtl="rtl",r))(I||{});oe.prototype.getContains=function(){return new Set(this.otherProperties.contains||[])};let xs=class $r{constructor(e){this.cssSelector=e.cssSelector,this.textNodeIndex=e.textNodeIndex,this.charOffset=e.charOffset}static deserialize(e){if(!(e&&e.cssSelector))return;let t=H(e.textNodeIndex);if(t===void 0)return;let i=H(e.charOffset);return i===void 0&&(i=H(e.offset)),new $r({cssSelector:e.cssSelector,textNodeIndex:t,charOffset:i})}serialize(){const e={cssSelector:this.cssSelector,textNodeIndex:this.textNodeIndex};return this.charOffset!==void 0&&(e.charOffset=this.charOffset),e}},Wo=class Hr{constructor(e){this.start=e.start,this.end=e.end}static deserialize(e){if(!e)return;let t=xs.deserialize(e.start);if(t)return new Hr({start:t,end:xs.deserialize(e.end)})}serialize(){const e={start:this.start.serialize()};return this.end&&(e.end=this.end.serialize()),e}};se.prototype.getCssSelector=function(){return this.otherLocations?.get("cssSelector")};se.prototype.getPartialCfi=function(){return this.otherLocations?.get("partialCfi")};se.prototype.getDomRange=function(){return Wo.deserialize(this.otherLocations?.get("domRange"))};se.prototype.fragmentParameters=function(){return new Map(this.fragments.map(r=>r.startsWith("#")?r.slice(1):r).join("&").split("&").filter(r=>!r.startsWith("#")).map(r=>r.split("=")).filter(r=>r.length===2).map(r=>[r[0].trim().toLowerCase(),r[1].trim()]))};se.prototype.htmlId=function(){if(!this.fragments.length)return;let r=this.fragments.find(e=>e.length&&!e.includes("="));if(!r){const e=this.fragmentParameters();e.has("id")?r=e.get("id"):e.has("name")&&(r=e.get("name"))}return r?.startsWith("#")?r.slice(1):r};se.prototype.page=function(){const r=parseInt(this.fragmentParameters().get("page"));if(!isNaN(r)&&r>=0)return r};se.prototype.time=function(){const r=parseInt(this.fragmentParameters().get("t"));if(!isNaN(r))return r};se.prototype.space=function(){const r=this.fragmentParameters();if(!r.has("xywh"))return;const e=r.get("xywh").split(",").map(t=>parseInt(t));if(e.length===4&&!e.some(isNaN))return e};class Ai{constructor(e){this.currency=e.currency,this.value=e.value}static deserialize(e){if(!e)return;let t=e.currency;if(!(t&&typeof t=="string"&&t.length>0))return;let i=H(e.value);if(i!==void 0)return new Ai({currency:t,value:i})}serialize(){return{currency:this.currency,value:this.value}}}let Bo=class gt{constructor(e){this.type=e.type,this.children=e.children}static deserialize(e){if(e&&e.type)return new gt({type:e.type,children:gt.deserializeArray(e.children)})}static deserializeArray(e){if(Array.isArray(e))return e.map(t=>gt.deserialize(t)).filter(t=>t!==void 0)}serialize(){const e={type:this.type};return this.children&&(e.children=this.children.map(t=>t.serialize())),e}},$o=class jr{constructor(e){this.total=e.total,this.position=e.position}static deserialize(e){if(e)return new jr({total:H(e.total),position:H(e.position)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.position!==void 0&&(e.position=this.position),e}};class _i{constructor(e){this.total=e.total,this.available=e.available}static deserialize(e){if(e)return new _i({total:H(e.total),available:H(e.available)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.available!==void 0&&(e.available=this.available),e}}class Oi{constructor(e){this.state=e.state,this.since=e.since,this.until=e.until}static deserialize(e){if(e&&e.state)return new Oi({state:e.state,since:Ss(e.since),until:Ss(e.until)})}serialize(){const e={state:this.state};return this.since!==void 0&&(e.since=this.since.toISOString()),this.until!==void 0&&(e.until=this.until.toISOString()),e}}oe.prototype.getNumberOfItems=function(){return H(this.otherProperties.numberOfItems)};oe.prototype.getPrice=function(){return Ai.deserialize(this.otherProperties.price)};oe.prototype.getIndirectAcquisitions=function(){const r=this.otherProperties.indirectAcquisition;if(r&&Array.isArray(r))return r.map(e=>Bo.deserialize(e)).filter(e=>e!==void 0)};oe.prototype.getHolds=function(){return $o.deserialize(this.otherProperties.holds)};oe.prototype.getCopies=function(){return _i.deserialize(this.otherProperties.copies)};oe.prototype.getAvailability=function(){return Oi.deserialize(this.otherProperties.availability)};oe.prototype.getAuthenticate=function(){return Ye.deserialize(this.otherProperties.authenticate)};const Ho="CssSelectorGenerator";function Ts(r="unknown problem",...e){console.warn(`${Ho}: ${r}`,...e)}function jo(r){return r instanceof RegExp}function Vo(r){return r.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".+")}function Go(r){const e=r.map(t=>{if(jo(t))return i=>t.test(i);if(typeof t=="function")return i=>{const s=t(i);return typeof s!="boolean"?(Ts("pattern matcher function invalid","Provided pattern matching function does not return boolean. It's result will be ignored.",t),!1):s};if(typeof t=="string"){const i=new RegExp("^"+Vo(t)+"$");return s=>i.test(s)}return Ts("pattern matcher invalid","Pattern matching only accepts strings, regular expressions and/or functions. This item is invalid and will be ignored.",t),()=>!1});return t=>e.some(i=>i(t))}Go(["class","id","ng-*"]);class Xo{}class Yo extends Xo{goLeft(e=!1,t){this.readingProgression===I.ltr?this.goBackward(e,t):this.readingProgression===I.rtl&&this.goForward(e,t)}goRight(e=!1,t){this.readingProgression===I.ltr?this.goForward(e,t):this.readingProgression===I.rtl&&this.goBackward(e,t)}}const qo=Math.pow(2,32),Ps=()=>Math.round(Math.random()*qo).toString(36),li=()=>`${Math.round(performance.now())}-${Ps()}-${Ps()}`,Re=1;class Jo{constructor(e){this.destination=null,this.registrar=new Map,this.origin="",this.channelId="",this.receiver=this.receive.bind(this),this.preLog=[],this.wnd=e,e.addEventListener("message",this.receiver)}receive(e){if(e.source===null)throw Error("Event source is null");if(typeof e.data!="object")return;const t=e.data;if(!(!("_readium"in t)||!t._readium||t._readium<=0)){if(t.key==="_ping"){if(!this.destination){if(this.destination=e.source,this.origin=e.origin,this.channelId=t._channel,t._readium!==Re){t._readium>Re?this.send("error",`received comms version ${t._readium} higher than ${Re}`):this.send("error",`received comms version ${t._readium} lower than ${Re}`),this.destination=null,this.origin="",this.channelId="";return}this.send("_pong",void 0),this.preLog.forEach(i=>this.send("log",i)),this.preLog=[]}return}else if(this.channelId){if(t._channel!==this.channelId||e.origin!==this.origin)return}else return;this.handle(t)}}handle(e){const t=this.registrar.get(e.key);if(!t||t.length===0){e.strict&&this.send("_unhandled",e);return}t.forEach(i=>i.cb(e.data,s=>{this.send("_ack",s,e.id)}))}register(e,t,i){Array.isArray(e)||(e=[e]),e.forEach(s=>{const n=this.registrar.get(s);if(n&&n.length>=0){if(n.find(o=>o.module===t))throw new Error(`Trying to register another callback for combination of event ${s} and module ${t}`);n.push({cb:i,module:t}),this.registrar.set(s,n)}else this.registrar.set(s,[{cb:i,module:t}])})}unregister(e,t){Array.isArray(e)||(e=[e]),e.forEach(i=>{const s=this.registrar.get(i);!s||s.length===0||s.splice(s.findIndex(n=>n.module===t),1)})}unregisterAll(e){this.registrar.forEach((t,i)=>this.registrar.set(i,t.filter(s=>s.module!==e)))}log(...e){this.destination?this.send("log",e):this.preLog.push(e)}get ready(){return!!this.destination}destroy(){this.destination=null,this.channelId="",this.preLog=[],this.registrar.clear(),this.wnd.removeEventListener("message",this.receiver)}send(e,t,i=void 0,s=[]){if(!this.destination)throw Error("Attempted to send comms message before destination has been initialized");const n={_readium:Re,_channel:this.channelId,id:i??li(),key:e,data:t};try{this.destination.postMessage(n,{targetOrigin:this.origin,transfer:s})}catch(o){if(s.length>0)throw o;this.destination.postMessage(n,this.origin,s)}}}const ue=class Le{constructor(e){if(typeof e=="string"){if(!Le.VALID_MODES.has(e.toLowerCase()))return;this.value=e.toLowerCase()}else{const t=e.filter(i=>Le.VALID_MODES.has(i.toLowerCase()));if(t.length===0)return;this.value=Array.from(new Set(t))}}static deserialize(e){if(!e)return;if(typeof e=="string")return new Le(e);if(!Array.isArray(e))return;const t=e.filter(i=>i?Le.VALID_MODES.has(i.toLowerCase()):!1);if(t.length!==0)return new Le(t)}serialize(){return this.value}};ue.VALID_MODES=new Set(["auditory","tactile","textual","visual"]),ue.AUDITORY=new ue("auditory"),ue.TACTILE=new ue("tactile"),ue.TEXTUAL=new ue("textual"),ue.VISUAL=new ue("visual");class Ri{constructor(e){this.algorithm=e.algorithm,this.compression=e.compression,this.originalLength=e.originalLength,this.profile=e.profile,this.scheme=e.scheme}static deserialize(e){if(e&&e.algorithm)return new Ri({algorithm:e.algorithm,compression:e.compression,originalLength:e.originalLength,profile:e.profile,scheme:e.scheme})}serialize(){const e={algorithm:this.algorithm};return this.compression!==void 0&&(e.compression=this.compression),this.originalLength!==void 0&&(e.originalLength=this.originalLength),this.profile!==void 0&&(e.profile=this.profile),this.scheme!==void 0&&(e.scheme=this.scheme),e}}class V{constructor(e){this.otherProperties=e}get page(){return this.otherProperties.page}static deserialize(e){if(e)return new V(e)}serialize(){return this.otherProperties}add(e){const t=Object.assign({},this.otherProperties);for(const i in e)t[i]=e[i];return new V(t)}}Object.defineProperty(V.prototype,"encryption",{get:function(){return Ri.deserialize(this.otherProperties.encrypted)}});function Ko(r){return r&&Array.isArray(r)?r:void 0}function Vr(r){return r&&typeof r=="string"?[r]:Ko(r)}function Cs(r){return typeof r=="string"?new Date(r):void 0}function ft(r){return isNaN(r)?void 0:r}function j(r){return ft(r)!==void 0&&Math.sign(r)>=0?r:void 0}function Zo(r){const e=new Array;return r.forEach(t=>e.push(t)),e}class w{constructor(e){let t,i,s=e.mediaType.replace(/\s/g,"").split(";");const n=s[0].split("/");if(n.length===2){if(t=n[0].toLowerCase().trim(),i=n[1].toLowerCase().trim(),t.length===0||i.length===0)throw new Error("Invalid media type")}else throw new Error("Invalid media type");const o={};for(let p=1;p<s.length;p++){const g=s[p].split("=");if(g.length===2){const c=g[0].toLocaleLowerCase(),m=c==="charset"?g[1].toUpperCase():g[1];o[c]=m}}const a={},l=Object.keys(o);l.sort((p,g)=>p.localeCompare(g)),l.forEach(p=>a[p]=o[p]);let h="";for(const p in a){const g=a[p];h+=`;${p}=${g}`}const u=`${t}/${i}${h}`,d=a.encoding;this.string=u,this.type=t,this.subtype=i,this.parameters=a,this.encoding=d,this.name=e.name,this.fileExtension=e.fileExtension}static parse(e){return new w(e)}get structuredSyntaxSuffix(){const e=this.subtype.split("+");return e.length>1?`+${e[e.length-1]}`:void 0}get charset(){return this.parameters.charset}contains(e){const t=typeof e=="string"?w.parse({mediaType:e}):e;if(!((this.type==="*"||this.type===t.type)&&(this.subtype==="*"||this.subtype===t.subtype)))return!1;const i=new Set(Object.entries(this.parameters).map(([n,o])=>`${n}=${o}`)),s=new Set(Object.entries(t.parameters).map(([n,o])=>`${n}=${o}`));for(const n of Array.from(i.values()))if(!s.has(n))return!1;return!0}matches(e){const t=typeof e=="string"?w.parse({mediaType:e}):e;return this.contains(t)||t.contains(this)}matchesAny(...e){for(const t of e)if(this.matches(t))return!0;return!1}equals(e){return this.string===e.string}get isZIP(){return this.matchesAny(w.ZIP,w.LCP_PROTECTED_AUDIOBOOK,w.LCP_PROTECTED_PDF)||this.structuredSyntaxSuffix==="+zip"}get isJSON(){return this.matchesAny(w.JSON)||this.structuredSyntaxSuffix==="+json"}get isOPDS(){return this.matchesAny(w.OPDS1,w.OPDS1_ENTRY,w.OPDS2,w.OPDS2_PUBLICATION,w.OPDS_AUTHENTICATION)||this.structuredSyntaxSuffix==="+json"}get isHTML(){return this.matchesAny(w.HTML,w.XHTML)}get isBitmap(){return this.matchesAny(w.BMP,w.GIF,w.JPEG,w.PNG,w.TIFF,w.WEBP)}get isAudio(){return this.type==="audio"}get isVideo(){return this.type==="video"}get isRWPM(){return this.matchesAny(w.READIUM_AUDIOBOOK_MANIFEST,w.DIVINA_MANIFEST,w.READIUM_WEBPUB_MANIFEST)}get isPublication(){return this.matchesAny(w.READIUM_AUDIOBOOK,w.READIUM_AUDIOBOOK_MANIFEST,w.CBZ,w.DIVINA,w.DIVINA_MANIFEST,w.EPUB,w.LCP_PROTECTED_AUDIOBOOK,w.LCP_PROTECTED_PDF,w.LPF,w.PDF,w.W3C_WPUB_MANIFEST,w.READIUM_WEBPUB,w.READIUM_WEBPUB_MANIFEST,w.ZAB)}static get AAC(){return w.parse({mediaType:"audio/aac",fileExtension:"aac"})}static get ACSM(){return w.parse({mediaType:"application/vnd.adobe.adept+xml",name:"Adobe Content Server Message",fileExtension:"acsm"})}static get AIFF(){return w.parse({mediaType:"audio/aiff",fileExtension:"aiff"})}static get AVI(){return w.parse({mediaType:"video/x-msvideo",fileExtension:"avi"})}static get BINARY(){return w.parse({mediaType:"application/octet-stream"})}static get BMP(){return w.parse({mediaType:"image/bmp",fileExtension:"bmp"})}static get CBZ(){return w.parse({mediaType:"application/vnd.comicbook+zip",name:"Comic Book Archive",fileExtension:"cbz"})}static get CSS(){return w.parse({mediaType:"text/css",fileExtension:"css"})}static get DIVINA(){return w.parse({mediaType:"application/divina+zip",name:"Digital Visual Narratives",fileExtension:"divina"})}static get DIVINA_MANIFEST(){return w.parse({mediaType:"application/divina+json",name:"Digital Visual Narratives",fileExtension:"json"})}static get EPUB(){return w.parse({mediaType:"application/epub+zip",name:"EPUB",fileExtension:"epub"})}static get GIF(){return w.parse({mediaType:"image/gif",fileExtension:"gif"})}static get GZ(){return w.parse({mediaType:"application/gzip",fileExtension:"gz"})}static get HTML(){return w.parse({mediaType:"text/html",fileExtension:"html"})}static get JAVASCRIPT(){return w.parse({mediaType:"text/javascript",fileExtension:"js"})}static get JPEG(){return w.parse({mediaType:"image/jpeg",fileExtension:"jpeg"})}static get JSON(){return w.parse({mediaType:"application/json"})}static get LCP_LICENSE_DOCUMENT(){return w.parse({mediaType:"application/vnd.readium.lcp.license.v1.0+json",name:"LCP License",fileExtension:"lcpl"})}static get LCP_PROTECTED_AUDIOBOOK(){return w.parse({mediaType:"application/audiobook+lcp",name:"LCP Protected Audiobook",fileExtension:"lcpa"})}static get LCP_PROTECTED_PDF(){return w.parse({mediaType:"application/pdf+lcp",name:"LCP Protected PDF",fileExtension:"lcpdf"})}static get LCP_STATUS_DOCUMENT(){return w.parse({mediaType:"application/vnd.readium.license.status.v1.0+json"})}static get LPF(){return w.parse({mediaType:"application/lpf+zip",fileExtension:"lpf"})}static get MP3(){return w.parse({mediaType:"audio/mpeg",fileExtension:"mp3"})}static get MPEG(){return w.parse({mediaType:"video/mpeg",fileExtension:"mpeg"})}static get NCX(){return w.parse({mediaType:"application/x-dtbncx+xml",fileExtension:"ncx"})}static get OGG(){return w.parse({mediaType:"audio/ogg",fileExtension:"oga"})}static get OGV(){return w.parse({mediaType:"video/ogg",fileExtension:"ogv"})}static get OPDS1(){return w.parse({mediaType:"application/atom+xml;profile=opds-catalog"})}static get OPDS1_ENTRY(){return w.parse({mediaType:"application/atom+xml;type=entry;profile=opds-catalog"})}static get OPDS2(){return w.parse({mediaType:"application/opds+json"})}static get OPDS2_PUBLICATION(){return w.parse({mediaType:"application/opds-publication+json"})}static get OPDS_AUTHENTICATION(){return w.parse({mediaType:"application/opds-authentication+json"})}static get OPUS(){return w.parse({mediaType:"audio/opus",fileExtension:"opus"})}static get OTF(){return w.parse({mediaType:"font/otf",fileExtension:"otf"})}static get PDF(){return w.parse({mediaType:"application/pdf",name:"PDF",fileExtension:"pdf"})}static get PNG(){return w.parse({mediaType:"image/png",fileExtension:"png"})}static get READIUM_AUDIOBOOK(){return w.parse({mediaType:"application/audiobook+zip",name:"Readium Audiobook",fileExtension:"audiobook"})}static get READIUM_AUDIOBOOK_MANIFEST(){return w.parse({mediaType:"application/audiobook+json",name:"Readium Audiobook",fileExtension:"json"})}static get READIUM_CONTENT_DOCUMENT(){return w.parse({mediaType:"application/vnd.readium.content+json",name:"Readium Content Document",fileExtension:"json"})}static get READIUM_GUIDED_NAVIGATION_DOCUMENT(){return w.parse({mediaType:"application/guided-navigation+json",name:"Readium Guided Navigation Document",fileExtension:"json"})}static get READIUM_POSITION_LIST(){return w.parse({mediaType:"application/vnd.readium.position-list+json",name:"Readium Position List",fileExtension:"json"})}static get READIUM_WEBPUB(){return w.parse({mediaType:"application/webpub+zip",name:"Readium Web Publication",fileExtension:"webpub"})}static get READIUM_WEBPUB_MANIFEST(){return w.parse({mediaType:"application/webpub+json",name:"Readium Web Publication",fileExtension:"json"})}static get SMIL(){return w.parse({mediaType:"application/smil+xml",fileExtension:"smil"})}static get SVG(){return w.parse({mediaType:"image/svg+xml",fileExtension:"svg"})}static get TEXT(){return w.parse({mediaType:"text/plain",fileExtension:"txt"})}static get TIFF(){return w.parse({mediaType:"image/tiff",fileExtension:"tiff"})}static get TTF(){return w.parse({mediaType:"font/ttf",fileExtension:"ttf"})}static get W3C_WPUB_MANIFEST(){return w.parse({mediaType:"application/x.readium.w3c.wpub+json",name:"Web Publication",fileExtension:"json"})}static get WAV(){return w.parse({mediaType:"audio/wav",fileExtension:"wav"})}static get WEBM_AUDIO(){return w.parse({mediaType:"audio/webm",fileExtension:"webm"})}static get WEBM_VIDEO(){return w.parse({mediaType:"video/webm",fileExtension:"webm"})}static get WEBP(){return w.parse({mediaType:"image/webp",fileExtension:"webp"})}static get WOFF(){return w.parse({mediaType:"font/woff",fileExtension:"woff"})}static get WOFF2(){return w.parse({mediaType:"font/woff2",fileExtension:"woff2"})}static get XHTML(){return w.parse({mediaType:"application/xhtml+xml",fileExtension:"xhtml"})}static get XML(){return w.parse({mediaType:"application/xml",fileExtension:"xml"})}static get ZAB(){return w.parse({mediaType:"application/x.readium.zab+zip",name:"Zipped Audio Book",fileExtension:"zab"})}static get ZIP(){return w.parse({mediaType:"application/zip",fileExtension:"zip"})}}class As{constructor(e){this.uri=e,this.parameters=this.getParameters(e)}getParameters(e){const t=/\{\??([^}]+)\}/g,i=e.match(t);return i?new Set(i.join(",").replace(t,"$1").split(",").map(s=>s.trim())):new Set}expand(e){const t=s=>s.split(",").map(n=>{const o=e[n];return o?encodeURIComponent(o):""}).join(","),i=s=>"?"+s.split(",").map(n=>{const o=n.split("=")[0],a=e[o];return a?`${o}=${encodeURIComponent(a)}`:""}).join("&");return this.uri.replace(/\{(\??)([^}]+)\}/g,(...s)=>s[1]?i(s[2]):t(s[2]))}}let k=class Gr{constructor(e){this.fragments=e.fragments?e.fragments:new Array,this.progression=e.progression,this.totalProgression=e.totalProgression,this.position=e.position,this.otherLocations=e.otherLocations}static deserialize(e){if(!e)return;const t=ft(e.progression),i=ft(e.totalProgression),s=ft(e.position),n=new Map,o=new Set(["fragment","fragments","progression","totalProgression","position"]);return Object.entries(e).forEach(([a,l])=>{o.has(a)||n.set(a,l)}),new Gr({fragments:Vr(e.fragments||e.fragment),progression:t!==void 0&&t>=0&&t<=1?t:void 0,totalProgression:i!==void 0&&i>=0&&i<=1?i:void 0,position:s!==void 0&&s>0?s:void 0,otherLocations:n.size===0?void 0:n})}serialize(){const e={};return this.fragments&&(e.fragments=this.fragments),this.progression!==void 0&&(e.progression=this.progression),this.totalProgression!==void 0&&(e.totalProgression=this.totalProgression),this.position!==void 0&&(e.position=this.position),this.otherLocations&&this.otherLocations.forEach((t,i)=>e[i]=t),e}},it=class Xr{constructor(e){this.after=e.after,this.before=e.before,this.highlight=e.highlight}static deserialize(e){if(e)return new Xr({after:e.after,before:e.before,highlight:e.highlight})}serialize(){const e={};return this.after!==void 0&&(e.after=this.after),this.before!==void 0&&(e.before=this.before),this.highlight!==void 0&&(e.highlight=this.highlight),e}},$e=class hi{constructor(e){this.href=e.href,this.type=e.type,this.title=e.title,this.locations=e.locations?e.locations:new k({}),this.text=e.text}static deserialize(e){if(e&&e.href&&e.type)return new hi({href:e.href,type:e.type,title:e.title,locations:k.deserialize(e.locations),text:it.deserialize(e.text)})}serialize(){const e={href:this.href,type:this.type};return this.title!==void 0&&(e.title=this.title),this.locations&&(e.locations=this.locations.serialize()),this.text&&(e.text=this.text.serialize()),e}copyWithLocations(e){return new hi({href:this.href,type:this.type,title:this.title,text:this.text,locations:new k({...this.locations,...e})})}},Yr=class yt{constructor(e){this.href=e.href,this.templated=e.templated,this.type=e.type,this.title=e.title,this.rels=e.rels,this.properties=e.properties,this.height=e.height,this.width=e.width,this.size=e.size,this.duration=e.duration,this.bitrate=e.bitrate,this.languages=e.languages,this.alternates=e.alternates,this.children=e.children}static deserialize(e){if(!(!e||typeof e.href!="string"))return new yt({href:e.href,templated:e.templated,type:e.type,title:e.title,rels:e.rel?Array.isArray(e.rel)?new Set(e.rel):new Set([e.rel]):void 0,properties:V.deserialize(e.properties),height:j(e.height),width:j(e.width),size:j(e.size),duration:j(e.duration),bitrate:j(e.bitrate),languages:Vr(e.language),alternates:_s.deserialize(e.alternate),children:_s.deserialize(e.children)})}serialize(){const e={href:this.href};return this.templated!==void 0&&(e.templated=this.templated),this.type!==void 0&&(e.type=this.type),this.title!==void 0&&(e.title=this.title),this.rels&&(e.rel=Zo(this.rels)),this.properties&&(e.properties=this.properties.serialize()),this.height!==void 0&&(e.height=this.height),this.width!==void 0&&(e.width=this.width),this.size!==void 0&&(e.size=this.size),this.duration!==void 0&&(e.duration=this.duration),this.bitrate!==void 0&&(e.bitrate=this.bitrate),this.languages&&(e.language=this.languages),this.alternates&&(e.alternate=this.alternates.serialize()),this.children&&(e.children=this.children.serialize()),e}get mediaType(){return this.type!==void 0?w.parse({mediaType:this.type}):w.BINARY}toURL(e){const t=this.href.replace(/^(\/)/,"");if(t.length===0)return;let i=e||"/";return i.startsWith("/")&&(i="file://"+i),new URL(t,i).href.replace(/^(file:\/\/)/,"")}get templateParameters(){return this.templated?new As(this.href).parameters:new Set}expandTemplate(e){return new yt({href:new As(this.href).expand(e),templated:!1})}addProperties(e){const t=yt.deserialize(this.serialize());return t.properties=t.properties?t.properties?.add(e):new V(e),t}get locator(){let e=this.href.split("#");return new $e({href:e.length>0&&e[0]!==void 0?e[0]:this.href,type:this.type??"",title:this.title,locations:new k({fragments:e.length>1&&e[1]!==void 0?[e[1]]:[]})})}},_s=class qr{constructor(e){this.items=e}static deserialize(e){if(e&&Array.isArray(e))return new qr(e.map(t=>Yr.deserialize(t)).filter(t=>t!==void 0))}serialize(){return this.items.map(e=>e.serialize())}findWithRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.find(t)}filterByRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.filter(t)}findWithHref(e){const t=i=>i.href===e;return this.items.find(t)}findIndexWithHref(e){const t=i=>i.href===e;return this.items.findIndex(t)}findWithMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.find(t)}filterByMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.filter(t)}filterByMediaTypes(e){const t=i=>{for(const s of e)if(i.mediaType.matches(s))return!0;return!1};return this.items.filter(t)}everyIsAudio(){const e=t=>t.mediaType.isAudio;return this.items.length>0&&this.items.every(e)}everyIsBitmap(){const e=t=>t.mediaType.isBitmap;return this.items.length>0&&this.items.every(e)}everyIsHTML(){const e=t=>t.mediaType.isHTML;return this.items.length>0&&this.items.every(e)}everyIsVideo(){const e=t=>t.mediaType.isVideo;return this.items.length>0&&this.items.every(e)}everyMatchesMediaType(e){return Array.isArray(e)?this.items.length>0&&this.items.every(t=>{for(const i of e)return t.mediaType.matches(i);return!1}):this.items.length>0&&this.items.every(t=>t.mediaType.matches(e))}filterLinksHasType(){return this.items.filter(e=>e.type)}};V.prototype.getContains=function(){return new Set(this.otherProperties.contains||[])};class xt{constructor(e){this.cssSelector=e.cssSelector,this.textNodeIndex=e.textNodeIndex,this.charOffset=e.charOffset}static deserialize(e){if(!(e&&e.cssSelector))return;let t=j(e.textNodeIndex);if(t===void 0)return;let i=j(e.charOffset);return i===void 0&&(i=j(e.offset)),new xt({cssSelector:e.cssSelector,textNodeIndex:t,charOffset:i})}serialize(){const e={cssSelector:this.cssSelector,textNodeIndex:this.textNodeIndex};return this.charOffset!==void 0&&(e.charOffset=this.charOffset),e}}class Li{constructor(e){this.start=e.start,this.end=e.end}static deserialize(e){if(!e)return;let t=xt.deserialize(e.start);if(t)return new Li({start:t,end:xt.deserialize(e.end)})}serialize(){const e={start:this.start.serialize()};return this.end&&(e.end=this.end.serialize()),e}}k.prototype.getCssSelector=function(){return this.otherLocations?.get("cssSelector")};k.prototype.getPartialCfi=function(){return this.otherLocations?.get("partialCfi")};k.prototype.getDomRange=function(){return Li.deserialize(this.otherLocations?.get("domRange"))};k.prototype.fragmentParameters=function(){return new Map(this.fragments.map(r=>r.startsWith("#")?r.slice(1):r).join("&").split("&").filter(r=>!r.startsWith("#")).map(r=>r.split("=")).filter(r=>r.length===2).map(r=>[r[0].trim().toLowerCase(),r[1].trim()]))};k.prototype.htmlId=function(){if(!this.fragments.length)return;let r=this.fragments.find(e=>e.length&&!e.includes("="));if(!r){const e=this.fragmentParameters();e.has("id")?r=e.get("id"):e.has("name")&&(r=e.get("name"))}return r?.startsWith("#")?r.slice(1):r};k.prototype.page=function(){const r=parseInt(this.fragmentParameters().get("page"));if(!isNaN(r)&&r>=0)return r};k.prototype.time=function(){const r=parseInt(this.fragmentParameters().get("t"));if(!isNaN(r))return r};k.prototype.space=function(){const r=this.fragmentParameters();if(!r.has("xywh"))return;const e=r.get("xywh").split(",").map(t=>parseInt(t));if(e.length===4&&!e.some(isNaN))return e};class zi{constructor(e){this.currency=e.currency,this.value=e.value}static deserialize(e){if(!e)return;let t=e.currency;if(!(t&&typeof t=="string"&&t.length>0))return;let i=j(e.value);if(i!==void 0)return new zi({currency:t,value:i})}serialize(){return{currency:this.currency,value:this.value}}}let Qo=class vt{constructor(e){this.type=e.type,this.children=e.children}static deserialize(e){if(e&&e.type)return new vt({type:e.type,children:vt.deserializeArray(e.children)})}static deserializeArray(e){if(Array.isArray(e))return e.map(t=>vt.deserialize(t)).filter(t=>t!==void 0)}serialize(){const e={type:this.type};return this.children&&(e.children=this.children.map(t=>t.serialize())),e}};class Mi{constructor(e){this.total=e.total,this.position=e.position}static deserialize(e){if(e)return new Mi({total:j(e.total),position:j(e.position)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.position!==void 0&&(e.position=this.position),e}}class Ii{constructor(e){this.total=e.total,this.available=e.available}static deserialize(e){if(e)return new Ii({total:j(e.total),available:j(e.available)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.available!==void 0&&(e.available=this.available),e}}class Ni{constructor(e){this.state=e.state,this.since=e.since,this.until=e.until}static deserialize(e){if(e&&e.state)return new Ni({state:e.state,since:Cs(e.since),until:Cs(e.until)})}serialize(){const e={state:this.state};return this.since!==void 0&&(e.since=this.since.toISOString()),this.until!==void 0&&(e.until=this.until.toISOString()),e}}V.prototype.getNumberOfItems=function(){return j(this.otherProperties.numberOfItems)};V.prototype.getPrice=function(){return zi.deserialize(this.otherProperties.price)};V.prototype.getIndirectAcquisitions=function(){const r=this.otherProperties.indirectAcquisition;if(r&&Array.isArray(r))return r.map(e=>Qo.deserialize(e)).filter(e=>e!==void 0)};V.prototype.getHolds=function(){return Mi.deserialize(this.otherProperties.holds)};V.prototype.getCopies=function(){return Ii.deserialize(this.otherProperties.copies)};V.prototype.getAvailability=function(){return Ni.deserialize(this.otherProperties.availability)};V.prototype.getAuthenticate=function(){return Yr.deserialize(this.otherProperties.authenticate)};const ea="CssSelectorGenerator";function Os(r="unknown problem",...e){console.warn(`${ea}: ${r}`,...e)}function ta(r){return r instanceof RegExp}function ia(r){return r.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".+")}function sa(r){const e=r.map(t=>{if(ta(t))return i=>t.test(i);if(typeof t=="function")return i=>{const s=t(i);return typeof s!="boolean"?(Os("pattern matcher function invalid","Provided pattern matching function does not return boolean. It's result will be ignored.",t),!1):s};if(typeof t=="string"){const i=new RegExp("^"+ia(t)+"$");return s=>i.test(s)}return Os("pattern matcher invalid","Pattern matching only accepts strings, regular expressions and/or functions. This item is invalid and will be ignored.",t),()=>!1});return t=>e.some(i=>i(t))}sa(["class","id","ng-*"]);let st=class{};function Rs(r){return r.split("").reverse().join("")}function ra(r,e,t){const i=Rs(e);return t.map(s=>{const n=Math.max(0,s.end-e.length-s.errors),o=Rs(r.slice(n,s.end));return{start:Jr(o,i,s.errors).reduce((a,l)=>s.end-l.end<a?s.end-l.end:a,s.end),end:s.end,errors:s.errors}})}function Ht(r){return(r|-r)>>31&1}function Ls(r,e,t,i){let s=r.P[t],n=r.M[t];const o=i>>>31,a=e[t]|o,l=a|n,h=(a&s)+s^s|a;let u=n|~(h|s),d=s&h;const p=Ht(u&r.lastRowMask[t])-Ht(d&r.lastRowMask[t]);return u<<=1,d<<=1,d|=o,u|=Ht(i)-o,s=d|~(l|u),n=u&l,r.P[t]=s,r.M[t]=n,p}function Jr(r,e,t){if(e.length===0)return[];t=Math.min(t,e.length);const i=[],s=32,n=Math.ceil(e.length/s)-1,o={P:new Uint32Array(n+1),M:new Uint32Array(n+1),lastRowMask:new Uint32Array(n+1)};o.lastRowMask.fill(1<<31),o.lastRowMask[n]=1<<(e.length-1)%s;const a=new Uint32Array(n+1),l=new Map,h=[];for(let p=0;p<256;p++)h.push(a);for(let p=0;p<e.length;p+=1){const g=e.charCodeAt(p);if(l.has(g))continue;const c=new Uint32Array(n+1);l.set(g,c),g<h.length&&(h[g]=c);for(let m=0;m<=n;m+=1){c[m]=0;for(let b=0;b<s;b+=1){const x=m*s+b;x>=e.length||e.charCodeAt(x)===g&&(c[m]|=1<<b)}}}let u=Math.max(0,Math.ceil(t/s)-1);const d=new Uint32Array(n+1);for(let p=0;p<=u;p+=1)d[p]=(p+1)*s;d[n]=e.length;for(let p=0;p<=u;p+=1)o.P[p]=-1,o.M[p]=0;for(let p=0;p<r.length;p+=1){const g=r.charCodeAt(p);let c;g<h.length?c=h[g]:(c=l.get(g),typeof c>"u"&&(c=a));let m=0;for(let b=0;b<=u;b+=1)m=Ls(o,c,b,m),d[b]+=m;if(d[u]-m<=t&&u<n&&(c[u+1]&1||m<0)){u+=1,o.P[u]=-1,o.M[u]=0;let b;if(u===n){const x=e.length%s;b=x===0?s:x}else b=s;d[u]=d[u-1]+b-m+Ls(o,c,u,m)}else for(;u>0&&d[u]>=t+s;)u-=1;u===n&&d[u]<=t&&(d[u]<t&&i.splice(0,i.length),i.push({start:-1,end:p+1,errors:d[u]}),t=d[u])}return i}function na(r,e,t){const i=Jr(r,e,t);return ra(r,e,i)}function Kr(r,e,t){let i=0;const s=[];for(;i!==-1;)i=r.indexOf(e,i),i!==-1&&(s.push({start:i,end:i+e.length,errors:0}),i+=1);return s.length>0?s:na(r,e,t)}function zs(r,e){return e.length===0||r.length===0?0:1-Kr(r,e,e.length)[0].errors/e.length}function oa(r,e,t={}){if(e.length===0)return null;const i=Math.min(256,e.length/2),s=Kr(r,e,i);if(s.length===0)return null;const n=a=>{const l=1-a.errors/e.length,h=t.prefix?zs(r.slice(Math.max(0,a.start-t.prefix.length),a.start),t.prefix):1,u=t.suffix?zs(r.slice(a.end,a.end+t.suffix.length),t.suffix):1;let d=1;return typeof t.hint=="number"&&(d=1-Math.abs(a.start-t.hint)/r.length),(50*l+20*h+20*u+2*d)/92},o=s.map(a=>({start:a.start,end:a.end,score:n(a)}));return o.sort((a,l)=>l.score-a.score),o[0]}function ci(r,e,t){const i=t===1?e:e-1;if(r.charAt(i).trim()!=="")return e;let s,n;if(t===2?(s=r.substring(0,e),n=s.trimEnd()):(s=r.substring(e),n=s.trimStart()),!n.length)return-1;const o=s.length-n.length;return t===2?e-o:e+o}function Ms(r,e){const t=r.commonAncestorContainer.ownerDocument.createNodeIterator(r.commonAncestorContainer,NodeFilter.SHOW_TEXT),i=e===1?r.startContainer:r.endContainer,s=e===1?r.endContainer:r.startContainer;let n=t.nextNode();for(;n&&n!==i;)n=t.nextNode();e===2&&(n=t.previousNode());let o=-1;const a=()=>{if(n=e===1?t.nextNode():t.previousNode(),n){const l=n.textContent,h=e===1?0:l.length;o=ci(l,h,e)}};for(;n&&o===-1&&n!==s;)a();if(n&&o>=0)return{node:n,offset:o};throw new RangeError("No text nodes with non-whitespace text found in range")}function aa(r){if(!r.toString().trim().length)throw new RangeError("Range contains no non-whitespace text");if(r.startContainer.nodeType!==Node.TEXT_NODE)throw new RangeError("Range startContainer is not a text node");if(r.endContainer.nodeType!==Node.TEXT_NODE)throw new RangeError("Range endContainer is not a text node");const e=r.cloneRange();let t=!1,i=!1;const s={start:ci(r.startContainer.textContent,r.startOffset,1),end:ci(r.endContainer.textContent,r.endOffset,2)};if(s.start>=0&&(e.setStart(r.startContainer,s.start),t=!0),s.end>0&&(e.setEnd(r.endContainer,s.end),i=!0),t&&i)return e;if(!t){const{node:n,offset:o}=Ms(e,1);n&&o>=0&&e.setStart(n,o)}if(!i){const{node:n,offset:o}=Ms(e,2);n&&o>0&&e.setEnd(n,o)}return e}function Zr(r){switch(r.nodeType){case Node.ELEMENT_NODE:case Node.TEXT_NODE:return r.textContent?.length??0;default:return 0}}function Is(r){let e=r.previousSibling,t=0;for(;e;)t+=Zr(e),e=e.previousSibling;return t}function Qr(r,...e){let t=e.shift();const i=r.ownerDocument.createNodeIterator(r,NodeFilter.SHOW_TEXT),s=[];let n=i.nextNode(),o,a=0;for(;t!==void 0&&n;)o=n,a+o.data.length>t?(s.push({node:o,offset:t-a}),t=e.shift()):(n=i.nextNode(),a+=o.data.length);for(;t!==void 0&&o&&a===t;)s.push({node:o,offset:o.data.length}),t=e.shift();if(t!==void 0)throw new RangeError("Offset exceeds text length");return s}let ht=class ze{constructor(e,t){if(t<0)throw new Error("Offset is invalid");this.element=e,this.offset=t}relativeTo(e){if(!e.contains(this.element))throw new Error("Parent is not an ancestor of current element");let t=this.element,i=this.offset;for(;t!==e;)i+=Is(t),t=t.parentElement;return new ze(t,i)}resolve(e={}){try{return Qr(this.element,this.offset)[0]}catch(t){if(this.offset===0&&e.direction!==void 0){const i=document.createTreeWalker(this.element.getRootNode(),NodeFilter.SHOW_TEXT);i.currentNode=this.element;const s=e.direction===1,n=s?i.nextNode():i.previousNode();if(!n)throw t;return{node:n,offset:s?0:n.data.length}}else throw t}}static fromCharOffset(e,t){switch(e.nodeType){case Node.TEXT_NODE:return ze.fromPoint(e,t);case Node.ELEMENT_NODE:return new ze(e,t);default:throw new Error("Node is not an element or text node")}}static fromPoint(e,t){switch(e.nodeType){case Node.TEXT_NODE:{if(t<0||t>e.data.length)throw new Error("Text node offset is out of range");if(!e.parentElement)throw new Error("Text node has no parent");const i=Is(e)+t;return new ze(e.parentElement,i)}case Node.ELEMENT_NODE:{if(t<0||t>e.childNodes.length)throw new Error("Child node offset is out of range");let i=0;for(let s=0;s<t;s++)i+=Zr(e.childNodes[s]);return new ze(e,i)}default:throw new Error("Point is not in an element or text node")}}},di=class je{constructor(e,t){this.start=e,this.end=t}relativeTo(e){return new je(this.start.relativeTo(e),this.end.relativeTo(e))}toRange(){let e,t;this.start.element===this.end.element&&this.start.offset<=this.end.offset?[e,t]=Qr(this.start.element,this.start.offset,this.end.offset):(e=this.start.resolve({direction:1}),t=this.end.resolve({direction:2}));const i=new Range;return i.setStart(e.node,e.offset),i.setEnd(t.node,t.offset),i}static fromRange(e){const t=ht.fromPoint(e.startContainer,e.startOffset),i=ht.fromPoint(e.endContainer,e.endOffset);return new je(t,i)}static fromOffsets(e,t,i){return new je(new ht(e,t),new ht(e,i))}static trimmedRange(e){return aa(je.fromRange(e).toRange())}},la=class ui{constructor(e,t,i){this.root=e,this.start=t,this.end=i}static fromRange(e,t){const i=di.fromRange(t).relativeTo(e);return new ui(e,i.start.offset,i.end.offset)}static fromSelector(e,t){return new ui(e,t.start,t.end)}toSelector(){return{type:"TextPositionSelector",start:this.start,end:this.end}}toRange(){return di.fromOffsets(this.root,this.start,this.end).toRange()}};class Tt{constructor(e,t,i={}){this.root=e,this.exact=t,this.context=i}static fromRange(e,t){const i=e.textContent,s=di.fromRange(t).relativeTo(e),n=s.start.offset,o=s.end.offset,a=32;return new Tt(e,i.slice(n,o),{prefix:i.slice(Math.max(0,n-a),n),suffix:i.slice(o,Math.min(i.length,o+a))})}static fromSelector(e,t){const{prefix:i,suffix:s}=t;return new Tt(e,t.exact,{prefix:i,suffix:s})}toSelector(){return{type:"TextQuoteSelector",exact:this.exact,prefix:this.context.prefix,suffix:this.context.suffix}}toRange(e={}){return this.toPositionAnchor(e).toRange()}toPositionAnchor(e={}){const t=this.root.textContent,i=oa(t,this.exact,{...this.context,hint:e.hint});if(!i)throw new Error("Quote not found");return new la(this.root,i.start,i.end)}}function ha(r){const e=r.tagName.toUpperCase();return e==="IMG"||e==="VIDEO"||e==="AUDIO"||e==="IFRAME"||e==="OBJECT"||e==="EMBED"||e==="CANVAS"}function Dt(r,e){try{const t=e.locations,i=e.text;if(i&&i.highlight){let s;t&&t.getCssSelector()&&(s=r.querySelector(t.getCssSelector())),s||(s=r.body);const n=new Tt(s,i.highlight,{prefix:i.before,suffix:i.after});try{return n.toRange()}catch{return console.warn("Quote not found:",n),null}}if(t){let s=null;if(!s&&t.getCssSelector()&&(s=r.querySelector(t.getCssSelector())),!s&&t.fragments){for(const n of t.fragments)if(s=r.getElementById(n),s)break}if(s){const n=r.createRange();return s.childNodes.length===0||ha(s)?(n.selectNode(s),n):(n.setStartBefore(s),n.setEndAfter(s),n)}}}catch(t){console.error(t)}return null}function ca(r,e){let t=r.getClientRects();t.length||r.commonAncestorContainer.nodeType===Node.ELEMENT_NODE&&(t=r.commonAncestorContainer.getClientRects());const i=1,s=[];for(const h of t)s.push({bottom:h.bottom,height:h.height,left:h.left,right:h.right,top:h.top,width:h.width});const n=en(s,i),o=ua(n,i),a=tn(o),l=4;for(let h=a.length-1;h>=0;h--){const u=a[h];if(!(u.width*u.height>l))if(a.length>1)a.splice(h,1);else break}return a}function en(r,e,t){for(let i=0;i<r.length;i++)for(let s=i+1;s<r.length;s++){const n=r[i],o=r[s];if(n===o)continue;const a=ie(n.top,o.top,e)&&ie(n.bottom,o.bottom,e),l=ie(n.left,o.left,e)&&ie(n.right,o.right,e);if(a&&!l&&sn(n,o,e)){const h=r.filter(d=>d!==n&&d!==o),u=da(n,o);return h.push(u),en(h,e)}}return r}function da(r,e){const t=Math.min(r.left,e.left),i=Math.max(r.right,e.right),s=Math.min(r.top,e.top),n=Math.max(r.bottom,e.bottom);return{bottom:n,height:n-s,left:t,right:i,top:s,width:i-t}}function ua(r,e){const t=new Set(r);for(const i of r){if(!(i.width>1&&i.height>1)){t.delete(i);continue}for(const s of r)if(i!==s&&t.has(s)&&pa(s,i,e)){t.delete(i);break}}return Array.from(t)}function pa(r,e,t){return ct(r,e.left,e.top,t)&&ct(r,e.right,e.top,t)&&ct(r,e.left,e.bottom,t)&&ct(r,e.right,e.bottom,t)}function ct(r,e,t,i){return(r.left<e||ie(r.left,e,i))&&(r.right>e||ie(r.right,e,i))&&(r.top<t||ie(r.top,t,i))&&(r.bottom>t||ie(r.bottom,t,i))}function tn(r){for(let e=0;e<r.length;e++)for(let t=e+1;t<r.length;t++){const i=r[e],s=r[t];if(i!==s&&sn(i,s,-1)){let n=[],o;const a=Ns(i,s);if(a.length===1)n=a,o=i;else{const h=Ns(s,i);a.length<h.length?(n=a,o=i):(n=h,o=s)}const l=r.filter(h=>h!==o);return Array.prototype.push.apply(l,n),tn(l)}}return r}function Ns(r,e){const t=ma(e,r);if(t.height===0||t.width===0)return[r];const i=[];{const s={bottom:r.bottom,height:0,left:r.left,right:t.left,top:r.top,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}{const s={bottom:t.top,height:0,left:t.left,right:t.right,top:r.top,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}{const s={bottom:r.bottom,height:0,left:t.left,right:t.right,top:t.bottom,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}{const s={bottom:r.bottom,height:0,left:t.right,right:r.right,top:r.top,width:0};s.width=s.right-s.left,s.height=s.bottom-s.top,s.height!==0&&s.width!==0&&i.push(s)}return i}function ma(r,e){const t=Math.max(r.left,e.left),i=Math.min(r.right,e.right),s=Math.max(r.top,e.top),n=Math.min(r.bottom,e.bottom);return{bottom:n,height:Math.max(0,n-s),left:t,right:i,top:s,width:Math.max(0,i-t)}}function sn(r,e,t){return(r.left<e.right||t>=0&&ie(r.left,e.right,t))&&(e.left<r.right||t>=0&&ie(e.left,r.right,t))&&(r.top<e.bottom||t>=0&&ie(r.top,e.bottom,t))&&(e.top<r.bottom||t>=0&&ie(e.top,r.bottom,t))}function ie(r,e,t){return Math.abs(r-e)<=t}function rn(r){const e={},t=r.document.documentElement.style;for(const i in r.document.documentElement.style)Object.hasOwn(t,i)&&!Number.isNaN(Number.parseInt(i))&&(e[t[i]]=t.getPropertyValue(t[i]));return e}function ga(r,e){const t=rn(r);Object.keys(t).forEach(i=>{e.hasOwnProperty(i)||ki(r,i)}),Object.entries(e).forEach(([i,s])=>{t[i]!==s&&Pt(r,i,s)})}function ks(r,e){return r.document.documentElement.style.getPropertyValue(e)}function Pt(r,e,t){r.document.documentElement.style.setProperty(e,t)}function ki(r,e){r.document.documentElement.style.removeProperty(e)}const fa=r=>{if(r.startsWith("rgb")){const e=r.match(/rgb\((\d+),\s(\d+),\s(\d+)(?:,\s(\d+))?\)/);if(e)return{r:parseInt(e[1],10),g:parseInt(e[2],10),b:parseInt(e[3],10),a:e[4]?parseInt(e[4],10)/255:1}}else if(r.startsWith("#")){const e=r.slice(1);if(e.length===3||e.length===4)return{r:parseInt(e[0]+e[0],16)/255,g:parseInt(e[1]+e[1],16)/255,b:parseInt(e[2]+e[2],16)/255,a:e.length===4?parseInt(e[3]+e[3],16)/255:1};if(e.length===6||e.length===8)return{r:parseInt(e[0]+e[1],16)/255,g:parseInt(e[2]+e[3],16)/255,b:parseInt(e[4]+e[5],16)/255,a:e.length===8?parseInt(e[6]+e[7],16)/255:1}}return{r:0,g:0,b:0,a:1}},ya=r=>.2126*r.r*r.a+.7152*r.g*r.a+.0722*r.b*r.a,va=r=>{const e=fa(r);return ya(e)<128},wa=()=>"Highlight"in window,Fs=["IMG","IMAGE","AUDIO","VIDEO","SVG"];class Sa{constructor(e,t,i,s){this.wnd=e,this.comms=t,this.id=i,this.name=s,this.items=[],this.lastItemId=0,this.container=void 0,this.activateable=!1,this.experimentalHighlights=!1,this.currentRender=0,wa()&&(this.experimentalHighlights=!0,this.notTextFlag=new Map)}get activeable(){return this.activateable}set activeable(e){this.activateable=e}add(e){const t=`${this.id}-${this.lastItemId++}`,i=Dt(this.wnd.document,e.locator);if(!i){this.comms.log("Can't locate DOM range for decoration",e);return}const s=i.commonAncestorContainer;s.nodeType!==Node.TEXT_NODE&&this.experimentalHighlights&&(Fs.includes(s.nodeName.toUpperCase())&&this.notTextFlag?.set(t,!0),s.querySelector(Fs.join(", ").toLowerCase())&&this.notTextFlag?.set(t,!0),(s.textContent?.trim()||"").length===0&&this.notTextFlag?.set(t,!0));const n={decoration:e,id:t,range:i};this.items.push(n),this.layout(n),this.renderLayout([n])}remove(e){const t=this.items.findIndex(s=>s.decoration.id===e);if(t<0)return;const i=this.items[t];this.items.splice(t,1),i.clickableElements=void 0,i.container&&(i.container.remove(),i.container=void 0),this.experimentalHighlights&&!this.notTextFlag?.has(i.id)&&this.wnd.CSS.highlights.get(this.id)?.delete(i.range),this.notTextFlag?.delete(i.id)}update(e){this.remove(e.id),this.add(e)}clear(){this.clearContainer(),this.items.length=0,this.notTextFlag?.clear()}requestLayout(){this.wnd.cancelAnimationFrame(this.currentRender),this.clearContainer(),this.items.forEach(e=>this.layout(e)),this.renderLayout(this.items)}experimentalLayout(e){const[t,i]=this.requireContainer(!0);i.add(e.range),t.innerHTML=`
        ::highlight(${this.id}) {
            color: black;
            background-color: ${e.decoration?.style?.tint??"yellow"};
        }`}layout(e){if(this.experimentalHighlights&&!this.notTextFlag?.has(e.id))return this.experimentalLayout(e);const t=this.wnd.document.createElement("div");t.setAttribute("id",e.id),t.style.setProperty("pointer-events","none");const i=this.wnd.innerWidth,s=parseInt(getComputedStyle(this.wnd.document.documentElement).getPropertyValue("column-count")),n=i/(s||1),o=this.wnd.document.scrollingElement,a=o.scrollLeft,l=o.scrollTop,h=(c,m,b)=>{if(c.style.position="absolute",e.decoration?.style?.width==="viewport"){c.style.width=`${i}px`,c.style.height=`${m.height}px`;let x=Math.floor(m.left/i)*i;c.style.left=`${x+a}px`,c.style.top=`${m.top+l}px`}else if(e.decoration?.style?.width==="bounds")c.style.width=`${b.width}px`,c.style.height=`${m.height}px`,c.style.left=`${b.left+a}px`,c.style.top=`${m.top+l}px`;else if(e.decoration?.style?.width==="page"){c.style.width=`${n}px`,c.style.height=`${m.height}px`;let x=Math.floor(m.left/n)*n;c.style.left=`${x+a}px`,c.style.top=`${m.top+l}px`}else c.style.width=`${m.width}px`,c.style.height=`${m.height}px`,c.style.left=`${m.left+a}px`,c.style.top=`${m.top+l}px`},u=e.range.getBoundingClientRect();let d=this.wnd.document.createElement("template");const p=ks(this.wnd,"--USER__appearance")==="readium-night-on"||va(ks(this.wnd,"--USER__backgroundColor"));d.innerHTML=`
        <div
            class="r2-highlight-0"
            style="${[`background-color: ${e.decoration?.style?.tint??"yellow"} !important`,`mix-blend-mode: ${p?"exclusion":"multiply"} !important`,"opacity: 1 !important","box-sizing: border-box !important"].join("; ")}"
        >
        </div>
        `.trim();const g=d.content.firstElementChild;if(e.decoration?.style?.layout==="bounds"){const c=g.cloneNode(!0);c.style.setProperty("pointer-events","none"),h(c,u,u),t.append(c)}else{let c=ca(e.range);c=c.sort((m,b)=>m.top<b.top?-1:m.top>b.top?1:0);for(let m of c){const b=g.cloneNode(!0);b.style.setProperty("pointer-events","none"),h(b,m,u),t.append(b)}}e.container=t,e.clickableElements=Array.from(t.querySelectorAll("[data-activable='1']")),e.clickableElements.length||(e.clickableElements=Array.from(t.children))}renderLayout(e){this.wnd.cancelAnimationFrame(this.currentRender),this.currentRender=this.wnd.requestAnimationFrame(()=>{e=e.filter(t=>!this.experimentalHighlights||!!this.notTextFlag?.has(t.id)),!(!e||e.length===0)&&this.requireContainer().append(...e.map(t=>t.container).filter(t=>!!t))})}requireContainer(e=!1){if(e){let t;this.wnd.document.getElementById(`${this.id}-style`)?t=this.wnd.document.getElementById(`${this.id}-style`):(t=this.wnd.document.createElement("style"),t.dataset.readium="true",t.id=`${this.id}-style`,this.wnd.document.head.appendChild(t));let i;return this.wnd.CSS.highlights.has(this.id)?i=this.wnd.CSS.highlights.get(this.id):(i=new this.wnd.Highlight,this.wnd.CSS.highlights.set(this.id,i)),[t,i]}return this.container||(this.container=this.wnd.document.createElement("div"),this.container.setAttribute("id",this.id),this.container.dataset.group=this.name,this.container.dataset.readium="true",this.container.style.setProperty("pointer-events","none"),this.container.style.display="contents",this.wnd.document.body.append(this.container)),this.container}clearContainer(){this.experimentalHighlights&&this.wnd.CSS.highlights.delete(this.id),this.container&&(this.container.remove(),this.container=void 0)}}const nn=class pi extends st{constructor(){super(...arguments),this.resizeFrame=0,this.lastGroupId=0,this.groups=new Map,this.handleResizer=this.handleResize.bind(this)}cleanup(){this.groups.forEach(e=>e.clear()),this.groups.clear()}handleResize(){this.wnd.clearTimeout(this.resizeFrame),this.resizeFrame=this.wnd.setTimeout(()=>{this.groups.forEach(e=>{e.experimentalHighlights||e.requestLayout()})},50)}mount(e,t){return this.wnd=e,t.register("decorate",pi.moduleName,(i,s)=>{const n=i;n.decoration&&n.decoration.locator&&(n.decoration.locator=$e.deserialize(n.decoration.locator)),this.groups.has(n.group)||this.groups.set(n.group,new Sa(e,t,`readium-decoration-${this.lastGroupId++}`,n.group));const o=this.groups.get(n.group);switch(n.action){case"add":o?.add(n.decoration);break;case"remove":o?.remove(n.decoration.id);break;case"clear":o?.clear();break;case"update":o?.update(n.decoration);break}s(!0)}),this.resizeObserver=new ResizeObserver(()=>e.requestAnimationFrame(()=>this.handleResize())),this.resizeObserver.observe(e.document.body),e.addEventListener("orientationchange",this.handleResizer),e.addEventListener("resize",this.handleResizer),t.log("Decorator Mounted"),!0}unmount(e,t){return e.removeEventListener("orientationchange",this.handleResizer),e.removeEventListener("resize",this.handleResizer),t.unregisterAll(pi.moduleName),this.resizeObserver.disconnect(),this.cleanup(),t.log("Decorator Unmounted"),!0}};nn.moduleName="decorator";let ba=nn;const Ds="readium-snapper-style",on=class mi extends st{constructor(){super(...arguments),this.protected=!1}buildStyles(){return`
        html, body {
            touch-action: manipulation;
            user-select: ${this.protected?"none":"auto"};
        }`}mount(e,t){const i=e.document.createElement("style");return i.dataset.readium="true",i.id=Ds,i.textContent=this.buildStyles(),e.document.head.appendChild(i),t.register("protect",mi.moduleName,(s,n)=>{this.protected=!0,i.textContent=this.buildStyles(),n(!0)}),t.register("unprotect",mi.moduleName,(s,n)=>{this.protected=!1,i.textContent=this.buildStyles(),n(!0)}),t.log("Snapper Mounted"),!0}unmount(e,t){return e.document.getElementById(Ds)?.remove(),t.log("Snapper Unmounted"),!0}};on.moduleName="snapper";let Fi=on;function Se(r){return r.document.body.dir.toLowerCase()==="rtl"}function an(r){return parseInt(r.getComputedStyle(r.document.documentElement).getPropertyValue("column-count"))}function Ea(r){const e=getComputedStyle(r),t=parseFloat(e.paddingTop||"0"),i=parseFloat(e.paddingBottom||"0");return r.clientHeight-t-i}function Us(r){const e=an(r);if(!e)return!1;const t=r.document.querySelectorAll("div[id^='readium-virtual-page']");for(const l of t)l.remove();const i=t.length,s=r.document.scrollingElement.scrollWidth,n=r.visualViewport.width,o=Math.round(s/n*e)%e,a=e===1||o===0?0:e-o;if(a>0)for(let l=0;l<a;l++){const h=r.document.createElement("div");h.setAttribute("id",`readium-virtual-page-${l}`),h.dataset.readium="true",CSS.supports("break-before","column")?h.style.breakBefore="column":(CSS.supports("break-inside","avoid-column")&&(h.style.breakInside="avoid-column"),h.style.height=Ea(r.document.documentElement)+"px"),h.innerHTML="&#8203;",r.document.body.appendChild(h)}return i!==a}function ln(r){const e=r.document.createElement("style");e.appendChild(r.document.createTextNode("*{}")),r.document.body.appendChild(e),r.document.body.removeChild(e)}function xa(r){return r<.5?2*r*r:-1+(4-2*r)*r}function L(r){const e=r.getSelection();e&&e.removeAllRanges()}const Ta=["a","audio","button","canvas","details","input","label","option","select","submit","textarea","video"];function hn(r){return Ta.indexOf(r.nodeName.toLowerCase())!==-1||r.hasAttribute("contenteditable")&&r.getAttribute("contenteditable")?.toLowerCase()!=="false"?r:r.parentElement?hn(r.parentElement):null}function Di(r,e){const t=cn(r,r.document.body,e),i=r._readium_cssSelectorGenerator.getCssSelector(t,{selectors:["tag","id","class","nthchild","nthoftype","attribute"]});return new $e({href:"#",type:"application/xhtml+xml",locations:new k({otherLocations:new Map([["cssSelector",i]])}),text:new it({highlight:t.textContent||void 0})})}function cn(r,e,t){for(var i=0;i<e.children.length;i++){const s=e.children[i];if(!Aa(s)&&Pa(r,s,t))return Ca(r,s)?s:cn(r,s,t)}return e}function Pa(r,e,t){if(e===document.body||e===document.documentElement)return!0;if(!document||!document.documentElement||!document.body)return!1;const i=e.getBoundingClientRect();return t?i.bottom>0&&i.top<r.innerHeight:i.right>0&&i.left<r.innerWidth}function Ca(r,e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=r.innerHeight&&t.right<=r.innerWidth}function Aa(r){const e=getComputedStyle(r);if(e){const t=e.getPropertyValue("display");if(t!="block"&&t!="list-item"||e.getPropertyValue("opacity")==="0")return!0}return!1}const Ws="readium-column-snapper-style",_a=200,dn=class q extends Fi{constructor(){super(...arguments),this.shakeTimeout=0,this.snappingCancelled=!1,this.alreadyScrollLeft=0,this.overscroll=0,this.cachedScrollWidth=0,this.touchState=0,this.startingX=void 0,this.endingX=void 0,this.onTouchStarter=this.onTouchStart.bind(this),this.onTouchEnder=this.onTouchEnd.bind(this),this.onWidthChanger=this.onWidthChange.bind(this),this.onTouchMover=this.onTouchMove.bind(this)}doc(){return this.wnd.document.scrollingElement}scrollOffset(){return this.doc().scrollLeft>0?this.doc().scrollLeft:this.alreadyScrollLeft}snapOffset(e){const t=e+(Se(this.wnd)?-1:1);return t-t%this.wnd.innerWidth}reportProgress(){const e=this.wnd.scrollX,t=this.cachedScrollWidth,i=Math.max(0,Math.min(1,e/t)),s=Math.max(0,Math.min(1,(e+this.wnd.innerWidth)/t));this.comms.send("progress",{start:i,end:s})}shake(){if(this.overscroll!==0||this.shakeTimeout!==0)return;const e=this.doc();e.classList.add(Se(this.wnd)?"readium-bounce-l":"readium-bounce-r");const t=this.scrollOffset();this.shakeTimeout=this.wnd.setTimeout(()=>{e.classList.remove("readium-bounce-l"),e.classList.remove("readium-bounce-r"),this.shakeTimeout=0,this.doc().scrollLeft=t},150)}takeOverSnap(){this.snappingCancelled=!0,this.clearTouches();const e=this.doc();this.overscroll=e.style.transform?.length>12?parseFloat(e.style.transform.slice(12).split("px")[0]):0}snapCurrentOffset(e=!1,t=!1){const i=this.wnd.scrollX>0?this.wnd.scrollX:this.alreadyScrollLeft,s=this.doc(),n=this.dragOffset(),o=an(this.wnd),a=Math.min(Math.max(0,i),this.cachedScrollWidth),l=Se(this.wnd)?-1:1,h=l*(this.wnd.innerWidth/3)*(l*n>0?2:1),u=this.snapOffset(a+h);if(e&&u!==this.scrollOffset()){this.snappingCancelled=!1;const d=(m,b,x,X)=>x>X?b:m+(b-m)*xa(x/X),p=_a*o;let g;const c=m=>{if(this.snappingCancelled)return;g||(g=m);const b=m-g,x=d(this.overscroll,0,b,p),X=d(i,u,b,p);s.scrollLeft=X,this.overscroll!==0&&(s.style.transform=`translate3d(${-x}px, 0px, 0px)`),b<p?this.wnd.requestAnimationFrame(c):(this.clearTouches(),s.style.removeProperty("transform"),s.scrollLeft=u,t||this.reportProgress())};this.wnd.requestAnimationFrame(c)}else s.style.removeProperty("transform"),this.wnd.requestAnimationFrame(()=>{s.scrollLeft=u,this.clearTouches(),t||this.reportProgress()})}dragOffset(){return(this.startingX??0)-(this.endingX??0)}clearTouches(){this.startingX=void 0,this.endingX=void 0,this.overscroll=0}onTouchStart(e){switch(e.stopPropagation(),this.takeOverSnap(),e.touches.length){case 1:break;case 2:this.onTouchEnd(e);return;default:{this.onTouchEnd(e),this.comms.send("tap_more",e.touches.length);return}}this.startingX=e.touches[0].clientX,this.alreadyScrollLeft=this.doc().scrollLeft,this.touchState=1}onTouchEnd(e){if(this.touchState===2){const t=this.dragOffset(),i=this.scrollOffset();this.cachedScrollWidth<=this.wnd.innerWidth?(this.reportProgress(),t>5&&this.comms.send("no_more",void 0),t<-5&&this.comms.send("no_less",void 0)):i<5&&t<5?(this.alreadyScrollLeft=0,this.comms.send("no_less",void 0)):this.cachedScrollWidth-i-this.wnd.innerWidth<5&&t>5&&(this.alreadyScrollLeft=this.cachedScrollWidth,this.comms.send("no_more",void 0)),this.snapCurrentOffset(!0),this.comms.send("swipe",t)}this.touchState=0}onWidthChange(){this.cachedScrollWidth=this.doc().scrollWidth,this.comms.ready&&this.snapCurrentOffset()}onTouchMove(e){if(this.touchState===0)return;this.touchState===1&&(this.touchState=2,L(this.wnd)),this.endingX=e.touches[0].clientX;const t=this.dragOffset(),i=this.alreadyScrollLeft+t;i<0?(this.overscroll=i,this.doc().style.transform=`translate3d(${-this.overscroll}px, 0px, 0px)`):i+this.wnd.innerWidth>this.cachedScrollWidth?(this.overscroll=i,this.doc().style.transform=`translate3d(${-i}px, 0px, 0px)`):(this.overscroll=0,this.doc().style.removeProperty("transform"),this.doc().scrollLeft=this.alreadyScrollLeft+t)}mount(e,t){if(this.wnd=e,this.comms=t,!super.mount(e,t))return!1;e.navigator.epubReadingSystem&&(e.navigator.epubReadingSystem.layoutStyle="paginated");const i=e.document.createElement("style");i.dataset.readium="true",i.id=Ws,i.textContent=`
        @keyframes readium-bounce-l-animation {
            0%, 100% {transform: translate3d(0, 0, 0);}
            50% {transform: translate3d(-50px, 0, 0);}
        }

        @keyframes readium-bounce-r-animation {
            0%, 100% {transform: translate3d(0, 0, 0);}
            50% {transform: translate3d(50px, 0, 0);}
        }

        .readium-bounce-l {
            animation: readium-bounce-l-animation 150ms ease-out 1;
        }

        .readium-bounce-r {
            animation: readium-bounce-r-animation 150ms ease-out 1;
        }

        html {
            overflow: hidden;
        }

        body {
            -ms-overflow-style: none; /* for Internet Explorer, Edge */
        }

        * {
            scrollbar-width: none; /* for Firefox */
        }
        
        body::-webkit-scrollbar {
            display: none; /* for Chrome, Safari, and Opera */
        }
        `,e.document.head.appendChild(i),this.resizeObserver=new ResizeObserver(()=>{e.requestAnimationFrame(()=>{e&&Us(e)}),this.onWidthChange()}),this.resizeObserver.observe(e.document.body),this.mutationObserver=new MutationObserver(n=>{for(const o of n)if(o.target===this.wnd.document.documentElement){const a=o.oldValue,l=o.target.getAttribute("style"),h=/transform\s*:\s*([^;]+)/,u=a?.match(h),d=l?.match(h);(!u&&!d||u&&!d||u&&d&&u[1]!==d[1])&&(e.requestAnimationFrame(()=>{e&&Us(e)}),this.onWidthChange())}else e.requestAnimationFrame(()=>this.cachedScrollWidth=this.doc().scrollWidth)}),e.frameElement&&this.mutationObserver.observe(e.frameElement,{attributes:!0,attributeFilter:["style"]}),this.mutationObserver.observe(e.document,{attributes:!0,attributeFilter:["style"]}),this.mutationObserver.observe(e.document.documentElement,{attributes:!0,attributeFilter:["style"]});const s=n=>{const o=this.doc().scrollLeft;return this.doc().scrollLeft=this.snapOffset(n),o!==this.doc().scrollLeft};return e.addEventListener("orientationchange",this.onWidthChanger),e.addEventListener("resize",this.onWidthChanger),e.requestAnimationFrame(()=>this.cachedScrollWidth=this.doc().scrollWidth),t.register("go_progression",q.moduleName,(n,o)=>{const a=n;if(a<0||a>1){t.send("error",{message:"go_progression must be given a position from 0.0 to 1.0"}),o(!1);return}this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const l=this.cachedScrollWidth,h=Se(e)?-1:1,u=l*a*h;this.doc().scrollLeft=this.snapOffset(u),this.reportProgress(),L(this.wnd),o(!0)})}),t.register("go_id",q.moduleName,(n,o)=>{const a=e.document.getElementById(n);if(!a){o(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollLeft=this.snapOffset(a.getBoundingClientRect().left+e.scrollX),this.reportProgress(),L(this.wnd),o(!0)})}),t.register("go_text",q.moduleName,(n,o)=>{let a;Array.isArray(n)&&(n.length>1&&(a=n[1]),n=n[0]);const l=it.deserialize(n),h=Dt(this.wnd.document,new $e({href:e.location.href,type:"text/html",text:l,locations:a?new k({otherLocations:new Map([["cssSelector",a]])}):void 0}));if(!h){o(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollLeft=this.snapOffset(h.getBoundingClientRect().left+e.scrollX),this.reportProgress(),L(this.wnd),o(!0)})}),t.register("go_end",q.moduleName,(n,o)=>{const a=Se(e)?-1:1;this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const l=this.cachedScrollWidth*a;if(this.doc().scrollLeft===l)return o(!1);this.doc().scrollLeft=this.snapOffset(l),this.reportProgress(),L(this.wnd),o(!0)})}),t.register("go_start",q.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{if(this.doc().scrollLeft===0)return o(!1);this.doc().scrollLeft=0,this.reportProgress(),L(this.wnd),o(!0)})}),t.register("go_prev",q.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const a=e.scrollX-e.innerWidth,l=Se(e)?-(this.cachedScrollWidth-e.innerWidth):0,h=s(Math.max(a,l));h&&(this.reportProgress(),L(this.wnd)),o(h)})}),t.register("go_next",q.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth;const a=e.scrollX+e.innerWidth,l=Se(e)?0:this.cachedScrollWidth-e.innerWidth,h=s(Math.min(a,l));h&&(this.reportProgress(),L(this.wnd)),o(h)})}),t.register("unfocus",q.moduleName,(n,o)=>{this.snappingCancelled=!0,L(this.wnd),o(!0)}),t.register("shake",q.moduleName,(n,o)=>{this.shake(),o(!0)}),t.register("focus",q.moduleName,(n,o)=>{this.wnd.requestAnimationFrame(()=>{this.cachedScrollWidth=this.doc().scrollWidth,this.snapCurrentOffset(!1,!0),this.reportProgress(),o(!0)})}),t.register("first_visible_locator",q.moduleName,(n,o)=>{const a=Di(e,!1);this.comms.send("first_visible_locator",a.serialize()),o(!0)}),e.addEventListener("touchstart",this.onTouchStarter,{passive:!0}),e.addEventListener("touchend",this.onTouchEnder,{passive:!0}),e.addEventListener("touchmove",this.onTouchMover,{passive:!0}),e.document.addEventListener("touchstart",()=>{}),t.log("ColumnSnapper Mounted"),!0}unmount(e,t){return this.snappingCancelled=!0,t.unregisterAll(q.moduleName),this.resizeObserver.disconnect(),this.mutationObserver.disconnect(),e.removeEventListener("touchstart",this.onTouchStarter),e.removeEventListener("touchend",this.onTouchEnder),e.removeEventListener("touchmove",this.onTouchMover),e.removeEventListener("orientationchange",this.onWidthChanger),e.removeEventListener("resize",this.onWidthChanger),e.document.getElementById(Ws)?.remove(),t.log("ColumnSnapper Unmounted"),super.unmount(e,t)}};dn.moduleName="column_snapper";let Oa=dn;const Bs="readium-scroll-snapper-style",un=class Q extends Fi{constructor(){super(...arguments),this.initialScrollHandled=!1,this.isScrolling=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce=null,this.handleScroll=()=>{if(this.comms.ready&&!this.isResizing){if(!this.initialScrollHandled){this.lastScrollTop=this.doc().scrollTop,this.initialScrollHandled=!0,this.reportProgress();return}this.isScrolling||(this.isScrolling=!0,this.wnd.requestAnimationFrame(()=>{this.reportProgress();const e=this.doc().scrollTop,t=e-this.lastScrollTop;this.lastScrollTop=e,this.comms.send("scroll",t),this.isScrolling=!1}))}}}doc(){return this.wnd.document.scrollingElement}reportProgress(){if(!this.comms.ready)return;const e=Math.ceil(this.doc().scrollTop),t=this.doc().scrollHeight,i=this.wnd.innerHeight,s=Math.max(0,Math.min(1,e/t)),n=Math.max(0,Math.min(1,(e+i)/t));this.comms.send("progress",{start:s,end:n})}mount(e,t){this.wnd=e,this.comms=t,this.initialScrollHandled=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce&&(this.wnd.clearTimeout(this.resizeDebounce),this.resizeDebounce=null),e.navigator.epubReadingSystem&&(e.navigator.epubReadingSystem.layoutStyle="scrolling");const i=e.document.createElement("style");return i.dataset.readium="true",i.id=Bs,i.textContent=`
        * {
            scrollbar-width: none; /* for Firefox */
        }
        
        body::-webkit-scrollbar {
            display: none; /* for Chrome, Safari, and Opera */
        }
        `,e.document.head.appendChild(i),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounce&&this.wnd.clearTimeout(this.resizeDebounce),this.isResizing=!0,this.resizeDebounce=this.wnd.setTimeout(()=>{this.isResizing=!1,this.resizeDebounce=null,this.reportProgress()},50)}),this.resizeObserver.observe(e.document.body),e.addEventListener("scroll",this.handleScroll,{passive:!0}),t.register("force_webkit_recalc",Q.moduleName,()=>{ln(this.wnd);const s=this.doc().scrollTop;s>1?this.doc().scrollTop=s-1:this.doc().scrollTop=s+1,this.doc().scrollTop=s}),t.register("go_progression",Q.moduleName,(s,n)=>{const o=s;if(o<0||o>1){t.send("error",{message:"go_progression must be given a position from 0.0 to 1.0"}),n(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=this.doc().offsetHeight*o,this.reportProgress(),L(this.wnd),n(!0)})}),t.register("go_id",Q.moduleName,(s,n)=>{const o=e.document.getElementById(s);if(!o){n(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=o.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),L(this.wnd),n(!0)})}),t.register("go_text",Q.moduleName,(s,n)=>{let o;Array.isArray(s)&&(s.length>1&&(o=s[1]),s=s[0]);const a=it.deserialize(s),l=Dt(this.wnd.document,new $e({href:e.location.href,type:"text/html",text:a,locations:o?new k({otherLocations:new Map([["cssSelector",o]])}):void 0}));if(!l){n(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=l.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),L(this.wnd),n(!0)})}),t.register("go_start",Q.moduleName,(s,n)=>{if(this.doc().scrollTop===0)return n(!1);this.doc().scrollTop=0,this.reportProgress(),n(!0)}),t.register("go_end",Q.moduleName,(s,n)=>{if(this.doc().scrollTop===this.doc().scrollHeight-this.doc().offsetHeight)return n(!1);this.doc().scrollTop=this.doc().scrollHeight-this.doc().offsetHeight,this.reportProgress(),n(!0)}),t.register("unfocus",Q.moduleName,(s,n)=>{L(this.wnd),n(!0)}),t.register(["go_next","go_prev"],Q.moduleName,(s,n)=>n(!1)),t.register("focus",Q.moduleName,(s,n)=>{this.reportProgress(),n(!0)}),t.register("first_visible_locator",Q.moduleName,(s,n)=>{const o=Di(e,!0);this.comms.send("first_visible_locator",o.serialize()),n(!0)}),t.log("ScrollSnapper Mounted"),!0}unmount(e,t){return t.unregisterAll(Q.moduleName),this.resizeObserver.disconnect(),this.handleScroll&&e.removeEventListener("scroll",this.handleScroll),e.document.getElementById(Bs)?.remove(),t.log("ScrollSnapper Unmounted"),!0}};un.moduleName="scroll_snapper";let Ra=un;const pn=class ee extends Fi{constructor(){super(...arguments),this.initialScrollHandled=!1,this.isScrolling=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce=null,this.handleScroll=()=>{if(this.comms.ready&&!this.isResizing){if(!this.initialScrollHandled){this.lastScrollTop=this.doc().scrollTop,this.initialScrollHandled=!0,this.reportProgress();return}this.isScrolling||(this.isScrolling=!0,this.wnd.requestAnimationFrame(()=>{this.reportProgress();const e=this.doc().scrollTop,t=e-this.lastScrollTop;this.lastScrollTop=e,this.comms.send("scroll",t),this.isScrolling=!1}))}}}doc(){return this.wnd.document.scrollingElement}reportProgress(){if(!this.comms.ready)return;const e=Math.ceil(this.doc().scrollTop),t=this.doc().scrollHeight,i=this.wnd.innerHeight,s=Math.max(0,Math.min(1,e/t)),n=Math.max(0,Math.min(1,(e+i)/t));this.comms.send("progress",{start:s,end:n})}mount(e,t){return this.wnd=e,this.comms=t,this.initialScrollHandled=!1,this.lastScrollTop=0,this.isResizing=!1,this.resizeDebounce&&(this.wnd.clearTimeout(this.resizeDebounce),this.resizeDebounce=null),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounce&&this.wnd.clearTimeout(this.resizeDebounce),this.isResizing=!0,this.resizeDebounce=this.wnd.setTimeout(()=>{this.isResizing=!1,this.resizeDebounce=null,this.reportProgress()},50)}),this.resizeObserver.observe(e.document.body),e.addEventListener("scroll",this.handleScroll,{passive:!0}),t.register("force_webkit_recalc",ee.moduleName,()=>{ln(this.wnd);const i=this.doc().scrollTop;i>1?this.doc().scrollTop=i-1:this.doc().scrollTop=i+1,this.doc().scrollTop=i}),t.register("go_progression",ee.moduleName,(i,s)=>{const n=i;if(n<0||n>1){t.send("error",{message:"go_progression must be given a position from 0.0 to 1.0"}),s(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=this.doc().offsetHeight*n,this.reportProgress(),L(this.wnd),s(!0)})}),this.comms.register("go_id",ee.moduleName,(i,s)=>{const n=e.document.getElementById(i);if(!n){s(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=n.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),L(this.wnd),s(!0)})}),t.register("go_text",ee.moduleName,(i,s)=>{let n;Array.isArray(i)&&(i.length>1&&(n=i[1]),i=i[0]);const o=it.deserialize(i),a=Dt(this.wnd.document,new $e({href:e.location.href,type:"text/html",text:o,locations:n?new k({otherLocations:new Map([["cssSelector",n]])}):void 0}));if(!a){s(!1);return}this.wnd.requestAnimationFrame(()=>{this.doc().scrollTop=a.getBoundingClientRect().top+e.scrollY-e.innerHeight/2,this.reportProgress(),L(this.wnd),s(!0)})}),t.register("go_start",ee.moduleName,(i,s)=>{if(this.doc().scrollTop===0)return s(!1);this.doc().scrollTop=0,this.reportProgress(),s(!0)}),t.register("go_end",ee.moduleName,(i,s)=>{if(this.doc().scrollTop===this.doc().scrollHeight-this.doc().offsetHeight)return s(!1);this.doc().scrollTop=this.doc().scrollHeight-this.doc().offsetHeight,this.reportProgress(),s(!0)}),t.register("unfocus",ee.moduleName,(i,s)=>{L(this.wnd),s(!0)}),t.register(["go_next","go_prev"],ee.moduleName,(i,s)=>s(!1)),t.register("focus",ee.moduleName,(i,s)=>{this.reportProgress(),s(!0)}),t.register("first_visible_locator",ee.moduleName,(i,s)=>{const n=Di(e,!0);t.send("first_visible_locator",n.serialize()),s(!0)}),t.log("WebPubSnapper Mounted"),!0}unmount(e,t){return t.unregisterAll(ee.moduleName),this.resizeObserver.disconnect(),this.handleScroll&&e.removeEventListener("scroll",this.handleScroll),t.log("WebPubSnapper Unmounted"),!0}};pn.moduleName="webpub_snapper";let La=pn;const mn=class extends st{constructor(){super(...arguments),this.pointerMoved=!1,this.onPointerUp=this.onPointUp.bind(this),this.onPointerMove=this.onPointMove.bind(this),this.onPointerDown=this.onPointDown.bind(this),this.onContextMenu=this.onContext.bind(this),this.onClicker=this.onClick.bind(this)}onPointUp(r){const e=this.wnd.getSelection();if(e&&e.toString()?.length>0){const i=e.getRangeAt(0)?.getClientRects();if(!i||i.length===0)return;const s=i[0],n={text:e.toString(),x:s.x,y:s.y,width:s.width,height:s.height,targetFrameSrc:this.wnd?.location?.href};this.comms.send("text_selected",n)}if(this.pointerMoved){this.pointerMoved=!1;return}if(!e?.isCollapsed||!r.isPrimary)return;const t=this.wnd.devicePixelRatio;r.preventDefault(),this.comms.send(r.pointerType==="touch"?"tap":"click",{defaultPrevented:r.defaultPrevented,x:r.clientX*t,y:r.clientY*t,targetFrameSrc:this.wnd.location.href,targetElement:r.target.outerHTML,interactiveElement:hn(r.target)?.outerHTML,cssSelector:this.wnd._readium_cssSelectorGenerator.getCssSelector(r.target)}),this.pointerMoved=!1}onPointMove(r){if(r.movementY!==void 0&&r.movementX!==void 0){(Math.abs(r.movementX)>1||Math.abs(r.movementY)>1)&&(this.pointerMoved=!0);return}this.pointerMoved=!0}onPointDown(){this.pointerMoved=!1}onContext(r){this.onPointUp(r),this.pointerMoved=!1}onClick(r){if(r.preventDefault(),!r.isTrusted){const e=new PointerEvent("pointerup",{isPrimary:!0,pointerType:"mouse",clientX:r.clientX,clientY:r.clientY});Object.defineProperty(e,"target",{writable:!1,value:r.target}),Object.defineProperty(e,"defaultPrevented",{writable:!1,value:r.defaultPrevented}),this.onPointUp(e)}}mount(r,e){return this.wnd=r,this.comms=e,r.document.addEventListener("pointerdown",this.onPointerDown),r.document.addEventListener("pointerup",this.onPointerUp),r.document.addEventListener("contextmenu",this.onContextMenu),r.document.addEventListener("pointermove",this.onPointerMove),r.document.addEventListener("click",this.onClicker),e.log("Peripherals Mounted"),!0}unmount(r,e){return r.document.removeEventListener("pointerdown",this.onPointerDown),r.document.removeEventListener("pointerup",this.onPointerUp),r.document.removeEventListener("contextmenu",this.onContextMenu),r.document.removeEventListener("pointermove",this.onPointerMove),r.document.removeEventListener("click",this.onClicker),e.log("Peripherals Unmounted"),!0}};mn.moduleName="peripherals";let za=mn;const gn=class gi extends st{constructor(){super(...arguments),this.mediaPlayingCount=0,this.allAnimations=new Set}wndOnErr(e){this.comms?.send("error",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}unblock(e){for(e._readium_blockEvents=!1;e._readium_blockedEvents?.length>0;){const t=e._readium_blockedEvents.shift();switch(t[0]){case 0:Reflect.apply(t[1],t[2],t[3]);break;case 1:const i=t[1],s=t[2];e.removeEventListener(i.type,e._readium_eventBlocker,!0);const n=new Event(i.type,{bubbles:i.bubbles,cancelable:i.cancelable});s?s.dispatchEvent(n):e.dispatchEvent(n);break}}}onMediaPlayEvent(){this.mediaPlayingCount++,this.comms?.send("media_play",this.mediaPlayingCount)}onMediaPauseEvent(){this.mediaPlayingCount>0&&this.mediaPlayingCount--,this.comms?.send("media_pause",this.mediaPlayingCount)}pauseAllMedia(e){const t=e.document.querySelectorAll("audio,video");for(let i=0;i<t.length;i++)t[i].pause()}mount(e,t){this.comms=t,e.addEventListener("error",this.wndOnErr,!1),Reflect.defineProperty(e.navigator,"epubReadingSystem",{value:{name:"readium-ts-toolkit",version:"2.2.0",hasFeature:(s,n="")=>{switch(s){case"dom-manipulation":return!0;case"layout-changes":return!0;case"touch-events":return!0;case"mouse-events":return!0;case"keyboard-events":return!0;case"spine-scripting":return!0;case"embedded-web-content":return!0;default:return!1}}},writable:!1}),"getAnimations"in e.document&&e.document.getAnimations().forEach(s=>{s.cancel(),this.allAnimations.add(s)}),t.register("activate",gi.moduleName,(s,n)=>{this.allAnimations.forEach(o=>{o.cancel(),o.play()}),n(!0)}),t.register("unfocus",gi.moduleName,(s,n)=>{this.pauseAllMedia(e),this.allAnimations.forEach(o=>o.pause()),n(!0)});const i=e.document.querySelectorAll("audio,video");for(let s=0;s<i.length;s++){const n=i[s];n.addEventListener("play",this.onMediaPlayEvent,{passive:!0}),n.addEventListener("pause",this.onMediaPauseEvent,{passive:!0})}return t.log("Setup Mounted"),!0}unmount(e,t){return e.removeEventListener("error",this.wndOnErr),e.removeEventListener("play",this.onMediaPlayEvent),e.removeEventListener("pause",this.onMediaPauseEvent),this.allAnimations.forEach(i=>i.cancel()),this.allAnimations.clear(),t.log("Setup Unmounted"),!0}};gn.moduleName="setup";let fn=gn;const $s="readium-viewport",yn=class Ee extends fn{onViewportWidthChanged(e){const t=e.target;Pt(t,"--RS__viewportWidth",`${t.innerWidth}px`)}mount(e,t){if(!super.mount(e,t))return!1;const i=e.document.createElement("meta");return i.dataset.readium="true",i.setAttribute("name","viewport"),i.setAttribute("id",$s),i.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no"),e.document.head.appendChild(i),e.addEventListener("orientationchange",this.onViewportWidthChanged),e.addEventListener("resize",this.onViewportWidthChanged),this.onViewportWidthChanged({target:e}),t.register("get_properties",Ee.moduleName,(s,n)=>{rn(e),n(!0)}),t.register("update_properties",Ee.moduleName,(s,n)=>{s["--RS__viewportWidth"]=`${e.innerWidth}px`,ga(e,s),n(!0)}),t.register("set_property",Ee.moduleName,(s,n)=>{const o=s;Pt(e,o[0],o[1]),n(!0)}),t.register("remove_property",Ee.moduleName,(s,n)=>{ki(e,s),n(!0)}),t.register("activate",Ee.moduleName,(s,n)=>{this.unblock(e),n(!0)}),t.log("ReflowableSetup Mounted"),!0}unmount(e,t){return t.unregisterAll(Ee.moduleName),e.document.head.querySelector(`#${$s}`)?.remove(),e.removeEventListener("orientationchange",this.onViewportWidthChanged),t.log("ReflowableSetup Unmounted"),super.unmount(e,t)}};yn.moduleName="reflowable_setup";let Ma=yn;const Hs="readium-fixed-style",vn=class ge extends fn{mount(e,t){if(!super.mount(e,t))return!1;e.navigator.epubReadingSystem&&(e.navigator.epubReadingSystem.layoutStyle="paginated");const i=e.document.createElement("style");return i.id=Hs,i.dataset.readium="true",i.textContent=`
        html, body {
            text-size-adjust: none;
            -ms-text-size-adjust: none;
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;

            /* Fight Safari pinches */
            touch-action: none !important;
            min-height: 100%;

            /*cursor: var() TODO*/
        }`,e.document.head.appendChild(i),t.register("set_property",ge.moduleName,(s,n)=>{const o=s;Pt(e,o[0],o[1]),n(!0)}),t.register("remove_property",ge.moduleName,(s,n)=>{ki(e,s),n(!0)}),t.register("first_visible_locator",ge.moduleName,(s,n)=>n(!1)),t.register("unfocus",ge.moduleName,(s,n)=>{L(e),n(!0)}),t.register(["focus","go_next","go_prev","go_id","go_end","go_start","go_text","go_progression"],ge.moduleName,(s,n)=>n(!0)),t.register("activate",ge.moduleName,(s,n)=>{this.unblock(e),n(!0)}),t.log("FixedSetup Mounted"),!0}unmount(e,t){return t.unregisterAll(ge.moduleName),e.document.getElementById(Hs)?.remove(),t.log("FixedSetup Unmounted"),super.unmount(e,t)}};vn.moduleName="fixed_setup";let Ia=vn;const wn=class Sn extends st{wndOnErr(e){this.comms?.send("error",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}mount(e,t){return this.comms=t,e.addEventListener("error",this.wndOnErr,!1),t.register("activate",Sn.moduleName,(i,s)=>{s(!0)}),t.log("WebPubSetup Mounted"),!0}unmount(e,t){return e.removeEventListener("error",this.wndOnErr),t.log("WebPubSetup Unmounted"),!0}};wn.moduleName="webpub_setup";let Na=wn;const ka=["fixed_setup","decorator","peripherals"],Fa=["reflowable_setup","decorator","peripherals","column_snapper","scroll_snapper"],fi=new Map([Ia,Ma,Na,La,za,ba,Oa,Ra].map(r=>[r.moduleName,r]));class Ct{constructor(e=window,t=[]){this.loadedModules=[],this.wnd=e,this.comms=new Jo(e);const i=[...new Set(t)];if(i.length){if(typeof e>"u")throw Error("Loader is not in a web browser");e.parent!==e&&this.comms.log("Loader is probably in a frame"),this.loadedModules=i.map(s=>{const n=this.loadModule(s);if(n)return n.mount(this.wnd,this.comms),n}).filter(s=>s!==void 0)}}loadModule(e){const t=fi.get(e);return t===void 0?(this.comms.log(`Module "${name}" does not exist in the library`),t):new t}addModule(e){const t=this.loadModule(e);return!t||!t.mount(this.wnd,this.comms)?!1:(this.loadedModules.push(t),!0)}removeModule(e){const t=fi.get(e);if(t===void 0)return this.comms.log(`Module "${e}" does not exist in the library`),!1;const i=this.loadedModules.findIndex(s=>s instanceof t);return i<0?!1:(this.loadedModules[i].unmount(this.wnd,this.comms),this.loadedModules.splice(i,1),!0)}destroy(){this.comms.destroy(),this.loadedModules.forEach(e=>e.unmount(this.wnd,this.comms)),this.loadedModules=[]}}const Da=1e4;let yi=class{constructor(e,t){this.registry=new Map,this._ready=!1,this.listenerBuffer=[],this.handler=this.handle.bind(this),this.wnd=e,this.origin=t;try{this.channelId=window.crypto.randomUUID()}catch{this.channelId=li()}this.gc=setInterval(()=>{this.registry.forEach((i,s)=>{performance.now()-i.time>Da&&(console.warn(s,"event for",i.key,"was never handled!"),this.registry.delete(s))})},5e3),window.addEventListener("message",this.handler),this.send("_ping",void 0)}set listener(e){this.listenerBuffer.length>0&&this.listenerBuffer.forEach(t=>e(t[0],t[1])),this.listenerBuffer=[],this._listener=e}clearListener(){typeof this._listener=="function"&&(this._listener=void 0)}halt(){this._ready=!1,window.removeEventListener("message",this.handler),clearInterval(this.gc),this._listener=void 0,this.registry.clear()}resume(){window.addEventListener("message",this.handler),this._ready=!0}handle(e){const t=e.data;if(!t._readium){console.warn("Ignoring",t);return}if(t._channel===this.channelId)switch(t.key){case"_ack":{if(!t.id)return;const i=this.registry.get(t.id);if(!i)return;this.registry.delete(t.id),i.cb(!!t.data);return}case"_pong":this._ready=!0;default:{if(!this.ready)return;typeof this._listener=="function"?this._listener(t.key,t.data):this.listenerBuffer.push([t.key,t.data])}}}get ready(){return this._ready}send(e,t,i,s=!1,n=[]){const o=li();return i&&this.registry.set(o,{cb:i,time:performance.now(),key:e}),this.wnd.postMessage({_readium:Re,_channel:this.channelId,id:o,data:t,key:e,strict:s},"/",n),o}};const Ua="'Iowan Old Style', Sitka, 'Sitka Text', Palatino, 'Book Antiqua', 'URW Palladio L', P052, serif",Wa={RS__oldStyleTf:Ua},Ba=16,js=Wa.RS__oldStyleTf;let $a=class wt{constructor(e){this._optimalLineLength=null,this._canvas=document.createElement("canvas"),this._optimalChars=e.optimalChars,this._minChars=e.minChars,this._maxChars=e.maxChars,this._baseFontSize=e.baseFontSize||Ba,this._fontFace=e.fontFace||js,this._sample=e.sample||null,this._pageGutter=e.pageGutter||0,this._letterSpacing=e.letterSpacing?Math.round(e.letterSpacing*this._baseFontSize):0,this._wordSpacing=e.wordSpacing?Math.round(e.wordSpacing*this._baseFontSize):0,this._isCJK=e.isCJK||!1,this._getRelative=e.getRelative||!1,this._padding=this._pageGutter*2,this._minDivider=this._minChars&&this._minChars<this._optimalChars?this._optimalChars/this._minChars:this._minChars===null?null:1,this._maxMultiplier=this._maxChars&&this._maxChars>this._optimalChars?this._maxChars/this._optimalChars:this._maxChars===null?null:1,this._approximatedWordSpaces=wt.approximateWordSpaces(this._optimalChars,this._sample)}updateMultipliers(){this._minDivider=this._minChars&&this._minChars<this._optimalChars?this._optimalChars/this._minChars:this._minChars===null?null:1,this._maxMultiplier=this._maxChars&&this._maxChars>this._optimalChars?this._maxChars/this._optimalChars:this._maxChars===null?null:1}update(e){e.optimalChars&&(this._optimalChars=e.optimalChars),e.minChars!==void 0&&(this._minChars=e.minChars),e.maxChars!==void 0&&(this._maxChars=e.maxChars),e.baseFontSize&&(this._baseFontSize=e.baseFontSize),e.fontFace!==void 0&&(this._fontFace=e.fontFace||js),e.letterSpacing&&(this._letterSpacing=e.letterSpacing),e.wordSpacing&&(this._wordSpacing=e.wordSpacing),e.isCJK!=null&&(this._isCJK=e.isCJK),e.pageGutter&&(this._pageGutter=e.pageGutter),e.getRelative&&(this._getRelative=e.getRelative),e.sample&&(this._sample=e.sample,this._approximatedWordSpaces=wt.approximateWordSpaces(this._optimalChars,this._sample)),this.updateMultipliers(),this._optimalLineLength=this.getOptimalLineLength()}get baseFontSize(){return this._baseFontSize}get minimalLineLength(){return this._optimalLineLength||(this._optimalLineLength=this.getOptimalLineLength()),this._minDivider!==null?Math.round(this._optimalLineLength/this._minDivider+this._padding)/(this._getRelative?this._baseFontSize:1):null}get maximalLineLength(){return this._optimalLineLength||(this._optimalLineLength=this.getOptimalLineLength()),this._maxMultiplier!==null?Math.round(this._optimalLineLength*this._maxMultiplier+this._padding)/(this._getRelative?this._baseFontSize:1):null}get optimalLineLength(){return this._optimalLineLength||(this._optimalLineLength=this.getOptimalLineLength()),Math.round(this._optimalLineLength+this._padding)/(this._getRelative?this._baseFontSize:1)}get all(){return this._optimalLineLength||(this._optimalLineLength=this.getOptimalLineLength()),{min:this.minimalLineLength,max:this.maximalLineLength,optimal:this.optimalLineLength,baseFontSize:this._baseFontSize}}static approximateWordSpaces(e,t){let i=0;if(t&&t.length>=e){const s=t.match(/([\s]+)/gi);i=(s?s.length:0)*(e/t.length)}return i}getLineLengthFallback(){const e=this._letterSpacing*(this._optimalChars-1),t=this._wordSpacing*this._approximatedWordSpaces;return this._optimalChars*(this._baseFontSize*.5)+e+t}getOptimalLineLength(){if(this._fontFace){if(typeof this._fontFace=="string")return this.measureText(this._fontFace);{const e=new FontFace(this._fontFace.name,`url(${this._fontFace.url})`);e.load().then(()=>(document.fonts.add(e),this.measureText(e.family)),t=>{})}}return this.getLineLengthFallback()}measureText(e){const t=this._canvas.getContext("2d");if(t&&e){let i=this._isCJK?"".repeat(this._optimalChars):"0".repeat(this._optimalChars);if(t.font=`${this._baseFontSize}px ${e}`,this._sample&&this._sample.length>=this._optimalChars&&(i=this._sample.slice(0,this._optimalChars)),Object.hasOwn(t,"letterSpacing")&&Object.hasOwn(t,"wordSpacing"))return t.letterSpacing=this._letterSpacing.toString()+"px",t.wordSpacing=this._wordSpacing.toString()+"px",t.measureText(i).width;{const s=this._letterSpacing*(this._optimalChars-1),n=this._wordSpacing*wt.approximateWordSpaces(this._optimalChars,this._sample);return t.measureText(i).width+s+n}}else return this.getLineLengthFallback()}};/*!
 *                                                                                                                         ()
 *  # sML.js | I'm a Simple and Middling Library.
 *
 *  * Copyright (c) Satoru MATSUSHIMA - https://github.com/satorumurmur/sML
 *  * Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 * Portions of this code come from the sML library
 * Current version: 1.0.36
 */const bn=()=>typeof navigator>"u"?"":navigator.userAgent||"",En=()=>typeof navigator>"u"?void 0:navigator.userAgentData||void 0;class xn{constructor(){const e=En(),t=bn(),i=n=>(typeof n=="string"||typeof n=="number")&&n?String(n).replace(/_/g,".").split(".").map(o=>parseInt(o)||0):[],s=(n="")=>{if(!n)return[];const o=new RegExp("^.*"+n+"[ :\\/]?(\\d+([\\._]\\d+)*).*$");return o.test(t)?i(t.replace(o,"$1")):[]};this.OS=(n=>(/(macOS|Mac OS X)/.test(t)?(/\(iP(hone|od touch);/.test(t)&&(n.iOS=s("CPU (?:iPhone )?OS ")),/\(iPad;/.test(t)?n.iOS=n.iPadOS=s("CPU (?:iPhone )?OS "):/(macOS|Mac OS X) \d/.test(t)&&(document.ontouchend!==void 0?n.iOS=n.iPadOS=s():n.macOS=s("(?:macOS|Mac OS X) "))):/Windows( NT)? \d/.test(t)?n.Windows=(o=>o[0]!==6||!o[1]?o:o[1]===1?[7]:o[1]===2?[8]:[8,1])(s("Windows(?: NT)?")):/Android \d/.test(t)?n.Android=s("Android"):/CrOS/.test(t)?n.ChromeOS=s():/X11;/.test(t)&&(n.Linux=s()),n))({}),e&&e.getHighEntropyValues(["architecture","model","platform","platformVersion","uaFullVersion"]).then(n=>(o=>{const a=n.platform,l=n.platformVersion;if(!(!a||!l)){if(/^i(OS|P(hone|od touch))$/.test(a))o.iOS=i(l);else if(/^iPad(OS)?$/.test(a))o.iOS=o.iPadOS=i(l);else if(/^(macOS|(Mac )?OS X|Mac(Intel)?)$/.test(a))document.ontouchend!==void 0?o.iOS=o.iPadOS=i():o.macOS=i(l);else if(/^(Microsoft )?Windows$/.test(a))o.Windows=i(l);else if(/^(Google )?Android$/.test(a))o.Android=i(l);else if(/^((Google )?Chrome OS|CrOS)$/.test(a))o.ChromeOS=i(l);else if(/^(Linux|Ubuntu|X11)$/.test(a))o.Linux=i(l);else return;Object.keys(this.OS).forEach(h=>delete this.OS[h]),Object.assign(this.OS,o)}})({})),this.UA=(n=>{let o=!1;if(e&&Array.isArray(e.brands)){const a=e.brands.reduce((l,h)=>(l[h.brand]=[h.version*1],l),{});a["Google Chrome"]?(o=!0,n.Blink=n.Chromium=a.Chromium||[],n.Chrome=a["Google Chrome"]):a["Microsoft Edge"]?(o=!0,n.Blink=n.Chromium=a.Chromium||[],n.Edge=a["Microsoft Edge"]):a.Opera&&(o=!0,n.Blink=n.Chromium=a.Chromium||[],n.Opera=a.Opera)}return o||(/ Gecko\/\d/.test(t)?(n.Gecko=s("rv"),/ Waterfox\/\d/.test(t)?n.Waterfox=s("Waterfox"):/ Firefox\/\d/.test(t)&&(n.Firefox=s("Firefox"))):/ Edge\/\d/.test(t)?(n.EdgeHTML=s("Edge"),n.Edge=n.EdgeHTML):/ Chrom(ium|e)\/\d/.test(t)?(n.Blink=n.Chromium=(a=>a[0]?a:s("Chrome"))(s("Chromium")),/ EdgA?\/\d/.test(t)?n.Edge=(a=>a[0]?a:s("Edg"))(s("EdgA")):/ OPR\/\d/.test(t)?n.Opera=s("OPR"):/ Vivaldi\/\d/.test(t)?n.Vivaldi=s("Vivaldi"):/ Silk\/\d/.test(t)?n.Silk=s("Silk"):/ UCBrowser\/\d/.test(t)?n.UCBrowser=s("UCBrowser"):/ Phoebe\/\d/.test(t)?n.Phoebe=s("Phoebe"):n.Chrome=(a=>a[0]?a:n.Chromium)(s("Chrome"))):/ AppleWebKit\/\d/.test(t)?(n.WebKit=s("AppleWebKit"),/ CriOS \d/.test(t)?n.Chrome=s("CriOS"):/ FxiOS \d/.test(t)?n.Firefox=s("FxiOS"):/ EdgiOS\/\d/.test(t)?n.Edge=s("EdgiOS"):/ Version\/\d/.test(t)&&(n.Safari=s("Version"))):/ Trident\/\d/.test(t)&&(n.Trident=s("Trident"),n.InternetExplorer=(a=>a[0]?a:s("MSIE"))(s("rv")))),/[\[; ]FB(AN|_IAB)\//.test(t)&&(n.Facebook=s("FBAV")),/ Line\/\d/.test(t)&&(n.LINE=s("Line")),n})({}),this.Env={get:()=>[this.OS,this.UA].reduce((n,o)=>{for(const a in o)o[a]&&n.push(a);return n},[])}}}class Ha extends xn{get iOSRequest(){const e=En(),t=bn();if(this.OS.iOS&&!this.OS.iPadOS)return"mobile";if(this.OS.iPadOS)return/\(iPad;/.test(t)||e&&/^iPad(OS)?$/.test(e.platform)?"mobile":"desktop"}}const St=new xn,he=new Ha;var jt,Vs;function ja(){if(Vs)return jt;Vs=1;function r(s){if(typeof s!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(s))}function e(s,n){for(var o="",a=0,l=-1,h=0,u,d=0;d<=s.length;++d){if(d<s.length)u=s.charCodeAt(d);else{if(u===47)break;u=47}if(u===47){if(!(l===d-1||h===1))if(l!==d-1&&h===2){if(o.length<2||a!==2||o.charCodeAt(o.length-1)!==46||o.charCodeAt(o.length-2)!==46){if(o.length>2){var p=o.lastIndexOf("/");if(p!==o.length-1){p===-1?(o="",a=0):(o=o.slice(0,p),a=o.length-1-o.lastIndexOf("/")),l=d,h=0;continue}}else if(o.length===2||o.length===1){o="",a=0,l=d,h=0;continue}}n&&(o.length>0?o+="/..":o="..",a=2)}else o.length>0?o+="/"+s.slice(l+1,d):o=s.slice(l+1,d),a=d-l-1;l=d,h=0}else u===46&&h!==-1?++h:h=-1}return o}function t(s,n){var o=n.dir||n.root,a=n.base||(n.name||"")+(n.ext||"");return o?o===n.root?o+a:o+s+a:a}var i={resolve:function(){for(var s="",n=!1,o,a=arguments.length-1;a>=-1&&!n;a--){var l;a>=0?l=arguments[a]:(o===void 0&&(o=process.cwd()),l=o),r(l),l.length!==0&&(s=l+"/"+s,n=l.charCodeAt(0)===47)}return s=e(s,!n),n?s.length>0?"/"+s:"/":s.length>0?s:"."},normalize:function(s){if(r(s),s.length===0)return".";var n=s.charCodeAt(0)===47,o=s.charCodeAt(s.length-1)===47;return s=e(s,!n),s.length===0&&!n&&(s="."),s.length>0&&o&&(s+="/"),n?"/"+s:s},isAbsolute:function(s){return r(s),s.length>0&&s.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var s,n=0;n<arguments.length;++n){var o=arguments[n];r(o),o.length>0&&(s===void 0?s=o:s+="/"+o)}return s===void 0?".":i.normalize(s)},relative:function(s,n){if(r(s),r(n),s===n||(s=i.resolve(s),n=i.resolve(n),s===n))return"";for(var o=1;o<s.length&&s.charCodeAt(o)===47;++o);for(var a=s.length,l=a-o,h=1;h<n.length&&n.charCodeAt(h)===47;++h);for(var u=n.length,d=u-h,p=l<d?l:d,g=-1,c=0;c<=p;++c){if(c===p){if(d>p){if(n.charCodeAt(h+c)===47)return n.slice(h+c+1);if(c===0)return n.slice(h+c)}else l>p&&(s.charCodeAt(o+c)===47?g=c:c===0&&(g=0));break}var m=s.charCodeAt(o+c),b=n.charCodeAt(h+c);if(m!==b)break;m===47&&(g=c)}var x="";for(c=o+g+1;c<=a;++c)(c===a||s.charCodeAt(c)===47)&&(x.length===0?x+="..":x+="/..");return x.length>0?x+n.slice(h+g):(h+=g,n.charCodeAt(h)===47&&++h,n.slice(h))},_makeLong:function(s){return s},dirname:function(s){if(r(s),s.length===0)return".";for(var n=s.charCodeAt(0),o=n===47,a=-1,l=!0,h=s.length-1;h>=1;--h)if(n=s.charCodeAt(h),n===47){if(!l){a=h;break}}else l=!1;return a===-1?o?"/":".":o&&a===1?"//":s.slice(0,a)},basename:function(s,n){if(n!==void 0&&typeof n!="string")throw new TypeError('"ext" argument must be a string');r(s);var o=0,a=-1,l=!0,h;if(n!==void 0&&n.length>0&&n.length<=s.length){if(n.length===s.length&&n===s)return"";var u=n.length-1,d=-1;for(h=s.length-1;h>=0;--h){var p=s.charCodeAt(h);if(p===47){if(!l){o=h+1;break}}else d===-1&&(l=!1,d=h+1),u>=0&&(p===n.charCodeAt(u)?--u===-1&&(a=h):(u=-1,a=d))}return o===a?a=d:a===-1&&(a=s.length),s.slice(o,a)}else{for(h=s.length-1;h>=0;--h)if(s.charCodeAt(h)===47){if(!l){o=h+1;break}}else a===-1&&(l=!1,a=h+1);return a===-1?"":s.slice(o,a)}},extname:function(s){r(s);for(var n=-1,o=0,a=-1,l=!0,h=0,u=s.length-1;u>=0;--u){var d=s.charCodeAt(u);if(d===47){if(!l){o=u+1;break}continue}a===-1&&(l=!1,a=u+1),d===46?n===-1?n=u:h!==1&&(h=1):n!==-1&&(h=-1)}return n===-1||a===-1||h===0||h===1&&n===a-1&&n===o+1?"":s.slice(n,a)},format:function(s){if(s===null||typeof s!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof s);return t("/",s)},parse:function(s){r(s);var n={root:"",dir:"",base:"",ext:"",name:""};if(s.length===0)return n;var o=s.charCodeAt(0),a=o===47,l;a?(n.root="/",l=1):l=0;for(var h=-1,u=0,d=-1,p=!0,g=s.length-1,c=0;g>=l;--g){if(o=s.charCodeAt(g),o===47){if(!p){u=g+1;break}continue}d===-1&&(p=!1,d=g+1),o===46?h===-1?h=g:c!==1&&(c=1):h!==-1&&(c=-1)}return h===-1||d===-1||c===0||c===1&&h===d-1&&h===u+1?d!==-1&&(u===0&&a?n.base=n.name=s.slice(1,d):n.base=n.name=s.slice(u,d)):(u===0&&a?(n.name=s.slice(1,h),n.base=s.slice(1,d)):(n.name=s.slice(u,h),n.base=s.slice(u,d)),n.ext=s.slice(h,d)),u>0?n.dir=s.slice(0,u-1):a&&(n.dir="/"),n},sep:"/",delimiter:":",win32:null,posix:null};return i.posix=i,jt=i,jt}var Gs=ja();const Va=`/*!
 * Readium CSS v.2.0.0-beta.19
 * Copyright (c) 20172025. Readium Foundation. All rights reserved.
 * Use of this source code is governed by a BSD-style license which is detailed in the
 * LICENSE file present in the project repository where this source code is maintained.
 * Core maintainer: Jiminy Panoz <jiminy.panoz@edrlab.org> 
 * Contributors: 
 * Daniel Weck
 * Hadrien Gardeur
 * Innovimax
 * L. Le Meur
 * Mickael Menu
 * k_taka
 */@namespace url(http://www.w3.org/1999/xhtml);@namespace epub url(http://www.idpf.org/2007/ops);@namespace m url(http://www.w3.org/1998/Math/MathML);@namespace svg url(http://www.w3.org/2000/svg);:root{--RS__viewportWidth:100%;--RS__pageGutter:0;--RS__defaultLineLength:40rem;--RS__colGap:0;--RS__colCount:1;--RS__colWidth:100vw}@page{margin:0!important}:root{position:relative;-webkit-column-width:var(--RS__colWidth);-moz-column-width:var(--RS__colWidth);column-width:var(--RS__colWidth);-webkit-column-count:var(--RS__colCount);-moz-column-count:var(--RS__colCount);column-count:var(--RS__colCount);-webkit-column-gap:var(--RS__colGap);-moz-column-gap:var(--RS__colGap);column-gap:var(--RS__colGap);-moz-column-fill:auto;column-fill:auto;width:var(--RS__viewportWidth);height:100vh;max-width:var(--RS__viewportWidth);max-height:100vh;min-width:var(--RS__viewportWidth);min-height:100vh;padding:0!important;margin:0!important;font-size:1rem!important;box-sizing:border-box;-webkit-touch-callout:none}body{width:100%;max-width:var(--RS__defaultLineLength)!important;padding:0 var(--RS__pageGutter)!important;margin:0 auto!important;box-sizing:border-box}:root:not([style*=readium-noOverflow-on]) body{overflow:hidden}@supports (overflow: clip){:root:not([style*=readium-noOverflow-on]){overflow:clip}:root:not([style*=readium-noOverflow-on]) body{overflow:clip;overflow-clip-margin:content-box}}:root[style*=readium-scroll-on]{-webkit-columns:auto auto!important;-moz-columns:auto auto!important;columns:auto auto!important;width:auto!important;height:auto!important;max-width:none!important;max-height:none!important;min-width:0!important;min-height:0!important}:root[style*=readium-scroll-on] body{max-width:var(--RS__defaultLineLength)!important;box-sizing:border-box!important}:root[style*=readium-scroll-on]:not([style*=readium-noOverflow-on]) body{overflow:auto}@supports (overflow: clip){:root[style*=readium-scroll-on]:not([style*=readium-noOverflow-on]){overflow:auto}:root[style*=readium-scroll-on]:not([style*=readium-noOverflow-on]) body{overflow:clip}}:root[style*=readium-scroll-on][style*=--RS__scrollPaddingTop] body{padding-top:var(--RS__scrollPaddingTop)!important}:root[style*=readium-scroll-on][style*=--RS__scrollPaddingBottom] body{padding-bottom:var(--RS__scrollPaddingBottom)!important}:root[style*=readium-scroll-on][style*=--RS__scrollPaddingLeft] body{padding-left:var(--RS__scrollPaddingLeft)!important}:root[style*=readium-scroll-on][style*=--RS__scrollPaddingRight] body{padding-right:var(--RS__scrollPaddingRight)!important}:root[style*=--USER__backgroundColor]{background-color:var(--USER__backgroundColor)!important}:root[style*=--USER__backgroundColor] *{background-color:transparent!important}:root[style*=--USER__textColor]{color:var(--USER__textColor)!important}:root[style*=--USER__textColor] *:not(a){color:inherit!important;background-color:transparent!important;border-color:currentcolor!important}:root[style*=--USER__textColor] svg text{fill:currentcolor!important;stroke:none!important}:root[style*=--USER__linkColor] a:link,:root[style*=--USER__linkColor] a:link *{color:var(--USER__linkColor)!important}:root[style*=--USER__visitedColor] a:visited,:root[style*=--USER__visitedColor] a:visited *{color:var(--USER__visitedColor)!important}:root[style*=--USER__selectionBackgroundColor][style*=--USER__selectionTextColor] ::-moz-selection{color:var(--USER__selectionTextColor)!important;background-color:var(--USER__selectionBackgroundColor)!important}:root[style*=--USER__selectionBackgroundColor][style*=--USER__selectionTextColor] ::selection{color:var(--USER__selectionTextColor)!important;background-color:var(--USER__selectionBackgroundColor)!important}:root[style*=--USER__colCount]{-webkit-column-count:var(--USER__colCount);-moz-column-count:var(--USER__colCount);column-count:var(--USER__colCount);--RS__colWidth:auto}:root[style*="--USER__colCount: 0"],:root[style*="--USER__colCount:0"]{-webkit-column-count:1;-moz-column-count:1;column-count:1}:root[style*="--USER__colCount: 0"],:root[style*="--USER__colCount:0"],:root[style*="--USER__colCount: 1"],:root[style*="--USER__colCount:1"]{--RS__colWidth:100vw}:root[style*=--USER__lineLength] body{max-width:var(--USER__lineLength)!important}:root[style*=--USER__textAlign]{text-align:var(--USER__textAlign)}:root[style*=--USER__textAlign] body,:root[style*=--USER__textAlign] p:not(blockquote p):not(figcaption p):not(hgroup p),:root[style*=--USER__textAlign] li,:root[style*=--USER__textAlign] dd{text-align:var(--USER__textAlign)!important;-moz-text-align-last:auto!important;-epub-text-align-last:auto!important;text-align-last:auto!important}:root[style*=--USER__bodyHyphens]{-webkit-hyphens:var(--USER__bodyHyphens)!important;-moz-hyphens:var(--USER__bodyHyphens)!important;-ms-hyphens:var(--USER__bodyHyphens)!important;-epub-hyphens:var(--USER__bodyHyphens)!important;hyphens:var(--USER__bodyHyphens)!important}:root[style*=--USER__bodyHyphens] body,:root[style*=--USER__bodyHyphens] p,:root[style*=--USER__bodyHyphens] li,:root[style*=--USER__bodyHyphens] div,:root[style*=--USER__bodyHyphens] dd{-webkit-hyphens:inherit;-moz-hyphens:inherit;-ms-hyphens:inherit;-epub-hyphens:inherit;hyphens:inherit}:root[style*=--USER__fontFamily]{font-family:var(--USER__fontFamily)!important}:root[style*=--USER__fontFamily] *{font-family:revert!important}:root[style*=AccessibleDfA]{font-family:AccessibleDfA,Verdana,Tahoma,Trebuchet MS,sans-serif!important}:root[style*="IA Writer Duospace"]{font-family:IA Writer Duospace,Menlo,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier,monospace!important}:root[style*=AccessibleDfA],:root[style*="IA Writer Duospace"],:root[style*=readium-a11y-on]{font-style:normal!important;font-weight:400!important}:root[style*=AccessibleDfA] *:not(code):not(var):not(kbd):not(samp),:root[style*="IA Writer Duospace"] *:not(code):not(var):not(kbd):not(samp),:root[style*=readium-a11y-on] *:not(code):not(var):not(kbd):not(samp){font-family:inherit!important;font-style:inherit!important;font-weight:inherit!important}:root[style*=AccessibleDfA] *,:root[style*="IA Writer Duospace"] *,:root[style*=readium-a11y-on] *{text-decoration:none!important;font-variant-caps:normal!important;font-variant-numeric:normal!important;font-variant-position:normal!important}:root[style*=AccessibleDfA] sup,:root[style*="IA Writer Duospace"] sup,:root[style*=readium-a11y-on] sup,:root[style*=AccessibleDfA] sub,:root[style*="IA Writer Duospace"] sub,:root[style*=readium-a11y-on] sub{font-size:1rem!important;vertical-align:baseline!important}:root:not([style*=readium-deprecatedFontSize-on]):not([style*=readium-iOSPatch-on])[style*=--USER__fontSize] body{zoom:var(--USER__fontSize)!important}:root[style*=readium-iOSPatch-on][style*=--USER__fontSize] body{-webkit-text-size-adjust:var(--USER__fontSize)!important}@supports not (zoom: 1){:root[style*=--USER__fontSize]{font-size:var(--USER__fontSize)!important}}:root[style*=readium-deprecatedFontSize-on][style*=--USER__fontSize]{font-size:var(--USER__fontSize)!important}:root[style*=--USER__lineHeight]{line-height:var(--USER__lineHeight)!important}:root[style*=--USER__lineHeight] body,:root[style*=--USER__lineHeight] p,:root[style*=--USER__lineHeight] li,:root[style*=--USER__lineHeight] div{line-height:inherit}:root[style*=--USER__paraSpacing] p{margin-top:var(--USER__paraSpacing)!important;margin-bottom:var(--USER__paraSpacing)!important}:root[style*=--USER__paraIndent] p{text-indent:var(--USER__paraIndent)!important}:root[style*=--USER__paraIndent] p *,:root[style*=--USER__paraIndent] p:first-letter{text-indent:0!important}:root[style*=--USER__wordSpacing] h1,:root[style*=--USER__wordSpacing] h2,:root[style*=--USER__wordSpacing] h3,:root[style*=--USER__wordSpacing] h4,:root[style*=--USER__wordSpacing] h5,:root[style*=--USER__wordSpacing] h6,:root[style*=--USER__wordSpacing] p,:root[style*=--USER__wordSpacing] li,:root[style*=--USER__wordSpacing] div,:root[style*=--USER__wordSpacing] dt,:root[style*=--USER__wordSpacing] dd{word-spacing:var(--USER__wordSpacing)}:root[style*=--USER__letterSpacing] h1,:root[style*=--USER__letterSpacing] h2,:root[style*=--USER__letterSpacing] h3,:root[style*=--USER__letterSpacing] h4,:root[style*=--USER__letterSpacing] h5,:root[style*=--USER__letterSpacing] h6,:root[style*=--USER__letterSpacing] p,:root[style*=--USER__letterSpacing] li,:root[style*=--USER__letterSpacing] div,:root[style*=--USER__letterSpacing] dt,:root[style*=--USER__letterSpacing] dd{letter-spacing:var(--USER__letterSpacing);font-variant:none}:root[style*=--USER__fontWeight] body{font-weight:var(--USER__fontWeight)!important}:root[style*=--USER__fontWeight] b,:root[style*=--USER__fontWeight] strong{font-weight:bolder}:root[style*=--USER__fontWidth] body{font-stretch:var(--USER__fontWidth)!important}:root[style*=--USER__fontOpticalSizing] body{font-optical-sizing:var(--USER__fontOpticalSizing)!important}:root[style*=readium-blend-on] svg,:root[style*=readium-blend-on] img{background-color:transparent!important;mix-blend-mode:multiply!important}:root[style*=--USER__darkenImages] img{-webkit-filter:brightness(var(--USER__darkenImages))!important;filter:brightness(var(--USER__darkenImages))!important}:root[style*=readium-darken-on] img{-webkit-filter:brightness(80%)!important;filter:brightness(80%)!important}:root[style*=--USER__invertImages] img{-webkit-filter:invert(var(--USER__invertImages))!important;filter:invert(var(--USER__invertImages))!important}:root[style*=readium-invert-on] img{-webkit-filter:invert(100%)!important;filter:invert(100%)!important}:root[style*=--USER__darkenImages][style*=--USER__invertImages] img{-webkit-filter:brightness(var(--USER__darkenImages)) invert(var(--USER__invertImages))!important;filter:brightness(var(--USER__darkenImages)) invert(var(--USER__invertImages))!important}:root[style*=readium-darken-on][style*=--USER__invertImages] img{-webkit-filter:brightness(80%) invert(var(--USER__invertImages))!important;filter:brightness(80%) invert(var(--USER__invertImages))!important}:root[style*=--USER__darkenImages][style*=readium-invert-on] img{-webkit-filter:brightness(var(--USER__darkenImages)) invert(100%)!important;filter:brightness(var(--USER__darkenImages)) invert(100%)!important}:root[style*=readium-darken-on][style*=readium-invert-on] img{-webkit-filter:brightness(80%) invert(100%)!important;filter:brightness(80%) invert(100%)!important}:root[style*=--USER__invertGaiji] img[class*=gaiji]{-webkit-filter:invert(var(--USER__invertGaiji))!important;filter:invert(var(--USER__invertGaiji))!important}:root[style*=readium-invertGaiji-on] img[class*=gaiji]{-webkit-filter:invert(100%)!important;filter:invert(100%)!important}:root[style*=readium-normalize-on]{--USER__typeScale:1.2}:root[style*=readium-normalize-on] p,:root[style*=readium-normalize-on] li,:root[style*=readium-normalize-on] div,:root[style*=readium-normalize-on] pre,:root[style*=readium-normalize-on] dd{font-size:1rem!important}:root[style*=readium-normalize-on] h1{font-size:1.75rem!important;font-size:calc(((1rem * var(--USER__typeScale)) * var(--USER__typeScale)) * var(--USER__typeScale))!important}:root[style*=readium-normalize-on] h2{font-size:1.5rem!important;font-size:calc((1rem * var(--USER__typeScale)) * var(--USER__typeScale))!important}:root[style*=readium-normalize-on] h3{font-size:1.25rem!important;font-size:calc(1rem * var(--USER__typeScale))!important}:root[style*=readium-normalize-on] h4,:root[style*=readium-normalize-on] h5,:root[style*=readium-normalize-on] h6{font-size:1rem!important}:root[style*=readium-normalize-on] small{font-size:smaller!important}:root[style*=readium-normalize-on] sub,:root[style*=readium-normalize-on] sup{font-size:67.5%!important}:root[style*=readium-normalize-on][style*=--USER__typeScale] h1{font-size:calc(((1rem * var(--USER__typeScale)) * var(--USER__typeScale)) * var(--USER__typeScale))!important}:root[style*=readium-normalize-on][style*=--USER__typeScale] h2{font-size:calc((1rem * var(--USER__typeScale)) * var(--USER__typeScale))!important}:root[style*=readium-normalize-on][style*=--USER__typeScale] h3{font-size:calc(1rem * var(--USER__typeScale))!important}:root[style*=readium-iPadOSPatch-on] body{-webkit-text-size-adjust:none}:root[style*=readium-iPadOSPatch-on] p,:root[style*=readium-iPadOSPatch-on] h1,:root[style*=readium-iPadOSPatch-on] h2,:root[style*=readium-iPadOSPatch-on] h3,:root[style*=readium-iPadOSPatch-on] h4,:root[style*=readium-iPadOSPatch-on] h5,:root[style*=readium-iPadOSPatch-on] h6,:root[style*=readium-iPadOSPatch-on] li,:root[style*=readium-iPadOSPatch-on] th,:root[style*=readium-iPadOSPatch-on] td,:root[style*=readium-iPadOSPatch-on] dt,:root[style*=readium-iPadOSPatch-on] dd,:root[style*=readium-iPadOSPatch-on] pre,:root[style*=readium-iPadOSPatch-on] address,:root[style*=readium-iPadOSPatch-on] details,:root[style*=readium-iPadOSPatch-on] summary,:root[style*=readium-iPadOSPatch-on] figcaption,:root[style*=readium-iPadOSPatch-on] div:not(:has(p,h1,h2,h3,h4,h5,h6,li,th,td,dt,dd,pre,address,aside,details,figcaption,summary)),:root[style*=readium-iPadOSPatch-on] aside:not(:has(p,h1,h2,h3,h4,h5,h6,li,th,td,dt,dd,pre,address,aside,details,figcaption,summary)){-webkit-text-zoom:reset}:root[style*=readium-iPadOSPatch-on] abbr,:root[style*=readium-iPadOSPatch-on] b,:root[style*=readium-iPadOSPatch-on] bdi,:root[style*=readium-iPadOSPatch-on] bdo,:root[style*=readium-iPadOSPatch-on] cite,:root[style*=readium-iPadOSPatch-on] code,:root[style*=readium-iPadOSPatch-on] dfn,:root[style*=readium-iPadOSPatch-on] em,:root[style*=readium-iPadOSPatch-on] i,:root[style*=readium-iPadOSPatch-on] kbd,:root[style*=readium-iPadOSPatch-on] mark,:root[style*=readium-iPadOSPatch-on] q,:root[style*=readium-iPadOSPatch-on] rp,:root[style*=readium-iPadOSPatch-on] rt,:root[style*=readium-iPadOSPatch-on] ruby,:root[style*=readium-iPadOSPatch-on] s,:root[style*=readium-iPadOSPatch-on] samp,:root[style*=readium-iPadOSPatch-on] small,:root[style*=readium-iPadOSPatch-on] span,:root[style*=readium-iPadOSPatch-on] strong,:root[style*=readium-iPadOSPatch-on] sub,:root[style*=readium-iPadOSPatch-on] sup,:root[style*=readium-iPadOSPatch-on] time,:root[style*=readium-iPadOSPatch-on] u,:root[style*=readium-iPadOSPatch-on] var{-webkit-text-zoom:normal}:root[style*=readium-iPadOSPatch-on] p:not(:has(b,cite,em,i,q,s,small,span,strong)):first-line{-webkit-text-zoom:normal}`,Ga=`/*!
 * Readium CSS v.2.0.0-beta.19
 * Copyright (c) 20172025. Readium Foundation. All rights reserved.
 * Use of this source code is governed by a BSD-style license which is detailed in the
 * LICENSE file present in the project repository where this source code is maintained.
 * Core maintainer: Jiminy Panoz <jiminy.panoz@edrlab.org> 
 * Contributors: 
 * Daniel Weck
 * Hadrien Gardeur
 * Innovimax
 * L. Le Meur
 * Mickael Menu
 * k_taka
 */@namespace url(http://www.w3.org/1999/xhtml);@namespace epub url(http://www.idpf.org/2007/ops);@namespace m url(http://www.w3.org/1998/Math/MathML);@namespace svg url(http://www.w3.org/2000/svg);@-ms-viewport{width:device-width}@viewport{width:device-width;zoom:1}:root{--RS__monospaceTf:ui-monospace, "Andale Mono", "Cascadia Code", "Source Code Pro", Menlo, Consolas, "DejaVu Sans Mono", monospace;--RS__humanistTf:Seravek, Calibri, "Gill Sans Nova", Roboto, Ubuntu, "DejaVu Sans", source-sans-pro, sans-serif;--RS__sansTf:-ui-sans-serif, -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI Variable", "Segoe UI", Inter, Roboto, "Helvetica Neue", "Arial Nova", "Liberation Sans", Arial, sans-serif;--RS__modernTf:Athelas, Constantia, Charter, "Bitstream Charter", Cambria, "Georgia Pro", Georgia, serif;--RS__oldStyleTf:"Iowan Old Style", Sitka, "Sitka Text", Palatino, "Book Antiqua", "URW Palladio L", P052, serif;--RS__baseFontFamily:var(--RS__oldStyleTf);--RS__lineHeightCompensation:1;--RS__baseLineHeight:calc(1.5 * var(--RS__lineHeightCompensation));--RS__selectionTextColor:inherit;--RS__selectionBackgroundColor:#b4d8fe;--RS__visitedColor:#551A8B;--RS__linkColor:#0000EE;--RS__textColor:#121212;--RS__backgroundColor:#FFFFFF;color:var(--RS__textColor)!important;background-color:var(--RS__backgroundColor)!important}::-moz-selection{color:var(--RS__selectionTextColor);background-color:var(--RS__selectionBackgroundColor)}::selection{color:var(--RS__selectionTextColor);background-color:var(--RS__selectionBackgroundColor)}html{font-family:var(--RS__baseFontFamily);line-height:1.6;line-height:var(--RS__baseLineHeight);text-rendering:optimizelegibility}h1,h2,h3{line-height:normal}:lang(ja),:lang(zh),:lang(ko){word-wrap:break-word;-webkit-line-break:strict;-epub-line-break:strict;line-break:strict}math{font-family:"Latin Modern Math","STIX Two Math","XITS Math","STIX Math","Libertinus Math","TeX Gyre Termes Math","TeX Gyre Bonum Math",TeX Gyre Schola,"DejaVu Math TeX Gyre","TeX Gyre Pagella Math","Asana Math","Cambria Math","Lucida Bright Math","Minion Math",STIXGeneral,STIXSizeOneSym,Symbol,Times New Roman,serif}:lang(am){--RS__baseFontFamily:kefa, nyala, roboto, noto, "Noto Sans Ethiopic", serif;--RS__lineHeightCompensation:1.167}:lang(ar){--RS__baseFontFamily:"Geeza Pro", "Arabic Typesetting", roboto, noto, "Noto Naskh Arabic", "Times New Roman", serif}:lang(bn){--RS__baseFontFamily:"Kohinoor Bangla", "Bangla Sangam MN", vrinda, roboto, noto, "Noto Sans Bengali", sans-serif;--RS__lineHeightCompensation:1.067}:lang(bo){--RS__baseFontFamily:kailasa, "Microsoft Himalaya", roboto, noto, "Noto Sans Tibetan", sans-serif}:lang(chr){--RS__baseFontFamily:"Plantagenet Cherokee", roboto, noto, "Noto Sans Cherokee";--RS__lineHeightCompensation:1.167}:lang(fa){--RS__baseFontFamily:"Geeza Pro", "Arabic Typesetting", roboto, noto, "Noto Naskh Arabic", "Times New Roman", serif}:lang(gu){--RS__baseFontFamily:"Gujarati Sangam MN", "Nirmala UI", shruti, roboto, noto, "Noto Sans Gujarati", sans-serif;--RS__lineHeightCompensation:1.167}:lang(he){--RS__baseFontFamily:"New Peninim MT", "Arial Hebrew", gisha, "Times New Roman", roboto, noto, "Noto Sans Hebrew" sans-serif;--RS__lineHeightCompensation:1.1}:lang(hi){--RS__baseFontFamily:"Kohinoor Devanagari", "Devanagari Sangam MN", kokila, "Nirmala UI", roboto, noto, "Noto Sans Devanagari", sans-serif;--RS__lineHeightCompensation:1.1}:lang(hy){--RS__baseFontFamily:mshtakan, sylfaen, roboto, noto, "Noto Serif Armenian", serif}:lang(iu){--RS__baseFontFamily:"Euphemia UCAS", euphemia, roboto, noto, "Noto Sans Canadian Aboriginal", sans-serif}:lang(ja){--RS__baseFontFamily:yugothic, "Hiragino Maru Gothic ProN", "Hiragino Sans", "Yu Gothic UI", "Meiryo UI", "MS Gothic", roboto, noto, "Noto Sans CJK JP", sans-serif;--RS__lineHeightCompensation:1.167;--RS__serif-ja:"Hiragino Mincho ProN", "Hiragino Mincho Pro", "YuMincho", "BIZ UDPMincho", "Yu Mincho", " ", "MS PMincho", serif;--RS__sans-serif-ja:"Hiragino Sans", "Hiragino Kaku Gothic ProN", "Hiragino Kaku Gothic Pro", " W3", "YuGothic", "Yu Gothic Medium", "BIZ UDPGothic", "Yu Gothic", " ", "MS PGothic", sans-serif;--RS__serif-ja-v:"Hiragino Mincho ProN", "Hiragino Mincho Pro", "YuMincho", "BIZ UDMincho", "Yu Mincho", "", "MS Mincho", serif;--RS__sans-serif-ja-v:"Hiragino Sans", "Hiragino Kaku Gothic ProN", "Hiragino Kaku Gothic Pro", " W3", "YuGothic", "Yu Gothic Medium", "BIZ UDGothic", "Yu Gothic", "", "MS Gothic", sans-serif}:lang(km){--RS__baseFontFamily:"Khmer Sangam MN", "Leelawadee UI", "Khmer UI", roboto, noto, "Noto Sans Khmer", sans-serif;--RS__lineHeightCompensation:1.067}:lang(kn){--RS__baseFontFamily:"Kannada Sangam MN", "Nirmala UI", tunga, roboto, noto, "Noto Sans Kannada", sans-serif;--RS__lineHeightCompensation:1.1}:lang(ko){--RS__baseFontFamily:"Nanum Gothic", "Apple SD Gothic Neo", "Malgun Gothic", roboto, noto, "Noto Sans CJK KR", sans-serif;--RS__lineHeightCompensation:1.167}:lang(lo){--RS__baseFontFamily:"Lao Sangam MN", "Leelawadee UI", "Lao UI", roboto, noto, "Noto Sans Lao", sans-serif}:lang(ml){--RS__baseFontFamily:"Malayalam Sangam MN", "Nirmala UI", kartika, roboto, noto, "Noto Sans Malayalam", sans-serif;--RS__lineHeightCompensation:1.067}:lang(or){--RS__baseFontFamily:"Oriya Sangam MN", "Nirmala UI", kalinga, roboto, noto, "Noto Sans Oriya", sans-serif;--RS__lineHeightCompensation:1.167}:lang(pa){--RS__baseFontFamily:"Gurmukhi MN", "Nirmala UI", kartika, roboto, noto, "Noto Sans Gurmukhi", sans-serif;--RS__lineHeightCompensation:1.1}:lang(si){--RS__baseFontFamily:"Sinhala Sangam MN", "Nirmala UI", "Iskoola Pota", roboto, noto, "Noto Sans Sinhala", sans-serif;--RS__lineHeightCompensation:1.167}:lang(ta){--RS__baseFontFamily:"Tamil Sangam MN", "Nirmala UI", latha, roboto, noto, "Noto Sans Tamil", sans-serif;--RS__lineHeightCompensation:1.067}:lang(te){--RS__baseFontFamily:"Kohinoor Telugu", "Telugu Sangam MN", "Nirmala UI", gautami, roboto, noto, "Noto Sans Telugu", sans-serif}:lang(th){--RS__baseFontFamily:"Thonburi", "Leelawadee UI", "Cordia New", roboto, noto, "Noto Sans Thai", sans-serif;--RS__lineHeightCompensation:1.067}:lang(zh){--RS__baseFontFamily:"", "PingFang SC", "", "Heiti SC", "Microsoft JhengHei UI", "Microsoft JhengHei", roboto, noto, "Noto Sans CJK SC", sans-serif;--RS__lineHeightCompensation:1.167}:lang(zh-Hant),:lang(zh-TW){--RS__baseFontFamily:"", "PingFang TC", "", "Heiti TC", "Microsoft JhengHei UI", "Microsoft JhengHei", roboto, noto, "Noto Sans CJK TC", sans-serif;--RS__lineHeightCompensation:1.167}:lang(zh-HK){--RS__baseFontFamily:"", "PingFang HK", "", "PingFang TC", "", "Heiti TC", "Microsoft JhengHei UI", "Microsoft JhengHei", roboto, noto, "Noto Sans CJK TC", sans-serif;--RS__lineHeightCompensation:1.167}@font-face{font-family:AccessibleDfA;font-style:normal;font-weight:400;src:local("AccessibleDfA"),url(./assets/AccessibleDfA-Regular.woff2) format("woff2"),url(./assets/AccessibleDfA-Regular.woff) format("woff")}@font-face{font-family:AccessibleDfA;font-style:normal;font-weight:700;src:local("AccessibleDfA"),url(./assets/AccessibleDfA-Bold.woff2) format("woff2")}@font-face{font-family:AccessibleDfA;font-style:italic;font-weight:400;src:local("AccessibleDfA"),url(./assets/AccessibleDfA-Italic.woff2) format("woff2")}@font-face{font-family:IA Writer Duospace;font-style:normal;font-weight:400;src:local("iAWriterDuospace-Regular"),url(./assets/iAWriterDuospace-Regular.ttf) format("truetype")}body{widows:2;orphans:2}figcaption,th,td{widows:1;orphans:1}h2,h3,h4,h5,h6,dt,hr,caption{-webkit-column-break-after:avoid;page-break-after:avoid;break-after:avoid}h1,h2,h3,h4,h5,h6,dt,figure,tr{-webkit-column-break-inside:avoid;page-break-inside:avoid;break-inside:avoid}body{-webkit-hyphenate-character:"-";-moz-hyphenate-character:"-";-ms-hyphenate-character:"-";hyphenate-character:"-";-webkit-hyphenate-limit-lines:3;-ms-hyphenate-limit-lines:3;hyphenate-limit-lines:3}h1,h2,h3,h4,h5,h6,dt,figcaption,pre,caption,address,center,code,var{-ms-hyphens:none;-moz-hyphens:none;-webkit-hyphens:none;-epub-hyphens:none;hyphens:none}body{font-variant-numeric:oldstyle-nums proportional-nums}:lang(ja) body,:lang(zh) body,:lang(ko) body{font-variant-numeric:lining-nums proportional-nums}h1,h2,h3,h4,h5,h6,dt{font-variant-numeric:lining-nums proportional-nums}table{font-variant-numeric:lining-nums tabular-nums}code,var{font-variant-ligatures:none;font-variant-numeric:lining-nums tabular-nums slashed-zero}rt{font-variant-east-asian:ruby}:lang(ar){font-variant-ligatures:common-ligatures}:lang(ko){font-kerning:normal}hr{color:inherit;border-color:currentcolor}table,th,td{border-color:currentcolor}figure,blockquote{margin:1em 5%}ul,ol{padding-left:5%}dd{margin-left:5%}pre{white-space:pre-wrap;-ms-tab-size:2;-moz-tab-size:2;-webkit-tab-size:2;tab-size:2}abbr[title],acronym[title]{text-decoration:dotted underline}nobr wbr{white-space:normal}ruby>rt,ruby>rp{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}*:lang(ja):not(:lang(ja-Latn)):not(:lang(ja-Cyrl)),*:lang(zh):not(:lang(zh-Latn)):not(:lang(zh-Cyrl)),*:lang(ko):not(:lang(ko-Latn)):not(:lang(ko-Cyrl)),:lang(ja):not(:lang(ja-Latn)):not(:lang(ja-Cyrl)) cite,:lang(ja):not(:lang(ja-Latn)):not(:lang(ja-Cyrl)) dfn,:lang(ja):not(:lang(ja-Latn)):not(:lang(ja-Cyrl)) em,:lang(ja):not(:lang(ja-Latn)):not(:lang(ja-Cyrl)) i,:lang(zh):not(:lang(zh-Latn)):not(:lang(zh-Cyrl)) cite,:lang(zh):not(:lang(zh-Latn)):not(:lang(zh-Cyrl)) dfn,:lang(zh):not(:lang(zh-Latn)):not(:lang(zh-Cyrl)) em,:lang(zh):not(:lang(zh-Latn)):not(:lang(zh-Cyrl)) i,:lang(ko):not(:lang(ko-Latn)):not(:lang(ko-Cyrl)) cite,:lang(ko):not(:lang(ko-Latn)):not(:lang(ko-Cyrl)) dfn,:lang(ko):not(:lang(ko-Latn)):not(:lang(ko-Cyrl)) em,:lang(ko):not(:lang(ko-Latn)):not(:lang(ko-Cyrl)) i{font-style:normal}:lang(ja) a,:lang(zh) a,:lang(ko) a{text-decoration:none}:root{--RS__maxMediaWidth:100%;--RS__maxMediaHeight:95vh;--RS__boxSizingMedia:border-box;--RS__boxSizingTable:border-box}a,a span,span a,h1,h2,h3,h4,h5,h6{word-wrap:break-word}div{max-width:var(--RS__maxMediaWidth)}img,svg|svg,video{object-fit:contain;width:auto;height:auto;max-width:var(--RS__maxMediaWidth);max-height:var(--RS__maxMediaHeight)!important;box-sizing:var(--RS__boxSizingMedia);-webkit-column-break-inside:avoid;page-break-inside:avoid;break-inside:avoid}audio{max-width:100%;-webkit-column-break-inside:avoid;page-break-inside:avoid;break-inside:avoid}table{max-width:var(--RS__maxMediaWidth);box-sizing:var(--RS__boxSizingTable)}`,Xa=`/*!
 * Readium CSS v.2.0.0-beta.19
 * Copyright (c) 20172025. Readium Foundation. All rights reserved.
 * Use of this source code is governed by a BSD-style license which is detailed in the
 * LICENSE file present in the project repository where this source code is maintained.
 * Core maintainer: Jiminy Panoz <jiminy.panoz@edrlab.org> 
 * Contributors: 
 * Daniel Weck
 * Hadrien Gardeur
 * Innovimax
 * L. Le Meur
 * Mickael Menu
 * k_taka
 */@namespace url(http://www.w3.org/1999/xhtml);@namespace epub url(http://www.idpf.org/2007/ops);@namespace m url(http://www.w3.org/1998/Math/MathML);@namespace svg url(http://www.w3.org/2000/svg);:root{--RS__compFontFamily:var(--RS__baseFontFamily);--RS__codeFontFamily:var(--RS__monospaceTf);--RS__typeScale:1.125;--RS__baseFontSize:100%;--RS__flowSpacing:1.5rem;--RS__paraSpacing:0;--RS__paraIndent:1em;--RS__linkColor:#0000EE;--RS__visitedColor:#551A8B;--RS__primaryColor:;--RS__secondaryColor:}body{font-size:var(--RS__baseFontSize)}h1,h2,h3,h4,h5,h6{font-family:var(--RS__compFontFamily)}blockquote,figure,p,pre,aside,footer,form,hr{margin-top:var(--RS__flowSpacing);margin-bottom:var(--RS__flowSpacing)}p{margin-top:var(--RS__paraSpacing);margin-bottom:var(--RS__paraSpacing);text-indent:var(--RS__paraIndent)}h1+p,h2+p,h3+p,h4+p,h5+p,h6+p,hr+p{text-indent:0}pre{font-family:var(--RS__codeFontFamily)}code,kbd,samp,tt{font-family:var(--RS__codeFontFamily)}sub,sup{position:relative;font-size:67.5%;line-height:1}sub{bottom:-.2ex}sup{bottom:0}:link{color:var(--RS__linkColor)}:visited{color:var(--RS__visitedColor)}h1{margin-top:calc(var(--RS__flowSpacing) * 2);margin-bottom:calc(var(--RS__flowSpacing) * 2);font-size:calc(((1em * var(--RS__typeScale)) * var(--RS__typeScale)) * var(--RS__typeScale))}h2{margin-top:calc(var(--RS__flowSpacing) * 2);margin-bottom:var(--RS__flowSpacing);font-size:calc((1em * var(--RS__typeScale)) * var(--RS__typeScale))}h3{margin-top:var(--RS__flowSpacing);margin-bottom:var(--RS__flowSpacing);font-size:calc(1em * var(--RS__typeScale))}h4{margin-top:var(--RS__flowSpacing);margin-bottom:var(--RS__flowSpacing);font-size:1em}h5{margin-top:var(--RS__flowSpacing);margin-bottom:var(--RS__flowSpacing);font-size:1em;font-variant:small-caps}h6{margin-top:var(--RS__flowSpacing);margin-bottom:0;font-size:1em;text-transform:lowercase;font-variant:small-caps}dl,ol,ul{margin-top:var(--RS__flowSpacing);margin-bottom:var(--RS__flowSpacing)}table{margin:var(--RS__flowSpacing) 0;border:1px solid currentcolor;border-collapse:collapse;empty-cells:show}thead,tbody,tfoot,table>tr{vertical-align:top}th{text-align:left}th,td{padding:4px;border:1px solid currentcolor}`,ye=(r,e)=>URL.createObjectURL(new Blob([r],{type:e})),Tn=r=>r.replace(/\/\/.*/g,"").replace(/\/\*[\s\S]*?\*\//g,"").replace(/\n/g,"").replace(/\s+/g," "),Vt=r=>r.replace(/\/\*(?:(?!\*\/)[\s\S])*\*\/|[\r\n\t]+/g,"").replace(/ {2,}/g," ").replace(/url\((?!(https?:)?\/\/)("?)\/([^\)]+)/g,`url($2${window.location.origin}/$3`),Ui=(r,e)=>{const t=r.createElement("script");return t.dataset.readium="true",t.src=e.startsWith("blob:")?e:ye(e,"text/javascript"),t},Gt=(r,e)=>{const t=r.createElement("link");return t.dataset.readium="true",t.rel="stylesheet",t.type="text/css",t.href=e.startsWith("blob:")?e:ye(e,"text/css"),t},Xt=new Map,ke=(r,e)=>{if(Xt.has(r))return Xt.get(r);const t=e();return Xt.set(r,t),t},Ya=r=>Ui(r,ke("css-selector-generator",()=>ye('!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports._readium_cssSelectorGenerator=e():t._readium_cssSelectorGenerator=e()}(self,(()=>(()=>{"use strict";var t,e,n={d:(t,e)=>{for(var o in e)n.o(e,o)&&!n.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};function r(t){return t&&t instanceof Element}function i(t="unknown problem",...e){console.warn(`CssSelectorGenerator: ${t}`,...e)}n.r(o),n.d(o,{default:()=>z,getCssSelector:()=>U}),function(t){t.NONE="none",t.DESCENDANT="descendant",t.CHILD="child"}(t||(t={})),function(t){t.id="id",t.class="class",t.tag="tag",t.attribute="attribute",t.nthchild="nthchild",t.nthoftype="nthoftype"}(e||(e={}));const c={selectors:[e.id,e.class,e.tag,e.attribute],includeTag:!1,whitelist:[],blacklist:[],combineWithinSelector:!0,combineBetweenSelectors:!0,root:null,maxCombinations:Number.POSITIVE_INFINITY,maxCandidates:Number.POSITIVE_INFINITY};function u(t){return t instanceof RegExp}function s(t){return["string","function"].includes(typeof t)||u(t)}function l(t){return Array.isArray(t)?t.filter(s):[]}function a(t){const e=[Node.DOCUMENT_NODE,Node.DOCUMENT_FRAGMENT_NODE,Node.ELEMENT_NODE];return function(t){return t instanceof Node}(t)&&e.includes(t.nodeType)}function f(t,e){if(a(t))return t.contains(e)||i("element root mismatch","Provided root does not contain the element. This will most likely result in producing a fallback selector using element\'s real root node. If you plan to use the selector using provided root (e.g. `root.querySelector`), it will nto work as intended."),t;const n=e.getRootNode({composed:!1});return a(n)?(n!==document&&i("shadow root inferred","You did not provide a root and the element is a child of Shadow DOM. This will produce a selector using ShadowRoot as a root. If you plan to use the selector using document as a root (e.g. `document.querySelector`), it will not work as intended."),n):e.ownerDocument.querySelector(":root")}function d(t){return"number"==typeof t?t:Number.POSITIVE_INFINITY}function m(t=[]){const[e=[],...n]=t;return 0===n.length?e:n.reduce(((t,e)=>t.filter((t=>e.includes(t)))),e)}function p(t){return[].concat(...t)}function h(t){const e=t.map((t=>{if(u(t))return e=>t.test(e);if("function"==typeof t)return e=>{const n=t(e);return"boolean"!=typeof n?(i("pattern matcher function invalid","Provided pattern matching function does not return boolean. It\'s result will be ignored.",t),!1):n};if("string"==typeof t){const e=new RegExp("^"+t.replace(/[|\\\\{}()[\\]^$+?.]/g,"\\\\$&").replace(/\\*/g,".+")+"$");return t=>e.test(t)}return i("pattern matcher invalid","Pattern matching only accepts strings, regular expressions and/or functions. This item is invalid and will be ignored.",t),()=>!1}));return t=>e.some((e=>e(t)))}function g(t,e,n){const o=Array.from(f(n,t[0]).querySelectorAll(e));return o.length===t.length&&t.every((t=>o.includes(t)))}function y(t,e){e=null!=e?e:function(t){return t.ownerDocument.querySelector(":root")}(t);const n=[];let o=t;for(;r(o)&&o!==e;)n.push(o),o=o.parentElement;return n}function b(t,e){return m(t.map((t=>y(t,e))))}const N={[t.NONE]:{type:t.NONE,value:""},[t.DESCENDANT]:{type:t.DESCENDANT,value:" > "},[t.CHILD]:{type:t.CHILD,value:" "}},S=new RegExp(["^$","\\\\s"].join("|")),E=new RegExp(["^$"].join("|")),w=[e.nthoftype,e.tag,e.id,e.class,e.attribute,e.nthchild],v=h(["class","id","ng-*"]);function C({nodeName:t}){return`[${t}]`}function O({nodeName:t,nodeValue:e}){return`[${t}=\'${L(e)}\']`}function T(t){const e=Array.from(t.attributes).filter((e=>function({nodeName:t},e){const n=e.tagName.toLowerCase();return!(["input","option"].includes(n)&&"value"===t||v(t))}(e,t)));return[...e.map(C),...e.map(O)]}function I(t){return(t.getAttribute("class")||"").trim().split(/\\s+/).filter((t=>!E.test(t))).map((t=>`.${L(t)}`))}function x(t){const e=t.getAttribute("id")||"",n=`#${L(e)}`,o=t.getRootNode({composed:!1});return!S.test(e)&&g([t],n,o)?[n]:[]}function j(t){const e=t.parentNode;if(e){const n=Array.from(e.childNodes).filter(r).indexOf(t);if(n>-1)return[`:nth-child(${n+1})`]}return[]}function A(t){return[L(t.tagName.toLowerCase())]}function D(t){const e=[...new Set(p(t.map(A)))];return 0===e.length||e.length>1?[]:[e[0]]}function $(t){const e=D([t])[0],n=t.parentElement;if(n){const o=Array.from(n.children).filter((t=>t.tagName.toLowerCase()===e)),r=o.indexOf(t);if(r>-1)return[`${e}:nth-of-type(${r+1})`]}return[]}function R(t=[],{maxResults:e=Number.POSITIVE_INFINITY}={}){const n=[];let o=0,r=k(1);for(;r.length<=t.length&&o<e;)o+=1,n.push(r.map((e=>t[e]))),r=P(r,t.length-1);return n}function P(t=[],e=0){const n=t.length;if(0===n)return[];const o=[...t];o[n-1]+=1;for(let t=n-1;t>=0;t--)if(o[t]>e){if(0===t)return k(n+1);o[t-1]++,o[t]=o[t-1]+1}return o[n-1]>e?k(n+1):o}function k(t=1){return Array.from(Array(t).keys())}const _=":".charCodeAt(0).toString(16).toUpperCase(),M=/[ !"#$%&\'()\\[\\]{|}<>*+,./;=?@^`~\\\\]/;function L(t=""){var e,n;return null!==(n=null===(e=null===CSS||void 0===CSS?void 0:CSS.escape)||void 0===e?void 0:e.call(CSS,t))&&void 0!==n?n:function(t=""){return t.split("").map((t=>":"===t?`\\\\${_} `:M.test(t)?`\\\\${t}`:escape(t).replace(/%/g,"\\\\"))).join("")}(t)}const q={tag:D,id:function(t){return 0===t.length||t.length>1?[]:x(t[0])},class:function(t){return m(t.map(I))},attribute:function(t){return m(t.map(T))},nthchild:function(t){return m(t.map(j))},nthoftype:function(t){return m(t.map($))}},F={tag:A,id:x,class:I,attribute:T,nthchild:j,nthoftype:$};function V(t){return t.includes(e.tag)||t.includes(e.nthoftype)?[...t]:[...t,e.tag]}function Y(t={}){const n=[...w];return t[e.tag]&&t[e.nthoftype]&&n.splice(n.indexOf(e.tag),1),n.map((e=>{return(o=t)[n=e]?o[n].join(""):"";var n,o})).join("")}function B(t,e,n="",o){const r=function(t,e){return""===e?t:function(t,e){return[...t.map((t=>e+" "+t)),...t.map((t=>e+" > "+t))]}(t,e)}(function(t,e,n){const o=function(t,e){const{blacklist:n,whitelist:o,combineWithinSelector:r,maxCombinations:i}=e,c=h(n),u=h(o);return function(t){const{selectors:e,includeTag:n}=t,o=[].concat(e);return n&&!o.includes("tag")&&o.push("tag"),o}(e).reduce(((e,n)=>{const o=function(t,e){var n;return(null!==(n=q[e])&&void 0!==n?n:()=>[])(t)}(t,n),s=function(t=[],e,n){return t.filter((t=>n(t)||!e(t)))}(o,c,u),l=function(t=[],e){return t.sort(((t,n)=>{const o=e(t),r=e(n);return o&&!r?-1:!o&&r?1:0}))}(s,u);return e[n]=r?R(l,{maxResults:i}):l.map((t=>[t])),e}),{})}(t,n),r=function(t,e){return function(t){const{selectors:e,combineBetweenSelectors:n,includeTag:o,maxCandidates:r}=t,i=n?R(e,{maxResults:r}):e.map((t=>[t]));return o?i.map(V):i}(e).map((e=>function(t,e){const n={};return t.forEach((t=>{const o=e[t];o.length>0&&(n[t]=o)})),function(t={}){let e=[];return Object.entries(t).forEach((([t,n])=>{e=n.flatMap((n=>0===e.length?[{[t]:n}]:e.map((e=>Object.assign(Object.assign({},e),{[t]:n})))))})),e}(n).map(Y)}(e,t))).filter((t=>t.length>0))}(o,n),i=p(r);return[...new Set(i)]}(t,o.root,o),n);for(const e of r)if(g(t,e,o.root))return e;return null}function G(t){return{value:t,include:!1}}function W({selectors:t,operator:n}){let o=[...w];t[e.tag]&&t[e.nthoftype]&&(o=o.filter((t=>t!==e.tag)));let r="";return o.forEach((e=>{(t[e]||[]).forEach((({value:t,include:e})=>{e&&(r+=t)}))})),n.value+r}function H(n){return[":root",...y(n).reverse().map((n=>{const o=function(e,n,o=t.NONE){const r={};return n.forEach((t=>{Reflect.set(r,t,function(t,e){return F[e](t)}(e,t).map(G))})),{element:e,operator:N[o],selectors:r}}(n,[e.nthchild],t.DESCENDANT);return o.selectors.nthchild.forEach((t=>{t.include=!0})),o})).map(W)].join("")}function U(t,n={}){const o=function(t){const e=(Array.isArray(t)?t:[t]).filter(r);return[...new Set(e)]}(t),i=function(t,n={}){const o=Object.assign(Object.assign({},c),n);return{selectors:(r=o.selectors,Array.isArray(r)?r.filter((t=>{return n=e,o=t,Object.values(n).includes(o);var n,o})):[]),whitelist:l(o.whitelist),blacklist:l(o.blacklist),root:f(o.root,t),combineWithinSelector:!!o.combineWithinSelector,combineBetweenSelectors:!!o.combineBetweenSelectors,includeTag:!!o.includeTag,maxCombinations:d(o.maxCombinations),maxCandidates:d(o.maxCandidates)};var r}(o[0],n);let u="",s=i.root;function a(){return function(t,e,n="",o){if(0===t.length)return null;const r=[t.length>1?t:[],...b(t,e).map((t=>[t]))];for(const t of r){const e=B(t,0,n,o);if(e)return{foundElements:t,selector:e}}return null}(o,s,u,i)}let m=a();for(;m;){const{foundElements:t,selector:e}=m;if(g(o,e,i.root))return e;s=t[0],u=e,m=a()}return o.length>1?o.map((t=>U(t,i))).join(", "):function(t){return t.map(H).join(", ")}(o)}const z=U;return o})()));',"text/javascript"))),qa=r=>Ui(r,ke("JS-Before",()=>ye(Tn(`
    window._readium_blockedEvents = [];
    window._readium_blockEvents = true;
    window._readium_eventBlocker = (e) => {
        if(!window._readium_blockEvents) return;
        e.preventDefault();
        e.stopImmediatePropagation();
        _readium_blockedEvents.push([
            1, e, e.currentTarget || e.target
        ]);
    };
    window.addEventListener("DOMContentLoaded", window._readium_eventBlocker, true);
    window.addEventListener("load", window._readium_eventBlocker, true);`),"text/javascript"))),Ja=r=>Ui(r,ke("JS-After",()=>ye(Tn(`
    if(window.onload) window.onload = new Proxy(window.onload, {
        apply: function(target, receiver, args) {
            if(!window._readium_blockEvents) {
                Reflect.apply(target, receiver, args);
                return;
            }
            _readium_blockedEvents.push([
                0, target, receiver, args
            ]);
        }
    });`),"text/javascript")));class Pn{constructor(e,t,i,s){this.pub=e,this.item=i,this.burl=i.toURL(t)||"",this.cssProperties=s}async build(e=!1){if(this.item.mediaType.isHTML)return await this.buildHtmlFrame(e);if(this.item.mediaType.isBitmap)return this.buildImageFrame();throw Error("Unsupported frame mediatype "+this.item.mediaType.string)}async buildHtmlFrame(e=!1){const t=await this.pub.get(this.item).readAsString();if(!t)throw new Error(`Failed reading item ${this.item.href}`);const i=new DOMParser().parseFromString(t,this.item.mediaType.string),s=i.querySelector("parsererror");if(s){const n=s.querySelector("div");throw new Error(`Failed parsing item ${this.item.href}: ${n?.textContent||s.textContent}`)}return this.finalizeDOM(i,this.burl,this.item.mediaType,e,this.cssProperties)}buildImageFrame(){const e=document.implementation.createHTMLDocument(this.item.title||this.item.href),t=document.createElement("img");return t.src=this.burl||"",t.alt=this.item.title||"",t.decoding="async",e.body.appendChild(t),this.finalizeDOM(e,this.burl,this.item.mediaType,!0)}hasExecutable(e){return!!e.querySelector("script")||!!e.querySelector("body[onload]:not(body[onload=''])")}hasStyle(e){return!!(e.querySelector("link[rel='stylesheet']")||e.querySelector("style")||e.querySelector("[style]:not([style=''])"))}setProperties(e,t){for(const i in e){const s=e[i];s&&t.documentElement.style.setProperty(i,s)}}finalizeDOM(e,t,i,s=!1,n){if(!e)return"";if(!s){const a=Gt(e,ke("ReadiumCSS-before",()=>ye(Vt(Ga),"text/css")));e.head.firstChild?e.head.firstChild.before(a):e.head.appendChild(a),this.hasStyle(e)||a.after(Gt(e,ke("ReadiumCSS-default",()=>ye(Vt(Xa),"text/css")))),e.head.appendChild(Gt(e,ke("ReadiumCSS-after",()=>ye(Vt(Va),"text/css")))),n&&this.setProperties(n,e)}if(e.body.querySelectorAll("img").forEach(a=>{a.setAttribute("fetchpriority","high")}),i.isHTML&&this.pub.metadata.languages?.[0]){const a=this.pub.metadata.languages[0];if(i===f.XHTML){const l=document.documentElement.lang||document.documentElement.getAttribute("xml:lang"),h=document.body.lang||document.body.getAttribute("xml:lang");h&&!l?(document.documentElement.lang=h,document.documentElement.setAttribute("xml:lang",h),document.body.removeAttribute("xml:lang"),document.body.removeAttribute("lang")):l||(document.documentElement.lang=a,document.documentElement.setAttribute("xml:lang",a))}else i===f.HTML&&!document.documentElement.lang&&(document.documentElement.lang=a)}if(t!==void 0){const a=e.createElement("base");a.href=t,a.dataset.readium="true",e.head.firstChild.before(a)}const o=this.hasExecutable(e);return o&&e.head.firstChild.before(qa(e)),e.head.firstChild.before(Ya(e)),o&&e.head.appendChild(Ja(e)),URL.createObjectURL(new Blob([new XMLSerializer().serializeToString(e)],{type:i.isHTML?i.string:"application/xhtml+xml"}))}}class Ka{constructor(e){this.hidden=!0,this.destroyed=!1,this.currModules=[],this.frame=document.createElement("iframe"),this.frame.classList.add("readium-navigator-iframe"),this.frame.style.visibility="hidden",this.frame.style.setProperty("aria-hidden","true"),this.frame.style.opacity="0",this.frame.style.position="absolute",this.frame.style.pointerEvents="none",this.frame.style.transition="visibility 0s, opacity 0.1s linear",this.source=e}async load(e){return new Promise((t,i)=>{if(this.loader){const s=this.frame.contentWindow;if([...this.currModules].sort().join("|")===[...e].sort().join("|")){try{t(s)}catch{}return}this.comms?.halt(),this.loader.destroy(),this.loader=new Ct(s,e),this.currModules=e,this.comms=void 0;try{t(s)}catch{}return}this.frame.onload=()=>{const s=this.frame.contentWindow;this.loader=new Ct(s,e),this.currModules=e;try{t(s)}catch{}},this.frame.onerror=s=>{try{i(s)}catch{}},this.frame.contentWindow.location.replace(this.source)})}async destroy(){await this.hide(),this.loader?.destroy(),this.frame.remove(),this.destroyed=!0}async hide(){if(!this.destroyed){if(this.frame.style.visibility="hidden",this.frame.style.setProperty("aria-hidden","true"),this.frame.style.opacity="0",this.frame.style.pointerEvents="none",this.hidden=!0,this.frame.parentElement)return this.comms===void 0||!this.comms.ready?void 0:new Promise((e,t)=>{this.comms?.send("unfocus",void 0,i=>{this.comms?.halt(),e()})});this.comms?.halt()}}async show(e){if(this.destroyed)throw Error("Trying to show frame when it doesn't exist");if(!this.frame.parentElement)throw Error("Trying to show frame that is not attached to the DOM");return this.comms?this.comms.resume():this.comms=new yi(this.frame.contentWindow,this.source),new Promise((t,i)=>{this.comms?.send("activate",void 0,()=>{this.comms?.send("focus",void 0,()=>{const s=()=>{this.frame.style.removeProperty("visibility"),this.frame.style.removeProperty("aria-hidden"),this.frame.style.removeProperty("opacity"),this.frame.style.removeProperty("pointer-events"),this.hidden=!1,St.UA.WebKit&&this.comms?.send("force_webkit_recalc",void 0),t()};e!==void 0?this.comms?.send("go_progression",e,s):s()})})})}setCSSProperties(e){this.destroyed||!this.frame.contentWindow||(this.hidden&&(this.comms?this.comms?.resume():this.comms=new yi(this.frame.contentWindow,this.source)),this.comms?.send("update_properties",e),this.hidden&&this.comms?.halt())}get iframe(){if(this.destroyed)throw Error("Trying to use frame when it doesn't exist");return this.frame}get realSize(){if(this.destroyed)throw Error("Trying to use frame client rect when it doesn't exist");return this.frame.getBoundingClientRect()}get window(){if(this.destroyed||!this.frame.contentWindow)throw Error("Trying to use frame window when it doesn't exist");return this.frame.contentWindow}get atLeft(){return this.window.scrollX<5}get atRight(){return this.window.scrollX>this.window.document.scrollingElement.scrollWidth-this.window.innerWidth-5}get msg(){return this.comms}get ldr(){return this.loader}}const Xs=5,Ys=3;class Za{constructor(e,t,i){this.pool=new Map,this.blobs=new Map,this.inprogress=new Map,this.pendingUpdates=new Map,this.container=e,this.positions=t,this.currentCssProperties=i}async destroy(){let e=this.inprogress.values(),t=e.next();const i=[];for(;t.value;)i.push(t.value),t=e.next();i.length>0&&await Promise.allSettled(i),this.inprogress.clear();let s=this.pool.values(),n=s.next();for(;n.value;)await n.value.destroy(),n=s.next();this.pool.clear(),this.blobs.forEach(o=>URL.revokeObjectURL(o)),this.container.childNodes.forEach(o=>{(o.nodeType===Node.ELEMENT_NODE||o.nodeType===Node.TEXT_NODE)&&o.remove()})}async update(e,t,i,s=!1){let n=this.positions.findIndex(l=>l.locations.position===t.locations.position);if(n<0)throw Error(`Locator not found in position list: ${t.locations.position} > ${this.positions.reduce((l,h)=>h.locations.position||0>l?h.locations.position||0:l,0)}`);const o=this.positions[n].href;this.inprogress.has(o)&&await this.inprogress.get(o);const a=new Promise(async(l,h)=>{const u=[],d=[];this.positions.forEach((c,m)=>{(m>n+Xs||m<n-Xs)&&(u.includes(c.href)||u.push(c.href)),m<n+Ys&&m>n-Ys&&(d.includes(c.href)||d.push(c.href))}),u.forEach(async c=>{d.includes(c)||this.pool.has(c)&&(await this.pool.get(c)?.destroy(),this.pool.delete(c),this.pendingUpdates.has(c)&&this.pendingUpdates.set(c,{inPool:!1}))}),this.currentBaseURL!==void 0&&e.baseURL!==this.currentBaseURL&&(this.blobs.forEach(c=>URL.revokeObjectURL(c)),this.blobs.clear()),this.currentBaseURL=e.baseURL;const p=async c=>{if(s&&(this.blobs.forEach(x=>URL.revokeObjectURL(x)),this.blobs.clear(),this.pendingUpdates.clear()),this.pendingUpdates.has(c)&&this.pendingUpdates.get(c)?.inPool===!1){const x=this.blobs.get(c);x&&(URL.revokeObjectURL(x),this.blobs.delete(c),this.pendingUpdates.delete(c))}if(this.pool.has(c)){const x=this.pool.get(c);if(!this.blobs.has(c))await x.destroy(),this.pool.delete(c),this.pendingUpdates.delete(c);else{await x.load(i);return}}const m=e.readingOrder.findWithHref(c);if(!m)return;if(!this.blobs.has(c)){const x=await new Pn(e,this.currentBaseURL||"",m,this.currentCssProperties).build();this.blobs.set(c,x)}const b=new Ka(this.blobs.get(c));c!==o&&await b.hide(),this.container.appendChild(b.iframe),await b.load(i),this.pool.set(c,b)};try{await Promise.all(d.map(c=>p(c)))}catch(c){h(c)}const g=this.pool.get(o);(g?.source!==this._currentFrame?.source||s)&&(await this._currentFrame?.hide(),g&&await g.load(i),g&&await g.show(t.locations.progression),this._currentFrame=g),l()});this.inprogress.set(o,a),await a,this.inprogress.delete(o)}setCSSProperties(e){if(!((t,i)=>{const s=Object.keys(t),n=Object.keys(i);if(s.length!==n.length)return!1;for(const o of s)if(t[o]!==i[o])return!1;return!0})(this.currentCssProperties||{},e)){this.currentCssProperties=e,this.pool.forEach(t=>{t.setCSSProperties(e)});for(const t of this.blobs.keys())this.pendingUpdates.set(t,{inPool:this.pool.has(t)})}}get currentFrames(){return[this._currentFrame]}get currentBounds(){const e={x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0,toJSON(){return this}};return this.currentFrames.forEach(t=>{if(!t)return;const i=t.realSize;e.x=Math.min(e.x,i.x),e.y=Math.min(e.y,i.y),e.width+=i.width,e.height=Math.max(e.height,i.height),e.top=Math.min(e.top,i.top),e.right=Math.min(e.right,i.right),e.bottom=Math.min(e.bottom,i.bottom),e.left=Math.min(e.left,i.left)}),e}}class Qa{constructor(e,t,i){this.currModules=[],this.cachedPage=void 0,this.peripherals=e,this.debugHref=i,this.frame=document.createElement("iframe"),this.frame.classList.add("readium-navigator-iframe"),this.frame.classList.add("blank"),this.frame.scrolling="no",this.frame.style.visibility="hidden",this.frame.style.setProperty("aria-hidden","true"),this.frame.style.display="none",this.frame.style.position="absolute",this.frame.style.pointerEvents="none",this.frame.style.transformOrigin="0 0",this.frame.style.transform="scale(1)",this.frame.style.background="#fff",this.frame.style.touchAction="none",this.frame.dataset.originalHref=i,this.source="about:blank",this.wrapper=document.createElement("div"),this.wrapper.style.position="relative",this.wrapper.style.float=this.wrapper.style.cssFloat=t===I.rtl?"right":"left",this.wrapper.appendChild(this.frame)}async load(e,t){return this.source===t&&this.loadPromise&&[...this.currModules].sort().join("|")===[...e].sort().join("|")?this.loadPromise:(this.loaded&&this.source!==t&&this.window.stop(),this.source=t,this.loadPromise=new Promise((i,s)=>{if(this.loader&&this.loaded){const n=this.frame.contentWindow;if([...this.currModules].sort().join("|")===[...e].sort().join("|")){try{i(n),this.loadPromise=void 0}catch{}return}this.comms?.halt(),this.loader.destroy(),this.loader=new Ct(n,e),this.currModules=e,this.comms=void 0;try{i(n),this.loadPromise=void 0}catch{}return}this.frame.addEventListener("load",()=>{const n=this.frame.contentWindow;this.loader=new Ct(n,e),this.currModules=e,this.peripherals.observe(this.wrapper),this.peripherals.observe(n);try{i(n)}catch{}},{once:!0}),this.frame.addEventListener("error",n=>{try{s(n.error),this.loadPromise=void 0}catch{}},{once:!0}),this.frame.style.removeProperty("display"),this.frame.contentWindow.location.replace(this.source)}),this.loadPromise)}loadPageSize(){const e=this.frame.contentWindow,t=e.document.head.querySelector("meta[name=viewport]");if(t){const i=/(\w+) *= *([^\s,]+)/g;let s,n=0,o=0;for(;s=i.exec(t.content);)s[1]==="width"?n=Number.parseFloat(s[2]):s[1]==="height"&&(o=Number.parseFloat(s[2]));if(n>0&&o>0)return{width:n,height:o}}return{width:e.document.body.scrollWidth,height:e.document.body.scrollHeight}}update(e){if(!this.loaded)return;const t=this.loadPageSize();this.frame.style.height=`${t.height}px`,this.frame.style.width=`${t.width}px`;const i=Math.min(this.wrapper.clientWidth/t.width,this.wrapper.clientHeight/t.height);this.frame.style.transform=`scale(${i})`;const s=this.frame.getBoundingClientRect(),n=this.wrapper.clientHeight-s.height;if(this.frame.style.top=`${n/2}px`,e===le.left){const o=this.wrapper.clientWidth-s.width;this.frame.style.left=`${o}px`}else if(e===le.center){const o=this.wrapper.clientWidth-s.width;this.frame.style.left=`${o/2}px`}else this.frame.style.left="0px";this.frame.style.removeProperty("visibility"),this.frame.style.removeProperty("aria-hidden"),this.frame.style.removeProperty("pointer-events"),this.frame.classList.remove("blank"),this.frame.classList.add("loaded")}async destroy(){await this.unfocus(),this.loader?.destroy(),this.wrapper.remove()}async unload(){if(this.loaded)return this.deselect(),this.frame.style.visibility="hidden",this.frame.style.setProperty("aria-hidden","true"),this.frame.style.pointerEvents="none",this.frame.classList.add("blank"),this.frame.classList.remove("loaded"),this.comms?.halt(),this.loader?.destroy(),this.comms=void 0,this.frame.blur(),new Promise((e,t)=>{this.frame.addEventListener("load",()=>{try{this.showPromise=void 0,e()}catch{}},{once:!0}),this.frame.addEventListener("error",i=>{try{this.showPromise=void 0,t(i.error)}catch{}},{once:!0}),this.source="about:blank",this.frame.contentWindow.location.replace("about:blank"),this.frame.style.display="none"})}deselect(){this.frame.contentWindow?.getSelection()?.removeAllRanges()}async unfocus(){if(this.frame.parentElement)return this.comms===void 0?void 0:new Promise((e,t)=>{this.comms?.send("unfocus",void 0,i=>{this.comms?.halt(),this.showPromise=void 0,e()})});this.comms?.halt()}async show(e){if(!this.frame.parentElement){console.warn("Trying to show frame that is not attached to the DOM");return}if(!this.loaded){this.showPromise=void 0;return}return this.showPromise?(this.cachedPage!==e&&(this.update(e),this.cachedPage=e),this.showPromise):(this.cachedPage=e,this.comms?this.comms.resume():this.comms=new yi(this.frame.contentWindow,this.source),this.showPromise=new Promise((t,i)=>{this.comms.send("focus",void 0,s=>{this.update(this.cachedPage),t()})}),this.showPromise)}async activate(){return new Promise((e,t)=>{if(!this.comms)return e();this.comms?.send("activate",void 0,()=>{e()})})}get element(){return this.wrapper}get iframe(){return this.frame}get realSize(){return this.frame.getBoundingClientRect()}get loaded(){return this.frame.contentWindow&&this.frame.contentWindow.location.href!=="about:blank"}set width(e){const t=`${e}%`;this.wrapper.style.width!==t&&(this.wrapper.style.width=t)}set height(e){const t=`${e}px`;this.wrapper.style.height!==t&&(this.wrapper.style.height=t)}get window(){if(!this.frame.contentWindow)throw Error("Trying to use frame window when it doesn't exist");return this.frame.contentWindow}get atLeft(){return this.window.scrollX<5}get atRight(){return this.window.scrollX>this.window.document.scrollingElement.scrollWidth-this.window.innerWidth-5}get msg(){return this.comms}get ldr(){return this.loader}}class el{constructor(){this.outerWidth=0,this.outerHeight=0,this.HTML=document.documentElement,this.Head=document.head,this.Body=document.body}refreshOuterPixels(e){St.OS.iOS||(this.outerHeight=window.outerHeight-window.innerHeight,St.OS.Android&&St.UA.Chrome&&window.screen.height>window.innerHeight&&(this.outerHeight=(window.screen.height-window.innerHeight)/1.5),this.outerWidth=window.outerWidth-window.innerWidth)}getBibiEventCoord(e,t=0){const i={X:0,Y:0};return/^touch/.test(e.type)?(i.X=e.touches[t].screenX,i.Y=e.touches[t].screenY):(i.X=e.screenX,i.Y=e.screenY),(e.target.ownerDocument?.documentElement||e.target.documentElement)===this.HTML&&(i.X-=this.HTML.scrollLeft+this.Body.scrollLeft,i.Y-=this.HTML.scrollTop+this.Body.scrollTop),i.X-=this.outerWidth,i.Y-=this.outerHeight,i}getTouchDistance(e){if(e.touches.length!==2)return 0;const t=e.touches[0].screenX-this.outerWidth,i=e.touches[0].screenY-this.outerHeight,s=e.touches[1].screenX-this.outerWidth,n=e.touches[1].screenY-this.outerHeight;return Math.sqrt(Math.pow(s-t,2)+Math.pow(n-i,2))}getTouchCenter(e){if(e.touches.length!==2)return null;const t=this.HTML.scrollLeft+this.Body.scrollLeft,i=this.HTML.scrollTop+this.Body.scrollTop,s=e.touches[0].screenX-this.outerWidth-t,n=e.touches[0].screenY-this.outerHeight-i,o=e.touches[1].screenX-this.outerWidth-t,a=e.touches[1].screenY-this.outerHeight-i;return{X:(s+o)/2,Y:(n+a)/2}}getBibiEvent(e){if(!e)return{Coord:null,Division:null,Ratio:null,Target:null};const t=this.getBibiEventCoord(e);let i=.3;const s={X:t.X/window.innerWidth,Y:t.Y/window.innerHeight};let n,o,a,l;a=n=i,l=o=1-i;const h={X:null,Y:null};return s.X<a?h.X=0:l<s.X?h.X=2:h.X=1,s.Y<n?h.Y=0:o<s.Y?h.Y=2:h.Y=1,{Target:e.target,Coord:t,Ratio:s,Division:h}}}class tl{constructor(){this._DOM={show:!1,pinchTarget:document.createElement("div"),touch1:document.createElement("div"),touch2:document.createElement("div"),center:document.createElement("div"),stats:document.createElement("div")},this._DOM.show=!0,this._DOM.pinchTarget.style.zIndex=this._DOM.stats.style.zIndex=this._DOM.center.style.zIndex=this._DOM.touch1.style.zIndex=this._DOM.touch2.style.zIndex="100000",this._DOM.pinchTarget.style.position=this._DOM.stats.style.position=this._DOM.center.style.position=this._DOM.touch1.style.position=this._DOM.touch2.style.position="absolute",this._DOM.pinchTarget.style.borderRadius=this._DOM.center.style.borderRadius=this._DOM.touch1.style.borderRadius=this._DOM.touch2.style.borderRadius="50%",this._DOM.pinchTarget.style.pointerEvents=this._DOM.stats.style.pointerEvents=this._DOM.center.style.pointerEvents=this._DOM.touch1.style.pointerEvents=this._DOM.touch2.style.pointerEvents="none",this._DOM.pinchTarget.style.display=this._DOM.center.style.display=this._DOM.touch1.style.display=this._DOM.touch2.style.display="none",this._DOM.pinchTarget.style.paddingTop=this._DOM.center.style.paddingTop="10px",this._DOM.pinchTarget.style.width=this._DOM.pinchTarget.style.height=this._DOM.center.style.width=this._DOM.center.style.height="10px",this._DOM.pinchTarget.style.backgroundColor="green",this._DOM.center.style.backgroundColor="red",this._DOM.touch1.style.backgroundColor=this._DOM.touch2.style.backgroundColor="blue",this._DOM.touch1.style.height=this._DOM.touch2.style.height="20px",this._DOM.touch1.style.width=this._DOM.touch2.style.width="20px",this._DOM.touch1.style.paddingTop=this._DOM.touch2.style.paddingTop="20px",this._DOM.touch1.textContent="1",this._DOM.touch2.textContent="2",this._DOM.stats.style.padding="20px",this._DOM.stats.style.backgroundColor="rgba(0,0,0,0.5)",this._DOM.stats.style.color="white",this._DOM.stats.textContent="[stats]",document.body.appendChild(this._DOM.stats),document.body.appendChild(this._DOM.center),document.body.appendChild(this._DOM.touch1),document.body.appendChild(this._DOM.touch2),document.body.appendChild(this._DOM.pinchTarget)}get show(){return this.DOM.show}get DOM(){return this._DOM}}const qs=6,Yt=1.02,Js=50;class il{constructor(e,t=!1){this.dragState=0,this.minimumMoved=!1,this.pan={startX:0,endX:0,startY:0,overscrollX:0,overscrollY:0,letItGo:!1,preventClick:!1,translateX:0,translateY:0,touchID:0},this.pinch={startDistance:0,startScale:0,target:{X:0,Y:0},touchN:0,startTranslate:{X:0,Y:0}},this._scale=1,this.scaleDebouncer=0,this.frameBounds=null,this.debugger=null,this.btouchstartHandler=this.touchstartHandler.bind(this),this.btouchendHandler=this.touchendHandler.bind(this),this.btouchmoveHandler=this.touchmoveHandler.bind(this),this.bdblclickHandler=this.dblclickHandler.bind(this),this.bmousedownHandler=this.mousedownHandler.bind(this),this.bmouseupHandler=this.mouseupHandler.bind(this),this.bmousemoveHandler=this.mousemoveHandler.bind(this),this.moveFrame=0,this.manager=e,this.coordinator=new el,this.attachEvents(),t&&(this.debugger=new tl)}get scale(){return this._scale}set scale(e){isNaN(e)&&(e=1),window.clearTimeout(this.scaleDebouncer),this.scaleDebouncer=window.setTimeout(()=>{this.dragState===0&&this.scale<Yt&&(this.pan.translateX=0,this.pan.translateY=0,this.clearPan(),this.manager.updateBookStyle()),this.manager.listener("zoom",e)},100),this._scale=e}attachEvents(){this.observe(this.manager.spineElement),this.pan={startX:0,startY:0,endX:0,overscrollX:0,overscrollY:0,letItGo:!1,preventClick:!1,translateX:0,translateY:0,touchID:0},this.pinch={startDistance:0,startScale:0,target:{X:0,Y:0},startTranslate:{X:0,Y:0},touchN:0}}clearPan(){this.pan.letItGo=!1,this.pan.touchID=0,this.pan.endX=0,this.pan.overscrollX=0,this.pan.overscrollY=0}clearPinch(){this.pinch={startDistance:0,startScale:this.pinch.startScale,target:{X:0,Y:0},touchN:0,startTranslate:{X:0,Y:0}}}observe(e){e.addEventListener("touchstart",this.btouchstartHandler),e.addEventListener("touchend",this.btouchendHandler),e.addEventListener("touchmove",this.btouchmoveHandler,{passive:!0}),e.addEventListener("dblclick",this.bdblclickHandler,{passive:!0}),e.addEventListener("mousedown",this.bmousedownHandler),e.addEventListener("mouseup",this.bmouseupHandler),e.addEventListener("mousemove",this.bmousemoveHandler)}clickHandler(e){}touchstartHandler(e){if(["TEXTAREA","OPTION","INPUT","SELECT"].indexOf(e.target.nodeName)!==-1)return;switch(e.stopPropagation(),this.frameBounds=this.manager.currentBounds,this.coordinator.refreshOuterPixels(this.frameBounds),e.touches.length){case 3:return;case 2:{e.preventDefault(),this.pinch.startDistance=this.coordinator.getTouchDistance(e);const i=this.startTouch(e);this.pan.startX=i.X,this.pan.startY=i.Y,this.dragState=2,this.manager.updateBookStyle(!0),this.isScaled?(this.pinch.target.X-=this.pan.translateX*(this.pinch.startScale/this.scale),this.pinch.target.Y-=this.pan.translateY*(this.pinch.startScale/this.scale),this.pinch.target={X:0,Y:0},this.pinch.startScale=1/this.scale):(this.pinch.target={X:0,Y:0},this.pinch.startScale=this.scale),this.pinch.startTranslate={X:this.pan.translateX,Y:this.pan.translateY},this.debugger?.show&&(this.debugger.DOM.touch2.style.display="",this.debugger.DOM.center.style.display="",this.debugger.DOM.pinchTarget.style.display="");return}case 1:this.pan.touchID=e.touches[0].identifier,this.debugger?.show&&(this.debugger.DOM.touch1.style.display="");default:this.dragState<1&&(this.dragState=1),this.manager.updateBookStyle(!0)}this.manager.updateSpineStyle(!1);const t=this.startTouch(e);this.pan.startX=t.X,this.pan.startY=t.Y}startTouch(e){const t=this.coordinator.getTouchCenter(e)||this.coordinator.getBibiEventCoord(e);return{X:t.X-this.manager.width/2-this.pan.translateX*this.scale+this.manager.width/2,Y:t.Y-this.manager.height/2-this.pan.translateY*this.scale+this.manager.height/2}}touchendHandler(e){if(e.stopPropagation(),!e.touches||e.touches.length===0)this.pan.endX&&!this.isScaled?(this.pinch.touchN&&(this.pan.endX=this.pan.startX),this.updateAfterDrag()):!this.pinch.touchN&&Math.abs(this.pan.overscrollX)>Js&&Math.abs(this.pan.overscrollY)<Js/2&&(this.pan.startX=0,this.pan.endX=-this.pan.overscrollX,this.updateAfterDrag()),this.dragState=0,this.minimumMoved=!1,this.clearPinch(),this.debugger?.show&&(this.debugger.DOM.center.style.display="none",this.debugger.DOM.touch1.style.display="none",this.debugger.DOM.touch2.style.display="none");else if(e.touches.length===1){this.dragState=1,e.touches[0].identifier!==this.pan.touchID&&(this.pan.touchID=e.touches[0].identifier),this.debugger?.show&&(this.debugger.DOM.center.style.display="none",this.debugger.DOM.touch2.style.display="none",this.debugger.DOM.pinchTarget.style.display="none");const t=this.startTouch(e);this.pan.startX=t.X,this.pan.startY=t.Y}window.setTimeout(()=>{this.manager.updateBookStyle(!0),this.dragState===0&&(this.scale<Yt&&(this.pan.translateX=0,this.pan.translateY=0),this.clearPan()),this.manager.updateBookStyle(!0)},50)}touchmoveHandler(e){e.stopPropagation();const t=this.coordinator.getBibiEventCoord(e);Math.abs(this.pan.startY-t.Y)+Math.abs(this.pan.startX-t.X)>5&&(this.minimumMoved||(this.manager.deselect(),this.minimumMoved=!0),this.dragState<1&&(this.dragState=1));const i=this.coordinator?.getTouchDistance(e);let s=!1;const n=this.scale;if(this.dragState===2&&i){if(this.pinch.touchN++,this.pinch.touchN<4)return;let o=i/this.pinch.startDistance*this.scale;o>=qs&&(o=qs),o<=Yt&&(o=1),this.scale=o,this.pinch.startDistance=i,s=!0}if(this.pan.letItGo===!1&&(this.pan.letItGo=Math.abs(this.pan.startY-t.Y)<Math.abs(this.pan.startX-t.X)),this.debugger?.show&&(this.debugger.DOM.touch1.style.top=`${t.Y-10}px`,this.debugger.DOM.touch1.style.left=`${t.X-10}px`,this.debugger.DOM.touch1.innerText=`${t.X.toFixed(2)},${t.Y.toFixed(2)}`),this.dragState>0&&this.isScaled||this.dragState>1){if(this.dragState===1){const l={X:t.X-this.manager.width/2,Y:t.Y-this.manager.height/2};this.pan.translateX=(l.X-(this.pan.startX-this.manager.width/2))*1/this.scale,this.pan.translateY=(l.Y-(this.pan.startY-this.manager.height/2))*1/this.scale}else if(this.dragState===2){const l=this.coordinator.getTouchCenter(e);if(this.debugger?.show){this.debugger.DOM.center.style.top=`${l.Y-5}px`,this.debugger.DOM.center.style.left=`${l.X-5}px`,this.debugger.DOM.center.innerText=`${l.X.toFixed(2)},${l.Y.toFixed(2)}`;const g=this.coordinator.getBibiEventCoord(e,1);this.debugger.DOM.touch2.style.top=`${g.Y-10}px`,this.debugger.DOM.touch2.style.left=`${g.X-10}px`,this.debugger.DOM.touch2.innerText=`${g.X.toFixed(2)},${g.Y.toFixed(2)}`}l.X-=this.manager.width/2,l.Y-=this.manager.height/2;let h=-l.X/n;h+=l.X/this.scale,this.pinch.target.X+=h,l.X+=this.pinch.target.X*this.scale/this.pinch.startScale;let u=-l.Y/n;u+=l.Y/this.scale,this.pinch.target.Y+=u,l.Y+=this.pinch.target.Y*this.scale/this.pinch.startScale;let d=(l.X-(this.pan.startX-this.manager.width/2))*1/this.scale,p=(l.Y-(this.pan.startY-this.manager.height/2))*1/this.scale;this.pan.translateX=d,this.pan.translateY=p,this.debugger?.show&&(this.debugger.DOM.pinchTarget.style.left=`${this.pinch.target.X*this.scale/this.pinch.startScale-5+this.manager.width/2}px`,this.debugger.DOM.pinchTarget.style.top=`${this.pinch.target.Y*this.scale/this.pinch.startScale-5+this.manager.height/2}px`,this.debugger.DOM.pinchTarget.innerText=`${(this.pinch.target.X*this.scale/this.pinch.startScale).toFixed(2)},${(this.pinch.target.Y*this.scale/this.pinch.startScale).toFixed(2)}`)}const o=this.frameBounds.width/6,a=this.frameBounds.height/6;this.pan.translateX<-o&&(this.pan.overscrollX=-(o+this.pan.translateX),this.pan.translateX=-o),this.pan.translateY<-a&&(this.pan.overscrollY=-(a+this.pan.translateY),this.pan.translateY=-a),this.pan.translateX>o&&(this.pan.overscrollX=o-this.pan.translateX,this.pan.translateX=o),this.pan.translateY>a&&(this.pan.overscrollY=a-this.pan.translateY,this.pan.translateY=a),s=!0,this.debugger?.show&&(this.debugger.DOM.stats.innerText=`TX: ${this.pan.translateX.toFixed(2)}
TY: ${this.pan.translateY.toFixed(2)}
Zoom: ${this.scale.toFixed(2)}
Overscroll: ${this.pan.overscrollX.toFixed(2)},${this.pan.overscrollY.toFixed(2)}`)}if(s){this.manager.updateBookStyle();return}if(this.dragState>0&&this.pan.letItGo){this.pan.endX=t.X;const o=this.manager.currentSlide*(this.manager.width/this.manager.perPage),a=this.pan.endX-this.pan.startX,l=this.manager.rtl?o+a:o-a;cancelAnimationFrame(this.moveFrame),this.moveFrame=requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.manager.spineElement.style.transform=`translate3d(${(this.manager.rtl?1:-1)*l}px, 0, 0)`})})}}dblclickHandler(e){clearTimeout(this.dtimer),this.pdblclick=!0,this.dtimer=window.setTimeout(()=>this.pdblclick=!1,200),!this.disableDblClick&&this.isScaled&&(this.scale=1)}get isScaled(){return this.scale>1}addTouch(e){e.touches=[{pageX:e.pageX,pageY:e.pageY}]}mousedownHandler(e){this.isScaled&&(this.addTouch(e),this.touchstartHandler(e))}mouseupHandler(e){this.isScaled&&this.touchendHandler(e)}mousemoveHandler(e){this.isScaled&&e.buttons>0&&(e.preventDefault(),this.addTouch(e),this.touchmoveHandler(e))}updateAfterDrag(){const e=(this.manager.rtl?-1:1)*(this.pan.endX-this.pan.startX),t=Math.abs(e);e>0&&t>this.manager.threshold&&this.manager.slength>this.manager.perPage?this.manager.listener("no_less",void 0):e<0&&t>this.manager.threshold&&this.manager.slength>this.manager.perPage&&this.manager.listener("no_more",void 0),this.manager.slideToCurrent(!0,!0)}}var vi=(r=>(r.auto="auto",r.landscape="landscape",r.portrait="portrait",r))(vi||{}),wi=(r=>(r.auto="auto",r.both="both",r.none="none",r.landscape="landscape",r))(wi||{});class sl{constructor(e){this.shift=!0,this.spreads=[],this.nLandscape=0,this.index(e),this.testShift(e),console.log(`Indexed ${this.spreads.length} spreads for ${e.readingOrder.items.length} items`)}index(e,t=!1){this.nLandscape=0,e.readingOrder.items.forEach((i,s)=>{t||(e.readingOrder.items[s]=i.addProperties({number:s+1,isImage:i.type?.indexOf("image/")===0}));const n=i.properties?.otherProperties.orientation==="landscape";(!i.properties?.page||t)&&(i.properties=i.properties?.add({page:n?"center":((this.shift?0:1)+s-this.nLandscape)%2?e.metadata.readingProgression===I.rtl?"right":"left":e.metadata.readingProgression===I.rtl?"left":"right"})),(n||i.properties?.otherProperties.addBlank)&&this.nLandscape++}),t&&(this.spreads=[]),this.buildSpreads(e.readingOrder)}testShift(e){let t=!1;this.spreads.forEach((i,s)=>{if(i.length>1)return;const n=i[0],o=n.properties?.otherProperties.orientation;s===0&&(o==="landscape"||o!=="portrait"&&((n.width||0)>(n.height||0)||n.properties?.otherProperties.spread==="both"))&&(this.shift=!1),t&&n.properties?.page===le.center&&this.spreads[s-1][0].addProperties({addBlank:!0}),o==="portrait"&&n.properties?.page!=="center"&&n.properties?.otherProperties.number>1?t=!0:t=!1}),this.shift||this.index(e,!0)}buildSpreads(e){let t=[];e.items.forEach((i,s)=>{!s&&this.shift?this.spreads.push([i]):i.properties?.page===le.center?(t.length>0&&this.spreads.push(t),this.spreads.push([i]),t=[]):t.length>=2?(this.spreads.push(t),t=[i]):t.push(i)}),t.length>0&&this.spreads.push(t)}currentSpread(e,t){return this.spreads[Math.min(Math.floor(e/t),this.spreads.length-1)]}findByLink(e){return this.spreads.find(t=>t.includes(e))||void 0}}const Ks=8,Zs=5,rl=300,nl=15e3,ol=250,al=150,ll=500;class hl{constructor(e,t,i){if(this.pool=new Map,this.blobs=new Map,this.inprogress=new Map,this.delayedShow=new Map,this.delayedTimeout=new Map,this.previousFrames=[],this.width=0,this.height=0,this.transform="",this.currentSlide=0,this.spread=!0,this.orientationInternal=-1,this.container=e,this.positions=t,this.pub=i,this.spreadPresentation=i.metadata.otherMetadata?.spread||wi.auto,this.pub.metadata.effectiveReadingProgression!==I.rtl&&this.pub.metadata.effectiveReadingProgression!==I.ltr)throw Error("Unsupported reading progression for EPUB");this.spreader=new sl(this.pub),this.containerHeightCached=e.clientHeight,this.bookElement=document.createElement("div"),this.bookElement.ariaLabel="Book",this.bookElement.tabIndex=-1,this.updateBookStyle(!0),this.spineElement=document.createElement("div"),this.spineElement.ariaLabel="Spine",this.bookElement.appendChild(this.spineElement),this.container.appendChild(this.bookElement),this.updateSpineStyle(!0),this.peripherals=new il(this),this.pub.readingOrder.items.forEach(s=>{const n=new Qa(this.peripherals,this.pub.metadata.effectiveReadingProgression,s.href);this.spineElement.appendChild(n.element),this.pool.set(s.href,n),n.width=100/this.length*(s.properties?.otherProperties.orientation===vi.landscape||s.properties?.otherProperties.addBlank?this.perPage:1),n.height=this.height})}set listener(e){this._listener=e}get listener(){return this._listener}get doNotDisturb(){return this.peripherals.pan.touchID>0}resizeHandler(e=!0,t=!0){this.currentSlide+this.perPage>this.length&&(this.currentSlide=this.length<=this.perPage?0:this.length-1),this.containerHeightCached=this.container.clientHeight,this.orientationInternal=-1,this.updateSpineStyle(!0),e&&(this.currentSlide=this.reAlign(),this.slideToCurrent(!t,t)),clearTimeout(this.resizeTimeout),this.resizeTimeout=window.setTimeout(()=>{this.pool.forEach((i,s)=>{let n=this.pub.readingOrder.items.findIndex(l=>l.href===s);const o=this.pub.readingOrder.items[n];if(i.width=100/this.length*(o.properties?.otherProperties.orientation===vi.landscape||o.properties?.otherProperties.addBlank?this.perPage:1),i.height=this.height,!i.loaded)return;const a=this.spreader.findByLink(o);i.update(this.spreadPosition(a,o))})},ol)}updateDimensions(){this.width=this.bookElement.clientWidth,this.height=this.bookElement.clientHeight}get rtl(){return this.pub.metadata.effectiveReadingProgression===I.rtl}get single(){return!this.spread||this.portrait}get perPage(){return this.spread&&!this.portrait?2:1}get threshold(){return 50}get portrait(){return this.spreadPresentation===wi.none?!0:(this.orientationInternal===-1&&(this.orientationInternal=this.containerHeightCached>this.container.clientWidth?1:0),this.orientationInternal===1)}updateSpineStyle(e,t=!0){let i="0";this.updateDimensions(),this.perPage>1&&(i=`${this.width/2}px`);const s={transition:e?`all ${t?al:ll}ms ease-out`:"all 0ms ease-out",marginRight:this.rtl?i:"0",marginLeft:this.rtl?"0":i,width:`${this.width/this.perPage*this.length}px`,transform:this.transform,contain:"content"};Object.assign(this.spineElement.style,s)}updateBookStyle(e=!1){if(e){const t={overflow:"hidden",direction:this.pub.metadata.effectiveReadingProgression,cursor:"",height:"100%",width:"100%",position:"relative",outline:"none",transition:this.peripherals?.dragState?"none":"transform .15s ease-in-out",touchAction:"none"};Object.assign(this.bookElement.style,t)}this.bookElement.style.transform=`scale(${this.peripherals?.scale||1})`+(this.peripherals?` translate3d(${this.peripherals.pan.translateX}px, ${this.peripherals.pan.translateY}px, 0px)`:"")}goTo(e){if(this.slength<=this.perPage)return;e=this.reAlign(e);const t=this.currentSlide;this.currentSlide=Math.min(Math.max(e,0),this.length-1),t!==this.currentSlide&&this.slideToCurrent(!1)}onChange(){this.peripherals.scale=1,this.updateBookStyle()}get offset(){return(this.rtl?1:-1)*this.currentSlide*(this.width/this.perPage)}get length(){if(this.single)return this.slength;const e=this.slength+this.nLandscape;return this.shift&&e%2===0?e+1:e}get slength(){return this.pub.readingOrder.items.length||0}get shift(){return this.spreader.shift}get nLandscape(){return this.spreader.nLandscape}setPerPage(e){e===null?this.spread=!0:e===1?this.spread=!1:this.spread=!0,requestAnimationFrame(()=>this.resizeHandler(!0))}slideToCurrent(e,t=!0){if(this.updateDimensions(),e)requestAnimationFrame(()=>{requestAnimationFrame(()=>{const i=`translate3d(${this.offset}px, 0, 0)`;this.spineElement.style.transform!==i&&(this.transform=i,this.updateSpineStyle(!0,t),this.deselect())})});else{const i=`translate3d(${this.offset}px, 0, 0)`;if(this.spineElement.style.transform===i)return;this.transform=i,this.updateSpineStyle(!1),this.deselect()}}bounce(e=!1){requestAnimationFrame(()=>{this.transform=`translate3d(${this.offset+50*(e?1:-1)}px, 0, 0)`,this.updateSpineStyle(!0,!0),setTimeout(()=>{this.transform=`translate3d(${this.offset}px, 0, 0)`,this.updateSpineStyle(!0,!0)},100)})}next(e=1){if(this.slength<=this.perPage)return!1;const t=this.currentSlide;return this.currentSlide=Math.min(this.currentSlide+e,this.length-1),this.perPage>1&&this.currentSlide%2&&this.currentSlide--,this.currentSlide===t&&(this.currentSlide+1,this.length),t!==this.currentSlide?(this.slideToCurrent(!0),this.onChange(),!0):(this.bounce(this.rtl),!1)}prev(e=1){if(this.slength<=this.perPage)return!1;const t=this.currentSlide;return this.currentSlide=Math.max(this.currentSlide-e,0),this.perPage>1&&this.currentSlide%2&&this.currentSlide++,t!==this.currentSlide?(this.slideToCurrent(!0),this.onChange(),!0):(this.bounce(!this.rtl),!1)}get ownerWindow(){return this.container.ownerDocument.defaultView||window}async destroy(){let e=this.inprogress.values(),t=e.next();const i=[];for(;t.value;)i.push(t.value),t=e.next();i.length>0&&await Promise.allSettled(i),this.inprogress.clear();let s=this.pool.values(),n=s.next();for(;n.value;)await n.value.destroy(),n=s.next();this.pool.clear(),this.blobs.forEach(o=>URL.revokeObjectURL(o)),this.container.childNodes.forEach(o=>{(o.nodeType===Node.ELEMENT_NODE||o.nodeType===Node.TEXT_NODE)&&o.remove()})}makeSpread(e){return this.perPage<2?[this.pub.readingOrder.items[e]]:this.spreader.currentSpread(e,this.perPage)}reAlign(e=this.currentSlide){return e%2&&!this.single&&e++,e}spreadPosition(e,t){return this.perPage<2||e.length<2?le.center:t.href===e[0].href?this.rtl?le.right:le.left:this.rtl?le.left:le.right}async waitForItem(e){if(this.inprogress.has(e)&&await this.inprogress.get(e),this.delayedShow.has(e)){const t=this.delayedTimeout.get(e);t>0?clearTimeout(t):await this.delayedShow.get(e),this.delayedTimeout.set(e,0),this.delayedShow.delete(e)}}async cancelShowing(e){if(this.delayedShow.has(e)){const t=this.delayedTimeout.get(e);t>0&&clearTimeout(t),this.delayedShow.delete(e)}}async update(e,t,i,s=!1){let n=this.pub.readingOrder.items.findIndex(l=>l.href===t.href);if(n<0)throw Error("Href not found in reading order");this.currentSlide!==n&&(this.currentSlide=this.reAlign(n),this.slideToCurrent(!0));const o=this.makeSpread(this.currentSlide);this.perPage>1&&n++;for(const l of o)await this.waitForItem(l.href);const a=new Promise(async(l,h)=>{const u=[],d=[];this.positions.forEach((c,m)=>{(m>n+Ks||m<n-Ks)&&(u.includes(c.href)||u.push(c.href)),m<n+Zs&&m>n-Zs&&(d.includes(c.href)||d.push(c.href))}),u.forEach(async c=>{d.includes(c)||this.pool.has(c)&&(this.cancelShowing(c),await this.pool.get(c)?.unload())}),this.currentBaseURL!==void 0&&e.baseURL!==this.currentBaseURL&&(this.blobs.forEach(c=>URL.revokeObjectURL(c)),this.blobs.clear()),this.currentBaseURL=e.baseURL;const p=async c=>{const m=e.readingOrder.findIndexWithHref(c),b=e.readingOrder.items[m];if(b){if(!this.blobs.has(c)){const x=await new Pn(e,this.currentBaseURL||"",b).build(!0);this.blobs.set(c,x)}this.delayedShow.has(c)||this.delayedShow.set(c,new Promise((x,X)=>{let rt=!1;const Ut=window.setTimeout(async()=>{this.delayedTimeout.set(c,0);const Wt=this.makeSpread(this.reAlign(m)),Bt=this.spreadPosition(Wt,b),nt=this.pool.get(c);await nt.load(i,this.blobs.get(c)),this.peripherals.isScaled||await nt.show(Bt),this.delayedShow.delete(c),rt=!0,x()},rl);setTimeout(()=>{!rt&&this.delayedShow.has(c)&&X(`Offscreen load timeout: ${c}`)},nl),this.delayedTimeout.set(c,Ut)}))}};try{await Promise.all(d.map(c=>p(c)))}catch(c){h(c)}const g=[];for(const c of o){const m=this.pool.get(c.href),b=this.blobs.get(c.href);b&&(this.cancelShowing(c.href),await m.load(i,b),await m.show(this.spreadPosition(o,c)),this.previousFrames.push(m),await m.activate(),g.push(m))}for(;this.previousFrames.length>0;){const c=this.previousFrames.shift();c&&!g.includes(c)&&await c.unfocus()}this.previousFrames=g,l()});for(const l of o)this.inprogress.set(l.href,a);await a;for(const l of o)this.inprogress.delete(l.href)}get currentFrames(){if(this.perPage<2){const e=this.pub.readingOrder.items[this.currentSlide];return[this.pool.get(e.href)]}return this.spreader.currentSpread(this.currentSlide,this.perPage).map(e=>this.pool.get(e.href))}get currentBounds(){const e={x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0,toJSON(){return this}};return this.currentFrames.forEach(t=>{if(!t)return;const i=t.realSize;e.x=Math.min(e.x,i.x),e.y=Math.min(e.y,i.y),e.width+=i.width,e.height=Math.max(e.height,i.height),e.top=Math.min(e.top,i.top),e.right=Math.min(e.right,i.right),e.bottom=Math.min(e.bottom,i.bottom),e.left=Math.min(e.left,i.left)}),e}get viewport(){const e={readingOrder:[],progressions:new Map,positions:null};return this.spreader.currentSpread(this.currentSlide,this.perPage).forEach(t=>{e.readingOrder.push(t.href),e.progressions.set(t.href,{start:0,end:1})}),e.positions=this.getCurrentNumbers(),e}getCurrentNumbers(){if(this.perPage<2)return[this.pub.readingOrder.items[this.currentSlide].properties?.otherProperties.number];const e=this.spreader.currentSpread(this.currentSlide,this.perPage);return e.length>1?[e[0].properties?.otherProperties.number,e[e.length-1].properties?.otherProperties.number]:[e[0].properties?.otherProperties.number]}deselect(){this.currentFrames?.forEach(e=>e?.deselect())}}var Ze=(r=>(r.start="start",r.left="left",r.right="right",r.justify="justify",r))(Ze||{});const At={range:[.7,4],step:.05},_t={range:[100,1e3],step:100},Ot={range:[50,250],step:10};function cl(r,e){return r==null||e==null||r<=e?r:void 0}function dl(r,e){return r==null||e==null||r>=e?r:void 0}function B(r){return typeof r=="string"?r:r===null?null:void 0}function O(r){return typeof r=="boolean"||r==null?r:void 0}function Cn(r,e){if(r!==void 0)return r===null?null:e[r]!==void 0?r:void 0}function Fe(r){return typeof r=="boolean"||typeof r=="number"&&r>=0?r:r===null?null:void 0}function P(r){if(r!==void 0)return r===null?null:r<0?void 0:r}function De(r,e){if(r===void 0)return;if(r===null)return null;const t=Math.min(...e),i=Math.max(...e);return r>=t&&r<=i?r:void 0}function qt(r,e){return r===void 0?e:r}class Qe{constructor(e={}){this.backgroundColor=B(e.backgroundColor),this.blendFilter=O(e.blendFilter),this.constraint=P(e.constraint),this.columnCount=P(e.columnCount),this.darkenFilter=Fe(e.darkenFilter),this.deprecatedFontSize=O(e.deprecatedFontSize),this.fontFamily=B(e.fontFamily),this.fontSize=De(e.fontSize,At.range),this.fontSizeNormalize=O(e.fontSizeNormalize),this.fontOpticalSizing=O(e.fontOpticalSizing),this.fontWeight=De(e.fontWeight,_t.range),this.fontWidth=De(e.fontWidth,Ot.range),this.hyphens=O(e.hyphens),this.invertFilter=Fe(e.invertFilter),this.invertGaijiFilter=Fe(e.invertGaijiFilter),this.iOSPatch=O(e.iOSPatch),this.iPadOSPatch=O(e.iPadOSPatch),this.letterSpacing=P(e.letterSpacing),this.ligatures=O(e.ligatures),this.lineHeight=P(e.lineHeight),this.linkColor=B(e.linkColor),this.noRuby=O(e.noRuby),this.pageGutter=P(e.pageGutter),this.paragraphIndent=P(e.paragraphIndent),this.paragraphSpacing=P(e.paragraphSpacing),this.scroll=O(e.scroll),this.scrollPaddingTop=P(e.scrollPaddingTop),this.scrollPaddingBottom=P(e.scrollPaddingBottom),this.selectionBackgroundColor=B(e.selectionBackgroundColor),this.selectionTextColor=B(e.selectionTextColor),this.textAlign=Cn(e.textAlign,Ze),this.textColor=B(e.textColor),this.textNormalization=O(e.textNormalization),this.visitedColor=B(e.visitedColor),this.wordSpacing=P(e.wordSpacing),this.optimalLineLength=P(e.optimalLineLength),this.maximalLineLength=P(e.maximalLineLength),this.minimalLineLength=P(e.minimalLineLength)}static serialize(e){const{...t}=e;return JSON.stringify(t)}static deserialize(e){try{const t=JSON.parse(e);return new Qe(t)}catch(t){return console.error("Failed to deserialize preferences:",t),null}}merging(e){const t={...this};for(const i of Object.keys(e))e[i]!==void 0&&(i!=="maximalLineLength"||e[i]===null||e[i]>=(e.optimalLineLength??t.optimalLineLength??65))&&(i!=="minimalLineLength"||e[i]===null||e[i]<=(e.optimalLineLength??t.optimalLineLength??65))&&(t[i]=e[i]);return new Qe(t)}}class ul{constructor(e){this.backgroundColor=B(e.backgroundColor)||null,this.blendFilter=O(e.blendFilter)??!1,this.constraint=P(e.constraint)||0,this.columnCount=P(e.columnCount)||null,this.darkenFilter=Fe(e.darkenFilter)??!1,this.deprecatedFontSize=O(e.deprecatedFontSize),(this.deprecatedFontSize===!1||this.deprecatedFontSize===null)&&(this.deprecatedFontSize=!CSS.supports("zoom","1")),this.fontFamily=B(e.fontFamily)||null,this.fontSize=De(e.fontSize,At.range)||1,this.fontSizeNormalize=O(e.fontSizeNormalize)??!1,this.fontOpticalSizing=O(e.fontOpticalSizing)??null,this.fontWeight=De(e.fontWeight,_t.range)||null,this.fontWidth=De(e.fontWidth,Ot.range)||null,this.hyphens=O(e.hyphens)??null,this.invertFilter=Fe(e.invertFilter)??!1,this.invertGaijiFilter=Fe(e.invertGaijiFilter)??!1,this.iOSPatch=e.iOSPatch===!1?!1:(he.OS.iOS||he.OS.iPadOS)&&he.iOSRequest==="mobile",this.iPadOSPatch=e.iPadOSPatch===!1?!1:he.OS.iPadOS&&he.iOSRequest==="desktop",this.letterSpacing=P(e.letterSpacing)||null,this.ligatures=O(e.ligatures)??null,this.lineHeight=P(e.lineHeight)||null,this.linkColor=B(e.linkColor)||null,this.noRuby=O(e.noRuby)??!1,this.pageGutter=qt(P(e.pageGutter),20),this.paragraphIndent=P(e.paragraphIndent)??null,this.paragraphSpacing=P(e.paragraphSpacing)??null,this.scroll=O(e.scroll)??!1,this.scrollPaddingTop=P(e.scrollPaddingTop)??null,this.scrollPaddingBottom=P(e.scrollPaddingBottom)??null,this.selectionBackgroundColor=B(e.selectionBackgroundColor)||null,this.selectionTextColor=B(e.selectionTextColor)||null,this.textAlign=Cn(e.textAlign,Ze)||null,this.textColor=B(e.textColor)||null,this.textNormalization=O(e.textNormalization)??!1,this.visitedColor=B(e.visitedColor)||null,this.wordSpacing=P(e.wordSpacing)||null,this.optimalLineLength=P(e.optimalLineLength)||65,this.maximalLineLength=qt(dl(e.maximalLineLength,this.optimalLineLength),80),this.minimalLineLength=qt(cl(e.minimalLineLength,this.optimalLineLength),40)}}class F{constructor({initialValue:e=null,effectiveValue:t,isEffective:i,onChange:s}){this._value=e,this._effectiveValue=t,this._isEffective=i,this._onChange=s}set value(e){this._value=e,this._onChange(this._value)}get value(){return this._value}get effectiveValue(){return this._effectiveValue}get isEffective(){return this._isEffective}clear(){this._value=null}}let re=class extends F{set value(e){this._value=e,this._onChange(this._value)}get value(){return this._value}get effectiveValue(){return this._effectiveValue}get isEffective(){return this._isEffective}clear(){this._value=null}toggle(){this._value=!this._value,this._onChange(this._value)}};class pl extends F{constructor({initialValue:e=null,effectiveValue:t,isEffective:i,onChange:s,supportedValues:n}){super({initialValue:e,effectiveValue:t,isEffective:i,onChange:s}),this._supportedValues=n}set value(e){if(e&&!this._supportedValues.includes(e))throw new Error(`Value '${String(e)}' is not in the supported values for this preference.`);this._value=e,this._onChange(this._value)}get value(){return this._value}get effectiveValue(){return this._effectiveValue}get isEffective(){return this._isEffective}get supportedValues(){return this._supportedValues}clear(){this._value=null}}class U extends F{constructor({initialValue:e=null,effectiveValue:t,isEffective:i,onChange:s,supportedRange:n,step:o}){super({initialValue:e,effectiveValue:t,isEffective:i,onChange:s}),this._supportedRange=n,this._step=o,this._decimals=this._step.toString().includes(".")?this._step.toString().split(".")[1].length:0}set value(e){if(e&&(e<this._supportedRange[0]||e>this._supportedRange[1]))throw new Error(`Value '${String(e)}' is out of the supported range for this preference.`);this._value=e,this._onChange(this._value)}get value(){return this._value}get effectiveValue(){return this._effectiveValue}get isEffective(){return this._isEffective}get supportedRange(){return this._supportedRange}get step(){return this._step}increment(){this._value&&this._value<this._supportedRange[1]&&(this._value=Math.min(Math.round((this._value+this._step)*10**this._decimals)/10**this._decimals,this._supportedRange[1]),this._onChange(this._value))}decrement(){this._value&&this._value>this._supportedRange[0]&&(this._value=Math.max(Math.round((this._value-this._step)*10**this._decimals)/10**this._decimals,this._supportedRange[0]),this._onChange(this._value))}format(e){return e.toString()}clear(){this._value=null}}const ml="#FFFFFF",gl="#121212",fl="#0000EE",yl="#551A8B",vl="#b4d8fe",wl="inherit",Ce={RS__backgroundColor:ml,RS__textColor:gl,RS__linkColor:fl,RS__visitedColor:yl,RS__selectionBackgroundColor:vl,RS__selectionTextColor:wl};class Qs{constructor(e,t,i){this.preferences=e,this.settings=t,this.metadata=i,this.layout=this.metadata?.effectiveLayout||E.reflowable}clear(){this.preferences=new Qe({optimalLineLength:65})}updatePreference(e,t){this.preferences[e]=t}get backgroundColor(){return new F({initialValue:this.preferences.backgroundColor,effectiveValue:this.settings.backgroundColor||Ce.RS__backgroundColor,isEffective:this.preferences.backgroundColor!==null,onChange:e=>{this.updatePreference("backgroundColor",e||null)}})}get blendFilter(){return new re({initialValue:this.preferences.blendFilter,effectiveValue:this.settings.blendFilter||!1,isEffective:this.preferences.blendFilter!==null,onChange:e=>{this.updatePreference("blendFilter",e||null)}})}get columnCount(){return new F({initialValue:this.preferences.columnCount,effectiveValue:this.settings.columnCount||null,isEffective:this.layout!==E.fixed&&!this.settings.scroll,onChange:e=>{this.updatePreference("columnCount",e||null)}})}get constraint(){return new F({initialValue:this.preferences.constraint,effectiveValue:this.preferences.constraint||0,isEffective:!0,onChange:e=>{this.updatePreference("constraint",e||null)}})}get darkenFilter(){return new U({initialValue:typeof this.preferences.darkenFilter=="boolean"?100:this.preferences.darkenFilter,effectiveValue:typeof this.settings.darkenFilter=="boolean"?100:this.settings.darkenFilter||0,isEffective:this.settings.darkenFilter!==null,onChange:e=>{this.updatePreference("darkenFilter",e||null)},supportedRange:[0,100],step:1})}get deprecatedFontSize(){return new re({initialValue:this.preferences.deprecatedFontSize,effectiveValue:CSS.supports("zoom","1")?this.settings.deprecatedFontSize||!1:!0,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("deprecatedFontSize",e||null)}})}get fontFamily(){return new F({initialValue:this.preferences.fontFamily,effectiveValue:this.settings.fontFamily||null,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("fontFamily",e||null)}})}get fontSize(){return new U({initialValue:this.preferences.fontSize,effectiveValue:this.settings.fontSize||1,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("fontSize",e||null)},supportedRange:At.range,step:At.step})}get fontSizeNormalize(){return new re({initialValue:this.preferences.fontSizeNormalize,effectiveValue:this.settings.fontSizeNormalize||!1,isEffective:this.layout!==E.fixed&&this.preferences.fontSizeNormalize!==null,onChange:e=>{this.updatePreference("fontSizeNormalize",e||null)}})}get fontOpticalSizing(){return new re({initialValue:this.preferences.fontOpticalSizing,effectiveValue:this.settings.fontOpticalSizing||!0,isEffective:this.layout!==E.fixed&&this.preferences.fontOpticalSizing!==null,onChange:e=>{this.updatePreference("fontOpticalSizing",e||null)}})}get fontWeight(){return new U({initialValue:this.preferences.fontWeight,effectiveValue:this.settings.fontWeight||400,isEffective:this.layout!==E.fixed&&this.preferences.fontWeight!==null,onChange:e=>{this.updatePreference("fontWeight",e||null)},supportedRange:_t.range,step:_t.step})}get fontWidth(){return new U({initialValue:this.preferences.fontWidth,effectiveValue:this.settings.fontWidth||100,isEffective:this.layout!==E.fixed&&this.preferences.fontWidth!==null,onChange:e=>{this.updatePreference("fontWidth",e||null)},supportedRange:Ot.range,step:Ot.step})}get hyphens(){return new re({initialValue:this.preferences.hyphens,effectiveValue:this.settings.hyphens||!1,isEffective:this.layout!==E.fixed&&this.metadata?.effectiveReadingProgression===I.ltr&&this.preferences.hyphens!==null,onChange:e=>{this.updatePreference("hyphens",e||null)}})}get invertFilter(){return new U({initialValue:typeof this.preferences.invertFilter=="boolean"?100:this.preferences.invertFilter,effectiveValue:typeof this.settings.invertFilter=="boolean"?100:this.settings.invertFilter||0,isEffective:this.settings.invertFilter!==null,onChange:e=>{this.updatePreference("invertFilter",e||null)},supportedRange:[0,100],step:1})}get invertGaijiFilter(){return new U({initialValue:typeof this.preferences.invertGaijiFilter=="boolean"?100:this.preferences.invertGaijiFilter,effectiveValue:typeof this.settings.invertGaijiFilter=="boolean"?100:this.settings.invertGaijiFilter||0,isEffective:this.preferences.invertGaijiFilter!==null,onChange:e=>{this.updatePreference("invertGaijiFilter",e||null)},supportedRange:[0,100],step:1})}get iOSPatch(){return new re({initialValue:this.preferences.iOSPatch,effectiveValue:this.settings.iOSPatch||!1,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("iOSPatch",e||null)}})}get iPadOSPatch(){return new re({initialValue:this.preferences.iPadOSPatch,effectiveValue:this.settings.iPadOSPatch||!1,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("iPadOSPatch",e||null)}})}get letterSpacing(){return new U({initialValue:this.preferences.letterSpacing,effectiveValue:this.settings.letterSpacing||0,isEffective:this.layout!==E.fixed&&this.preferences.letterSpacing!==null,onChange:e=>{this.updatePreference("letterSpacing",e||null)},supportedRange:[0,1],step:.125})}get ligatures(){return new re({initialValue:this.preferences.ligatures,effectiveValue:this.settings.ligatures||!0,isEffective:this.layout!==E.fixed&&this.metadata?.languages?.some(e=>e==="ar"||e==="fa")&&this.preferences.ligatures!==null||!1,onChange:e=>{this.updatePreference("ligatures",e||null)}})}get lineHeight(){return new U({initialValue:this.preferences.lineHeight,effectiveValue:this.settings.lineHeight,isEffective:this.layout!==E.fixed&&this.preferences.lineHeight!==null,onChange:e=>{this.updatePreference("lineHeight",e||null)},supportedRange:[1,2],step:.1})}get linkColor(){return new F({initialValue:this.preferences.linkColor,effectiveValue:this.settings.linkColor||Ce.RS__linkColor,isEffective:this.layout!==E.fixed&&this.preferences.linkColor!==null,onChange:e=>{this.updatePreference("linkColor",e||null)}})}get maximalLineLength(){return new U({initialValue:this.preferences.maximalLineLength,effectiveValue:this.settings.maximalLineLength,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("maximalLineLength",e)},supportedRange:[20,100],step:1})}get minimalLineLength(){return new U({initialValue:this.preferences.minimalLineLength,effectiveValue:this.settings.minimalLineLength,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("minimalLineLength",e)},supportedRange:[20,100],step:1})}get noRuby(){return new re({initialValue:this.preferences.noRuby,effectiveValue:this.settings.noRuby||!1,isEffective:this.layout!==E.fixed&&this.metadata?.languages?.includes("ja")||!1,onChange:e=>{this.updatePreference("noRuby",e||null)}})}get optimalLineLength(){return new U({initialValue:this.preferences.optimalLineLength,effectiveValue:this.settings.optimalLineLength,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("optimalLineLength",e)},supportedRange:[20,100],step:1})}get pageGutter(){return new F({initialValue:this.preferences.pageGutter,effectiveValue:this.settings.pageGutter,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("pageGutter",e||null)}})}get paragraphIndent(){return new U({initialValue:this.preferences.paragraphIndent,effectiveValue:this.settings.paragraphIndent||0,isEffective:this.layout!==E.fixed&&this.preferences.paragraphIndent!==null,onChange:e=>{this.updatePreference("paragraphIndent",e||null)},supportedRange:[0,3],step:.25})}get paragraphSpacing(){return new U({initialValue:this.preferences.paragraphSpacing,effectiveValue:this.settings.paragraphSpacing||0,isEffective:this.layout!==E.fixed&&this.preferences.paragraphSpacing!==null,onChange:e=>{this.updatePreference("paragraphSpacing",e||null)},supportedRange:[0,3],step:.25})}get scroll(){return new re({initialValue:this.preferences.scroll,effectiveValue:this.settings.scroll||!1,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("scroll",e||null)}})}get scrollPaddingTop(){return new F({initialValue:this.preferences.scrollPaddingTop,effectiveValue:this.settings.scrollPaddingTop||0,isEffective:this.layout!==E.fixed&&!!this.settings.scroll&&this.preferences.scrollPaddingTop!==null,onChange:e=>{this.updatePreference("scrollPaddingTop",e||null)}})}get scrollPaddingBottom(){return new F({initialValue:this.preferences.scrollPaddingBottom,effectiveValue:this.settings.scrollPaddingBottom||0,isEffective:this.layout!==E.fixed&&!!this.settings.scroll&&this.preferences.scrollPaddingBottom!==null,onChange:e=>{this.updatePreference("scrollPaddingBottom",e||null)}})}get selectionBackgroundColor(){return new F({initialValue:this.preferences.selectionBackgroundColor,effectiveValue:this.settings.selectionBackgroundColor||Ce.RS__selectionBackgroundColor,isEffective:this.layout!==E.fixed&&this.preferences.selectionBackgroundColor!==null,onChange:e=>{this.updatePreference("selectionBackgroundColor",e||null)}})}get selectionTextColor(){return new F({initialValue:this.preferences.selectionTextColor,effectiveValue:this.settings.selectionTextColor||Ce.RS__selectionTextColor,isEffective:this.layout!==E.fixed&&this.preferences.selectionTextColor!==null,onChange:e=>{this.updatePreference("selectionTextColor",e||null)}})}get textAlign(){return new pl({initialValue:this.preferences.textAlign,effectiveValue:this.settings.textAlign||Ze.start,isEffective:this.layout!==E.fixed&&this.preferences.textAlign!==null,onChange:e=>{this.updatePreference("textAlign",e||null)},supportedValues:Object.values(Ze)})}get textColor(){return new F({initialValue:this.preferences.textColor,effectiveValue:this.settings.textColor||Ce.RS__textColor,isEffective:this.layout!==E.fixed&&this.preferences.textColor!==null,onChange:e=>{this.updatePreference("textColor",e||null)}})}get textNormalization(){return new re({initialValue:this.preferences.textNormalization,effectiveValue:this.settings.textNormalization||!1,isEffective:this.layout!==E.fixed,onChange:e=>{this.updatePreference("textNormalization",e||null)}})}get visitedColor(){return new F({initialValue:this.preferences.visitedColor,effectiveValue:this.settings.visitedColor||Ce.RS__visitedColor,isEffective:this.layout!==E.fixed&&this.preferences.visitedColor!==null,onChange:e=>{this.updatePreference("visitedColor",e||null)}})}get wordSpacing(){return new U({initialValue:this.preferences.wordSpacing,effectiveValue:this.settings.wordSpacing||0,isEffective:this.layout!==E.fixed&&this.preferences.wordSpacing!==null,onChange:e=>{this.updatePreference("wordSpacing",e||null)},supportedRange:[0,2],step:.125})}}class er{constructor(e,t){this.backgroundColor=e.backgroundColor||t.backgroundColor||null,this.blendFilter=typeof e.blendFilter=="boolean"?e.blendFilter:t.blendFilter??null,this.columnCount=e.columnCount!==void 0?e.columnCount:t.columnCount!==void 0?t.columnCount:null,this.constraint=e.constraint||t.constraint,this.darkenFilter=typeof e.darkenFilter=="boolean"?e.darkenFilter:t.darkenFilter??null,this.deprecatedFontSize=typeof e.deprecatedFontSize=="boolean"?e.deprecatedFontSize:t.deprecatedFontSize??null,this.fontFamily=e.fontFamily||t.fontFamily||null,this.fontSize=e.fontSize!==void 0?e.fontSize:t.fontSize!==void 0?t.fontSize:null,this.fontSizeNormalize=typeof e.fontSizeNormalize=="boolean"?e.fontSizeNormalize:t.fontSizeNormalize??null,this.fontOpticalSizing=typeof e.fontOpticalSizing=="boolean"?e.fontOpticalSizing:t.fontOpticalSizing??null,this.fontWeight=e.fontWeight!==void 0?e.fontWeight:t.fontWeight!==void 0?t.fontWeight:null,this.fontWidth=e.fontWidth!==void 0?e.fontWidth:t.fontWidth!==void 0?t.fontWidth:null,this.hyphens=typeof e.hyphens=="boolean"?e.hyphens:t.hyphens??null,this.invertFilter=typeof e.invertFilter=="boolean"?e.invertFilter:t.invertFilter??null,this.invertGaijiFilter=typeof e.invertGaijiFilter=="boolean"?e.invertGaijiFilter:t.invertGaijiFilter??null,this.iOSPatch=this.deprecatedFontSize||e.iOSPatch===!1?!1:e.iOSPatch===!0?(he.OS.iOS||he.OS.iPadOS)&&he.iOSRequest==="mobile":t.iOSPatch,this.iPadOSPatch=this.deprecatedFontSize||e.iPadOSPatch===!1?!1:e.iPadOSPatch===!0?he.OS.iPadOS&&he.iOSRequest==="desktop":t.iPadOSPatch,this.letterSpacing=e.letterSpacing!==void 0?e.letterSpacing:t.letterSpacing!==void 0?t.letterSpacing:null,this.ligatures=typeof e.ligatures=="boolean"?e.ligatures:t.ligatures??null,this.lineHeight=e.lineHeight!==void 0?e.lineHeight:t.lineHeight!==void 0?t.lineHeight:null,this.linkColor=e.linkColor||t.linkColor||null,this.maximalLineLength=e.maximalLineLength===null?null:e.maximalLineLength||t.maximalLineLength||null,this.minimalLineLength=e.minimalLineLength===null?null:e.minimalLineLength||t.minimalLineLength||null,this.noRuby=typeof e.noRuby=="boolean"?e.noRuby:t.noRuby??null,this.optimalLineLength=e.optimalLineLength||t.optimalLineLength,this.pageGutter=e.pageGutter!==void 0?e.pageGutter:t.pageGutter!==void 0?t.pageGutter:null,this.paragraphIndent=e.paragraphIndent!==void 0?e.paragraphIndent:t.paragraphIndent!==void 0?t.paragraphIndent:null,this.paragraphSpacing=e.paragraphSpacing!==void 0?e.paragraphSpacing:t.paragraphSpacing!==void 0?t.paragraphSpacing:null,this.scroll=typeof e.scroll=="boolean"?e.scroll:t.scroll??null,this.scrollPaddingTop=e.scrollPaddingTop!==void 0?e.scrollPaddingTop:t.scrollPaddingTop!==void 0?t.scrollPaddingTop:null,this.scrollPaddingBottom=e.scrollPaddingBottom!==void 0?e.scrollPaddingBottom:t.scrollPaddingBottom!==void 0?t.scrollPaddingBottom:null,this.selectionBackgroundColor=e.selectionBackgroundColor||t.selectionBackgroundColor||null,this.selectionTextColor=e.selectionTextColor||t.selectionTextColor||null,this.textAlign=e.textAlign||t.textAlign||null,this.textColor=e.textColor||t.textColor||null,this.textNormalization=typeof e.textNormalization=="boolean"?e.textNormalization:t.textNormalization??null,this.visitedColor=e.visitedColor||t.visitedColor||null,this.wordSpacing=e.wordSpacing!==void 0?e.wordSpacing:t.wordSpacing!==void 0?t.wordSpacing:null}}function bt(r){const e=getComputedStyle(r),t=parseFloat(e.paddingLeft||"0"),i=parseFloat(e.paddingRight||"0");return r.clientWidth-t-i}class An{constructor(){}toFlag(e){return`readium-${e}-on`}toUnitless(e){return e.toString()}toPercentage(e,t=!1){return t||e>0&&e<=1?`${Math.round(e*100)}%`:`${e}%`}toVw(e){const t=Math.round(e*100);return`${Math.min(t,100)}vw`}toVh(e){const t=Math.round(e*100);return`${Math.min(t,100)}vh`}toPx(e){return`${e}px`}toRem(e){return`${e}rem`}}class _n extends An{constructor(e){super(),this.a11yNormalize=e.a11yNormalize??null,this.backgroundColor=e.backgroundColor??null,this.blendFilter=e.blendFilter??null,this.bodyHyphens=e.bodyHyphens??null,this.colCount=e.colCount??null,this.darkenFilter=e.darkenFilter??null,this.deprecatedFontSize=e.deprecatedFontSize??null,this.fontFamily=e.fontFamily??null,this.fontOpticalSizing=e.fontOpticalSizing??null,this.fontSize=e.fontSize??null,this.fontSizeNormalize=e.fontSizeNormalize??null,this.fontWeight=e.fontWeight??null,this.fontWidth=e.fontWidth??null,this.invertFilter=e.invertFilter??null,this.invertGaijiFilter=e.invertGaijiFilter??null,this.iOSPatch=e.iOSPatch??null,this.iPadOSPatch=e.iPadOSPatch??null,this.letterSpacing=e.letterSpacing??null,this.ligatures=e.ligatures??null,this.lineHeight=e.lineHeight??null,this.lineLength=e.lineLength??null,this.linkColor=e.linkColor??null,this.noRuby=e.noRuby??null,this.paraIndent=e.paraIndent??null,this.paraSpacing=e.paraSpacing??null,this.selectionBackgroundColor=e.selectionBackgroundColor??null,this.selectionTextColor=e.selectionTextColor??null,this.textAlign=e.textAlign??null,this.textColor=e.textColor??null,this.view=e.view??null,this.visitedColor=e.visitedColor??null,this.wordSpacing=e.wordSpacing??null}toCSSProperties(){const e={};return this.a11yNormalize&&(e["--USER__a11yNormalize"]=this.toFlag("a11y")),this.backgroundColor&&(e["--USER__backgroundColor"]=this.backgroundColor),this.blendFilter&&(e["--USER__blendFilter"]=this.toFlag("blend")),this.bodyHyphens&&(e["--USER__bodyHyphens"]=this.bodyHyphens),this.colCount&&(e["--USER__colCount"]=this.toUnitless(this.colCount)),this.darkenFilter===!0?e["--USER__darkenFilter"]=this.toFlag("darken"):typeof this.darkenFilter=="number"&&(e["--USER__darkenFilter"]=this.toPercentage(this.darkenFilter)),this.deprecatedFontSize&&(e["--USER__fontSizeImplementation"]=this.toFlag("deprecatedFontSize")),this.fontFamily&&(e["--USER__fontFamily"]=this.fontFamily),this.fontOpticalSizing!=null&&(e["--USER__fontOpticalSizing"]=this.fontOpticalSizing),this.fontSize!=null&&(e["--USER__fontSize"]=this.toPercentage(this.fontSize,!0)),this.fontSizeNormalize&&(e["--USER__fontSizeNormalize"]=this.toFlag("normalize")),this.fontWeight!=null&&(e["--USER__fontWeight"]=this.toUnitless(this.fontWeight)),this.fontWidth!=null&&(e["--USER__fontWidth"]=typeof this.fontWidth=="string"?this.fontWidth:this.toUnitless(this.fontWidth)),this.invertFilter===!0?e["--USER__invertFilter"]=this.toFlag("invert"):typeof this.invertFilter=="number"&&(e["--USER__invertFilter"]=this.toPercentage(this.invertFilter)),this.invertGaijiFilter===!0?e["--USER__invertGaiji"]=this.toFlag("invertGaiji"):typeof this.invertGaijiFilter=="number"&&(e["--USER__invertGaiji"]=this.toPercentage(this.invertGaijiFilter)),this.iOSPatch&&(e["--USER__iOSPatch"]=this.toFlag("iOSPatch")),this.iPadOSPatch&&(e["--USER__iPadOSPatch"]=this.toFlag("iPadOSPatch")),this.letterSpacing!=null&&(e["--USER__letterSpacing"]=this.toRem(this.letterSpacing)),this.ligatures&&(e["--USER__ligatures"]=this.ligatures),this.lineHeight!=null&&(e["--USER__lineHeight"]=this.toUnitless(this.lineHeight)),this.lineLength!=null&&(e["--USER__lineLength"]=this.toPx(this.lineLength)),this.linkColor&&(e["--USER__linkColor"]=this.linkColor),this.noRuby&&(e["--USER__noRuby"]=this.toFlag("noRuby")),this.paraIndent!=null&&(e["--USER__paraIndent"]=this.toRem(this.paraIndent)),this.paraSpacing!=null&&(e["--USER__paraSpacing"]=this.toRem(this.paraSpacing)),this.selectionBackgroundColor&&(e["--USER__selectionBackgroundColor"]=this.selectionBackgroundColor),this.selectionTextColor&&(e["--USER__selectionTextColor"]=this.selectionTextColor),this.textAlign&&(e["--USER__textAlign"]=this.textAlign),this.textColor&&(e["--USER__textColor"]=this.textColor),this.view&&(e["--USER__view"]=this.toFlag(this.view)),this.visitedColor&&(e["--USER__visitedColor"]=this.visitedColor),this.wordSpacing!=null&&(e["--USER__wordSpacing"]=this.toRem(this.wordSpacing)),e}}class Sl extends An{constructor(e){super(),this.backgroundColor=e.backgroundColor??null,this.baseFontFamily=e.baseFontFamily??null,this.baseFontSize=e.baseFontSize??null,this.baseLineHeight=e.baseLineHeight??null,this.boxSizingMedia=e.boxSizingMedia??null,this.boxSizingTable=e.boxSizingTable??null,this.colWidth=e.colWidth??null,this.colCount=e.colCount??null,this.colGap=e.colGap??null,this.codeFontFamily=e.codeFontFamily??null,this.compFontFamily=e.compFontFamily??null,this.defaultLineLength=e.defaultLineLength??null,this.flowSpacing=e.flowSpacing??null,this.humanistTf=e.humanistTf??null,this.linkColor=e.linkColor??null,this.maxMediaWidth=e.maxMediaWidth??null,this.maxMediaHeight=e.maxMediaHeight??null,this.modernTf=e.modernTf??null,this.monospaceTf=e.monospaceTf??null,this.noOverflow=e.noOverflow??null,this.noVerticalPagination=e.noVerticalPagination??null,this.oldStyleTf=e.oldStyleTf??null,this.pageGutter=e.pageGutter??null,this.paraIndent=e.paraIndent??null,this.paraSpacing=e.paraSpacing??null,this.primaryColor=e.primaryColor??null,this.scrollPaddingBottom=e.scrollPaddingBottom??null,this.scrollPaddingTop=e.scrollPaddingTop??null,this.sansSerifJa=e.sansSerifJa??null,this.sansSerifJaV=e.sansSerifJaV??null,this.sansTf=e.sansTf??null,this.secondaryColor=e.secondaryColor??null,this.selectionBackgroundColor=e.selectionBackgroundColor??null,this.selectionTextColor=e.selectionTextColor??null,this.serifJa=e.serifJa??null,this.serifJaV=e.serifJaV??null,this.textColor=e.textColor??null,this.typeScale=e.typeScale??null,this.visitedColor=e.visitedColor??null}toCSSProperties(){const e={};return this.backgroundColor&&(e["--RS__backgroundColor"]=this.backgroundColor),this.baseFontFamily&&(e["--RS__baseFontFamily"]=this.baseFontFamily),this.baseFontSize!=null&&(e["--RS__baseFontSize"]=this.toRem(this.baseFontSize)),this.baseLineHeight!=null&&(e["--RS__baseLineHeight"]=this.toUnitless(this.baseLineHeight)),this.boxSizingMedia&&(e["--RS__boxSizingMedia"]=this.boxSizingMedia),this.boxSizingTable&&(e["--RS__boxSizingTable"]=this.boxSizingTable),this.colWidth!=null&&(e["--RS__colWidth"]=this.colWidth),this.colCount!=null&&(e["--RS__colCount"]=this.toUnitless(this.colCount)),this.colGap!=null&&(e["--RS__colGap"]=this.toPx(this.colGap)),this.codeFontFamily&&(e["--RS__codeFontFamily"]=this.codeFontFamily),this.compFontFamily&&(e["--RS__compFontFamily"]=this.compFontFamily),this.defaultLineLength!=null&&(e["--RS__defaultLineLength"]=this.toPx(this.defaultLineLength)),this.flowSpacing!=null&&(e["--RS__flowSpacing"]=this.toRem(this.flowSpacing)),this.humanistTf&&(e["--RS__humanistTf"]=this.humanistTf),this.linkColor&&(e["--RS__linkColor"]=this.linkColor),this.maxMediaWidth&&(e["--RS__maxMediaWidth"]=this.toVw(this.maxMediaWidth)),this.maxMediaHeight&&(e["--RS__maxMediaHeight"]=this.toVh(this.maxMediaHeight)),this.modernTf&&(e["--RS__modernTf"]=this.modernTf),this.monospaceTf&&(e["--RS__monospaceTf"]=this.monospaceTf),this.noOverflow&&(e["--RS__disableOverflow"]=this.toFlag("noOverflow")),this.noVerticalPagination&&(e["--RS__disablePagination"]=this.toFlag("noVerticalPagination")),this.oldStyleTf&&(e["--RS__oldStyleTf"]=this.oldStyleTf),this.pageGutter!=null&&(e["--RS__pageGutter"]=this.toPx(this.pageGutter)),this.paraIndent!=null&&(e["--RS__paraIndent"]=this.toRem(this.paraIndent)),this.paraSpacing!=null&&(e["--RS__paraSpacing"]=this.toRem(this.paraSpacing)),this.primaryColor&&(e["--RS__primaryColor"]=this.primaryColor),this.sansSerifJa&&(e["--RS__sans-serif-ja"]=this.sansSerifJa),this.sansSerifJaV&&(e["--RS__sans-serif-ja-v"]=this.sansSerifJaV),this.sansTf&&(e["--RS__sansTf"]=this.sansTf),this.scrollPaddingBottom!=null&&(e["--RS__scrollPaddingBottom"]=this.toPx(this.scrollPaddingBottom)),this.scrollPaddingTop!=null&&(e["--RS__scrollPaddingTop"]=this.toPx(this.scrollPaddingTop)),this.secondaryColor&&(e["--RS__secondaryColor"]=this.secondaryColor),this.selectionBackgroundColor&&(e["--RS__selectionBackgroundColor"]=this.selectionBackgroundColor),this.selectionTextColor&&(e["--RS__selectionTextColor"]=this.selectionTextColor),this.serifJa&&(e["--RS__serif-ja"]=this.serifJa),this.serifJaV&&(e["--RS__serif-ja-v"]=this.serifJaV),this.textColor&&(e["--RS__textColor"]=this.textColor),this.typeScale&&(e["--RS__typeScale"]=this.toUnitless(this.typeScale)),this.visitedColor&&(e["--RS__visitedColor"]=this.visitedColor),e}}class bl{constructor(e){this.rsProperties=e.rsProperties,this.userProperties=e.userProperties,this.lineLengths=e.lineLengths,this.container=e.container,this.containerParent=e.container.parentElement||document.documentElement,this.constraint=e.constraint,this.cachedColCount=e.userProperties.colCount,this.effectiveContainerWidth=bt(this.containerParent)}update(e){this.cachedColCount=e.columnCount,e.constraint!==this.constraint&&(this.constraint=e.constraint),e.pageGutter!==this.rsProperties.pageGutter&&(this.rsProperties.pageGutter=e.pageGutter),e.scrollPaddingBottom!==this.rsProperties.scrollPaddingBottom&&(this.rsProperties.scrollPaddingBottom=e.scrollPaddingBottom),e.scrollPaddingTop!==this.rsProperties.scrollPaddingTop&&(this.rsProperties.scrollPaddingTop=e.scrollPaddingTop),this.lineLengths.update({fontFace:e.fontFamily,letterSpacing:e.letterSpacing,pageGutter:e.pageGutter,wordSpacing:e.wordSpacing,optimalChars:e.optimalLineLength,minChars:e.minimalLineLength,maxChars:e.maximalLineLength});const t=this.updateLayout(e.fontSize,e.deprecatedFontSize||e.iOSPatch,e.scroll,e.columnCount);t?.effectiveContainerWidth&&(this.effectiveContainerWidth=t?.effectiveContainerWidth);const i={a11yNormalize:e.textNormalization,backgroundColor:e.backgroundColor,blendFilter:e.blendFilter,bodyHyphens:typeof e.hyphens!="boolean"?null:e.hyphens?"auto":"none",colCount:t?.colCount,darkenFilter:e.darkenFilter,deprecatedFontSize:e.deprecatedFontSize,fontFamily:e.fontFamily,fontOpticalSizing:typeof e.fontOpticalSizing!="boolean"?null:e.fontOpticalSizing?"auto":"none",fontSize:e.fontSize,fontSizeNormalize:e.fontSizeNormalize,fontWeight:e.fontWeight,fontWidth:e.fontWidth,invertFilter:e.invertFilter,invertGaijiFilter:e.invertGaijiFilter,iOSPatch:e.iOSPatch,iPadOSPatch:e.iPadOSPatch,letterSpacing:e.letterSpacing,ligatures:typeof e.ligatures!="boolean"?null:e.ligatures?"common-ligatures":"none",lineHeight:e.lineHeight,lineLength:t?.effectiveLineLength,linkColor:e.linkColor,noRuby:e.noRuby,paraIndent:e.paragraphIndent,paraSpacing:e.paragraphSpacing,selectionBackgroundColor:e.selectionBackgroundColor,selectionTextColor:e.selectionTextColor,textAlign:e.textAlign,textColor:e.textColor,view:typeof e.scroll!="boolean"?null:e.scroll?"scroll":"paged",visitedColor:e.visitedColor,wordSpacing:e.wordSpacing};this.userProperties=new _n(i)}updateLayout(e,t,i,s){return i??this.userProperties.view==="scroll"?this.computeScrollLength(e,t):this.paginate(e,t,s)}getCompensatedMetrics(e,t){const i=e||this.userProperties.fontSize||1,s=i<1?1/i:t?i:1;return{zoomFactor:i,zoomCompensation:s,optimal:Math.round(this.lineLengths.optimalLineLength)*i,minimal:this.lineLengths.minimalLineLength!==null?Math.round(this.lineLengths.minimalLineLength*i):null,maximal:this.lineLengths.maximalLineLength!==null?Math.round(this.lineLengths.maximalLineLength*i):null}}paginate(e,t,i){const s=Math.round(bt(this.containerParent)-this.constraint),n=this.getCompensatedMetrics(e,t),{zoomCompensation:o,optimal:a,minimal:l,maximal:h}=n,u=()=>s>=a&&h!==null?Math.min(Math.round(h*o),s):s;let d=1,p=s;if(i===void 0)return{colCount:void 0,effectiveContainerWidth:p,effectiveLineLength:Math.round(p/d*o)};if(i===null)if(s>=a&&h!==null){d=Math.floor(s/a);const g=Math.round(d*(h*o));p=Math.min(g,s)}else p=u();else if(i>1){const g=Math.round(i*(l!==null?l:a));if(s>=g)if(d=i,h===null)p=s;else{const c=Math.round(d*(h*o));p=Math.min(c,s)}else if(l!==null&&s<Math.round(i*l))if(d=Math.floor(s/l),d<=1)d=1,p=u();else{const c=Math.round(d*(a*o));p=Math.min(c,s)}else{d=i;const c=Math.round(d*(a*o));p=Math.min(c,s)}}else d=1,p=u();return{colCount:d,effectiveContainerWidth:p,effectiveLineLength:Math.round(p/d/(e&&e>=1?e:1)*o)}}computeScrollLength(e,t){const i=Math.round(bt(this.containerParent)-this.constraint),s=this.getCompensatedMetrics(e&&(e<1||t)?e:1,t),n=s.zoomCompensation,o=s.optimal,a=s.maximal;let l,h=i,u=Math.round(o*n);if(a===null)u=i;else{const d=Math.min(Math.round(a*n),i);u=t?d:Math.round(d*n)}return{colCount:l,effectiveContainerWidth:h,effectiveLineLength:u}}setContainerWidth(){this.container.style.width=`${this.effectiveContainerWidth}px`}resizeHandler(){const e=this.updateLayout(this.userProperties.fontSize,this.userProperties.deprecatedFontSize||this.userProperties.iOSPatch,this.userProperties.view==="scroll",this.cachedColCount);this.userProperties.colCount=e.colCount,this.userProperties.lineLength=e.effectiveLineLength,this.effectiveContainerWidth=e.effectiveContainerWidth,this.container.style.width=`${this.effectiveContainerWidth}px`}}const El=r=>({frameLoaded:r.frameLoaded||(()=>{}),positionChanged:r.positionChanged||(()=>{}),tap:r.tap||(()=>!1),click:r.click||(()=>!1),zoom:r.zoom||(()=>{}),miscPointer:r.miscPointer||(()=>{}),scroll:r.scroll||(()=>{}),customEvent:r.customEvent||(()=>{}),handleLocator:r.handleLocator||(()=>!1),textSelected:r.textSelected||(()=>{})});class Wi extends Yo{constructor(e,t,i,s=[],n=void 0,o={preferences:{},defaults:{}}){super(),this._preferencesEditor=null,this.reflowViewport={readingOrder:[],progressions:new Map,positions:null},this.pub=t,this.container=e,this.listeners=El(i),this.currentLocation=n,s.length&&(this.positions=s),this._preferences=new Qe(o.preferences),this._defaults=new ul(o.defaults),this._settings=new er(this._preferences,this._defaults),this._css=new bl({rsProperties:new Sl({}),userProperties:new _n({}),lineLengths:new $a({optimalChars:this._settings.optimalLineLength,minChars:this._settings.minimalLineLength,maxChars:this._settings.maximalLineLength,pageGutter:this._settings.pageGutter,fontFace:this._settings.fontFamily,letterSpacing:this._settings.letterSpacing,wordSpacing:this._settings.wordSpacing}),container:e,constraint:this._settings.constraint}),this._layout=Wi.determineLayout(t,!!this._settings.scroll),this.currentProgression=t.metadata.effectiveReadingProgression,this.resizeObserver=new ResizeObserver(()=>this.ownerWindow.requestAnimationFrame(async()=>await this.resizeHandler())),this.resizeObserver.observe(this.container.parentElement||document.documentElement)}static determineLayout(e,t){const i=e.metadata.effectiveLayout;return i===E.fixed||e.metadata.otherMetadata&&"http://openmangaformat.org/schema/1.0#version"in e.metadata.otherMetadata||e.metadata?.conformsTo?.includes(Br.DIVINA)?E.fixed:i===E.scrolled||i===E.reflowable&&t?E.scrolled:E.reflowable}async load(){if(this.positions?.length||(this.positions=await this.pub.positionsFromManifest()),this._layout===E.fixed)this.framePool=new hl(this.container,this.positions,this.pub),this.framePool.listener=(e,t)=>{this.eventListener(e,t)};else{await this.updateCSS(!1);const e=this.compileCSSProperties(this._css);this.framePool=new Za(this.container,this.positions,e)}this.currentLocation===void 0&&(this.currentLocation=this.positions[0]),await this.resizeHandler(),await this.apply()}get settings(){if(this._layout===E.fixed)return Object.freeze({...this._settings});{const e=this._css.userProperties.colCount||this._css.rsProperties.colCount||this._settings.columnCount;return Object.freeze({...this._settings,columnCount:e})}}get preferencesEditor(){return this._preferencesEditor===null&&(this._preferencesEditor=new Qs(this._preferences,this.settings,this.pub.metadata)),this._preferencesEditor}async submitPreferences(e){this._preferences=this._preferences.merging(e),await this.applyPreferences()}async applyPreferences(){const e=this._settings;this._settings=new er(this._preferences,this._defaults),this._preferencesEditor!==null&&(this._preferencesEditor=new Qs(this._preferences,this.settings,this.pub.metadata)),this._layout===E.fixed?this.handleFXLPrefs(e,this._settings):await this.updateCSS(!0)}handleFXLPrefs(e,t){e.columnCount!==t.columnCount&&this.framePool.setPerPage(t.columnCount)}async updateCSS(e){this._css.update(this._settings),e&&await this.commitCSS(this._css)}compileCSSProperties(e){const t={};for(const[i,s]of Object.entries(e.rsProperties.toCSSProperties()))t[i]=s;for(const[i,s]of Object.entries(e.userProperties.toCSSProperties()))t[i]=s;return t}async commitCSS(e){const t=this.compileCSSProperties(e);this.framePool.setCSSProperties(t),this._css.userProperties.view==="paged"&&this._layout===E.scrolled?await this.setLayout(E.reflowable):this._css.userProperties.view==="scroll"&&this._layout===E.reflowable&&await this.setLayout(E.scrolled),this._css.setContainerWidth()}async resizeHandler(){const e=this.container.parentElement||document.documentElement;if(this._layout===E.fixed)this.container.style.width=`${bt(e)-this._settings.constraint}px`,this.framePool.resizeHandler();else{const t=this._css.userProperties.colCount,i=this._css.userProperties.lineLength;this._css.resizeHandler(),(this._css.userProperties.view!=="scroll"&&t!==this._css.userProperties.colCount||i!==this._css.userProperties.lineLength)&&await this.commitCSS(this._css)}}get layout(){return this._layout}get ownerWindow(){return this.container.ownerDocument.defaultView||window}get _cframes(){return this.framePool.currentFrames}get pool(){return this.framePool}eventListener(e,t){switch(e){case"_pong":this.listeners.frameLoaded(this._cframes[0].iframe.contentWindow),this.listeners.positionChanged(this.currentLocation);break;case"first_visible_locator":const i=oi.deserialize(t);if(!i)break;this.currentLocation=new oi({href:this.currentLocation.href,type:this.currentLocation.type,title:this.currentLocation.title,locations:i?.locations,text:i?.text}),this.listeners.positionChanged(this.currentLocation);break;case"text_selected":this.listeners.textSelected(t);break;case"click":case"tap":const s=t;if(s.interactiveElement){const n=new DOMParser().parseFromString(s.interactiveElement,"text/html").body.children[0];if(n.nodeType===n.ELEMENT_NODE&&n.nodeName==="A"&&n.hasAttribute("href")){const o=n.attributes.getNamedItem("href")?.value;if(o.startsWith("#"))this.go(this.currentLocation.copyWithLocations({fragments:[o.substring(1)]}),!1,()=>{});else if(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("mailto:")||o.startsWith("tel:"))this.listeners.handleLocator(new Ye({href:o}).locator);else try{this.goLink(new Ye({href:Gs.join(Gs.dirname(this.currentLocation.href),o)}),!1,()=>{})}catch(a){console.warn(`Couldn't go to link for ${o}: ${a}`),this.listeners.handleLocator(new Ye({href:o}).locator)}}else console.log("Clicked on",n)}else{if(this._layout===E.fixed&&this.framePool.doNotDisturb&&(s.doNotDisturb=!0),this._layout===E.fixed&&(this.currentProgression===I.rtl||this.currentProgression===I.ltr)&&this.framePool.currentFrames.length>1){const o=this.framePool.currentFrames;s.targetFrameSrc===o[this.currentProgression===I.rtl?0:1]?.source&&(s.x+=(o[this.currentProgression===I.rtl?1:0]?.iframe.contentWindow?.innerWidth??0)*window.devicePixelRatio)}if(e==="click"?this.listeners.click(s):this.listeners.tap(s))break;const n=(this._cframes.length===2?this._cframes[0].window.innerWidth+this._cframes[1].window.innerWidth:this._cframes[0].window.innerWidth)*window.devicePixelRatio/4;s.x>=n&&s.x<=n*3&&this.listeners.miscPointer(1),s.x<n?this.goLeft(!1,()=>{}):s.x>n*3&&this.goRight(!1,()=>{})}break;case"tap_more":this.listeners.miscPointer(t);break;case"no_more":this.changeResource(1);break;case"no_less":this.changeResource(-1);break;case"swipe":break;case"scroll":this.listeners.scroll(t);break;case"zoom":this.listeners.zoom(t);break;case"progress":this.syncLocation(t);break;case"log":console.log(this._cframes[0]?.source?.split("/")[3],...t);break;default:this.listeners.customEvent(e,t);break}}determineModules(){let e=Array.from(fi.keys());return this._layout===E.fixed?e.filter(t=>ka.includes(t)):(e=e.filter(t=>Fa.includes(t)),this._layout===E.scrolled?e=e.filter(t=>t!=="column_snapper"):e=e.filter(t=>t!=="scroll_snapper"),e)}attachListener(){const e=this._cframes.filter(t=>!!t);if(e.length===0)throw Error("no cframe to attach listener to");e.forEach(t=>{t.msg&&(t.msg.listener=(i,s)=>{this.eventListener(i,s)})})}async apply(){if(await this.framePool.update(this.pub,this.currentLocator,this.determineModules()),this.attachListener(),this.pub.readingOrder.findIndexWithHref(this.currentLocation.href)<0)throw Error("Link for "+this.currentLocation.href+" not found!")}async destroy(){await this.framePool?.destroy()}async changeResource(e){if(e===0)return!1;if(this._layout===E.fixed){const s=this.framePool,n=s.viewport.positions[0];if(e===1){if(!s.next(s.perPage))return!1}else if(e===-1){if(!s.prev(s.perPage))return!1}else throw Error("Invalid relative value for FXL");const o=s.viewport.positions[0];if(n>o){for(let a=this.positions.length-1;a>=0;a--)if(this.positions[a].href===this.pub.readingOrder.items[o-1].href){this.currentLocation=this.positions[a].copyWithLocations({progression:.999999999999});break}}else if(n<o){for(let a=0;a<this.positions.length;a++)if(this.positions[a].href===this.pub.readingOrder.items[o-1].href){this.currentLocation=this.positions[a];break}}return await this.apply(),!0}const t=this.pub.readingOrder.findIndexWithHref(this.currentLocation.href),i=Math.max(0,Math.min(this.pub.readingOrder.items.length-1,t+e));if(i===t)return this._cframes[0]?.msg?.send("shake",void 0,async s=>{}),!1;if(t>i){for(let s=this.positions.length-1;s>=0;s--)if(this.positions[s].href===this.pub.readingOrder.items[i].href){this.currentLocation=this.positions[s].copyWithLocations({progression:.999999999999});break}}else for(let s=0;s<this.positions.length;s++)if(this.positions[s].href===this.pub.readingOrder.items[i].href){this.currentLocation=this.positions[s];break}return await this.apply(),!0}findLastPositionInProgressionRange(e,t){const i=e.findLastIndex(s=>{const n=s.locations.progression;return!!(n&&n>t.start&&n<=t.end)});return i!==-1?e[i]:void 0}findNearestPositions(e){const t=this.positions.filter(n=>n.href===this.currentLocation.href);let i=this.currentLocation,s;return t.some((n,o)=>{const a=n.locations.progression??0;if(e.start<=a){i=n;const l=t.splice(o+1,t.length);return s=this.findLastPositionInProgressionRange(l,e),!0}else return!1}),{first:i,last:s}}updateViewport(e){this.reflowViewport.readingOrder=[],this.reflowViewport.progressions.clear(),this.reflowViewport.positions=null,this.currentLocation&&(this.reflowViewport.readingOrder.push(this.currentLocation.href),this.reflowViewport.progressions.set(this.currentLocation.href,e),this.currentLocation.locations?.position!==void 0&&(this.reflowViewport.positions=[this.currentLocation.locations.position],this.lastLocationInView?.locations?.position!==void 0&&this.reflowViewport.positions.push(this.lastLocationInView.locations.position)))}async syncLocation(e){const t=e,i=this.findNearestPositions(t);this.currentLocation=i.first.copyWithLocations({progression:t.start}),this.lastLocationInView=i.last,this.updateViewport(t),this.listeners.positionChanged(this.currentLocation),await this.framePool.update(this.pub,this.currentLocation,this.determineModules())}goBackward(e,t){this._layout===E.fixed?(this.changeResource(-1),t(!0)):this._cframes[0]?.msg?.send("go_prev",void 0,async i=>{t(i?!0:await this.changeResource(-1))})}goForward(e,t){this._layout===E.fixed?(this.changeResource(1),t(!0)):this._cframes[0]?.msg?.send("go_next",void 0,async i=>{t(i?!0:await this.changeResource(1))})}get currentLocator(){return this.currentLocation}get viewport(){return this._layout===E.fixed?this.framePool.viewport:this.reflowViewport}get isScrollStart(){const e=this.viewport.readingOrder[0];return this.viewport.progressions.get(e)?.start===0}get isScrollEnd(){const e=this.viewport.readingOrder[this.viewport.readingOrder.length-1];return this.viewport.progressions.get(e)?.end===1}get canGoBackward(){const e=this.pub.readingOrder.items[0]?.href;return!(this.viewport.progressions.has(e)&&this.viewport.progressions.get(e)?.start===0)}get canGoForward(){const e=this.pub.readingOrder.items[this.pub.readingOrder.items.length-1]?.href;return!(this.viewport.progressions.has(e)&&this.viewport.progressions.get(e)?.end===1)}get readingProgression(){return this.currentProgression}async setLayout(e){this._layout!==e&&(this._layout=e,await this.framePool.update(this.pub,this.currentLocator,this.determineModules(),!0),this.attachListener())}get publication(){return this.pub}async loadLocator(e,t){let i=!1,s=typeof e.locations.getCssSelector=="function"&&e.locations.getCssSelector();if(e.text?.highlight?i=await new Promise((a,l)=>{this._cframes[0].msg.send("go_text",s?[e.text?.serialize(),s]:e.text?.serialize(),h=>a(h))}):s&&(i=await new Promise((a,l)=>{this._cframes[0].msg.send("go_text",["",s],h=>a(h))})),i){t(i);return}const n=typeof e.locations.htmlId=="function"&&e.locations.htmlId();if(n&&(i=await new Promise((a,l)=>{this._cframes[0].msg.send("go_id",n,h=>a(h))})),i){t(i);return}const o=e?.locations?.progression;o&&o>0?i=await new Promise((a,l)=>{this._cframes[0].msg.send("go_progression",o,h=>a(h))}):i=!0,t(i)}go(e,t,i){const s=e.href.split("#")[0];let n=this.pub.readingOrder.findWithHref(s);if(!n)return i(this.listeners.handleLocator(e));this.currentLocation=this.positions.find(o=>o.href===n.href),this.apply().then(()=>this.loadLocator(e,o=>i(o))).then(()=>{this.attachListener()})}goLink(e,t,i){return this.go(e.locator,t,i)}}class xl{close(){}links(){return[]}get(e){throw Error("This is an empty fetcher")}}class Tl{constructor(e,t){this.client=e||window.fetch.bind(window),this.baseUrl=t}links(){return[]}get(e){const t=e.toURL(this.baseUrl);if(t===void 0)throw Error(`Invalid HREF: ${e.href}`);return new Pl(this.client,e,t)}close(){}}class Pl{constructor(e,t,i){this.client=e||window.fetch.bind(window),this._link=t,this.url=i}async headResponse(){if(this._headResponse)return this._headResponse;const e=await this.client(this.url,{method:"HEAD"});if(!e.ok)throw new Error(`http HEAD request for ${this.url} failed with HTTP status code ${e.status}`);return this._headResponse=e,e}close(){}async link(){return this._link}async read(e){if(e)throw new Error("http read range not implemented!");const t=await this.client(this.url);if(!t.ok)throw new Error(`http GET request for ${this.url} failed with HTTP status code ${t.status}`);return new Uint8Array(await t.arrayBuffer())}async length(){const e=(await this.headResponse()).headers.get("content-length");if(e===null||e==="")throw new Error("length for resource unavailable");return parseInt(e)}async readAsJSON(){const e=await this.client(this.url);if(!e.ok)throw new Error(`http GET request for ${this.url} failed with HTTP status code ${e.status}`);return await e.json()}async readAsString(){const e=await this.client(this.url);if(!e.ok)throw new Error(`http GET request for ${this.url} failed with HTTP status code ${e.status}`);return await e.text()}async readAsXML(){const e=await this.client(this.url);if(!e.ok)throw new Error(`http GET request for ${this.url} failed with HTTP status code ${e.status}`);return new DOMParser().parseFromString(await e.text(),"application/xml")}}class Bi{constructor(e={}){this.conformsTo=e.conformsTo??[],this.certification=e.certification??null,this.summary=e.summary??null,this.accessMode=e.accessMode??[],this.accessModeSufficient=e.accessModeSufficient??[],this.feature=e.feature??[],this.hazard=e.hazard??[],this.exemption=e.exemption??[]}static deserialize(e){if(!e||typeof e!="object")return;const t=e;return new Bi({conformsTo:t.conformsTo?t.conformsTo.map(i=>Cl.deserialize(i)).filter(i=>i!==void 0):void 0,certification:t.certification?$i.deserialize(t.certification):void 0,summary:t.summary,accessMode:t.accessMode?t.accessMode.map(i=>Al.deserialize(i)).filter(i=>i!==void 0):void 0,accessModeSufficient:t.accessModeSufficient?t.accessModeSufficient.map(i=>_l.deserialize(i)).filter(i=>i!==void 0):void 0,feature:t.feature?t.feature.map(i=>Ol.deserialize(i)).filter(i=>i!==void 0):void 0,hazard:t.hazard?t.hazard.map(i=>Rl.deserialize(i)).filter(i=>i!==void 0):void 0,exemption:t.exemption?t.exemption.map(i=>Ll.deserialize(i)).filter(i=>i!==void 0):void 0})}serialize(){const e={};return this.conformsTo?.length>0&&(e.conformsTo=this.conformsTo.map(t=>t.serialize())),this.certification!==void 0&&this.certification!==null&&(e.certification=this.certification.serialize()),this.summary!==void 0&&this.summary!==null&&(e.summary=this.summary),this.accessMode?.length>0&&(e.accessMode=this.accessMode.map(t=>t.serialize())),this.accessModeSufficient?.length>0&&(e.accessModeSufficient=this.accessModeSufficient.map(t=>t.serialize())),this.feature?.length>0&&(e.feature=this.feature.map(t=>t.serialize())),this.hazard?.length>0&&(e.hazard=this.hazard.map(t=>t.serialize())),this.exemption?.length>0&&(e.exemption=this.exemption.map(t=>t.serialize())),e}}const T=class W{constructor(e){this.uri=e}static deserialize(e){if(!(!e||typeof e!="string"))return new W(e)}serialize(){return this.uri}get isWCAGLevelA(){return this===W.EPUB_A11Y_10_WCAG_20_A||this===W.EPUB_A11Y_11_WCAG_20_A||this===W.EPUB_A11Y_11_WCAG_21_A||this===W.EPUB_A11Y_11_WCAG_22_A}get isWCAGLevelAA(){return this===W.EPUB_A11Y_10_WCAG_20_AA||this===W.EPUB_A11Y_11_WCAG_20_AA||this===W.EPUB_A11Y_11_WCAG_21_AA||this===W.EPUB_A11Y_11_WCAG_22_AA}get isWCAGLevelAAA(){return this===W.EPUB_A11Y_10_WCAG_20_AAA||this===W.EPUB_A11Y_11_WCAG_20_AAA||this===W.EPUB_A11Y_11_WCAG_21_AAA||this===W.EPUB_A11Y_11_WCAG_22_AAA}};T.EPUB_A11Y_10_WCAG_20_A=new T("http://www.idpf.org/epub/a11y/accessibility-20170105.html#wcag-a"),T.EPUB_A11Y_10_WCAG_20_AA=new T("http://www.idpf.org/epub/a11y/accessibility-20170105.html#wcag-aa"),T.EPUB_A11Y_10_WCAG_20_AAA=new T("http://www.idpf.org/epub/a11y/accessibility-20170105.html#wcag-aaa"),T.EPUB_A11Y_11_WCAG_20_A=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.0-a"),T.EPUB_A11Y_11_WCAG_20_AA=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.0-aa"),T.EPUB_A11Y_11_WCAG_20_AAA=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.0-aaa"),T.EPUB_A11Y_11_WCAG_21_A=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.1-a"),T.EPUB_A11Y_11_WCAG_21_AA=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.1-aa"),T.EPUB_A11Y_11_WCAG_21_AAA=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.1-aaa"),T.EPUB_A11Y_11_WCAG_22_A=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.2-a"),T.EPUB_A11Y_11_WCAG_22_AA=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.2-aa"),T.EPUB_A11Y_11_WCAG_22_AAA=new T("https://www.w3.org/TR/epub-a11y-11#wcag-2.2-aaa");let Cl=T;class $i{constructor(e=null,t=null,i=null){this.certifiedBy=e,this.credential=t,this.report=i}static deserialize(e){if(!(!e||typeof e!="object"))return new $i(e.certifiedBy,e.credential,e.report)}serialize(){const e={};return this.certifiedBy&&(e.certifiedBy=this.certifiedBy),this.credential&&(e.credential=this.credential),this.report&&(e.report=this.report),e}}const C=class On{constructor(e){this.value=e}static deserialize(e){if(!(!e||typeof e!="string"))return new On(e)}serialize(){return this.value}};C.AUDITORY=new C("auditory"),C.CHART_ON_VISUAL=new C("chartOnVisual"),C.CHEM_ON_VISUAL=new C("chemOnVisual"),C.COLOR_DEPENDENT=new C("colorDependent"),C.DIAGRAM_ON_VISUAL=new C("diagramOnVisual"),C.MATH_ON_VISUAL=new C("mathOnVisual"),C.MUSIC_ON_VISUAL=new C("musicOnVisual"),C.TACTILE=new C("tactile"),C.TEXT_ON_VISUAL=new C("textOnVisual"),C.TEXTUAL=new C("textual"),C.VISUAL=new C("visual");let Al=C;const ae=class Me{constructor(e){if(typeof e=="string"){if(!Me.VALID_MODES.has(e.toLowerCase()))return;this.value=e.toLowerCase()}else{const t=e.filter(i=>Me.VALID_MODES.has(i.toLowerCase()));if(t.length===0)return;this.value=Array.from(new Set(t))}}static deserialize(e){if(!e)return;if(typeof e=="string")return new Me(e);if(!Array.isArray(e))return;const t=e.filter(i=>i?Me.VALID_MODES.has(i.toLowerCase()):!1);if(t.length!==0)return new Me(t)}serialize(){return this.value}};ae.VALID_MODES=new Set(["auditory","tactile","textual","visual"]),ae.AUDITORY=new ae("auditory"),ae.TACTILE=new ae("tactile"),ae.TEXTUAL=new ae("textual"),ae.VISUAL=new ae("visual");let _l=ae;const S=class Rn{constructor(e){this.value=e}static deserialize(e){if(!(!e||typeof e!="string"))return new Rn(e)}serialize(){return this.value}};S.NONE=new S("none"),S.ANNOTATIONS=new S("annotations"),S.ARIA=new S("ARIA"),S.INDEX=new S("index"),S.PAGE_BREAK_MARKERS=new S("pageBreakMarkers"),S.PAGE_NAVIGATION=new S("pageNavigation"),S.PRINT_PAGE_NUMBERS=new S("printPageNumbers"),S.READING_ORDER=new S("readingOrder"),S.STRUCTURAL_NAVIGATION=new S("structuralNavigation"),S.TABLE_OF_CONTENTS=new S("tableOfContents"),S.TAGGED_PDF=new S("taggedPDF"),S.ALTERNATIVE_TEXT=new S("alternativeText"),S.AUDIO_DESCRIPTION=new S("audioDescription"),S.CAPTIONS=new S("captions"),S.CLOSED_CAPTIONS=new S("closedCaptions"),S.DESCRIBED_MATH=new S("describedMath"),S.LONG_DESCRIPTION=new S("longDescription"),S.OPEN_CAPTIONS=new S("openCaptions"),S.SIGN_LANGUAGE=new S("signLanguage"),S.TRANSCRIPT=new S("transcript"),S.DISPLAY_TRANSFORMABILITY=new S("displayTransformability"),S.SYNCHRONIZED_AUDIO_TEXT=new S("synchronizedAudioText"),S.TIMING_CONTROL=new S("timingControl"),S.UNLOCKED=new S("unlocked"),S.CHEM_ML=new S("ChemML"),S.LATEX=new S("latex"),S.LATEX_CHEMISTRY=new S("latex-chemistry"),S.MATH_ML=new S("MathML"),S.MATH_ML_CHEMISTRY=new S("MathML-chemistry"),S.TTS_MARKUP=new S("ttsMarkup"),S.HIGH_CONTRAST_AUDIO=new S("highContrastAudio"),S.HIGH_CONTRAST_DISPLAY=new S("highContrastDisplay"),S.LARGE_PRINT=new S("largePrint"),S.BRAILLE=new S("braille"),S.TACTILE_GRAPHIC=new S("tactileGraphic"),S.TACTILE_OBJECT=new S("tactileObject"),S.FULL_RUBY_ANNOTATIONS=new S("fullRubyAnnotations"),S.HORIZONTAL_WRITING=new S("horizontalWriting"),S.RUBY_ANNOTATIONS=new S("rubyAnnotations"),S.VERTICAL_WRITING=new S("verticalWriting"),S.WITH_ADDITIONAL_WORD_SEGMENTATION=new S("withAdditionalWordSegmentation"),S.WITHOUT_ADDITIONAL_WORD_SEGMENTATION=new S("withoutAdditionalWordSegmentation");let Ol=S;const A=class Ln{constructor(e){this.value=e}static deserialize(e){if(!(!e||typeof e!="string"))return new Ln(e)}serialize(){return this.value}};A.FLASHING=new A("flashing"),A.NO_FLASHING_HAZARD=new A("noFlashingHazard"),A.UNKNOWN_FLASHING_HAZARD=new A("unknownFlashingHazard"),A.MOTION_SIMULATION=new A("motionSimulation"),A.NO_MOTION_SIMULATION_HAZARD=new A("noMotionSimulationHazard"),A.UNKNOWN_MOTION_SIMULATION_HAZARD=new A("unknownMotionSimulationHazard"),A.SOUND=new A("sound"),A.NO_SOUND_HAZARD=new A("noSoundHazard"),A.UNKNOWN_SOUND_HAZARD=new A("unknownSoundHazard"),A.UNKNOWN=new A("unknown"),A.NONE=new A("none");let Rl=A;const _=class zn{constructor(e){this.value=e}static deserialize(e){if(!(!e||typeof e!="string"))return new zn(e)}serialize(){return this.value}};_.NONE=new _("none"),_.DOCUMENTED=new _("documented"),_.LEGAL=new _("legal"),_.TEMPORARY=new _("temporary"),_.TECHNICAL=new _("technical"),_.EAA_DISPROPORTIONATE_BURDEN=new _("eaa-disproportionate-burden"),_.EAA_FUNDAMENTAL_ALTERATION=new _("eaa-fundamental-alteration"),_.EAA_MICROENTERPRISE=new _("eaa-microenterprise"),_.EAA_TECHNICAL_IMPOSSIBILITY=new _("eaa-technical-impossibility"),_.EAA_TEMPORARY=new _("eaa-temporary");let Ll=_;var Ve=(r=>(r.reflowable="reflowable",r.fixed="fixed",r.scrolled="scrolled",r))(Ve||{});class Hi{constructor(e){this.algorithm=e.algorithm,this.compression=e.compression,this.originalLength=e.originalLength,this.profile=e.profile,this.scheme=e.scheme}static deserialize(e){if(e&&e.algorithm)return new Hi({algorithm:e.algorithm,compression:e.compression,originalLength:e.originalLength,profile:e.profile,scheme:e.scheme})}serialize(){const e={algorithm:this.algorithm};return this.compression!==void 0&&(e.compression=this.compression),this.originalLength!==void 0&&(e.originalLength=this.originalLength),this.profile!==void 0&&(e.profile=this.profile),this.scheme!==void 0&&(e.scheme=this.scheme),e}}class G{constructor(e){this.otherProperties=e}get page(){return this.otherProperties.page}static deserialize(e){if(e)return new G(e)}serialize(){return this.otherProperties}add(e){const t=Object.assign({},this.otherProperties);for(const i in e)t[i]=e[i];return new G(t)}}Object.defineProperty(G.prototype,"encryption",{get:function(){return Hi.deserialize(this.otherProperties.encrypted)}});class ji{constructor(e){this.activeClass=e.activeClass,this.playbackActiveClass=e.playbackActiveClass}static deserialize(e){if(e)return new ji({activeClass:e.activeClass,playbackActiveClass:e.playbackActiveClass})}serialize(){const e={};return this.activeClass&&(e.activeClass=this.activeClass),this.playbackActiveClass&&(e.playbackActiveClass=this.playbackActiveClass),e}}function zl(r){return r&&Array.isArray(r)?r:void 0}function Pe(r){return r&&typeof r=="string"?[r]:zl(r)}function Rt(r){return typeof r=="string"?new Date(r):void 0}function qe(r){return isNaN(r)?void 0:r}function M(r){return qe(r)!==void 0&&Math.sign(r)>=0?r:void 0}function Lt(r){const e=new Array;return r.forEach(t=>e.push(t)),e}class Ue{constructor(e){this.value=e.value,this.scheme=e.scheme}static deserialize(e){if(e){if(typeof e=="string")return new Ue({value:e});if(typeof e=="object"&&e.value)return new Ue({value:e.value,scheme:e.scheme})}}serialize(){return this.scheme?{value:this.value,scheme:this.scheme}:this.value}}class y{constructor(e){let t,i,s=e.mediaType.replace(/\s/g,"").split(";");const n=s[0].split("/");if(n.length===2){if(t=n[0].toLowerCase().trim(),i=n[1].toLowerCase().trim(),t.length===0||i.length===0)throw new Error("Invalid media type")}else throw new Error("Invalid media type");const o={};for(let p=1;p<s.length;p++){const g=s[p].split("=");if(g.length===2){const c=g[0].toLocaleLowerCase(),m=c==="charset"?g[1].toUpperCase():g[1];o[c]=m}}const a={},l=Object.keys(o);l.sort((p,g)=>p.localeCompare(g)),l.forEach(p=>a[p]=o[p]);let h="";for(const p in a){const g=a[p];h+=`;${p}=${g}`}const u=`${t}/${i}${h}`,d=a.encoding;this.string=u,this.type=t,this.subtype=i,this.parameters=a,this.encoding=d,this.name=e.name,this.fileExtension=e.fileExtension}static parse(e){return new y(e)}get structuredSyntaxSuffix(){const e=this.subtype.split("+");return e.length>1?`+${e[e.length-1]}`:void 0}get charset(){return this.parameters.charset}contains(e){const t=typeof e=="string"?y.parse({mediaType:e}):e;if(!((this.type==="*"||this.type===t.type)&&(this.subtype==="*"||this.subtype===t.subtype)))return!1;const i=new Set(Object.entries(this.parameters).map(([n,o])=>`${n}=${o}`)),s=new Set(Object.entries(t.parameters).map(([n,o])=>`${n}=${o}`));for(const n of Array.from(i.values()))if(!s.has(n))return!1;return!0}matches(e){const t=typeof e=="string"?y.parse({mediaType:e}):e;return this.contains(t)||t.contains(this)}matchesAny(...e){for(const t of e)if(this.matches(t))return!0;return!1}equals(e){return this.string===e.string}get isZIP(){return this.matchesAny(y.ZIP,y.LCP_PROTECTED_AUDIOBOOK,y.LCP_PROTECTED_PDF)||this.structuredSyntaxSuffix==="+zip"}get isJSON(){return this.matchesAny(y.JSON)||this.structuredSyntaxSuffix==="+json"}get isOPDS(){return this.matchesAny(y.OPDS1,y.OPDS1_ENTRY,y.OPDS2,y.OPDS2_PUBLICATION,y.OPDS_AUTHENTICATION)||this.structuredSyntaxSuffix==="+json"}get isHTML(){return this.matchesAny(y.HTML,y.XHTML)}get isBitmap(){return this.matchesAny(y.BMP,y.GIF,y.JPEG,y.PNG,y.TIFF,y.WEBP)}get isAudio(){return this.type==="audio"}get isVideo(){return this.type==="video"}get isRWPM(){return this.matchesAny(y.READIUM_AUDIOBOOK_MANIFEST,y.DIVINA_MANIFEST,y.READIUM_WEBPUB_MANIFEST)}get isPublication(){return this.matchesAny(y.READIUM_AUDIOBOOK,y.READIUM_AUDIOBOOK_MANIFEST,y.CBZ,y.DIVINA,y.DIVINA_MANIFEST,y.EPUB,y.LCP_PROTECTED_AUDIOBOOK,y.LCP_PROTECTED_PDF,y.LPF,y.PDF,y.W3C_WPUB_MANIFEST,y.READIUM_WEBPUB,y.READIUM_WEBPUB_MANIFEST,y.ZAB)}static get AAC(){return y.parse({mediaType:"audio/aac",fileExtension:"aac"})}static get ACSM(){return y.parse({mediaType:"application/vnd.adobe.adept+xml",name:"Adobe Content Server Message",fileExtension:"acsm"})}static get AIFF(){return y.parse({mediaType:"audio/aiff",fileExtension:"aiff"})}static get AVI(){return y.parse({mediaType:"video/x-msvideo",fileExtension:"avi"})}static get BINARY(){return y.parse({mediaType:"application/octet-stream"})}static get BMP(){return y.parse({mediaType:"image/bmp",fileExtension:"bmp"})}static get CBZ(){return y.parse({mediaType:"application/vnd.comicbook+zip",name:"Comic Book Archive",fileExtension:"cbz"})}static get CSS(){return y.parse({mediaType:"text/css",fileExtension:"css"})}static get DIVINA(){return y.parse({mediaType:"application/divina+zip",name:"Digital Visual Narratives",fileExtension:"divina"})}static get DIVINA_MANIFEST(){return y.parse({mediaType:"application/divina+json",name:"Digital Visual Narratives",fileExtension:"json"})}static get EPUB(){return y.parse({mediaType:"application/epub+zip",name:"EPUB",fileExtension:"epub"})}static get GIF(){return y.parse({mediaType:"image/gif",fileExtension:"gif"})}static get GZ(){return y.parse({mediaType:"application/gzip",fileExtension:"gz"})}static get HTML(){return y.parse({mediaType:"text/html",fileExtension:"html"})}static get JAVASCRIPT(){return y.parse({mediaType:"text/javascript",fileExtension:"js"})}static get JPEG(){return y.parse({mediaType:"image/jpeg",fileExtension:"jpeg"})}static get JSON(){return y.parse({mediaType:"application/json"})}static get LCP_LICENSE_DOCUMENT(){return y.parse({mediaType:"application/vnd.readium.lcp.license.v1.0+json",name:"LCP License",fileExtension:"lcpl"})}static get LCP_PROTECTED_AUDIOBOOK(){return y.parse({mediaType:"application/audiobook+lcp",name:"LCP Protected Audiobook",fileExtension:"lcpa"})}static get LCP_PROTECTED_PDF(){return y.parse({mediaType:"application/pdf+lcp",name:"LCP Protected PDF",fileExtension:"lcpdf"})}static get LCP_STATUS_DOCUMENT(){return y.parse({mediaType:"application/vnd.readium.license.status.v1.0+json"})}static get LPF(){return y.parse({mediaType:"application/lpf+zip",fileExtension:"lpf"})}static get MP3(){return y.parse({mediaType:"audio/mpeg",fileExtension:"mp3"})}static get MPEG(){return y.parse({mediaType:"video/mpeg",fileExtension:"mpeg"})}static get NCX(){return y.parse({mediaType:"application/x-dtbncx+xml",fileExtension:"ncx"})}static get OGG(){return y.parse({mediaType:"audio/ogg",fileExtension:"oga"})}static get OGV(){return y.parse({mediaType:"video/ogg",fileExtension:"ogv"})}static get OPDS1(){return y.parse({mediaType:"application/atom+xml;profile=opds-catalog"})}static get OPDS1_ENTRY(){return y.parse({mediaType:"application/atom+xml;type=entry;profile=opds-catalog"})}static get OPDS2(){return y.parse({mediaType:"application/opds+json"})}static get OPDS2_PUBLICATION(){return y.parse({mediaType:"application/opds-publication+json"})}static get OPDS_AUTHENTICATION(){return y.parse({mediaType:"application/opds-authentication+json"})}static get OPUS(){return y.parse({mediaType:"audio/opus",fileExtension:"opus"})}static get OTF(){return y.parse({mediaType:"font/otf",fileExtension:"otf"})}static get PDF(){return y.parse({mediaType:"application/pdf",name:"PDF",fileExtension:"pdf"})}static get PNG(){return y.parse({mediaType:"image/png",fileExtension:"png"})}static get READIUM_AUDIOBOOK(){return y.parse({mediaType:"application/audiobook+zip",name:"Readium Audiobook",fileExtension:"audiobook"})}static get READIUM_AUDIOBOOK_MANIFEST(){return y.parse({mediaType:"application/audiobook+json",name:"Readium Audiobook",fileExtension:"json"})}static get READIUM_CONTENT_DOCUMENT(){return y.parse({mediaType:"application/vnd.readium.content+json",name:"Readium Content Document",fileExtension:"json"})}static get READIUM_GUIDED_NAVIGATION_DOCUMENT(){return y.parse({mediaType:"application/guided-navigation+json",name:"Readium Guided Navigation Document",fileExtension:"json"})}static get READIUM_POSITION_LIST(){return y.parse({mediaType:"application/vnd.readium.position-list+json",name:"Readium Position List",fileExtension:"json"})}static get READIUM_WEBPUB(){return y.parse({mediaType:"application/webpub+zip",name:"Readium Web Publication",fileExtension:"webpub"})}static get READIUM_WEBPUB_MANIFEST(){return y.parse({mediaType:"application/webpub+json",name:"Readium Web Publication",fileExtension:"json"})}static get SMIL(){return y.parse({mediaType:"application/smil+xml",fileExtension:"smil"})}static get SVG(){return y.parse({mediaType:"image/svg+xml",fileExtension:"svg"})}static get TEXT(){return y.parse({mediaType:"text/plain",fileExtension:"txt"})}static get TIFF(){return y.parse({mediaType:"image/tiff",fileExtension:"tiff"})}static get TTF(){return y.parse({mediaType:"font/ttf",fileExtension:"ttf"})}static get W3C_WPUB_MANIFEST(){return y.parse({mediaType:"application/x.readium.w3c.wpub+json",name:"Web Publication",fileExtension:"json"})}static get WAV(){return y.parse({mediaType:"audio/wav",fileExtension:"wav"})}static get WEBM_AUDIO(){return y.parse({mediaType:"audio/webm",fileExtension:"webm"})}static get WEBM_VIDEO(){return y.parse({mediaType:"video/webm",fileExtension:"webm"})}static get WEBP(){return y.parse({mediaType:"image/webp",fileExtension:"webp"})}static get WOFF(){return y.parse({mediaType:"font/woff",fileExtension:"woff"})}static get WOFF2(){return y.parse({mediaType:"font/woff2",fileExtension:"woff2"})}static get XHTML(){return y.parse({mediaType:"application/xhtml+xml",fileExtension:"xhtml"})}static get XML(){return y.parse({mediaType:"application/xml",fileExtension:"xml"})}static get ZAB(){return y.parse({mediaType:"application/x.readium.zab+zip",name:"Zipped Audio Book",fileExtension:"zab"})}static get ZIP(){return y.parse({mediaType:"application/zip",fileExtension:"zip"})}}class zt{constructor(e){this.uri=e,this.parameters=this.getParameters(e)}getParameters(e){const t=/\{\??([^}]+)\}/g,i=e.match(t);return i?new Set(i.join(",").replace(t,"$1").split(",").map(s=>s.trim())):new Set}expand(e){const t=s=>s.split(",").map(n=>{const o=e[n];return o?encodeURIComponent(o):""}).join(","),i=s=>"?"+s.split(",").map(n=>{const o=n.split("=")[0],a=e[o];return a?`${o}=${encodeURIComponent(a)}`:""}).join("&");return this.uri.replace(/\{(\??)([^}]+)\}/g,(...s)=>s[1]?i(s[2]):t(s[2]))}}class D{constructor(e){this.fragments=e.fragments?e.fragments:new Array,this.progression=e.progression,this.totalProgression=e.totalProgression,this.position=e.position,this.otherLocations=e.otherLocations}static deserialize(e){if(!e)return;const t=qe(e.progression),i=qe(e.totalProgression),s=qe(e.position),n=new Map,o=new Set(["fragment","fragments","progression","totalProgression","position"]);return Object.entries(e).forEach(([a,l])=>{o.has(a)||n.set(a,l)}),new D({fragments:Pe(e.fragments||e.fragment),progression:t!==void 0&&t>=0&&t<=1?t:void 0,totalProgression:i!==void 0&&i>=0&&i<=1?i:void 0,position:s!==void 0&&s>0?s:void 0,otherLocations:n.size===0?void 0:n})}serialize(){const e={};return this.fragments&&(e.fragments=this.fragments),this.progression!==void 0&&(e.progression=this.progression),this.totalProgression!==void 0&&(e.totalProgression=this.totalProgression),this.position!==void 0&&(e.position=this.position),this.otherLocations&&this.otherLocations.forEach((t,i)=>e[i]=t),e}}class Vi{constructor(e){this.after=e.after,this.before=e.before,this.highlight=e.highlight}static deserialize(e){if(e)return new Vi({after:e.after,before:e.before,highlight:e.highlight})}serialize(){const e={};return this.after!==void 0&&(e.after=this.after),this.before!==void 0&&(e.before=this.before),this.highlight!==void 0&&(e.highlight=this.highlight),e}}class We{constructor(e){this.href=e.href,this.type=e.type,this.title=e.title,this.locations=e.locations?e.locations:new D({}),this.text=e.text}static deserialize(e){if(e&&e.href&&e.type)return new We({href:e.href,type:e.type,title:e.title,locations:D.deserialize(e.locations),text:Vi.deserialize(e.text)})}serialize(){const e={href:this.href,type:this.type};return this.title!==void 0&&(e.title=this.title),this.locations&&(e.locations=this.locations.serialize()),this.text&&(e.text=this.text.serialize()),e}copyWithLocations(e){return new We({href:this.href,type:this.type,title:this.title,text:this.text,locations:new D({...this.locations,...e})})}}class pe{constructor(e){this.href=e.href,this.templated=e.templated,this.type=e.type,this.title=e.title,this.rels=e.rels,this.properties=e.properties,this.height=e.height,this.width=e.width,this.size=e.size,this.duration=e.duration,this.bitrate=e.bitrate,this.languages=e.languages,this.alternates=e.alternates,this.children=e.children}static deserialize(e){if(!(!e||typeof e.href!="string"))return new pe({href:e.href,templated:e.templated,type:e.type,title:e.title,rels:e.rel?Array.isArray(e.rel)?new Set(e.rel):new Set([e.rel]):void 0,properties:G.deserialize(e.properties),height:M(e.height),width:M(e.width),size:M(e.size),duration:M(e.duration),bitrate:M(e.bitrate),languages:Pe(e.language),alternates:J.deserialize(e.alternate),children:J.deserialize(e.children)})}serialize(){const e={href:this.href};return this.templated!==void 0&&(e.templated=this.templated),this.type!==void 0&&(e.type=this.type),this.title!==void 0&&(e.title=this.title),this.rels&&(e.rel=Lt(this.rels)),this.properties&&(e.properties=this.properties.serialize()),this.height!==void 0&&(e.height=this.height),this.width!==void 0&&(e.width=this.width),this.size!==void 0&&(e.size=this.size),this.duration!==void 0&&(e.duration=this.duration),this.bitrate!==void 0&&(e.bitrate=this.bitrate),this.languages&&(e.language=this.languages),this.alternates&&(e.alternate=this.alternates.serialize()),this.children&&(e.children=this.children.serialize()),e}get mediaType(){return this.type!==void 0?y.parse({mediaType:this.type}):y.BINARY}toURL(e){const t=this.href.replace(/^(\/)/,"");if(t.length===0)return;let i=e||"/";return i.startsWith("/")&&(i="file://"+i),new URL(t,i).href.replace(/^(file:\/\/)/,"")}get templateParameters(){return this.templated?new zt(this.href).parameters:new Set}expandTemplate(e){return new pe({href:new zt(this.href).expand(e),templated:!1})}addProperties(e){const t=pe.deserialize(this.serialize());return t.properties=t.properties?t.properties?.add(e):new G(e),t}get locator(){let e=this.href.split("#");return new We({href:e.length>0&&e[0]!==void 0?e[0]:this.href,type:this.type??"",title:this.title,locations:new D({fragments:e.length>1&&e[1]!==void 0?[e[1]]:[]})})}}class J{constructor(e){this.items=e}static deserialize(e){if(e&&Array.isArray(e))return new J(e.map(t=>pe.deserialize(t)).filter(t=>t!==void 0))}serialize(){return this.items.map(e=>e.serialize())}findWithRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.find(t)}filterByRel(e){const t=i=>i.rels&&i.rels.has(e);return this.items.filter(t)}findWithHref(e){const t=i=>i.href===e;return this.items.find(t)}findIndexWithHref(e){const t=i=>i.href===e;return this.items.findIndex(t)}findWithMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.find(t)}filterByMediaType(e){const t=i=>i.mediaType.matches(e);return this.items.filter(t)}filterByMediaTypes(e){const t=i=>{for(const s of e)if(i.mediaType.matches(s))return!0;return!1};return this.items.filter(t)}everyIsAudio(){const e=t=>t.mediaType.isAudio;return this.items.length>0&&this.items.every(e)}everyIsBitmap(){const e=t=>t.mediaType.isBitmap;return this.items.length>0&&this.items.every(e)}everyIsHTML(){const e=t=>t.mediaType.isHTML;return this.items.length>0&&this.items.every(e)}everyIsVideo(){const e=t=>t.mediaType.isVideo;return this.items.length>0&&this.items.every(e)}everyMatchesMediaType(e){return Array.isArray(e)?this.items.length>0&&this.items.every(t=>{for(const i of e)return t.mediaType.matches(i);return!1}):this.items.length>0&&this.items.every(t=>t.mediaType.matches(e))}filterLinksHasType(){return this.items.filter(e=>e.type)}}const Si=class Ie{constructor(e){this.translations=typeof e=="string"?{[Ie.UNDEFINED_LANGUAGE]:e}:e}static deserialize(e){if(e&&(typeof e=="string"||e.constructor===Object))return new Ie(e)}serialize(){return this.translations}getTranslation(e){return this.translations[e||Ie.UNDEFINED_LANGUAGE]||this.translations[Ie.UNDEFINED_LANGUAGE]||this.translations[Ie.LANGUAGE_EN]||(Object.values(this.translations).length===0?"":Object.values(this.translations)[0])}};Si.UNDEFINED_LANGUAGE="undefined",Si.LANGUAGE_EN="en";let Te=Si;class Mt{constructor(e){this.name=e.name,this.sortAs=e.sortAs,this.identifier=e.identifier,this.altIdentifiers=e.altIdentifiers,this.roles=e.roles,this.links=e.links,this.position=e.position}static deserialize(e){if(e)return typeof e=="string"?new Mt({name:Te.deserialize(e)}):e.name?new Mt({name:Te.deserialize(e.name),sortAs:e.sortAs,identifier:e.identifier,altIdentifiers:e.altIdentifier?Array.isArray(e.altIdentifier)?new Set(e.altIdentifier.map(t=>Ue.deserialize(t)).filter(t=>t!==void 0)):new Set([Ue.deserialize(e.altIdentifier)].filter(t=>t!==void 0)):void 0,roles:e.role?new Set(Pe(e.role)):void 0,links:J.deserialize(e.links),position:qe(e.position)}):void 0}serialize(){const e={name:this.name.serialize()};return this.sortAs!==void 0&&(e.sortAs=this.sortAs),this.identifier!==void 0&&(e.identifier=this.identifier),this.altIdentifiers&&(e.altIdentifier=Lt(this.altIdentifiers).map(t=>t.serialize())),this.roles&&(e.role=Lt(this.roles)),this.links&&(e.links=this.links.serialize()),this.position!==void 0&&(e.position=this.position),e}}class z{constructor(e){this.items=e}static deserialize(e){if(!e)return;const t=Array.isArray(e)?e:[e];return new z(t.map(i=>Mt.deserialize(i)).filter(i=>i!==void 0))}serialize(){return this.items.map(e=>e.serialize())}}class Je{constructor(e){this.items=e&&e.items?e.items:new Map}static deserialize(e){if(!(e&&typeof e=="object"))return;const t=new Map;return Object.entries(e).forEach(([i,s])=>{const n=z.deserialize(s);n&&n.items.length>0&&t.set(i,n)}),new Je({items:t})}serialize(){const e={};return this.items.forEach((t,i)=>e[i]=t.serialize()),e}}var Ge=(r=>(r.EPUB="https://readium.org/webpub-manifest/profiles/epub",r.AUDIOBOOK="https://readium.org/webpub-manifest/profiles/audiobook",r.DIVINA="https://readium.org/webpub-manifest/profiles/divina",r.PDF="https://readium.org/webpub-manifest/profiles/pdf",r))(Ge||{}),xe=(r=>(r.ltr="ltr",r.rtl="rtl",r))(xe||{});class It{constructor(e){this.name=e.name,this.sortAs=e.sortAs,this.code=e.code,this.scheme=e.scheme,this.links=e.links}static deserialize(e){if(e)return typeof e=="string"?new It({name:Te.deserialize(e)}):e.name?new It({name:Te.deserialize(e.name),sortAs:e.sortAs,code:e.code,scheme:e.scheme,links:J.deserialize(e.links)}):void 0}serialize(){const e={name:this.name.serialize()};return this.sortAs!==void 0&&(e.sortAs=this.sortAs),this.code!==void 0&&(e.code=this.code),this.scheme!==void 0&&(e.scheme=this.scheme),this.links&&(e.links=this.links.serialize()),e}}class Gi{constructor(e){this.items=e}static deserialize(e){if(!e)return;const t=Array.isArray(e)?e:[e];return new Gi(t.map(i=>It.deserialize(i)).filter(i=>i!==void 0))}serialize(){return this.items.map(e=>e.serialize())}}class Xi{constructor(e){this.reservation=e.reservation,this.policy=e.policy}static deserialize(e){if(e)return new Xi({reservation:e.reservation,policy:e.policy})}serialize(){const e={};return this.reservation!==void 0&&(e.reservation=this.reservation),this.policy!==void 0&&(e.policy=this.policy),e}}const Mn=class bi{constructor(e){this.title=e.title,this.typeUri=e.typeUri,this.conformsTo=e.conformsTo,this.identifier=e.identifier,this.altIdentifier=e.altIdentifier,this.subtitle=e.subtitle,this.sortAs=e.sortAs,this.artists=e.artists,this.authors=e.authors,this.colorists=e.colorists,this.contributors=e.contributors,this.editors=e.editors,this.illustrators=e.illustrators,this.inkers=e.inkers,this.letterers=e.letterers,this.narrators=e.narrators,this.pencilers=e.pencilers,this.translators=e.translators,this.languages=e.languages,this.description=e.description,this.publishers=e.publishers,this.imprints=e.imprints,this.published=e.published,this.modified=e.modified,this.subjects=e.subjects,this.belongsTo=e.belongsTo,this.belongsToCollections=e.belongsToCollections,this.belongsToSeries=e.belongsToSeries,this.belongsToCollections&&this.belongsToCollections.items.length>0&&(this.belongsTo||(this.belongsTo=new Je),this.belongsTo.items.set("collection",this.belongsToCollections)),this.belongsToSeries&&this.belongsToSeries.items.length>0&&(this.belongsTo||(this.belongsTo=new Je),this.belongsTo.items.set("series",this.belongsToSeries)),this.layout=e.layout,this.readingProgression=e.readingProgression,this.duration=e.duration,this.numberOfPages=e.numberOfPages,this.accessibility=e.accessibility,this.tdm=e.tdm,this.otherMetadata=e.otherMetadata}static deserialize(e){if(!(e&&e.title))return;const t=Te.deserialize(e.title),i=e["@type"],s=Pe(e.conformsTo),n=e.identifier,o=Ue.deserialize(e.altIdentifier),a=Te.deserialize(e.subtitle),l=Te.deserialize(e.sortAs),h=z.deserialize(e.artist),u=z.deserialize(e.author),d=z.deserialize(e.colorist),p=z.deserialize(e.contributor),g=z.deserialize(e.editor),c=z.deserialize(e.illustrator),m=z.deserialize(e.inker),b=z.deserialize(e.letterer),x=z.deserialize(e.narrator),X=z.deserialize(e.penciler),rt=z.deserialize(e.translator),Ut=Pe(e.language),Wt=e.description,Bt=z.deserialize(e.publisher),nt=z.deserialize(e.imprint),Nn=Rt(e.published),kn=Rt(e.modified),Fn=Gi.deserialize(e.subject),Dn=Je.deserialize(e.belongsTo),Un=Bi.deserialize(e.accessibility),Wn=e.layout,Bn=e.readingProgression,$n=M(e.duration),Hn=M(e.numberOfPages),jn=Xi.deserialize(e.tdm);let ot=Object.assign({},e);return bi.mappedProperties.forEach(Vn=>delete ot[Vn]),Object.keys(ot).length===0&&(ot=void 0),new bi({title:t,typeUri:i,conformsTo:s,identifier:n,altIdentifier:o,subtitle:a,sortAs:l,artists:h,authors:u,colorists:d,contributors:p,editors:g,illustrators:c,inkers:m,letterers:b,narrators:x,pencilers:X,translators:rt,languages:Ut,description:Wt,publishers:Bt,imprints:nt,published:Nn,modified:kn,subjects:Fn,belongsTo:Dn,layout:Wn,readingProgression:Bn,duration:$n,numberOfPages:Hn,accessibility:Un,tdm:jn,otherMetadata:ot})}serialize(){const e={title:this.title.serialize()};if(this.typeUri!==void 0&&(e["@type"]=this.typeUri),this.conformsTo&&(e.conformsTo=this.conformsTo),this.identifier!==void 0&&(e.identifier=this.identifier),this.altIdentifier&&(e.altIdentifier=this.altIdentifier.serialize()),this.subtitle&&(e.subtitle=this.subtitle.serialize()),this.sortAs&&(e.sortAs=this.sortAs.serialize()),this.editors&&(e.editor=this.editors.serialize()),this.artists&&(e.artist=this.artists.serialize()),this.authors&&(e.author=this.authors.serialize()),this.colorists&&(e.colorist=this.colorists.serialize()),this.contributors&&(e.contributor=this.contributors.serialize()),this.illustrators&&(e.illustrator=this.illustrators.serialize()),this.letterers&&(e.letterer=this.letterers.serialize()),this.narrators&&(e.narrator=this.narrators.serialize()),this.pencilers&&(e.penciler=this.pencilers.serialize()),this.translators&&(e.translator=this.translators.serialize()),this.inkers&&(e.inker=this.inkers.serialize()),this.languages&&(e.language=this.languages),this.description!==void 0&&(e.description=this.description),this.publishers&&(e.publisher=this.publishers.serialize()),this.imprints&&(e.imprint=this.imprints.serialize()),this.published!==void 0&&(e.published=this.published.toISOString()),this.modified!==void 0&&(e.modified=this.modified.toISOString()),this.subjects&&(e.subject=this.subjects.serialize()),this.belongsTo&&(e.belongsTo=this.belongsTo.serialize()),this.layout&&(e.layout=this.layout),this.readingProgression&&(e.readingProgression=this.readingProgression),this.duration!==void 0&&(e.duration=this.duration),this.numberOfPages!==void 0&&(e.numberOfPages=this.numberOfPages),this.accessibility&&(e.accessibility=this.accessibility.serialize()),this.tdm&&(e.tdm=this.tdm.serialize()),this.otherMetadata){const t=this.otherMetadata;Object.keys(t).forEach(i=>e[i]=t[i])}return e}get effectiveLayout(){if(!this.conformsTo)return null;for(const e of this.conformsTo)switch(e){case Ge.EPUB:return this.layout||Ve.reflowable;case Ge.DIVINA:return this.layout===Ve.reflowable?Ve.fixed:this.layout||Ve.fixed;case Ge.AUDIOBOOK:case Ge.PDF:return null}return null}get effectiveReadingProgression(){if(this.readingProgression)return this.readingProgression;if(this.languages?.length!==1)return xe.ltr;const e=this.languages[0].toLowerCase();if(e==="zh-hant"||e==="zh-tw")return xe.rtl;switch(e.split("-")[0]){case"ar":return xe.rtl;case"fa":return xe.rtl;case"he":return xe.rtl;default:return xe.ltr}}};Mn.mappedProperties=["title","@type","conformsTo","identifier","altIdentifier","subtitle","sortAs","artist","author","colorist","contributor","editor","illustrator","inker","letterer","narrator","penciler","translator","language","description","publisher","imprint","published","modified","subject","belongsTo","layout","readingProgression","duration","numberOfPages","accessibility","tdm"];let In=Mn;In.prototype.getMediaOverlay=function(){const r=this.otherMetadata?.mediaOverlay;if(r)return ji.deserialize(r)};G.prototype.getContains=function(){return new Set(this.otherProperties.contains||[])};class Yi{constructor(e){this.links=e.links,this.guided=e.guided}static deserialize(e){if(e)return new Yi({links:J.deserialize(e.links),guided:Ne.deserializeArray(e.guided)})}serialize(){const e={};return this.links!==void 0&&(e.links=this.links.serialize()),this.guided!==void 0&&(e.guided=this.guided.map(t=>t.serialize())),e}}class Nt{constructor(e){this.plain=e.plain,this.ssml=e.ssml,this.language=e.language}static deserialize(e){if(e!=null){if(typeof e=="string")return new Nt({plain:e});if(e.plain||e.ssml||e.language)return new Nt({plain:e.plain,ssml:e.ssml,language:e.language})}}serialize(){const e={};return this.plain!==void 0&&(e.plain=this.plain),this.ssml!==void 0&&(e.ssml=this.ssml),this.language!==void 0&&(e.language=this.language),Object.keys(e).length>0?e:void 0}}class Ne{constructor(e){this.audioref=e.audioref,this.children=e.children,this.imgref=e.imgref,this.role=e.role,this.level=e.level!==void 0?Math.min(6,Math.max(1,e.level)):void 0,this.text=e.text,this.textref=e.textref,this.description=e.description}get plainText(){return this.text?.plain}get ssmlText(){return this.text?.ssml}get textLanguage(){return this.text?.language}static deserialize(e){if(e)return new Ne({audioref:e.audioref,children:Ne.deserializeArray(e.children),imgref:e.imgref,role:e.role?new Set(Pe(e.role)):void 0,level:typeof e.level=="number"?e.level:void 0,text:Nt.deserialize(e.text),textref:e.textref,description:Ne.deserialize(e.description)})}static deserializeArray(e){if(Array.isArray(e))return e.map(t=>Ne.deserialize(t)).filter(t=>t!==void 0)}serialize(){const e={};if(this.audioref!==void 0&&(e.audioref=this.audioref),this.children!==void 0&&(e.children=this.children.map(t=>t.serialize())),this.imgref!==void 0&&(e.imgref=this.imgref),this.role!==void 0&&(e.role=Lt(this.role)),this.level!==void 0&&(e.level=this.level),this.text!==void 0){const t=this.text.serialize();t!==void 0&&(e.text=t)}return this.textref!==void 0&&(e.textref=this.textref),this.description&&(e.description=this.description.serialize()),e}get audioFile(){return this.audioref?.split("#")[0]}get audioTime(){if(this.audioref?.includes("#"))return this.audioref.split("#",2)[1]}get textFile(){return this.textref?.split("#")[0]}get fragmentId(){if(this.textref?.includes("#"))return this.textref.split("#",2)[1]}get clip(){const e=this.audioFile;if(!e)return;const t=this.audioTime,i={audioResource:e,fragmentId:this.fragmentId};if(!t)return i;const s=this.parseTimer(t);return i.start=s[0],i.end=s[1],i}parseTimer(e){if(!e||!e.startsWith("t="))return[void 0,void 0];const t=e.substring(2).split(",").map(i=>parseFloat(i));return t.length===1?[isNaN(t[0])?void 0:t[0],void 0]:t.length>2?[void 0,void 0]:[isNaN(t[0])?void 0:t[0],isNaN(t[1])?void 0:t[1]]}}class ve{constructor(e){this.fetcher=new xl,e.fetcher&&(this.fetcher=e.fetcher),this.manifest=e.manifest,this.context=e.manifest.context,this.metadata=e.manifest.metadata,this.links=e.manifest.links,this.readingOrder=e.manifest.readingOrder,this.resources=e.manifest.resources,this.toc=e.manifest.toc,this.subcollections=e.manifest.subcollections}get baseURL(){return this.manifest.baseURL}linkWithHref(e){return this.manifest.linkWithHref(e)}linksWithRole(e){const t=this.subcollections?.get(e);return t&&t.length>0?t[0].links:void 0}linksWithRel(e){return this.manifest.linksWithRel(e)}linkWithRel(e){return this.manifest.linkWithRel(e)}async positionsFromManifest(){const e=this.manifest.links.findWithMediaType("application/vnd.readium.position-list+json");if(e===void 0)return[];const t=await this.get(e).readAsJSON();return t.total?t.positions.map(i=>We.deserialize(i)).filter(i=>i!==void 0):[]}async guideForLink(e){const t=o=>o.alternates?.findWithMediaType("application/guided-navigation+json");let i=t(e);if(!i){const o=this.linkWithHref(e.href);o!==void 0&&(i=t(o))}if(i||(i=this.manifest.links.findWithMediaType("application/guided-navigation+json")),!i)return;let s=i.href;if(i.templated){const o=new zt(s),a={};o.parameters.has("ref")&&(a.ref=e.href),s=new zt(s).expand(a)}const n=await this.get(new pe({href:s})).readAsJSON();return Yi.deserialize(n)}get(e){return this.fetcher.get(e)}}ve.prototype.getPageList=function(){return this.linksWithRole("pageList")};ve.prototype.getLandmarks=function(){return this.linksWithRole("landmarks")};ve.prototype.getListOfAudioClips=function(){return this.linksWithRole("loa")};ve.prototype.getListOfIllustrations=function(){return this.linksWithRole("loi")};ve.prototype.getListOfTables=function(){return this.linksWithRole("lot")};ve.prototype.getListOfVideoClips=function(){return this.linksWithRole("lov")};class kt{constructor(e){this.cssSelector=e.cssSelector,this.textNodeIndex=e.textNodeIndex,this.charOffset=e.charOffset}static deserialize(e){if(!(e&&e.cssSelector))return;let t=M(e.textNodeIndex);if(t===void 0)return;let i=M(e.charOffset);return i===void 0&&(i=M(e.offset)),new kt({cssSelector:e.cssSelector,textNodeIndex:t,charOffset:i})}serialize(){const e={cssSelector:this.cssSelector,textNodeIndex:this.textNodeIndex};return this.charOffset!==void 0&&(e.charOffset=this.charOffset),e}}class qi{constructor(e){this.start=e.start,this.end=e.end}static deserialize(e){if(!e)return;let t=kt.deserialize(e.start);if(t)return new qi({start:t,end:kt.deserialize(e.end)})}serialize(){const e={start:this.start.serialize()};return this.end&&(e.end=this.end.serialize()),e}}D.prototype.getCssSelector=function(){return this.otherLocations?.get("cssSelector")};D.prototype.getPartialCfi=function(){return this.otherLocations?.get("partialCfi")};D.prototype.getDomRange=function(){return qi.deserialize(this.otherLocations?.get("domRange"))};D.prototype.fragmentParameters=function(){return new Map(this.fragments.map(r=>r.startsWith("#")?r.slice(1):r).join("&").split("&").filter(r=>!r.startsWith("#")).map(r=>r.split("=")).filter(r=>r.length===2).map(r=>[r[0].trim().toLowerCase(),r[1].trim()]))};D.prototype.htmlId=function(){if(!this.fragments.length)return;let r=this.fragments.find(e=>e.length&&!e.includes("="));if(!r){const e=this.fragmentParameters();e.has("id")?r=e.get("id"):e.has("name")&&(r=e.get("name"))}return r?.startsWith("#")?r.slice(1):r};D.prototype.page=function(){const r=parseInt(this.fragmentParameters().get("page"));if(!isNaN(r)&&r>=0)return r};D.prototype.time=function(){const r=parseInt(this.fragmentParameters().get("t"));if(!isNaN(r))return r};D.prototype.space=function(){const r=this.fragmentParameters();if(!r.has("xywh"))return;const e=r.get("xywh").split(",").map(t=>parseInt(t));if(e.length===4&&!e.some(isNaN))return e};class Ji{constructor(e){this.currency=e.currency,this.value=e.value}static deserialize(e){if(!e)return;let t=e.currency;if(!(t&&typeof t=="string"&&t.length>0))return;let i=M(e.value);if(i!==void 0)return new Ji({currency:t,value:i})}serialize(){return{currency:this.currency,value:this.value}}}class Ke{constructor(e){this.type=e.type,this.children=e.children}static deserialize(e){if(e&&e.type)return new Ke({type:e.type,children:Ke.deserializeArray(e.children)})}static deserializeArray(e){if(Array.isArray(e))return e.map(t=>Ke.deserialize(t)).filter(t=>t!==void 0)}serialize(){const e={type:this.type};return this.children&&(e.children=this.children.map(t=>t.serialize())),e}}class Ki{constructor(e){this.total=e.total,this.position=e.position}static deserialize(e){if(e)return new Ki({total:M(e.total),position:M(e.position)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.position!==void 0&&(e.position=this.position),e}}class Zi{constructor(e){this.total=e.total,this.available=e.available}static deserialize(e){if(e)return new Zi({total:M(e.total),available:M(e.available)})}serialize(){const e={};return this.total!==void 0&&(e.total=this.total),this.available!==void 0&&(e.available=this.available),e}}class Qi{constructor(e){this.state=e.state,this.since=e.since,this.until=e.until}static deserialize(e){if(e&&e.state)return new Qi({state:e.state,since:Rt(e.since),until:Rt(e.until)})}serialize(){const e={state:this.state};return this.since!==void 0&&(e.since=this.since.toISOString()),this.until!==void 0&&(e.until=this.until.toISOString()),e}}G.prototype.getNumberOfItems=function(){return M(this.otherProperties.numberOfItems)};G.prototype.getPrice=function(){return Ji.deserialize(this.otherProperties.price)};G.prototype.getIndirectAcquisitions=function(){const r=this.otherProperties.indirectAcquisition;if(r&&Array.isArray(r))return r.map(e=>Ke.deserialize(e)).filter(e=>e!==void 0)};G.prototype.getHolds=function(){return Ki.deserialize(this.otherProperties.holds)};G.prototype.getCopies=function(){return Zi.deserialize(this.otherProperties.copies)};G.prototype.getAvailability=function(){return Qi.deserialize(this.otherProperties.availability)};G.prototype.getAuthenticate=function(){return pe.deserialize(this.otherProperties.authenticate)};ve.prototype.getImages=function(){return this.linksWithRole("images")};const Ml="CssSelectorGenerator";function tr(r="unknown problem",...e){console.warn(`${Ml}: ${r}`,...e)}function Il(r){return r instanceof RegExp}function Nl(r){return r.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".+")}function kl(r){const e=r.map(t=>{if(Il(t))return i=>t.test(i);if(typeof t=="function")return i=>{const s=t(i);return typeof s!="boolean"?(tr("pattern matcher function invalid","Provided pattern matching function does not return boolean. It's result will be ignored.",t),!1):s};if(typeof t=="string"){const i=new RegExp("^"+Nl(t)+"$");return s=>i.test(s)}return tr("pattern matcher invalid","Pattern matching only accepts strings, regular expressions and/or functions. This item is invalid and will be ignored.",t),()=>!1});return t=>e.some(i=>i(t))}kl(["class","id","ng-*"]);class fe{constructor(e){this.metadata=e.metadata,this.links=e.links,this.subcollections=e.subcollections}static deserialize(e){if(!e)return;let t,i,s;if(Array.isArray(e))t=J.deserialize(e);else if(typeof e=="object")t=J.deserialize(e.links),i=new Map,e.metadata&&Object.entries(e.metadata).forEach(([n,o])=>{i?.set(n,o)}),s=fe.deserializeCollections(e);else return;if(!(!t||t.items.length===0))return new fe({metadata:i?.size?i:void 0,links:t,subcollections:s?.size?s:void 0})}static deserializeCollections(e){if(!e)return;const t=new Map;return Object.entries(e).forEach(([i,s])=>{if(i!=="links"&&i!=="metadata"){const n=fe.deserialize(s);if(n){const o=new Array;o.push(n),t.set(i,o)}else if(Array.isArray(s)){const o=s.map(a=>fe.deserialize(a)).filter(a=>a!==void 0);t.set(i,o)}}}),t.size?t:void 0}serialize(){const e={};return this.metadata&&(e.metadata={},this.metadata.forEach((t,i)=>e.metadata[i]=t)),this.links.items.length&&(e.links=this.links.serialize()),fe.serializeCollection(e,this.subcollections),e}static serializeCollection(e,t){t&&t.size>0&&t.forEach((i,s)=>{i.length===1?e[s]=i[0].serialize():e[s]=i.map(n=>n.serialize())})}}class es{constructor(e){this.context=e.context,this.metadata=e.metadata,this.links=e.links,this.readingOrder=e.readingOrder,this.resources=e.resources,this.toc=e.toc,this.subcollections=e.subcollections}static deserialize(e){if(!e)return;const t=In.deserialize(e.metadata);if(!t)return;const i=J.deserialize(e.links);if(!i)return;const s=J.deserialize(e.readingOrder?e.readingOrder:e.spine);if(s)return new es({context:Pe(e["@context"]),metadata:t,links:i,readingOrder:s,resources:J.deserialize(e.resources),toc:J.deserialize(e.toc),subcollections:fe.deserializeCollections({sub:e.sub})})}serialize(){const e={};return this.context!==void 0&&(e["@context"]=this.context),e.metadata=this.metadata.serialize(),e.links=this.links.serialize(),e.readingOrder=this.readingOrder.serialize(),this.resources&&(e.resources=this.resources.serialize()),this.toc&&(e.toc=this.toc.serialize()),fe.serializeCollection(e,this.subcollections),e}linkWithRel(e){const t=new Array;t.push(this.readingOrder),this.resources&&t.push(this.resources),t.push(this.links);let i;for(const s of t)if(i=s.findWithRel(e),i!==void 0)return i;return i}linksWithRel(e){const t=[];return t.push(this.readingOrder.filterByRel(e)),this.resources&&t.push(this.resources.filterByRel(e)),t.push(this.links.filterByRel(e)),t.reduce((i,s)=>i.concat(s),[])}locatorFromLink(e){const t=e.href.split("#"),i=t.length==2?t[0]:e.href,s=this.linkWithHref(i);if(!s)return;const n=s.type;if(!n)return;const o=t.length==2?t[1]:void 0;return new We({href:i,type:n,title:s.title??e.title,locations:new D({fragments:o?[o]:void 0,progression:o?void 0:0})})}linkWithHref(e){const t=a=>{let l;for(const u of a)if(l=u.findWithHref(e),l!==void 0)return l;const h=new Array;return a.forEach(u=>{const d=[];for(const p of u.items)p.alternates&&d.push(p.alternates),p.children&&d.push(p.children);h.push(...d)}),h.length>0&&(l=t(h)),l},i=[];i.push(this.readingOrder),this.resources&&i.push(this.resources),i.push(this.links);const s=t(i);if(s!==void 0)return s;const n=e.split(/[#]/);if(n.length<2)return;const o=n[0];return this.linkWithHref(o)}get baseURL(){const e=this.links.items.find(t=>t.rels&&t.rels.has("self"));if(e){let t=e.href;if(t){const i=t.lastIndexOf("/"),s=i===-1?void 0:t.substring(i+1);t=t.replace(new RegExp("/?$query$"),""),t=t.replace(new RegExp("//$"),""),s&&(t=t.replace(new RegExp(s+"$"),""))}return t}}setSelfLink(e){this.links.items=this.links.items.filter(t=>t.rels===void 0||!t.rels?.has("self")),this.links.items.push(new pe({href:e,type:y.READIUM_WEBPUB_MANIFEST.string,rels:new Set(["self"])}))}}function Fl(r){document.querySelectorAll(`a[href*="${r}"]`).forEach(e=>{const t=document.createElement("span");t.innerHTML=e.innerHTML,e.replaceWith(t)})}function Dl(){document.querySelectorAll("#loading-message").forEach(r=>r.style.display="none")}const Ul=document.getElementById("debug"),Wl=document.getElementById("container");async function Bl(r){Fl(r);const e=`https://www.kbresearch.nl/epub/${r}/manifest.json`,t=new pe({href:"manifest.json"}),i=new Tl(void 0,e),s=i.get(t),n=(await s.link()).toURL(e);Ul.innerHTML=e,await s.readAsJSON().then(async o=>{const a=es.deserialize(o);a.setSelfLink(n);const l=new ve({manifest:a,fetcher:i}),h={frameLoaded:function(d){console.log("frameLoaded wnd=",d)},positionChanged:function(d){Dl(),console.log("positionChanged locator=",d)},tap:function(d){return console.log("tap e=",d),!1},click:function(d){return console.log("click e=",d),!1},zoom:function(d){console.log("zoom scale=",d)},miscPointer:function(d){console.log("miscPointer amount=",d)},scroll:function(d){console.log("scroll delta=",d)},customEvent:function(d,p){console.log("customEvent key=",d,"data=",p)},handleLocator:function(d){return console.log("handleLocator locator=",d),!1},textSelected:function(d){console.log("textSelected selection=",d)}};await new Wi(Wl,l,h).load()})}document.addEventListener("DOMContentLoaded",()=>{const e=`${new URLSearchParams(location.search.replace("?","")).get("boek")}`;e?Bl(e):console.error("Er mist een boek ID")});
